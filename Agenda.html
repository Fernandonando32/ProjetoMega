<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Tarefas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/pg-config.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/tasks-api.js"></script>
    
    <script type="module">
        import * as Auth from './js/auth.js';
        
        // Verificar autenticação
        async function checkAuth() {
            if (!await Auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Obter usuário atual
            const currentUser = Auth.getCurrentUser();
            
            // Verificar permissão para visualizar tarefas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_TASKS)) {
                alert('Você não tem permissão para acessar esta página.');
                window.location.href = 'login.html';
                return;
            }
            
            // Configurar elementos da interface após carregamento
            document.addEventListener('DOMContentLoaded', setupUI);
        }
        
        // Iniciar verificação de autenticação
        checkAuth();
        
        // Função para configurar a interface do usuário
        function setupUI() {
            const currentUser = Auth.getCurrentUser();
            if (currentUser) {
                // Configurar elementos da interface com base no usuário atual
                // Código para atualizar a UI com informações do usuário...
            }
        }
        
        // Expor Auth globalmente para uso em outros scripts inline
        window.Auth = Auth;
    </script>
    <style>
        :root {
            --primary-color: #2a3d66;
            --secondary-color: #eaf0fa;
            --accent-color: #27ae60;
            --danger-color: #c0392b;
            --text-color: #2a3d66;
            --light-text: #666;
            --border-color: #e0e6f0;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: #f4f6fb;
            color: var(--text-color);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            max-height: 100vh;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .logo h1 {
            font-size: 20px;
            color: var(--primary-color);
        }

        .user-info {
            text-align: right;
            margin-top: 10px;
            font-size: 12px;
        }

        .logout-button {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .logout-button:hover {
            background: #a93226;
        }

        .task-form {
            flex: 1;
        }

        .task-form h2 {
            margin-bottom: 20px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-color);
        }

        input, textarea, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            height: 80px;
            resize: vertical;
        }

        button {
            cursor: pointer;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #1a2540;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--text-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
        }

        .calendar-header button {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-color);
            padding: 5px;
        }

        .view-selector {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .view-selector button {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .view-selector button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            margin-bottom: 1px;
        }

        .calendar-day-header {
            background: var(--secondary-color);
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .calendar-day-content {
            background: white;
            min-height: 100px;
            padding: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .calendar-day-content.today {
            background: #e6f7ff;
        }

        .calendar-day-content.other-month {
            background: #f9f9f9;
            color: var(--light-text);
        }

        .daily-view {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1px;
            background: var(--border-color);
        }

        .daily-view-header {
            background: var(--secondary-color);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .daily-view-content {
            background: white;
            min-height: 300px;
            padding: 20px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 10px;
        }

        .time-slot {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--light-text);
        }

        .time-slot-content {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            min-height: 50px;
        }

        .time-slot-content.has-task {
            background: #f8f9fa;
        }

        .calendar-grid {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--secondary-color);
            padding: 10px;
            font-weight: bold;
            text-align: center;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .calendar-tasks {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100% - 25px);
        }

        .calendar-task {
            font-size: 12px;
            padding: 2px 5px;
            margin-bottom: 2px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }

        .calendar-task.priority-high {
            border-left: 2px solid var(--danger-color);
        }

        .calendar-task.priority-medium {
            border-left: 2px solid #f39c12;
        }

        .calendar-task.priority-low {
            border-left: 2px solid var(--accent-color);
        }

        .calendar-task.completed {
            background-color: #27ae60 !important;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .calendar-day.today {
            background: #e6f7ff;
        }

        .calendar-day.has-tasks::after {
            display: none;
        }

        .calendar-day.other-month {
            background: #f9f9f9;
            color: var(--light-text);
        }

        .task-list {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .task-list h3 {
            margin-bottom: 15px;
        }

        .task-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item.priority-high {
            border-left: 3px solid var(--danger-color);
        }

        .task-item.priority-medium {
            border-left: 3px solid #f39c12;
        }

        .task-item.priority-low {
            border-left: 3px solid var(--accent-color);
        }

        .task-item.urgent {
            background: #ffebee;
            animation: pulse 1s infinite;
        }

        .task-item.upcoming {
            background: #fff8e1;
            animation: pulse 2s infinite;
        }

        .task-item.upcoming .notification-bell {
            color: #f39c12;
        }

        .task-item.urgent .notification-bell {
            color: var(--danger-color);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Estilo para tarefas concluídas */
        .task-item.completed {
            background: #f0f8f0;
            opacity: 0.8;
            border-left: 3px solid var(--accent-color);
        }
        
        .day-tooltip-task.completed {
            background-color: #f0f8f0;
            border-left-color: var(--accent-color);
        }
        
        .day-tooltip-task.completed .day-tooltip-title {
            text-decoration: line-through;
        }
        
        .btn-success {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .task-completion-status {
            display: inline-block;
            margin-left: 10px;
            font-size: 12px;
            color: var(--accent-color);
        }
        
        /* Abas para visualização de tarefas concluídas */
        .tasks-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tasks-tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 2px solid transparent;
        }
        
        .tasks-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tasks-tab:hover {
            background-color: var(--secondary-color);
        }

        /* Notification Styles */
        .notification-bell {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #f39c12;
            animation: ring 2s infinite;
        }

        @keyframes ring {
            0% { transform: translateY(-50%) rotate(0deg); }
            25% { transform: translateY(-50%) rotate(15deg); }
            50% { transform: translateY(-50%) rotate(-15deg); }
            75% { transform: translateY(-50%) rotate(15deg); }
            100% { transform: translateY(-50%) rotate(0deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Tooltip/Balão para tarefas do dia */
        .day-tooltip {
            display: none;
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 100;
            min-width: 250px;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
        }

        .day-tooltip h4 {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
        }

        .day-tooltip-task {
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid;
            background-color: #f8f9fa;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .day-tooltip-task:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .day-tooltip-task:last-child {
            margin-bottom: 0;
        }

        .day-tooltip-task.priority-high {
            border-left-color: var(--danger-color);
        }

        .day-tooltip-task.priority-medium {
            border-left-color: #f39c12;
        }

        .day-tooltip-task.priority-low {
            border-left-color: var(--accent-color);
        }

        .day-tooltip-task.completed {
            background-color: #f0f8f0;
            border-left-color: var(--accent-color);
        }

        .day-tooltip-time {
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 3px;
        }

        .day-tooltip-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .day-tooltip-category {
            font-size: 11px;
            color: var(--light-text);
            font-style: italic;
        }

        .tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
            top: -8px;
            left: 15px;
        }

        .show-tooltip {
            display: block;
        }

        /* Refresh Indicator Styles */
        .refresh-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .refresh-indicator button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 14px;
            padding: 3px 8px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .refresh-indicator button:hover {
            background-color: var(--secondary-color);
        }
        
        .refresh-animation {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .calendar-day {
                min-height: 60px;
            }
            
            header {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            header > div {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Ajuste para o novo layout com cabeçalho */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .container {
            flex: 1;
            margin-top: 0;
        }
        
        /* Garante que o menu de navegação esteja visível */
        .main-menu {
            position: relative;
            z-index: 100;
            display: block !important;
            width: 100%;
        }
        
        .main-menu ul {
            display: flex !important;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Estilos para o sistema de notificações */
        @keyframes bellRing {
            0% { transform: rotate(0); }
            20% { transform: rotate(15deg); }
            40% { transform: rotate(-15deg); }
            60% { transform: rotate(7deg); }
            80% { transform: rotate(-7deg); }
            100% { transform: rotate(0); }
        }
        
        .bell-animation {
            animation: bellRing 0.8s ease;
        }
        
        .notification-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background-color: var(--secondary-color);
        }
        
        .notification-item.unread {
            background-color: #f0f7ff;
        }
        
        .notification-item .notification-title {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 14px;
        }
        
        .notification-item .notification-message {
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 5px;
        }
        
        .notification-item .notification-time {
            font-size: 11px;
            color: var(--light-text);
            text-align: right;
        }
        
        .notification-indicator {
            position: absolute;
            top: 7px;
            right: 7px;
            width: 8px;
            height: 8px;
            background-color: var(--danger-color);
            border-radius: 50%;
        }
        
        /* Estilos para o painel de tarefas na barra lateral */
        .task-list-sidebar {
            margin-top: 10px;
            margin-bottom: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .task-list-sidebar .tasks-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .task-list-sidebar .tasks-tab {
            padding: 8px 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            border-bottom: 2px solid transparent;
        }
        
        .task-list-sidebar .tasks-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .task-list-sidebar .task-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .task-list-sidebar .task-item h4 {
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .task-list-sidebar .task-item p {
            font-size: 12px;
        }
        
        .task-list-sidebar .complete-task-btn {
            padding: 3px 8px;
            font-size: 11px;
        }
        
        /* Estilos para o seletor de dias da semana */
        .weekdays-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        
        .weekday-checkbox {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .weekday-checkbox input[type="checkbox"] {
            display: none;
        }
        
        .weekday-checkbox label {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-color);
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .weekday-checkbox input[type="checkbox"]:checked + label {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Estilos para seleção de cores predefinidas */
        .predefined-colors {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .color-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .color-option input[type="radio"] {
            display: none;
        }
        
        .color-option label {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option input[type="radio"]:checked + label {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .color-option span {
            font-size: 12px;
            color: var(--text-color);
        }
        
        .color-custom.active #customColorPicker {
            display: block !important;
        }
        
        /* Estilo específico para o seletor de cores personalizado */
        #customColorPicker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        #customColorPicker::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }
        
        #customColorPicker::-moz-color-swatch {
            border: none;
            border-radius: 50%;
        }
        
        /* Estilos para seleção de cores */
        .color-palette {
            margin-top: 10px;
        }
        
        .color-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .extra-colors {
            padding-top: 5px;
            border-top: 1px solid var(--border-color);
        }
        
        .color-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .color-option input[type="radio"] {
            display: none;
        }
        
        .color-option label {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option input[type="radio"]:checked + label {
            border-color: var(--primary-color);
            transform: scale(1.1);
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .color-option span {
            font-size: 12px;
            color: var(--text-color);
        }
        
        .extra-colors .color-option {
            margin-bottom: 5px;
        }
        
        .color-custom-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .custom-color-btn {
            background: none;
            border: 1px dashed var(--border-color);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            color: var(--light-text);
            transition: all 0.2s;
        }
        
        .custom-color-btn:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }
        
        #customColorPicker {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #customColorPicker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        #customColorPicker::-webkit-color-swatch {
            border: none;
            border-radius: 5px;
        }
        
        #customColorPicker::-moz-color-swatch {
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <header style="background: var(--primary-color); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow);">
        <div style="display: flex; align-items: center;">
            <i class="fas fa-calendar-alt" style="font-size: 24px; margin-right: 10px;"></i>
            <h1 style="font-size: 20px; margin: 0;">Agenda de Tarefas</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="currentUserName" style="font-size: 14px;"></div>
            
            <!-- Sistema de notificação para administradores -->
            <div id="notificationSystem" style="display: none; position: relative;">
                <button id="notificationButton" style="background: none; border: none; color: white; position: relative; padding: 5px; cursor: pointer;" title="Notificações">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" style="position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                </button>
                <div id="notificationDropdown" style="display: none; position: absolute; right: 0; top: 100%; width: 300px; max-height: 400px; overflow-y: auto; background: white; border-radius: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); color: var(--text-color); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">
                        <h3 style="margin: 0; font-size: 16px;">Notificações</h3>
                        <button id="markAllReadButton" style="font-size: 12px; padding: 3px 8px; background: var(--secondary-color); color: var(--text-color); border: none; border-radius: 3px; cursor: pointer;">Marcar todas como lidas</button>
                    </div>
                    <div id="notificationList" style="padding: 0;">
                        <div style="padding: 20px; text-align: center; color: var(--light-text);">
                            Nenhuma notificação
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="admin-button" id="adminButton" style="display: none; padding: 5px 8px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;" title="Administrar Usuários">
                <i class="fas fa-cog"></i>
            </button>
            <button class="logout-button" id="logoutButton" style="padding: 5px 10px; font-size: 12px; background: var(--danger-color); color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <!-- Menu de navegação intuitivo -->
    <nav class="main-menu" style="background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px 20px; margin-bottom: 20px; position: relative; z-index: 500; display: block !important;">
        <ul style="display: flex !important; list-style: none; margin: 0; padding: 0; gap: 5px; flex-wrap: wrap; justify-content: center;">
            <li class="menu-item" style="position: relative;">
                <a href="Pagina1 (1).html" style="display: flex; align-items: center; padding: 10px 15px; color: var(--text-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: all 0.2s ease; background: transparent;">
                    <i class="fas fa-home" style="margin-right: 8px;"></i>
                    <span>Principal</span>
                </a>
                <div class="menu-hover-indicator" style="position: absolute; bottom: -2px; left: 0; width: 0; height: 3px; background: var(--primary-color); border-radius: 3px; transition: width 0.2s ease;"></div>
            </li>
            <li class="menu-item active" style="position: relative;">
                <a href="Agenda.html" style="display: flex; align-items: center; padding: 10px 15px; color: var(--primary-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: all 0.2s ease; background: var(--secondary-color);">
                    <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
                    <span>Agenda</span>
                </a>
                <div class="menu-hover-indicator" style="position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--primary-color); border-radius: 3px;"></div>
            </li>
            <li class="menu-item" style="position: relative;">
                <a href="manutencao.html" style="display: flex; align-items: center; padding: 10px 15px; color: var(--text-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: all 0.2s ease; background: transparent;">
                    <i class="fas fa-tools" style="margin-right: 8px;"></i>
                    <span>Manutenção de Veículos</span>
                </a>
                <div class="menu-hover-indicator" style="position: absolute; bottom: -2px; left: 0; width: 0; height: 3px; background: var(--primary-color); border-radius: 3px; transition: width 0.2s ease;"></div>
            </li>
        </ul>
    </nav>

    <div class="container">
        <div class="sidebar">
            <div style="padding: 10px 0; border-bottom: 1px solid var(--border-color); cursor: pointer;" id="formToggler">
                <h2 style="font-size: 18px; margin-bottom: 0;">
                    <i class="fas fa-tasks" style="margin-right: 10px;"></i>
                    Nova Tarefa
                    <i class="fas fa-chevron-down" style="float: right; transition: transform 0.3s;"></i>
                </h2>
            </div>
            
            <div class="task-form" id="taskFormContainer" style="margin-top: 15px; display: none;">
                <form id="taskForm">
                    <div class="form-group">
                        <label for="taskTitle">Título</label>
                        <input type="text" id="taskTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Descrição</label>
                        <textarea id="taskDescription"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDate">Data</label>
                        <input type="date" id="taskDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskStartTime">Horário de Início</label>
                        <input type="time" id="taskStartTime" required>
                    </div>

                    <div class="form-group">
                        <label for="taskEndTime">Horário de Término</label>
                        <input type="time" id="taskEndTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority">Prioridade</label>
                        <select id="taskPriority" required>
                            <option value="alta">Alta</option>
                            <option value="media" selected>Média</option>
                            <option value="baixa">Baixa</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskCategory">Categoria</label>
                        <select id="taskCategory">
                            <option value="trabalho">Trabalho</option>
                            <option value="pessoal">Pessoal</option>
                            <option value="estudos">Estudos</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskAssignedTo">Atribuir para</label>
                        <select id="taskAssignedTo" multiple size="3" required>
                            <!-- Opções de usuários serão carregadas dinamicamente -->
                        </select>
                        <small style="color: var(--light-text); font-size: 12px;">Segure Ctrl (Windows) ou Command (Mac) para selecionar múltiplos usuários</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskColor">Cor da Tarefa</label>
                        <div class="color-palette">
                            <div class="color-row">
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorSolides" value="#1a2540" checked>
                                    <label for="colorSolides" style="background-color: #1a2540;"></label>
                                    <span>Solides</span>
                                </div>
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorPonto" value="#808080">
                                    <label for="colorPonto" style="background-color: #808080;"></label>
                                    <span>Ponto</span>
                                </div>
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorReuniao" value="#442211">
                                    <label for="colorReuniao" style="background-color: #442211;"></label>
                                    <span>Reunião</span>
                                </div>
                            </div>
                            <div class="color-row extra-colors">
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorRed" value="#e74c3c">
                                    <label for="colorRed" style="background-color: #e74c3c;"></label>
                                </div>
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorOrange" value="#e67e22">
                                    <label for="colorOrange" style="background-color: #e67e22;"></label>
                                </div>
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorYellow" value="#f1c40f">
                                    <label for="colorYellow" style="background-color: #f1c40f;"></label>
                                </div>
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorGreen" value="#2ecc71">
                                    <label for="colorGreen" style="background-color: #2ecc71;"></label>
                                </div>
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorBlue" value="#3498db">
                                    <label for="colorBlue" style="background-color: #3498db;"></label>
                                </div>
                                <div class="color-option">
                                    <input type="radio" name="taskColorOption" id="colorPurple" value="#9b59b6">
                                    <label for="colorPurple" style="background-color: #9b59b6;"></label>
                                </div>
                            </div>
                            <div class="color-custom-container">
                                <button type="button" id="showCustomColor" class="custom-color-btn">
                                    <i class="fas fa-plus"></i> Cor personalizada
                                </button>
                                <div id="customColorContainer" style="display: none; margin-top: 10px; transition: all 0.3s ease;">
                                    <input type="color" id="customColorPicker" value="#2a3d66">
                                    <button type="button" id="applyCustomColor" class="btn-secondary" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">Aplicar</button>
                                </div>
                            </div>
                            <input type="hidden" id="taskColor" value="#1a2540">
                        </div>
                    </div>
                    
                    <!-- Seção de Repetição de Tarefas -->
                    <div class="form-group">
                        <label for="taskRepeat">Repetir</label>
                        <select id="taskRepeat" onchange="toggleRepeatOptions()">
                            <option value="none">Não repetir</option>
                            <option value="daily">Todos os dias</option>
                            <option value="weekly">Semanalmente</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    
                    <!-- Dias da semana (aparece quando Weekly ou Custom é selecionado) -->
                    <div id="weekdaysContainer" class="form-group" style="display: none;">
                        <label>Dias da semana</label>
                        <div class="weekdays-selector">
                            <div class="weekday-checkbox">
                                <input type="checkbox" id="weekday-0" value="0">
                                <label for="weekday-0">Dom</label>
                            </div>
                            <div class="weekday-checkbox">
                                <input type="checkbox" id="weekday-1" value="1">
                                <label for="weekday-1">Seg</label>
                            </div>
                            <div class="weekday-checkbox">
                                <input type="checkbox" id="weekday-2" value="2">
                                <label for="weekday-2">Ter</label>
                            </div>
                            <div class="weekday-checkbox">
                                <input type="checkbox" id="weekday-3" value="3">
                                <label for="weekday-3">Qua</label>
                            </div>
                            <div class="weekday-checkbox">
                                <input type="checkbox" id="weekday-4" value="4">
                                <label for="weekday-4">Qui</label>
                            </div>
                            <div class="weekday-checkbox">
                                <input type="checkbox" id="weekday-5" value="5">
                                <label for="weekday-5">Sex</label>
                            </div>
                            <div class="weekday-checkbox">
                                <input type="checkbox" id="weekday-6" value="6">
                                <label for="weekday-6">Sáb</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Período personalizado (aparece quando qualquer opção de repetição é selecionada) -->
                    <div id="repeatEndContainer" class="form-group" style="display: none;">
                        <label for="repeatEndType">Terminar</label>
                        <select id="repeatEndType" onchange="toggleEndDateField()">
                            <option value="never">Nunca</option>
                            <option value="on">Em data específica</option>
                            <option value="after">Após um número de ocorrências</option>
                        </select>
                        
                        <div id="endDateContainer" style="display: none; margin-top: 10px;">
                            <label for="repeatEndDate">Data de término</label>
                            <input type="date" id="repeatEndDate">
                        </div>
                        
                        <div id="occurrencesContainer" style="display: none; margin-top: 10px;">
                            <label for="repeatOccurrences">Número de ocorrências</label>
                            <input type="number" id="repeatOccurrences" min="1" value="10">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskOperacao">Operação</label>
                            <select id="taskOperacao" required>
                                <option value="BJ Fibra">BJ Fibra</option>
                                <option value="Megalink">Megalink</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskAssignedTo">Atribuir para</label>
                            <select id="taskAssignedTo" multiple size="3" required>
                                <!-- Opções de usuários serão carregadas dinamicamente -->
                            </select>
                            <small style="color: var(--light-text); font-size: 12px;">Segure Ctrl (Windows) ou Command (Mac) para selecionar múltiplos usuários</small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary">Adicionar Tarefa</button>
                </form>
            </div>
            
            <!-- Painel de Tarefas do Dia Movido para sidebar -->
            <div style="padding: 20px 0 10px; border-bottom: 1px solid var(--border-color);">
                <h2 style="font-size: 18px; margin-bottom: 10px;">
                    <i class="fas fa-calendar-day" style="margin-right: 10px;"></i>
                    Tarefas do Dia
                </h2>
            </div>
            
            <div class="task-list-sidebar">
                <div class="tasks-tabs">
                    <div class="tasks-tab active" id="pendingTasksTab">Pendentes</div>
                    <div class="tasks-tab" id="completedTasksTab">Concluídas</div>
                </div>
                <div id="dailyTasks"></div>
                <div id="completedTasks" style="display: none;"></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="calendar-header">
                <button id="prevPeriod"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentPeriod">Janeiro 2024</h2>
                <button id="nextPeriod"><i class="fas fa-chevron-right"></i></button>
                <div class="view-selector">
                    <button id="dailyView" class="active">Dia</button>
                    <button id="weeklyView">Semana</button>
                    <button id="monthlyView">Mês</button>
                    <button id="completedView"><i class="fas fa-check-circle"></i> Concluídas</button>
                    <button id="clearTasksButton" class="clear-tasks-button" style="display: none; margin-left: 10px; padding: 5px 10px; font-size: 12px; background: var(--danger-color); color: white; border: none; border-radius: 3px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i> Limpar Todas as Tarefas
                    </button>
                </div>
            </div>
            
            <div class="refresh-indicator">
                Última atualização: <span id="lastRefreshTime">Agora</span>
                <button id="manualRefresh" title="Atualizar agora"><i class="fas fa-sync-alt"></i></button>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <!-- O conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para visualização/edição de tarefas -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Detalhes da Tarefa</h2>
            <div id="modalContent"></div>
            <div class="modal-actions">
                <button id="completeTask" class="btn-success"><i class="fas fa-check"></i> Concluir</button>
                <button id="editTask" class="btn-secondary">Editar</button>
                <button id="deleteTask" class="btn-danger">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Tooltip/Balão para visualização rápida de tarefas do dia -->
    <div id="dayTooltip" class="day-tooltip">
        <div class="tooltip-arrow"></div>
        <h4 id="tooltipDate">Tarefas do dia</h4>
        <span class="close-tooltip" style="position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 16px;">&times;</span>
        <div id="tooltipContent"></div>
    </div>

    <script>
        // Verificar e inicializar o usuário atual
        let currentUser = null;
        try {
            // Tentar obter o usuário do localStorage
            const userStr = localStorage.getItem('currentUser');
            if (userStr) {
                currentUser = JSON.parse(userStr);
            } else {
                // Redirecionar para o login se não houver usuário
                window.location.href = 'login.html';
            }
        } catch (error) {
            console.error('Erro ao carregar dados do usuário:', error);
            // Redirecionar para o login em caso de erro
            window.location.href = 'login.html';
        }
        
        // Configurar informações do usuário
        let displayName = currentUser.name;
        if (Auth && Auth.ACCESS_LEVELS && currentUser.accessLevel && Auth.ACCESS_LEVELS[currentUser.accessLevel]) {
            displayName += ` (${Auth.ACCESS_LEVELS[currentUser.accessLevel].name})`;
        }
        document.getElementById('currentUserName').textContent = displayName;

        // Configurar botão de logout
        document.getElementById('logoutButton').addEventListener('click', () => {
            Auth.logout();
            // O redirecionamento agora é feito diretamente na função Auth.logout()
        });

        // Verificar permissões e ajustar a interface
        function checkPermissions() {
            const taskFormContainer = document.getElementById('taskFormContainer');
            const completeTaskButton = document.getElementById('completeTask');
            const editTaskButton = document.getElementById('editTask');
            const deleteTaskButton = document.getElementById('deleteTask');
            const completedViewButton = document.getElementById('completedView');
            const adminButton = document.getElementById('adminButton');
            const clearTasksButton = document.getElementById('clearTasksButton');

            // Verificar permissão de criar tarefas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.CREATE_TASKS)) {
                taskFormContainer.style.display = 'none';
            }

            // Verificar permissão de editar tarefas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TASKS)) {
                editTaskButton.style.display = 'none';
            }

            // Verificar permissão de excluir tarefas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TASKS)) {
                deleteTaskButton.style.display = 'none';
            }

            // Verificar permissão de concluir tarefas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.COMPLETE_TASKS)) {
                completeTaskButton.style.display = 'none';
            }

            // Verificar permissão de visualizar tarefas concluídas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_COMPLETED)) {
                completedViewButton.style.display = 'none';
            }
            
            // Verificar permissão de gerenciar usuários
            if (Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                adminButton.style.display = 'block';
                adminButton.addEventListener('click', () => {
                    // Armazenar a página de origem antes de redirecionar
                    localStorage.setItem('adminOriginPage', 'Agenda.html');
                    window.location.href = 'admin.html';
                });
                
                // Mostrar botão de limpar tarefas apenas para administradores
                clearTasksButton.style.display = 'block';
                
                // Inicializar sistema de notificações para administradores
                if (notificationSystem) {
                    updateNotificationUI();
                    
                    // Adicionar efeito de destaque para notificações ao iniciar
                    if (notifications.some(notif => !notif.read)) {
                        setTimeout(() => {
                            const bellIcon = notificationButton.querySelector('i');
                            bellIcon.classList.add('bell-animation');
                            setTimeout(() => {
                                bellIcon.classList.remove('bell-animation');
                            }, 1000);
                        }, 2000); // Atraso para garantir que a UI esteja pronta
                    }
                }
            }
        }

        // Chamar a verificação de permissões após o carregamento da página
        document.addEventListener('DOMContentLoaded', async () => {
            checkPermissions();
            
            // Carregar tarefas do banco de dados
            try {
                console.log("Carregando tarefas do banco de dados...");
                tasks = await window.TasksAPI.getAllTasks();
                console.log(`${tasks.length} tarefas carregadas`);
            } catch (error) {
                console.error("Erro ao carregar tarefas:", error);
                tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                console.log(`${tasks.length} tarefas carregadas do localStorage (fallback)`);
            }
            
            renderCalendar();
            renderDailyTasks();
            setupEventListeners();
            requestNotificationPermission();
            startNotificationCheck();
            startAutoRefresh();
            loadUsersForAssignment(); // Garantir que os usuários sejam carregados
            
            // Remove o evento de clique para o botão Voltar que não existe
            // document.getElementById('btnVoltar').addEventListener('click', () => {
            //     window.location.href = 'Pagina1 (1).html';
            // });
            
            // Inicializar estado do seletor de cor personalizada
            // Não é necessário inicializar aqui pois já foi feito anteriormente
            // Removemos esta parte para evitar conflitos
        });

        // Variáveis globais
        let tasks = [];
        let currentDate = new Date();
        let selectedDate = new Date();
        let notificationCheckInterval;
        let currentView = 'monthly'; // 'daily', 'weekly', 'monthly', 'completed'
        let activeTooltip = null; // Para controlar o tooltip ativo
        let autoRefreshInterval; // Para controlar o intervalo de atualização automática
        let showCompletedTasks = false; // Controla se devemos mostrar tarefas concluídas nas visualizações normais
        let actionHistory = JSON.parse(localStorage.getItem('actionHistory')) || []; // Histórico de ações dos usuários

        // Elementos do DOM
        const calendarGrid = document.getElementById('calendarGrid');
        const currentPeriodElement = document.getElementById('currentPeriod');
        const prevPeriodButton = document.getElementById('prevPeriod');
        const nextPeriodButton = document.getElementById('nextPeriod');
        const dailyViewButton = document.getElementById('dailyView');
        const weeklyViewButton = document.getElementById('weeklyView');
        const monthlyViewButton = document.getElementById('monthlyView');
        const completedViewButton = document.getElementById('completedView');
        const taskForm = document.getElementById('taskForm');
        const dailyTasks = document.getElementById('dailyTasks');
        const completedTasks = document.getElementById('completedTasks');
        const pendingTasksTab = document.getElementById('pendingTasksTab');
        const completedTasksTab = document.getElementById('completedTasksTab');
        const taskModal = document.getElementById('taskModal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.querySelector('.close');
        const completeTaskButton = document.getElementById('completeTask');
        const editTaskButton = document.getElementById('editTask');
        const deleteTaskButton = document.getElementById('deleteTask');
        const dayTooltip = document.getElementById('dayTooltip');
        const tooltipDate = document.getElementById('tooltipDate');
        const tooltipContent = document.getElementById('tooltipContent');
        const refreshIndicator = document.querySelector('.refresh-indicator');
        const lastRefreshTime = document.getElementById('lastRefreshTime');
        const manualRefreshButton = document.getElementById('manualRefresh');

        // Função para registrar ações no histórico
        function logUserAction(action, details) {
            // Não registrar ações de administradores
            if (currentUser.accessLevel === 'ADMIN') return;
            
            const actionLog = {
                userId: currentUser.id,
                userName: currentUser.name,
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            actionHistory.unshift(actionLog); // Adicionar no início para manter mais recentes primeiro
            
            // Limitar o tamanho do histórico (manter últimas 1000 ações)
            if (actionHistory.length > 1000) {
                actionHistory = actionHistory.slice(0, 1000);
            }
            
            // Salvar no localStorage
            localStorage.setItem('actionHistory', JSON.stringify(actionHistory));
            
            // Criar notificação para administradores
            createAdminNotification(actionLog);
        }
        
        // Sistema de notificações para administradores
        let notifications = JSON.parse(localStorage.getItem('adminNotifications')) || [];
        const notificationSystem = document.getElementById('notificationSystem');
        const notificationButton = document.getElementById('notificationButton');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const notificationCount = document.getElementById('notificationCount');
        const notificationList = document.getElementById('notificationList');
        const markAllReadButton = document.getElementById('markAllReadButton');
        let hasUnreadNotifications = false;
        
        // Função para criar notificação para administradores
        function createAdminNotification(actionLog) {
            const notification = {
                id: Date.now(),
                title: `${actionLog.userName} ${actionLog.action}`,
                message: actionLog.details,
                timestamp: actionLog.timestamp,
                read: false
            };
            
            // Adicionar ao início da lista
            notifications.unshift(notification);
            
            // Limitar a 50 notificações
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            // Salvar no localStorage
            localStorage.setItem('adminNotifications', JSON.stringify(notifications));
            
            // Verificar notificações a cada 5 segundos para administradores
            if (currentUser.accessLevel === 'ADMIN') {
                updateNotificationUI();
            }
        }
        
        // Função para atualizar UI de notificações
        function updateNotificationUI() {
            if (currentUser.accessLevel !== 'ADMIN') return;
            
            // Mostrar o sistema de notificações para administradores
            notificationSystem.style.display = 'block';
            
            // Contar notificações não lidas
            const unreadCount = notifications.filter(notif => !notif.read).length;
            const previousUnreadCount = parseInt(notificationCount.textContent) || 0;
            
            // Atualizar contador
            notificationCount.textContent = unreadCount;
            notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
            
            // Verificar se há novas notificações
            if (unreadCount > previousUnreadCount && previousUnreadCount !== 0) {
                // Tocar som de notificação
                playNotificationSound();
                
                // Mostrar notificação de desktop
                if (unreadCount > previousUnreadCount) {
                    const newNotifications = notifications.slice(0, unreadCount - previousUnreadCount);
                    if (newNotifications.length > 0) {
                        showDesktopNotification(newNotifications);
                    }
                }
            }
            
            // Adicionar animação ao sino se houver novas notificações
            if (unreadCount > 0 && !hasUnreadNotifications) {
                const bellIcon = notificationButton.querySelector('i');
                bellIcon.classList.add('bell-animation');
                setTimeout(() => {
                    bellIcon.classList.remove('bell-animation');
                }, 1000);
                hasUnreadNotifications = true;
            } else if (unreadCount === 0) {
                hasUnreadNotifications = false;
            }
            
            // Atualizar lista de notificações
            renderNotificationList();
        }
        
        // Função para tocar som de notificação
        function playNotificationSound() {
            // Criar elemento de áudio
            const audio = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAASAAAeMwAUFBQUFCIiIiIiIjAwMDAwMD09PT09PUlJSUlJSVVVVVVVVWZmZmZmZnJycnJycoGBgYGBgY+Pj4+Pj5+fn5+fn6enpqamprGxsbGxsb+/v7+/v8nJycnJydPT09PT0+Dg4ODg4Ojo6Ojo6PPz8/Pz8/n5+fn5+f////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAX/AAAAAAAAAB4zAABAAAAOADFBTYWQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAo=');
            audio.play().catch(e => console.log('Erro ao reproduzir som de notificação:', e));
        }
        
        // Função para renderizar lista de notificações
        function renderNotificationList() {
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--light-text);">
                        Nenhuma notificação
                    </div>
                `;
                return;
            }
            
            notificationList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" data-id="${notification.id}">
                    ${!notification.read ? '<div class="notification-indicator"></div>' : ''}
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${formatTimeAgo(notification.timestamp)}</div>
                </div>
            `).join('');
            
            // Adicionar evento de clique para marcar como lida
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', () => {
                    const notificationId = parseInt(item.dataset.id);
                    markNotificationAsRead(notificationId);
                });
            });
        }
        
        // Função para marcar notificação como lida
        function markNotificationAsRead(id) {
            const index = notifications.findIndex(notif => notif.id === id);
            if (index !== -1) {
                notifications[index].read = true;
                localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                updateNotificationUI();
            }
        }
        
        // Função para marcar todas as notificações como lidas
        function markAllNotificationsAsRead() {
            notifications.forEach(notif => {
                notif.read = true;
            });
            localStorage.setItem('adminNotifications', JSON.stringify(notifications));
            updateNotificationUI();
        }
        
        // Função para formatar tempo relativo
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'agora mesmo';
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} ${minutes === 1 ? 'minuto' : 'minutos'} atrás`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} ${hours === 1 ? 'hora' : 'horas'} atrás`;
            
            const days = Math.floor(hours / 24);
            if (days < 30) return `${days} ${days === 1 ? 'dia' : 'dias'} atrás`;
            
            const months = Math.floor(days / 30);
            if (months < 12) return `${months} ${months === 1 ? 'mês' : 'meses'} atrás`;
            
            const years = Math.floor(months / 12);
            return `${years} ${years === 1 ? 'ano' : 'anos'} atrás`;
        }
        
        // Configurar eventos do sistema de notificações
        if (notificationButton) {
            notificationButton.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.style.display = notificationDropdown.style.display === 'none' ? 'block' : 'none';
            });
            
            markAllReadButton.addEventListener('click', function(e) {
                e.stopPropagation();
                markAllNotificationsAsRead();
            });
            
            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function() {
                if (notificationDropdown.style.display === 'block') {
                    notificationDropdown.style.display = 'none';
                }
            });
            
            // Evitar que o clique no dropdown feche ele
            notificationDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Verificar notificações ao carregar a página
        if (currentUser.accessLevel === 'ADMIN') {
            // Solicitar permissão para notificações de desktop
            requestNotificationPermission();
            
            // Verificar a cada 5 segundos
            setInterval(function() {
                // Verificar se há novas notificações no localStorage (caso outro usuário tenha gerado)
                const storedNotifications = JSON.parse(localStorage.getItem('adminNotifications')) || [];
                if (JSON.stringify(notifications) !== JSON.stringify(storedNotifications)) {
                    notifications = storedNotifications;
                    updateNotificationUI();
                }
            }, 5000);
            
            // Verificar imediatamente ao carregar
            updateNotificationUI();
        }
        
        // Função para solicitar permissão para notificações de desktop
        function requestNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('Permissão para notificações de desktop concedida');
                            // Mostrar notificação de teste
                            new Notification('Notificações ativadas', {
                                body: 'Você receberá notificações das ações dos usuários no sistema.',
                                icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0OTYgNTEyIj48cGF0aCBmaWxsPSIjMmEzZDY2IiBkPSJNMTg1LjcgMjY4LjFoNzYuMnY3Ni4ySDI2MlYzNDRIMTg1LjdWMjY4LjF6TTU4Ny42IDMyLjhDNTgyLjEgOC4zIDU1NS44IDAgNTI3LjUgMHYtLjFINDhhQzI5LjYgMCAyMyA5LjYgMjMgMjIuMyM4MyAzNjRoMzB2LjJIMzQ5djg5LjRoNzYuN3Y3Ni4ySDI2MlYzNDRIMTg1LjdWMjY4LjFIMjYyVjE5MmgtNzYuN1YxMTYuMkgyNjJWMjkuNWgtNzYuN3YtLjJIMTU4Ljh2LjJoLTMwVi44aC03NnYuMmgtNzYuMnYuMUgyOUMyOS42IDUuOCAyNS4yIDExLjIgMjMgMjIuMyM4MyAzNjR2NzYuMmg5MVYzMjRoMzB2LjJoMzY5VjgzYTIyLjcgMjIuNyAwIDAgMCAtMi0yLjQgMjIuNiAyMi42IDAgMCAwIC0yLjQuOEw1NTEgMzIuNyA1ODcuNiAzMi44eiIvPjwvc3ZnPg=='
                            });
                        }
                    });
                }
            }
        }

        // Função para formatar data e hora para exibição
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
        }

        // Função para mostrar o histórico de ações
        function showActionHistory() {
            // Criar o modal de histórico
            const historyModal = document.createElement('div');
            historyModal.className = 'modal';
            historyModal.id = 'historyModal';
            historyModal.style.display = 'block';
            
            // Filtros de histórico
            const filters = `
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <div>
                        <label for="historyFilterUser" style="display: block; margin-bottom: 5px;">Filtrar por usuário:</label>
                        <select id="historyFilterUser">
                            <option value="">Todos os usuários</option>
                            ${getUserOptionsForHistory()}
                        </select>
                    </div>
                    <div>
                        <label for="historyFilterAction" style="display: block; margin-bottom: 5px;">Filtrar por ação:</label>
                        <select id="historyFilterAction">
                            <option value="">Todas as ações</option>
                            <option value="Criou tarefa">Criação de tarefas</option>
                            <option value="Editou tarefa">Edição de tarefas</option>
                            <option value="Excluiu tarefa">Exclusão de tarefas</option>
                            <option value="Concluiu tarefa">Conclusão de tarefas</option>
                            <option value="Entrou no sistema">Login</option>
                        </select>
                    </div>
                    <div>
                        <label for="historyFilterDate" style="display: block; margin-bottom: 5px;">Filtrar por data:</label>
                        <input type="date" id="historyFilterDate">
                    </div>
                    <div style="align-self: flex-end;">
                        <button id="historyFilterButton" class="btn-primary" style="height: 32px;">Filtrar</button>
                        <button id="historyClearFilters" class="btn-secondary" style="height: 32px;">Limpar Filtros</button>
                    </div>
                </div>
            `;
            
            // Conteúdo do modal
            historyModal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; width: 90%;">
                    <span class="close" id="closeHistoryModal">&times;</span>
                    <h2>Histórico de Ações dos Usuários</h2>
                    
                    ${filters}
                    
                    <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
                        ${renderActionHistoryTable(actionHistory)}
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button id="exportHistoryButton" class="btn-secondary">
                            <i class="fas fa-file-export"></i> Exportar Histórico
                        </button>
                    </div>
                </div>
            `;
            
            // Adicionar o modal ao documento
            document.body.appendChild(historyModal);
            
            // Adicionar eventos aos filtros e botões
            document.getElementById('closeHistoryModal').addEventListener('click', () => {
                document.body.removeChild(historyModal);
            });
            
            document.getElementById('historyFilterButton').addEventListener('click', () => {
                filterActionHistory();
            });
            
            document.getElementById('historyClearFilters').addEventListener('click', () => {
                document.getElementById('historyFilterUser').value = '';
                document.getElementById('historyFilterAction').value = '';
                document.getElementById('historyFilterDate').value = '';
                filterActionHistory();
            });
            
            document.getElementById('exportHistoryButton').addEventListener('click', () => {
                exportActionHistory();
            });
            
            // Fechar modal ao clicar fora dele
            window.addEventListener('click', (e) => {
                if (e.target === historyModal) {
                    document.body.removeChild(historyModal);
                }
            });
        }
        
        // Função para obter as opções de usuários para o filtro
        function getUserOptionsForHistory() {
            const users = JSON.parse(localStorage.getItem('users')) || Auth.DEFAULT_USERS;
            // Filtrar para excluir usuários admin
            const nonAdminUsers = users.filter(user => user.accessLevel !== 'ADMIN');
            return nonAdminUsers.map(user => `<option value="${user.id}">${user.name}</option>`).join('');
        }
        
        // Função para renderizar a tabela de histórico de ações
        function renderActionHistoryTable(history) {
            if (history.length === 0) {
                return '<p>Nenhuma ação encontrada.</p>';
            }
            
            return `
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="background-color: var(--secondary-color);">
                            <th style="padding: 10px; border: 1px solid var(--border-color);">Data/Hora</th>
                            <th style="padding: 10px; border: 1px solid var(--border-color);">Usuário</th>
                            <th style="padding: 10px; border: 1px solid var(--border-color);">Ação</th>
                            <th style="padding: 10px; border: 1px solid var(--border-color);">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(item => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid var(--border-color);">${formatDateTime(item.timestamp)}</td>
                                <td style="padding: 8px; border: 1px solid var(--border-color);">${item.userName}</td>
                                <td style="padding: 8px; border: 1px solid var(--border-color);">${item.action}</td>
                                <td style="padding: 8px; border: 1px solid var(--border-color);">${item.details}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Função para filtrar o histórico de ações
        function filterActionHistory() {
            const userFilter = document.getElementById('historyFilterUser').value;
            const actionFilter = document.getElementById('historyFilterAction').value;
            const dateFilter = document.getElementById('historyFilterDate').value;
            
            let filteredHistory = [...actionHistory];
            
            // Aplicar filtro de usuário
            if (userFilter) {
                filteredHistory = filteredHistory.filter(item => item.userId == userFilter);
            }
            
            // Aplicar filtro de ação
            if (actionFilter) {
                filteredHistory = filteredHistory.filter(item => item.action.includes(actionFilter));
            }
            
            // Aplicar filtro de data
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                filteredHistory = filteredHistory.filter(item => {
                    const itemDate = new Date(item.timestamp);
                    return itemDate.toDateString() === filterDate.toDateString();
                });
            }
            
            // Atualizar a tabela
            document.getElementById('historyContent').innerHTML = renderActionHistoryTable(filteredHistory);
        }
        
        // Função para exportar o histórico de ações
        function exportActionHistory() {
            // Obter histórico filtrado
            const userFilter = document.getElementById('historyFilterUser').value;
            const actionFilter = document.getElementById('historyFilterAction').value;
            const dateFilter = document.getElementById('historyFilterDate').value;
            
            let historyToExport = [...actionHistory];
            
            // Aplicar filtros se existirem
            if (userFilter || actionFilter || dateFilter) {
                if (userFilter) {
                    historyToExport = historyToExport.filter(item => item.userId == userFilter);
                }
                
                if (actionFilter) {
                    historyToExport = historyToExport.filter(item => item.action.includes(actionFilter));
                }
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    historyToExport = historyToExport.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return itemDate.toDateString() === filterDate.toDateString();
                    });
                }
            }
            
            // Converter para CSV
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Cabeçalho
            csvContent += "Data/Hora,Usuário,Ação,Detalhes\n";
            
            // Dados
            historyToExport.forEach(item => {
                const row = [
                    formatDateTime(item.timestamp),
                    item.userName,
                    item.action,
                    item.details.replace(/,/g, ";") // Substituir vírgulas por ponto e vírgula para não quebrar o CSV
                ];
                csvContent += row.join(",") + "\n";
            });
            
            // Criar um link para download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `historico_acoes_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            
            // Limpar
            document.body.removeChild(link);
        }

        // Configuração dos event listeners
        function setupEventListeners() {
            prevPeriodButton.addEventListener('click', () => {
                if (currentView === 'daily') {
                    currentDate.setDate(currentDate.getDate() - 1);
                } else if (currentView === 'weekly') {
                    currentDate.setDate(currentDate.getDate() - 7);
                } else if (currentView === 'monthly') {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                }
                renderCalendar();
            });

            nextPeriodButton.addEventListener('click', () => {
                if (currentView === 'daily') {
                    currentDate.setDate(currentDate.getDate() + 1);
                } else if (currentView === 'weekly') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (currentView === 'monthly') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                renderCalendar();
            });

            dailyViewButton.addEventListener('click', () => {
                currentView = 'daily';
                updateViewButtons();
                renderCalendar();
            });

            weeklyViewButton.addEventListener('click', () => {
                currentView = 'weekly';
                updateViewButtons();
                renderCalendar();
            });

            monthlyViewButton.addEventListener('click', () => {
                currentView = 'monthly';
                updateViewButtons();
                renderCalendar();
            });
            
            completedViewButton.addEventListener('click', () => {
                currentView = 'completed';
                updateViewButtons();
                renderCompletedView();
            });
            
            pendingTasksTab.addEventListener('click', () => {
                showCompletedTasks = false;
                pendingTasksTab.classList.add('active');
                completedTasksTab.classList.remove('active');
                dailyTasks.style.display = 'block';
                completedTasks.style.display = 'none';
                renderDailyTasks();
            });
            
            completedTasksTab.addEventListener('click', () => {
                showCompletedTasks = true;
                pendingTasksTab.classList.remove('active');
                completedTasksTab.classList.add('active');
                dailyTasks.style.display = 'none';
                completedTasks.style.display = 'block';
                renderCompletedTasks();
            });

            taskForm.addEventListener('submit', handleTaskSubmit);
            closeModal.addEventListener('click', () => taskModal.style.display = 'none');
            
            // Event listener para marcar tarefa como concluída
            completeTaskButton.addEventListener('click', completeTask);
            
            // Fechar tooltip quando clicar fora dele
            document.addEventListener('click', hideDayTooltip);
            
            // Evitar que cliques dentro do tooltip o fechem
            dayTooltip.addEventListener('click', (e) => e.stopPropagation());
            
            window.addEventListener('click', (e) => {
                if (e.target === taskModal) taskModal.style.display = 'none';
            });

            manualRefreshButton.addEventListener('click', () => {
                console.log("Atualizando página manualmente...");
                
                // Adicionar animação ao ícone de atualização
                const refreshIcon = manualRefreshButton.querySelector('i');
                refreshIcon.classList.add('refresh-animation');
                
                // Verificar se há novas tarefas no localStorage
                const storedTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                if (JSON.stringify(tasks) !== JSON.stringify(storedTasks)) {
                    tasks = storedTasks;
                }
                
                // Verificar se há novas entradas no histórico de ações
                const storedHistory = JSON.parse(localStorage.getItem('actionHistory')) || [];
                if (JSON.stringify(actionHistory) !== JSON.stringify(storedHistory)) {
                    actionHistory = storedHistory;
                }
                
                // Atualizar visualizações
                if (currentView === 'completed') {
                    renderCompletedView();
                } else {
                renderCalendar();
                }
                
                // Atualizar as listas de tarefas do dia
                if (showCompletedTasks) {
                    renderCompletedTasks();
                } else {
                renderDailyTasks();
                }
                
                // Verificar tarefas próximas
                checkUpcomingTasks();
                
                // Atualizar o indicador com a hora atual
                updateRefreshTime();
                
                // Remover a animação após 1 segundo
                setTimeout(() => {
                    refreshIcon.classList.remove('refresh-animation');
                }, 1000);
            });

            // Carregar lista de usuários no select de atribuição
            loadUsersForAssignment();
            
            // Adicionar evento para recarregar usuários quando o formulário for resetado
            taskForm.addEventListener('reset', () => {
                setTimeout(loadUsersForAssignment, 0);
                
                // Selecionar a cor padrão (Solides) quando o formulário for resetado
                document.getElementById('colorSolides').checked = true;
                document.getElementById('taskColor').value = '#1a2540';
                
                // Ocultar o seletor de cores personalizado
                document.getElementById('customColorContainer').style.display = 'none';
                
                weekdaysContainer.style.display = 'none';
                repeatEndContainer.style.display = 'none';
            });
            
            // Adicionar evento para o botão de limpar tarefas
            document.getElementById('clearTasksButton').addEventListener('click', clearAllTasks);
            
            // Adicionar botão de histórico para administradores
            if (currentUser.accessLevel === 'ADMIN') {
                const historyButton = document.createElement('button');
                historyButton.id = 'viewHistoryButton';
                historyButton.className = 'view-history-button';
                historyButton.innerHTML = '<i class="fas fa-history"></i> Ver Histórico';
                historyButton.style.marginLeft = '10px';
                historyButton.style.padding = '5px 10px';
                historyButton.style.fontSize = '12px';
                historyButton.style.background = 'var(--primary-color)';
                historyButton.style.color = 'white';
                historyButton.style.border = 'none';
                historyButton.style.borderRadius = '3px';
                historyButton.style.cursor = 'pointer';
                
                historyButton.addEventListener('click', showActionHistory);
                
                // Adicionar botão ao lado do botão de visualização
                document.querySelector('.view-selector').appendChild(historyButton);
            }
            
            // Registrar login no histórico quando a página é carregada
            logUserAction('Entrou no sistema', 'Login realizado com sucesso');
            
            // Controle de exibição do formulário de nova tarefa
            const formToggler = document.getElementById('formToggler');
            const taskFormContainer = document.getElementById('taskFormContainer');
            const chevronIcon = formToggler.querySelector('.fa-chevron-down');
            
            // Função para exibir o formulário de nova tarefa
            function showTaskForm() {
                taskFormContainer.style.display = 'block';
                chevronIcon.style.transform = 'rotate(180deg)';
                // Rolar a página para o formulário em dispositivos móveis
                if (window.innerWidth <= 768) {
                    taskFormContainer.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            formToggler.addEventListener('click', () => {
                if (taskFormContainer.style.display === 'none') {
                    showTaskForm();
                } else {
                    hideTaskForm();
                }
            });
            
            // Gerenciar seleção das cores predefinidas
            const colorOptions = document.querySelectorAll('input[name="taskColorOption"]');
            const taskColorInput = document.getElementById('taskColor');
            const customColorPicker = document.getElementById('customColorPicker');
            const showCustomColorBtn = document.getElementById('showCustomColor');
            const customColorContainer = document.getElementById('customColorContainer');
            const applyCustomColorBtn = document.getElementById('applyCustomColor');
            
            // Log para depuração
            console.log("Elementos de cores:", {
                colorOptions: colorOptions.length > 0 ? 'Encontrado' : 'Não encontrado',
                taskColorInput: taskColorInput ? 'Encontrado' : 'Não encontrado',
                customColorPicker: customColorPicker ? 'Encontrado' : 'Não encontrado',
                showCustomColorBtn: showCustomColorBtn ? 'Encontrado' : 'Não encontrado',
                customColorContainer: customColorContainer ? 'Encontrado' : 'Não encontrado',
                applyCustomColorBtn: applyCustomColorBtn ? 'Encontrado' : 'Não encontrado'
            });
            
            // Função para atualizar o valor da cor
            function updateColorValue(value) {
                taskColorInput.value = value;
            }
            
            // Event listener para as opções de cores predefinidas
            colorOptions.forEach(option => {
                option.addEventListener('change', function() {
                    if (this.checked) {
                        // Usar a cor predefinida
                        updateColorValue(this.value);
                    }
                });
            });
            
            // Event listener para mostrar/ocultar o seletor de cores personalizado
            if (showCustomColorBtn) {
                showCustomColorBtn.onclick = function() {
                    const currentDisplay = customColorContainer.style.display;
                    console.log("Botão de cor personalizada clicado. Estado atual:", currentDisplay);
                    
                    if (currentDisplay === 'none' || currentDisplay === '') {
                        customColorContainer.style.display = 'block';
                        this.innerHTML = '<i class="fas fa-minus"></i> Ocultar cor personalizada';
                    } else {
                        customColorContainer.style.display = 'none';
                        this.innerHTML = '<i class="fas fa-plus"></i> Cor personalizada';
                    }
                };
            }
            
            // Event listener para aplicar a cor personalizada
            if (applyCustomColorBtn) {
                applyCustomColorBtn.onclick = function() {
                    // Desmarcar qualquer cor predefinida selecionada
                    colorOptions.forEach(option => {
                        option.checked = false;
                    });
                    
                    // Atualizar o valor da cor com a cor personalizada
                    updateColorValue(customColorPicker.value);
                    
                    // Criar um efeito visual de confirmação
                    this.textContent = 'Aplicada!';
                    setTimeout(() => {
                        this.textContent = 'Aplicar';
                    }, 1000);
                };
            }
            
            // Event listener para o seletor de cores personalizado
            if (customColorPicker) {
                customColorPicker.oninput = function() {
                    // Apenas mostrar a cor, o usuário precisa clicar em 'Aplicar' para confirmar
                    console.log("Cor personalizada alterada:", this.value);
                };
            }
            
            // Botão para completar a tarefa do modal
            completeTaskButton.addEventListener('click', () => {
                const taskId = taskModal.dataset.taskId;
                if (taskId) {
                    completeTaskById(taskId);
                    taskModal.style.display = 'none';
                }
            });
            
            // Botão para editar a tarefa
            editTaskButton.addEventListener('click', () => {
                const taskId = taskModal.dataset.taskId;
                if (taskId) {
                    editTask(taskId);
                    taskModal.style.display = 'none';
                }
            });
            
            // Botão para excluir a tarefa
            deleteTaskButton.addEventListener('click', () => {
                const taskId = taskModal.dataset.taskId;
                if (taskId) {
                    if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                        deleteTask(taskId);
                        taskModal.style.display = 'none';
                    }
                }
            });
            
            // Botão de atualização manual
            manualRefreshButton.addEventListener('click', () => {
                console.log("Atualizando página manualmente...");
                
                // Adicionar animação ao ícone de atualização
                const refreshIcon = manualRefreshButton.querySelector('i');
                refreshIcon.classList.add('refresh-animation');
                
                // Verificar se há novas tarefas no localStorage
                const storedTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                if (JSON.stringify(tasks) !== JSON.stringify(storedTasks)) {
                    tasks = storedTasks;
                }
                
                // Verificar se há novas entradas no histórico de ações
                const storedActionHistory = JSON.parse(localStorage.getItem('actionHistory')) || [];
                if (JSON.stringify(actionHistory) !== JSON.stringify(storedActionHistory)) {
                    actionHistory = storedActionHistory;
                }
                
                // Atualizar a visualização com base na view atual
                if (currentView === 'completed') {
                    renderCompletedView();
                } else {
                    renderCalendar();
                }
                
                // Atualizar tarefas do dia na barra lateral
                renderDailyTasks();
                
                // Se a aba de tarefas concluídas estiver ativa, atualizar
                if (completedTasksTab.classList.contains('active')) {
                    renderCompletedTasks();
                }
                
                // Atualizar a hora da última atualização
                updateLastRefreshTime();
                
                // Remover a animação após 1 segundo
                setTimeout(() => {
                    refreshIcon.classList.remove('refresh-animation');
                }, 1000);
            });
            
            // Botão para limpar todas as tarefas (apenas para administradores)
            const clearTasksButton = document.getElementById('clearTasksButton');
            if (clearTasksButton) {
                clearTasksButton.addEventListener('click', () => {
                    if (confirm('Tem certeza que deseja limpar TODAS as tarefas? Esta ação não pode ser desfeita.')) {
                        tasks = [];
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                        renderCalendar();
                        renderDailyTasks();
                        renderCompletedTasks();
                        alert('Todas as tarefas foram removidas.');
                    }
                });
            }
            
            // Sistema de notificações para administradores
            if (notificationButton && notificationDropdown) {
                notificationButton.addEventListener('click', () => {
                    notificationDropdown.style.display = notificationDropdown.style.display === 'none' ? 'block' : 'none';
                });
                
                // Fechar dropdown ao clicar fora
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#notificationSystem')) {
                        notificationDropdown.style.display = 'none';
                    }
                });
                
                // Marcar todas como lidas
                markAllReadButton.addEventListener('click', () => {
                    notifications.forEach(notif => {
                        notif.read = true;
                    });
                    
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                    updateNotificationUI();
                });
            }
        }

        function updateViewButtons() {
            dailyViewButton.classList.remove('active');
            weeklyViewButton.classList.remove('active');
            monthlyViewButton.classList.remove('active');
            completedViewButton.classList.remove('active');
            
            if (currentView === 'daily') {
                dailyViewButton.classList.add('active');
            } else if (currentView === 'weekly') {
                weeklyViewButton.classList.add('active');
            } else if (currentView === 'monthly') {
                monthlyViewButton.classList.add('active');
            } else if (currentView === 'completed') {
                completedViewButton.classList.add('active');
            }
        }

        // Renderização do calendário
        function renderCalendar() {
            // Filtrar tarefas visíveis para o usuário atual
            const visibleTasks = tasks.filter(task => {
                // Administradores veem todas as tarefas
                if (currentUser.accessLevel === 'ADMIN') return true;
                
                // Outros usuários veem apenas as tarefas atribuídas a eles
                return task.assignedTo.includes(currentUser.id);
            });

            // Ordenar as tarefas por data e hora antes de renderizar
            visibleTasks.sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.startTime}`);
                const dateB = new Date(`${b.date}T${b.startTime}`);
                return dateA - dateB;
            });

            if (currentView === 'daily') {
                renderDailyView(visibleTasks);
            } else if (currentView === 'weekly') {
                renderWeeklyView(visibleTasks);
            } else if (currentView === 'monthly') {
                renderMonthlyView(visibleTasks);
            } else {
                renderCompletedView(visibleTasks);
            }
        }

        function renderDailyView(tasksToRender) {
            const date = currentDate;
            currentPeriodElement.textContent = date.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }).toUpperCase();

            // Obter todas as tarefas para o dia, incluindo as concluídas
            const allTasksForDay = tasksToRender.filter(task => {
                const taskDate = new Date(task.date + 'T12:00:00');
                const compareDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
                return taskDate.toDateString() === compareDate.toDateString();
            }).sort((a, b) => a.startTime.localeCompare(b.startTime));

            // Formatar a data para o atributo data-date
            const dateISO = date.toISOString().split('T')[0];

            let content = `
                <div class="daily-view">
                    <div class="daily-view-header">
                        ${date.toLocaleDateString('pt-BR', { weekday: 'long' }).toUpperCase()}
                    </div>
                    <div class="daily-view-content" data-date="${dateISO}">
                        <div class="time-slots">
                            ${Array.from({length: 24}, (_, i) => {
                                const hour = i.toString().padStart(2, '0') + ':00';
                                const hourTasks = allTasksForDay.filter(task => {
                                    const taskStartHour = task.startTime.split(':')[0];
                                    const taskEndHour = task.endTime.split(':')[0];
                                    return parseInt(taskStartHour) <= i && parseInt(taskEndHour) >= i;
                                }).sort((a, b) => a.startTime.localeCompare(b.startTime));
                                
                                return `
                                    <div class="time-slot">${hour}</div>
                                    <div class="time-slot-content ${hourTasks.length > 0 ? 'has-task' : ''}" data-hour="${i}">
                                        ${hourTasks.map(task => {
                                            // Verificar se o usuário atual marcou a tarefa como concluída
                                            const userCompleted = task.completedBy && task.completedBy.includes(currentUser.id);
                                            // Para administradores, a tarefa só aparece como concluída se estiver totalmente concluída
                                            // Para usuários normais, a tarefa aparece como concluída se o usuário a marcou como concluída
                                            const showAsCompleted = currentUser.accessLevel === 'ADMIN' ? task.completed : userCompleted;
                                            return `
                                                <div class="calendar-task priority-${task.priority} ${showAsCompleted ? 'completed' : ''}" 
                                                     style="background-color: ${showAsCompleted ? '#27ae60' : task.color || '#2a3d66'}"
                                                     title="${task.title} - ${task.startTime} até ${task.endTime}${showAsCompleted ? ' (Concluída)' : ''}">
                                                ${task.title}
                                                <span style="font-size: 10px; display: block;">${task.startTime} - ${task.endTime}</span>
                                            </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            calendarGrid.innerHTML = content;
            
            // Adicionar evento de clique na área do dia
            document.querySelector('.daily-view-content').addEventListener('click', showDayTooltip);
            
            // Atualize as abas e as tarefas do dia
            selectedDate = new Date(date);
            renderDailyTasks();
            renderCompletedTasks();
        }

        function renderWeeklyView(tasksToRender) {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            currentPeriodElement.textContent = `${startOfWeek.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })} - ${endOfWeek.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' })}`;

            let content = `
                <div class="calendar-week">
                    ${Array.from({length: 7}, (_, i) => {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + i);
                        
                        // Obter todas as tarefas para o dia, incluindo as concluídas
                        const allDayTasks = tasksToRender.filter(task => {
                            const taskDate = new Date(task.date + 'T12:00:00');
                            const compareDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
                            return taskDate.toDateString() === compareDate.toDateString();
                        }).sort((a, b) => a.startTime.localeCompare(b.startTime));

                        // Comparar com a data atual para destacar o dia de hoje
                        const today = new Date();
                        const isToday = date.getDate() === today.getDate() && 
                                       date.getMonth() === today.getMonth() && 
                                       date.getFullYear() === today.getFullYear();

                        // Formatar a data para o atributo data-date no formato ISO para facilitar a recuperação
                        const dateISO = date.toISOString().split('T')[0];

                        return `
                            <div>
                                <div class="calendar-day-header">
                                    ${date.toLocaleDateString('pt-BR', { weekday: 'short' }).toUpperCase()}
                                    <br>
                                    ${date.getDate()}
                                </div>
                                <div class="calendar-day-content ${isToday ? 'today' : ''}" data-date="${dateISO}">
                                    ${allDayTasks.map(task => {
                                        // Verificar se o usuário atual marcou a tarefa como concluída
                                        const userCompleted = task.completedBy && task.completedBy.includes(currentUser.id);
                                        // Para administradores, a tarefa só aparece como concluída se estiver totalmente concluída
                                        // Para usuários normais, a tarefa aparece como concluída se o usuário a marcou como concluída
                                        const showAsCompleted = currentUser.accessLevel === 'ADMIN' ? task.completed : userCompleted;
                                        return `
                                            <div class="calendar-task priority-${task.priority} ${showAsCompleted ? 'completed' : ''}" 
                                                 style="background-color: ${showAsCompleted ? '#27ae60' : task.color || '#2a3d66'}"
                                                 title="${task.title} - ${task.startTime} até ${task.endTime}${showAsCompleted ? ' (Concluída)' : ''}">
                                            ${task.title}
                                            <span style="font-size: 10px; display: block;">${task.startTime} - ${task.endTime}</span>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            calendarGrid.innerHTML = content;
            
            // Adicionar eventos de clique nos dias
            document.querySelectorAll('.calendar-day-content').forEach(day => {
                day.addEventListener('click', showDayTooltip);
            });
            
            // Atualizar as tarefas do dia selecionado
            selectedDate = new Date(currentDate);
            renderDailyTasks();
            renderCompletedTasks();
        }

        function renderMonthlyView(tasksToRender) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            currentPeriodElement.textContent = new Date(year, month).toLocaleDateString('pt-BR', {
                month: 'long',
                year: 'numeric'
            }).toUpperCase();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();

            // Obter a data atual para destacar o dia de hoje
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            const currentDay = today.getDate();

            let content = `
                <div class="calendar-weekdays">
                    <div>Dom</div>
                    <div>Seg</div>
                    <div>Ter</div>
                    <div>Qua</div>
                    <div>Qui</div>
                    <div>Sex</div>
                    <div>Sáb</div>
                </div>
                <div class="calendar-days">
                    ${Array.from({length: startingDay}, (_, i) => {
                        const prevMonthLastDay = new Date(year, month, 0).getDate();
                        const date = new Date(year, month - 1, prevMonthLastDay - startingDay + i + 1);
                        
                        // Obter todas as tarefas para o dia, incluindo as concluídas
                        const allDayTasks = tasksToRender.filter(task => {
                            const taskDate = new Date(task.date + 'T12:00:00');
                            const compareDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
                            return taskDate.toDateString() === compareDate.toDateString();
                        }).sort((a, b) => a.startTime.localeCompare(b.startTime));

                        // Formatar a data para o atributo data-date
                        const dateISO = date.toISOString().split('T')[0];

                        return `
                            <div class="calendar-day other-month" data-date="${dateISO}">
                                <div class="calendar-day-number">${prevMonthLastDay - startingDay + i + 1}</div>
                                ${allDayTasks.map(task => {
                                    // Verificar se o usuário atual marcou a tarefa como concluída
                                    const userCompleted = task.completedBy && task.completedBy.includes(currentUser.id);
                                    // Para administradores, a tarefa só aparece como concluída se estiver totalmente concluída
                                    // Para usuários normais, a tarefa aparece como concluída se o usuário a marcou como concluída
                                    const showAsCompleted = currentUser.accessLevel === 'ADMIN' ? task.completed : userCompleted;
                                    return `
                                        <div class="calendar-task priority-${task.priority} ${showAsCompleted ? 'completed' : ''}" 
                                             style="background-color: ${showAsCompleted ? '#27ae60' : task.color || '#2a3d66'}"
                                             title="${task.title} - ${task.startTime} até ${task.endTime}${showAsCompleted ? ' (Concluída)' : ''}">
                                        ${task.title}
                                        <span style="font-size: 10px; display: block;">${task.startTime} - ${task.endTime}</span>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }).join('')}
                    ${Array.from({length: daysInMonth}, (_, i) => {
                        const date = new Date(year, month, i + 1);
                        
                        // Obter todas as tarefas para o dia, incluindo as concluídas
                        const allDayTasks = tasksToRender.filter(task => {
                            const taskDate = new Date(task.date + 'T12:00:00');
                            const compareDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
                            return taskDate.toDateString() === compareDate.toDateString();
                        }).sort((a, b) => a.startTime.localeCompare(b.startTime));

                        const isToday = isCurrentMonth && (i + 1) === currentDay;
                        
                        // Formatar a data para o atributo data-date
                        const dateISO = date.toISOString().split('T')[0];

                        return `
                            <div class="calendar-day ${isToday ? 'today' : ''}" data-date="${dateISO}">
                                <div class="calendar-day-number">${i + 1}</div>
                                ${allDayTasks.map(task => {
                                    // Verificar se o usuário atual marcou a tarefa como concluída
                                    const userCompleted = task.completedBy && task.completedBy.includes(currentUser.id);
                                    // Para administradores, a tarefa só aparece como concluída se estiver totalmente concluída
                                    // Para usuários normais, a tarefa aparece como concluída se o usuário a marcou como concluída
                                    const showAsCompleted = currentUser.accessLevel === 'ADMIN' ? task.completed : userCompleted;
                                    return `
                                        <div class="calendar-task priority-${task.priority} ${showAsCompleted ? 'completed' : ''}" 
                                             style="background-color: ${showAsCompleted ? '#27ae60' : task.color || '#2a3d66'}"
                                             title="${task.title} - ${task.startTime} até ${task.endTime}${showAsCompleted ? ' (Concluída)' : ''}">
                                        ${task.title}
                                        <span style="font-size: 10px; display: block;">${task.startTime} - ${task.endTime}</span>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            calendarGrid.innerHTML = content;
            
            // Adicionar eventos de clique nos dias
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('click', showDayTooltip);
            });
            
            // Atualizar a data selecionada e as tarefas
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            renderDailyTasks();
            renderCompletedTasks();
        }

        function renderCompletedView(tasksToRender) {
            currentPeriodElement.textContent = "TAREFAS CONCLUÍDAS";
            
            // Se não foi fornecida uma lista de tarefas, usar a lista global
            if (!tasksToRender) {
                tasksToRender = tasks;
            }
            
            // Filtrar apenas tarefas concluídas
            const completedTasksList = tasksToRender.filter(task => {
                // Verificar se a tarefa está marcada como concluída
                if (!task.completed) return false;
                
                // Verificar se o usuário tem permissão para ver esta tarefa
                if (currentUser.accessLevel === 'ADMIN') return true;
                
                // Usuários normais só podem ver tarefas que foram atribuídas a eles
                return task.assignedTo && task.assignedTo.includes(currentUser.id);
            });
            
            // Agrupar tarefas concluídas por data
            const tasksByDate = {};
            completedTasksList.forEach(task => {
                const dateKey = task.date;
                if (!tasksByDate[dateKey]) {
                    tasksByDate[dateKey] = [];
                }
                tasksByDate[dateKey].push(task);
            });
            
            // Ordenar as datas (mais recente primeiro)
            const sortedDates = Object.keys(tasksByDate).sort((a, b) => new Date(b) - new Date(a));
            
            let content = `
                <div class="completed-view">
                    <div class="completed-summary">
                        <p>Total de tarefas concluídas: <strong>${completedTasksList.length}</strong></p>
                    </div>
                    <div class="completed-tasks-container">
                        ${sortedDates.length > 0 ? sortedDates.map(date => {
                            const formattedDate = new Date(date + 'T12:00:00').toLocaleDateString('pt-BR', {
                                weekday: 'long',
                                day: 'numeric',
                                month: 'long',
                                year: 'numeric'
                            });
                            
                            return `
                                <div class="completed-date-group">
                                    <h3>${formattedDate}</h3>
                                    ${tasksByDate[date].map(task => `
                                        <div class="task-item completed" data-task-id="${task.id}">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <h4 style="color: ${task.color || '#2a3d66'}; text-decoration: line-through;">${task.title}</h4>
                                                <span style="color: var(--light-text);">${task.startTime} - ${task.endTime}</span>
                                            </div>
                                            <p style="color: var(--light-text); margin-top: 5px;">${task.category}</p>
                                            <div>
                                                ${task.completedDate ? 
                                                  `<span class="task-completion-status">
                                                      <i class="fas fa-check-circle"></i> Concluída em ${new Date(task.completedDate).toLocaleString('pt-BR')}
                                                  </span>` : 
                                                  `<span class="task-completion-status">
                                                      <i class="fas fa-check-circle"></i> Concluída
                                                  </span>`
                                                }
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }).join('') : '<p>Nenhuma tarefa concluída ainda.</p>'}
                    </div>
                </div>
            `;
            
            calendarGrid.innerHTML = content;
            
            // Adicionar eventos de clique para as tarefas concluídas
            document.querySelectorAll('.task-item.completed').forEach(item => {
                item.addEventListener('click', (e) => {
                    const taskId = parseInt(item.dataset.taskId);
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        showTaskDetails(task);
                    }
                });
            });
        }

        // Verifica se existem tarefas para uma data específica
        function hasTasksForDate(date) {
            return tasks.some(task => {
                const taskDate = new Date(task.date);
                return taskDate.toDateString() === date.toDateString();
            });
        }

        // Renderização das tarefas do dia
        function renderDailyTasks() {
            // Verificar permissão para visualizar todas operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            const tasksForDay = tasks.filter(task => {
                // Criar as datas com horário meio-dia para evitar problemas de fuso horário
                const taskDate = new Date(task.date + 'T12:00:00');
                const compareDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 12, 0, 0);
                
                // Verificar se o usuário tem permissão para ver a operação
                const operacaoMatch = podeVerTodasOperacoes || 
                                     !currentUser.operacao || 
                                     !task.operacao || 
                                     task.operacao === currentUser.operacao;
                
                // Filtrar por data, verificar se estamos mostrando ou não tarefas concluídas e se o usuário tem permissão
                return taskDate.toDateString() === compareDate.toDateString() && 
                       !task.completed && 
                       operacaoMatch &&
                       (currentUser.accessLevel === 'ADMIN' || task.assignedTo.includes(currentUser.id));
            }).sort((a, b) => a.startTime.localeCompare(b.startTime));

            dailyTasks.innerHTML = '';

            if (tasksForDay.length === 0) {
                dailyTasks.innerHTML = '<p>Nenhuma tarefa pendente para este dia.</p>';
                return;
            }

            const now = new Date();
            const thirtyMinutesFromNow = new Date(now.getTime() + 30 * 60000);
            const isAdmin = currentUser.accessLevel === 'ADMIN';

            tasksForDay.forEach(task => {
                const taskStartDateTime = new Date(`${task.date}T${task.startTime}`);
                const taskElement = document.createElement('div');
                taskElement.className = `task-item priority-${task.priority}`;
                taskElement.dataset.taskId = task.id;
                
                // Adicionar classes para tarefas próximas
                if (taskStartDateTime > now && taskStartDateTime <= thirtyMinutesFromNow) {
                    taskElement.classList.add('upcoming');
                }
                if (taskStartDateTime > now && taskStartDateTime <= new Date(now.getTime() + 15 * 60000)) {
                    taskElement.classList.add('urgent');
                }
                
                // Verificar se o usuário atual já concluiu esta tarefa
                const currentUserCompleted = task.completedBy && task.completedBy.includes(currentUser.id);
                
                // Calcular o progresso de conclusão
                const totalAssigned = task.assignedTo.length;
                const totalCompleted = task.completedBy ? task.completedBy.length : 0;
                const completionPercentage = totalAssigned > 0 ? Math.round((totalCompleted / totalAssigned) * 100) : 0;

                // Calcular minutos restantes
                const minutesLeft = Math.round((taskStartDateTime - now) / 60000);
                const timeLeftText = minutesLeft > 0 ? `(Faltam ${minutesLeft} minutos)` : '(Agora)';

                // Obter usuários atribuídos para administradores
                let assignmentInfo = '';
                if (isAdmin) {
                    const users = JSON.parse(localStorage.getItem('users')) || Auth.DEFAULT_USERS;
                    const assignedUsers = users.filter(user => task.assignedTo.includes(user.id));
                    assignmentInfo = `
                        <div style="margin-top: 5px; font-size: 12px; color: var(--light-text);">
                            <strong>Atribuído para:</strong> ${assignedUsers.map(user => user.name).join(', ')}
                        </div>
                    `;
                }

                taskElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="color: ${task.color || '#2a3d66'}">${task.title}</h4>
                        <span style="color: var(--light-text);">${task.startTime} - ${task.endTime} ${timeLeftText}</span>
                    </div>
                    <p style="color: var(--light-text); margin-top: 5px;">${task.category}</p>
                    ${isAdmin ? assignmentInfo : ''}
                    ${totalCompleted > 0 ? `
                    <div style="margin-top: 5px; margin-bottom: 5px;">
                        <div style="background: #f1f1f1; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background: var(--accent-color); height: 100%; width: ${completionPercentage}%;"></div>
                        </div>
                        <span style="font-size: 12px; color: var(--light-text);">
                            Progresso: ${isAdmin ? `${completionPercentage}% (${totalCompleted}/${totalAssigned})` : 
                                    currentUserCompleted ? 'Você já concluiu' : 'Pendente'}
                        </span>
                    </div>
                    ` : ''}
                    ${(taskStartDateTime > now && taskStartDateTime <= thirtyMinutesFromNow) ? 
                        '<i class="fas fa-bell notification-bell"></i>' : ''}
                    ${task.assignedTo.includes(currentUser.id) && !currentUserCompleted ?
                        `<button class="complete-task-btn btn-success" style="padding: 5px 10px; margin-top: 5px; font-size: 12px;">
                            <i class="fas fa-check"></i> Marcar como concluída
                        </button>` :
                        currentUserCompleted ? 
                        `<span style="display: block; margin-top: 5px; color: var(--accent-color); font-size: 12px;">
                            <i class="fas fa-check-circle"></i> Você já concluiu esta tarefa
                        </span>` : ''
                    }
                `;
                
                // Adicionar evento de clique para toda a tarefa (exceto no botão)
                taskElement.addEventListener('click', (e) => {
                    // Não disparar se o clique foi no botão de concluir
                    if (!e.target.closest('.complete-task-btn')) {
                        const task = tasks.find(t => t.id === parseInt(taskElement.dataset.taskId));
                        if (task) {
                            showTaskDetails(task);
                        }
                    }
                });
                
                // Adicionar evento específico para o botão de concluir
                const completeBtn = taskElement.querySelector('.complete-task-btn');
                if (completeBtn) {
                    completeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const task = tasks.find(t => t.id === parseInt(taskElement.dataset.taskId));
                        if (task) {
                            if (!task.completedBy) {
                                task.completedBy = [];
                            }
                            
                            // Verificar se o usuário já concluiu
                            if (task.completedBy.includes(currentUser.id)) {
                                alert('Você já marcou esta tarefa como concluída!');
                                return;
                            }
                            
                            // Adicionar o usuário à lista de conclusão
                            task.completedBy.push(currentUser.id);
                            
                            // Verificar se todos os usuários atribuídos já concluíram
                            const allCompleted = task.assignedTo.every(userId => 
                                task.completedBy.includes(userId)
                            );
                            
                            // Marcar como totalmente concluída se todos os usuários concluíram
                            if (allCompleted) {
                                task.completed = true;
                                task.completedDate = new Date().toISOString();
                            }
                            
                            saveTasks();
                            renderDailyTasks();
                            renderCompletedTasks();
                            hideDayTooltip();
                            
                            if (allCompleted) {
                                alert('Tarefa totalmente concluída por todos os usuários atribuídos!');
                            } else {
                                alert('Tarefa marcada como concluída por você!');
                            }
                        }
                    });
                }
                
                dailyTasks.appendChild(taskElement);
            });
        }
        
        // Renderizar tarefas concluídas para o dia selecionado na barra lateral
        function renderCompletedTasks() {
            completedTasks.innerHTML = '';
            
            // Verificar permissão para visualizar todas operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Filtrar tarefas concluídas para o dia selecionado
            const completedTasksForDay = tasks.filter(task => {
                // Criar as datas com horário meio-dia para evitar problemas de fuso horário
                const taskDate = new Date(task.date + 'T12:00:00');
                const compareDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 12, 0, 0);
                
                if (taskDate.toDateString() !== compareDate.toDateString() || !task.completed) {
                    return false;
                }
                
                // Verificar se o usuário tem permissão para ver a operação
                const operacaoMatch = podeVerTodasOperacoes || 
                                     !currentUser.operacao || 
                                     !task.operacao || 
                                     task.operacao === currentUser.operacao;
                
                // Verificar se o usuário tem permissão para ver esta tarefa
                if (currentUser.accessLevel === 'ADMIN') {
                    return operacaoMatch;
                } else {
                    return task.assignedTo.includes(currentUser.id) && operacaoMatch;
                }
            }).sort((a, b) => {
                const timeA = new Date('1970-01-01T' + a.startTime + ':00');
                const timeB = new Date('1970-01-01T' + b.startTime + ':00');
                return timeA - timeB;
            });
            
            if (completedTasksForDay.length === 0) {
                completedTasks.innerHTML = '<p style="padding: 15px; color: var(--light-text); text-align: center;">Não há tarefas concluídas para hoje.</p>';
                return;
            }
            
            // Renderizar cada tarefa concluída
            completedTasksForDay.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item completed`;
                taskElement.dataset.id = task.id;
                
                // Formatação de horários para display
                const startTimeFormatted = formatTime(task.startTime);
                const endTimeFormatted = formatTime(task.endTime);
                
                // Obter data e hora da conclusão, se disponível
                let completionInfo = '';
                if (task.completedAt) {
                    const completedDate = new Date(task.completedAt);
                    const completedTimeFormatted = completedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    completionInfo = `<small style="color: var(--accent-color);">Concluída às ${completedTimeFormatted}</small>`;
                }
                
                taskElement.innerHTML = `
                    <h4 style="text-decoration: line-through; color: ${task.color}">${task.title}</h4>
                    <p>${startTimeFormatted} - ${endTimeFormatted}</p>
                    <p>${task.category}</p>
                    ${completionInfo}
                `;
                
                completedTasks.appendChild(taskElement);
                
                // Adicionar evento para mostrar detalhes da tarefa
                taskElement.addEventListener('click', () => {
                    showTaskDetails(task);
                });
            });
        }
        
        // Configuração dos event listeners
        function setupEventListeners() {
            prevPeriodButton.addEventListener('click', () => {
                if (currentView === 'daily') {
                    currentDate.setDate(currentDate.getDate() - 1);
                } else if (currentView === 'weekly') {
                    currentDate.setDate(currentDate.getDate() - 7);
                } else if (currentView === 'monthly') {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                }
                renderCalendar();
            });

            nextPeriodButton.addEventListener('click', () => {
                if (currentView === 'daily') {
                    currentDate.setDate(currentDate.getDate() + 1);
                } else if (currentView === 'weekly') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (currentView === 'monthly') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                renderCalendar();
            });

            dailyViewButton.addEventListener('click', () => {
                currentView = 'daily';
                updateViewButtons();
                renderCalendar();
            });

            weeklyViewButton.addEventListener('click', () => {
                currentView = 'weekly';
                updateViewButtons();
                renderCalendar();
            });

            monthlyViewButton.addEventListener('click', () => {
                currentView = 'monthly';
                updateViewButtons();
                renderCalendar();
            });

            completedViewButton.addEventListener('click', () => {
                currentView = 'completed';
                updateViewButtons();
                renderCompletedView();
            });
            
            // Abas de tarefas pendentes e concluídas na barra lateral
            pendingTasksTab.addEventListener('click', () => {
                pendingTasksTab.classList.add('active');
                completedTasksTab.classList.remove('active');
                dailyTasks.style.display = 'block';
                completedTasks.style.display = 'none';
            });
            
            completedTasksTab.addEventListener('click', () => {
                completedTasksTab.classList.add('active');
                pendingTasksTab.classList.remove('active');
                dailyTasks.style.display = 'none';
                completedTasks.style.display = 'block';
                renderCompletedTasks(); // Atualizar a lista quando a aba for selecionada
            });

            // Controle de exibição do formulário de nova tarefa
            const formToggler = document.getElementById('formToggler');
            const taskFormContainer = document.getElementById('taskFormContainer');
            const chevronIcon = formToggler.querySelector('.fa-chevron-down');
            
            // Função para exibir o formulário de nova tarefa
            function showTaskForm() {
                taskFormContainer.style.display = 'block';
                chevronIcon.style.transform = 'rotate(180deg)';
                // Rolar a página para o formulário em dispositivos móveis
                if (window.innerWidth <= 768) {
                    taskFormContainer.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            // Função para ocultar o formulário de nova tarefa
            function hideTaskForm() {
                taskFormContainer.style.display = 'none';
                chevronIcon.style.transform = 'rotate(0deg)';
            }
            
            // Alternar exibição do formulário ao clicar no título
            formToggler.addEventListener('click', () => {
                if (taskFormContainer.style.display === 'none') {
                    showTaskForm();
                } else {
                    hideTaskForm();
                }
            });
            
            // Fechar o modal quando clicar no X
            closeModal.addEventListener('click', () => {
                taskModal.style.display = 'none';
            });
            
            // Fechar o modal quando clicar fora dele
            window.addEventListener('click', (event) => {
                if (event.target === taskModal) {
                    taskModal.style.display = 'none';
                }
            });
            
            // Quando a janela for redimensionada, reposicionar o tooltip se estiver ativo
            window.addEventListener('resize', () => {
                if (activeTooltip) {
                    positionTooltip(activeTooltip);
                }
            });
            
            // Ocultar o tooltip ao clicar em qualquer lugar da página
            document.addEventListener('click', (e) => {
                // Não fechar se o clique foi dentro do tooltip ou em um dia do calendário
                if (!e.target.closest('.day-tooltip') && !e.target.closest('.calendar-day')) {
                    hideDayTooltip();
                }
            });
            
            // Formulário de adição de tarefas
            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const taskTitle = document.getElementById('taskTitle').value;
                const taskDescription = document.getElementById('taskDescription').value;
                const taskDate = document.getElementById('taskDate').value;
                const taskStartTime = document.getElementById('taskStartTime').value;
                const taskEndTime = document.getElementById('taskEndTime').value;
                const taskPriority = document.getElementById('taskPriority').value;
                const taskCategory = document.getElementById('taskCategory').value;
                const taskColor = document.getElementById('taskColor').value;
                const taskRepeat = document.getElementById('taskRepeat').value;
                const taskOperacao = document.getElementById('taskOperacao').value;
                
                // Obter usuários selecionados
                const taskAssignedTo = Array.from(document.getElementById('taskAssignedTo').selectedOptions).map(option => parseInt(option.value));
                
                // Validar o formulário
                if (!taskTitle || !taskDate || !taskStartTime || !taskEndTime || taskAssignedTo.length === 0) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }
                
                // Validar que a hora de término é depois da hora de início
                const startTime = new Date(`2000-01-01T${taskStartTime}`);
                const endTime = new Date(`2000-01-01T${taskEndTime}`);
                
                if (endTime <= startTime) {
                    alert('A hora de término deve ser posterior à hora de início.');
                    return;
                }
                
                // Criar objeto de tarefa base
                const baseTask = {
                    id: Date.now(),
                    title: taskTitle,
                    description: taskDescription,
                    date: taskDate,
                    startTime: taskStartTime,
                    endTime: taskEndTime,
                    priority: taskPriority,
                    category: taskCategory,
                    color: taskColor,
                    operacao: taskOperacao, // Adicionando a operação à tarefa
                    completed: false,
                    assignedTo: taskAssignedTo,
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                // Processar configurações de repetição
                if (taskRepeat !== 'none') {
                    baseTask.recurring = {
                        type: taskRepeat,
                        endType: document.getElementById('repeatEndType').value,
                    };
                    
                    // Capturar detalhes específicos da repetição
                    if (taskRepeat === 'weekly' || taskRepeat === 'custom') {
                        const weekdays = [];
                        for (let i = 0; i < 7; i++) {
                            if (document.getElementById(`weekday-${i}`).checked) {
                                weekdays.push(i);
                            }
                        }
                        baseTask.recurring.weekdays = weekdays;
                    }
                    
                    // Capturar configurações de término
                    if (baseTask.recurring.endType === 'on') {
                        baseTask.recurring.endDate = document.getElementById('repeatEndDate').value;
                    } else if (baseTask.recurring.endType === 'after') {
                        baseTask.recurring.occurrences = parseInt(document.getElementById('repeatOccurrences').value) || 10;
                    }
                }
                
                // Gerar tarefas recorrentes se necessário
                const tasksToAdd = generateRecurringTasks(baseTask);
                
                // Adicionar tarefas ao array global
                tasks.push(...tasksToAdd);
                saveTasks();
                
                // Registrar ação
                logUserAction('criou tarefa' + (tasksToAdd.length > 1 ? ' recorrente' : ''), 
                    `"${taskTitle}" ${tasksToAdd.length > 1 ? `(${tasksToAdd.length} ocorrências)` : ''}`);
                
                // Limpar o formulário
                taskForm.reset();
                document.getElementById('colorSolides').checked = true;
                document.getElementById('taskColor').value = '#1a2540';
                
                // Ocultar o seletor de cores personalizado
                document.getElementById('customColorContainer').style.display = 'none';
                
                weekdaysContainer.style.display = 'none';
                repeatEndContainer.style.display = 'none';
                
                // Atualizar a visualização
                renderCalendar();
                
                // Se a data da nova tarefa for igual à data selecionada, atualizar as tarefas do dia
                const newTaskDate = new Date(taskDate + 'T12:00:00');
                const selectedDateObj = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 12, 0, 0);
                
                if (newTaskDate.toDateString() === selectedDateObj.toDateString()) {
                    renderDailyTasks();
                }
                
                alert(`Tarefa adicionada com sucesso${tasksToAdd.length > 1 ? ` com ${tasksToAdd.length} ocorrências` : ''}!`);
            });
            
            // Preview da cor da tarefa
            const taskColor = document.getElementById('taskColor');
            const colorPreview = document.getElementById('colorPreview');
            
            taskColor.addEventListener('input', () => {
                colorPreview.textContent = taskColor.value;
                colorPreview.style.color = taskColor.value;
            });
            
            // Botão para completar a tarefa do modal
            completeTaskButton.addEventListener('click', () => {
                const taskId = taskModal.dataset.taskId;
                if (taskId) {
                    completeTaskById(taskId);
                    taskModal.style.display = 'none';
                }
            });
            
            // Botão para editar a tarefa
            editTaskButton.addEventListener('click', () => {
                const taskId = taskModal.dataset.taskId;
                if (taskId) {
                    editTask(taskId);
                    taskModal.style.display = 'none';
                }
            });
            
            // Botão para excluir a tarefa
            deleteTaskButton.addEventListener('click', () => {
                const taskId = taskModal.dataset.taskId;
                if (taskId) {
                    if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                        deleteTask(taskId);
                        taskModal.style.display = 'none';
                    }
                }
            });
            
            // Botão de atualização manual
            manualRefreshButton.addEventListener('click', () => {
                console.log("Atualizando página manualmente...");
                
                // Adicionar animação ao ícone de atualização
                const refreshIcon = manualRefreshButton.querySelector('i');
                refreshIcon.classList.add('refresh-animation');
                
                // Verificar se há novas tarefas no localStorage
                const storedTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                if (JSON.stringify(tasks) !== JSON.stringify(storedTasks)) {
                    tasks = storedTasks;
                }
                
                // Verificar se há novas entradas no histórico de ações
                const storedActionHistory = JSON.parse(localStorage.getItem('actionHistory')) || [];
                if (JSON.stringify(actionHistory) !== JSON.stringify(storedActionHistory)) {
                    actionHistory = storedActionHistory;
                }
                
                // Atualizar a visualização com base na view atual
                if (currentView === 'completed') {
                    renderCompletedView();
                } else {
                    renderCalendar();
                }
                
                // Atualizar tarefas do dia na barra lateral
                renderDailyTasks();
                
                // Se a aba de tarefas concluídas estiver ativa, atualizar
                if (completedTasksTab.classList.contains('active')) {
                    renderCompletedTasks();
                }
                
                // Atualizar a hora da última atualização
                updateLastRefreshTime();
                
                // Remover a animação após 1 segundo
                setTimeout(() => {
                    refreshIcon.classList.remove('refresh-animation');
                }, 1000);
            });
            
            // Botão para limpar todas as tarefas (apenas para administradores)
            const clearTasksButton = document.getElementById('clearTasksButton');
            if (clearTasksButton) {
                clearTasksButton.addEventListener('click', () => {
                    if (confirm('Tem certeza que deseja limpar TODAS as tarefas? Esta ação não pode ser desfeita.')) {
                        tasks = [];
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                        renderCalendar();
                        renderDailyTasks();
                        renderCompletedTasks();
                        alert('Todas as tarefas foram removidas.');
                    }
                });
            }
            
            // Sistema de notificações para administradores
            if (notificationButton && notificationDropdown) {
                notificationButton.addEventListener('click', () => {
                    notificationDropdown.style.display = notificationDropdown.style.display === 'none' ? 'block' : 'none';
                });
                
                // Fechar dropdown ao clicar fora
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#notificationSystem')) {
                        notificationDropdown.style.display = 'none';
                    }
                });
                
                // Marcar todas como lidas
                markAllReadButton.addEventListener('click', () => {
                    notifications.forEach(notif => {
                        notif.read = true;
                    });
                    
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                    updateNotificationUI();
                });
            }
        }

        // Solicitar permissão para notificações
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Permissão para notificações concedida');
                    }
                });
            }
        }

        // Iniciar verificação de notificações
        function startNotificationCheck() {
            // Verificar a cada minuto
            notificationCheckInterval = setInterval(checkUpcomingTasks, 60000);
            // Verificar imediatamente ao carregar
            checkUpcomingTasks();
        }

        // Verificar tarefas próximas
        function checkUpcomingTasks() {
            const now = new Date();
            const thirtyMinutesFromNow = new Date(now.getTime() + 30 * 60000);
            const fifteenMinutesFromNow = new Date(now.getTime() + 15 * 60000);

            tasks.forEach(task => {
                // Criar a data com horário de início correto
                const taskStartDateTime = new Date(`${task.date}T${task.startTime}`);
                
                // Criar as datas com horário meio-dia para comparação do dia
                const taskDate = new Date(task.date + 'T12:00:00');
                const todayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0);
                
                // Verificar se a tarefa é para hoje e está próxima
                if (taskDate.toDateString() === todayDate.toDateString()) {
                    if (taskStartDateTime > now && taskStartDateTime <= thirtyMinutesFromNow) {
                        // Verificar se já foi notificado
                        if (!task.notified) {
                            showTaskNotification(task, taskStartDateTime <= fifteenMinutesFromNow ? 'urgent' : 'upcoming');
                            task.notified = true;
                            saveTasks();
                        }
                    }
                }
            });
        }

        // Mostrar notificação da tarefa
        function showTaskNotification(task, type) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const minutesLeft = Math.round((new Date(`${task.date}T${task.startTime}`) - new Date()) / 60000);
                const timeLeftText = minutesLeft > 0 ? `Faltam ${minutesLeft} minutos` : 'Agora';
                
                const title = type === 'urgent' ? 'Tarefa Urgente!' : 'Tarefa Próxima';
                const notification = new Notification(title, {
                    body: `${task.title}\nHorário: ${task.startTime} - ${task.endTime}\n${timeLeftText}\nCategoria: ${task.category}`,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzJhM2Q2NiIgZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDIgMC04LTMuNTgtOC04czMuNTgtOCA4LTggOCAzLjU4IDggOC0zLjU4IDgtOCA4eiIvPjxwYXRoIGZpbGw9IiMyYTNkNjYiIGQ9Ik0xMi41IDdoLTF2Nmw0LjI1IDIuNTUuNzUtMS4yMy0zLjUtMi4wN1Y3eiIvPjwvc3ZnPg==',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDIgMC04LTMuNTgtOC04czMuNTgtOCA4LTggOCAzLjU4IDggOC0zLjU4IDgtOCA4eiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0xMi41IDdoLTF2Nmw0LjI1IDIuNTUuNzUtMS4yMy0zLjUtMi4wN1Y3eiIvPjwvc3ZnPg=='
                });

                // Fechar notificação após 10 segundos
                setTimeout(() => notification.close(), 10000);

                // Adicionar som de notificação
                const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');
                audio.play().catch(e => console.log('Erro ao reproduzir som:', e));
            }
        }

        // Manipulação do formulário de tarefas
        async function handleTaskSubmit(e) {
            e.preventDefault();

            const taskDate = document.getElementById('taskDate').value;
            
            // Criar a data corretamente, considerando o fuso horário
            const formattedDate = new Date(taskDate + 'T12:00:00');
            // Ajustar para o formato ISO mas mantendo apenas a data
            const adjustedDate = formattedDate.toISOString().split('T')[0];

            // Verificar se estamos editando uma tarefa existente
            const editingTaskId = this.dataset.editingTaskId;
            
            // Obter os usuários selecionados
            const assignedUsers = Array.from(document.getElementById('taskAssignedTo').selectedOptions)
                .map(option => parseInt(option.value));
            
            const taskTitle = document.getElementById('taskTitle').value;
            const taskDescription = document.getElementById('taskDescription').value;
            const taskStartTime = document.getElementById('taskStartTime').value;
            const taskEndTime = document.getElementById('taskEndTime').value;
            const taskPriority = document.getElementById('taskPriority').value;
            const taskCategory = document.getElementById('taskCategory').value;
            const taskColor = document.getElementById('taskColor').value;
            const taskOperacao = document.getElementById('taskOperacao').value;
            
            const task = {
                id: editingTaskId ? parseInt(editingTaskId) : Date.now(),
                title: taskTitle,
                description: taskDescription,
                date: adjustedDate,
                startTime: taskStartTime,
                endTime: taskEndTime,
                priority: taskPriority,
                category: taskCategory,
                color: taskColor,
                operacao: taskOperacao, // Adicionando a operação à tarefa
                notified: false,
                completed: false, // Agora indica se a tarefa está totalmente concluída
                completedDate: null,
                assignedTo: assignedUsers, // Array de IDs de usuários
                completedBy: [] // Novo array que armazena IDs de usuários que completaram a tarefa
            };

            // Registrar detalhes da edição se estivermos editando uma tarefa existente
            if (editingTaskId) {
                const originalTask = tasks.find(t => t.id === parseInt(editingTaskId));
                if (originalTask) {
                    // Criar uma lista de mudanças
                    const changes = [];
                    
                    if (originalTask.title !== taskTitle) 
                        changes.push(`Título alterado de "${originalTask.title}" para "${taskTitle}"`);
                        
                    if (originalTask.description !== taskDescription)
                        changes.push(`Descrição alterada`);
                        
                    if (originalTask.date !== adjustedDate) {
                        const oldDate = new Date(originalTask.date).toLocaleDateString('pt-BR');
                        const newDate = new Date(adjustedDate).toLocaleDateString('pt-BR');
                        changes.push(`Data alterada de ${oldDate} para ${newDate}`);
                    }
                        
                    if (originalTask.startTime !== taskStartTime)
                        changes.push(`Hora de início alterada de ${originalTask.startTime} para ${taskStartTime}`);
                        
                    if (originalTask.endTime !== taskEndTime)
                        changes.push(`Hora de término alterada de ${originalTask.endTime} para ${taskEndTime}`);
                        
                    if (originalTask.priority !== taskPriority)
                        changes.push(`Prioridade alterada de ${originalTask.priority} para ${taskPriority}`);
                        
                    if (originalTask.category !== taskCategory)
                        changes.push(`Categoria alterada de ${originalTask.category} para ${taskCategory}`);
                        
                    if (originalTask.color !== taskColor)
                        changes.push(`Cor alterada`);
                        
                    if (originalTask.operacao !== taskOperacao)
                        changes.push(`Operação alterada de ${originalTask.operacao || 'Não definida'} para ${taskOperacao}`);
                        
                    // Verificar mudanças nos usuários atribuídos
                    const originalUsers = originalTask.assignedTo || [];
                    const newUsers = assignedUsers;
                    
                    if (JSON.stringify(originalUsers.sort()) !== JSON.stringify(newUsers.sort())) {
                        const users = JSON.parse(localStorage.getItem('users')) || Auth.DEFAULT_USERS;
                        const getNames = (ids) => ids.map(id => {
                            const user = users.find(u => u.id === id);
                            return user ? user.name : `Usuário ${id}`;
                        }).join(", ");
                        
                        changes.push(`Usuários atribuídos alterados de [${getNames(originalUsers)}] para [${getNames(newUsers)}]`);
                    }
                    
                    // Registrar a ação no histórico com detalhes das mudanças
                    const changeDetails = changes.length > 0 
                        ? `Tarefa "${taskTitle}" (ID: ${task.id}) foi editada. Mudanças: ${changes.join("; ")}`
                        : `Tarefa "${taskTitle}" (ID: ${task.id}) foi aberta para edição mas nenhuma mudança foi feita`;
                        
                    logUserAction('Editou tarefa', changeDetails);
                    
                    // Atualizar no banco de dados
                    try {
                        console.log('Atualizando tarefa no banco de dados...', task);
                        const updatedTask = await window.TasksAPI.updateTask(task.id.toString(), task);
                        console.log('Tarefa atualizada com sucesso:', updatedTask);
                        
                        // Atualizar a lista local
                        tasks = tasks.filter(t => t.id !== parseInt(editingTaskId));
                        tasks.push(updatedTask);
                    } catch (error) {
                        console.error('Erro ao atualizar tarefa no banco de dados:', error);
                        
                        // Atualizar apenas localmente
                        tasks = tasks.filter(t => t.id !== parseInt(editingTaskId));
                        tasks.push(task);
                    }
                } else {
                    // Se por algum motivo a tarefa original não for encontrada
                    logUserAction('Editou tarefa', `Tarefa "${taskTitle}" (ID: ${task.id}) foi editada`);
                    
                    // Atualizar no banco de dados
                    try {
                        console.log('Atualizando tarefa no banco de dados...', task);
                        const updatedTask = await window.TasksAPI.updateTask(task.id.toString(), task);
                        console.log('Tarefa atualizada com sucesso:', updatedTask);
                        
                        // Atualizar a lista local
                        tasks = tasks.filter(t => t.id !== parseInt(editingTaskId));
                        tasks.push(updatedTask);
                    } catch (error) {
                        console.error('Erro ao atualizar tarefa no banco de dados:', error);
                        
                        // Atualizar apenas localmente
                        tasks = tasks.filter(t => t.id !== parseInt(editingTaskId));
                        tasks.push(task);
                    }
                }
            } else {
                // Registrar a criação de uma nova tarefa
                deleteTaskButton.style.display = 'none';
            }

            // Verificar se o usuário atual já concluiu a tarefa
            if (Auth.hasPermission(currentUser, Auth.PERMISSIONS.COMPLETE_TASKS) && !currentUserCompleted && task.assignedTo.includes(currentUser.id)) {
                completeTaskButton.style.display = 'inline-block';
                completeTaskButton.dataset.taskId = task.id;
                completeTaskButton.textContent = 'Marcar como concluída';
            } else if (currentUserCompleted) {
                completeTaskButton.style.display = 'none';
                // Adicionar indicação de que o usuário já concluiu
                const completionIndicator = document.createElement('div');
                completionIndicator.innerHTML = '<span style="color: var(--accent-color); display: inline-block; margin-right: 10px;"><i class="fas fa-check-circle"></i> Você já concluiu esta tarefa</span>';
                document.querySelector('.modal-actions').prepend(completionIndicator);
            } else {
                completeTaskButton.style.display = 'none';
            }

            taskModal.style.display = 'block';
        }

        // Edição de tarefa
        function editTask(task) {
            // Atualizar o ID da tarefa que está sendo editada
            taskForm.dataset.editingTaskId = task.id;
            
            // Preencher o formulário com os dados da tarefa
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskDate').value = task.date;
            document.getElementById('taskStartTime').value = task.startTime;
            document.getElementById('taskEndTime').value = task.endTime;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskCategory').value = task.category;
            document.getElementById('taskColor').value = task.color || '#2a3d66';
            document.getElementById('taskOperacao').value = task.operacao || (currentUser.operacao || 'BJ Fibra');
            
            // Atualizar a visualização da cor
            updateColorValue(task.color || '#2a3d66');
            
            // Verificar se todos os usuários atribuídos estão no seletor
            document.getElementById('taskAssignedTo').querySelectorAll('option').forEach(option => {
                option.selected = task.assignedTo.includes(parseInt(option.value));
            });
            
            // Mostrar o formulário e atualizar o título
            document.querySelector('#taskFormHeader h3').textContent = 'Editar Tarefa';
            document.getElementById('taskFormContainer').style.display = 'flex';
        }

        // Exclusão de tarefa
        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            
            // Verificar se a tarefa está concluída e se o usuário é administrador
            if (task.completed && currentUser.accessLevel !== 'ADMIN') {
                alert('Apenas administradores podem excluir tarefas concluídas.');
                return;
            }

            if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                // Registrar a ação no histórico antes de excluir
                logUserAction('Excluiu tarefa', `Tarefa "${task.title}" (ID: ${task.id}) foi excluída`);
                
                // Excluir no banco de dados
                try {
                    console.log('Excluindo tarefa do banco de dados...', taskId);
                    await window.TasksAPI.deleteTask(taskId.toString());
                    console.log('Tarefa excluída com sucesso');
                } catch (error) {
                    console.error('Erro ao excluir tarefa do banco de dados:', error);
                }
                
                // Atualizar localmente
                tasks = tasks.filter(task => task.id !== taskId);
                saveTasks();
                taskModal.style.display = 'none';
                renderCalendar();
                renderDailyTasks();
            }
        }

        // Salvamento das tarefas no localStorage e banco de dados
        async function saveTasks() {
            // Salvar no localStorage para fallback
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            // Se estamos usando o banco de dados, tentamos salvar lá também
            // mas isso é feito individualmente em cada operação CRUD
            console.log("Tarefas salvas no localStorage");
        }

        // Adicionar event listener para o color picker
        document.getElementById('taskColor').addEventListener('input', function(e) {
            document.getElementById('colorPreview').textContent = e.target.value;
        });

        // Função para mostrar o tooltip com as tarefas do dia
        function showDayTooltip(e) {
            // Esconder qualquer tooltip ativo
            hideDayTooltip();
            
            // Obter a data do dia clicado
            const dateString = this.dataset.date;
            if (!dateString) return;
            
            const date = new Date(dateString + 'T12:00:00');
            const isAdmin = currentUser.accessLevel === 'ADMIN';
            
            // Obter as tarefas para este dia
            const allDayTasks = tasks.filter(task => {
                const taskDate = new Date(task.date + 'T12:00:00');
                return taskDate.toDateString() === date.toDateString();
            }).sort((a, b) => a.startTime.localeCompare(b.startTime));
            
            // Filtrar tarefas que o usuário pode ver
            const userTasks = allDayTasks.filter(task => {
                if (isAdmin) return true;
                return task.assignedTo.includes(currentUser.id);
            });
            
            if (userTasks.length === 0) {
                // Sem tarefas para mostrar
                tooltipDate.textContent = formatDateFullMonth(date);
                tooltipContent.innerHTML = '<p style="text-align: center; color: var(--light-text);">Não há tarefas para este dia.</p>';
            } else {
                // Mostrar tarefas
                tooltipDate.textContent = formatDateFullMonth(date);
                tooltipContent.innerHTML = '';
                
                userTasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = `day-tooltip-task priority-${task.priority} ${task.completed ? 'completed' : ''}`;
                    
                    // Formatar horários
                    const startTime = formatTime(task.startTime);
                    const endTime = formatTime(task.endTime);
                    
                    taskEl.innerHTML = `
                        <div class="day-tooltip-time">${startTime} - ${endTime}</div>
                        <div class="day-tooltip-title" style="color: ${task.color}">${task.title}</div>
                        <div class="day-tooltip-category">${task.category}</div>
                    `;
                    
                    tooltipContent.appendChild(taskEl);
                    
                    // Ao clicar em uma tarefa no tooltip, mostrar detalhes
                    taskEl.addEventListener('click', () => {
                            showTaskDetails(task);
                            hideDayTooltip();
                    });
                });
            }
            
            // Mostrar o tooltip
            dayTooltip.classList.add('show-tooltip');
            activeTooltip = this;
            
            // Posicionar o tooltip
            positionTooltip(this);
            
            // Atualizar a data selecionada
            selectedDate = date;
            
            // Atualizar as listas de tarefas na barra lateral
            renderDailyTasks();
            if (completedTasksTab.classList.contains('active')) {
                renderCompletedTasks();
            }
            
            // Adicionar evento de clique ao botão de fechar
            const closeTooltipBtn = dayTooltip.querySelector('.close-tooltip');
            closeTooltipBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                hideDayTooltip();
            });
            
            e.stopPropagation();
        }

        // Função para esconder o tooltip
        function hideDayTooltip() {
            if (activeTooltip) {
                activeTooltip.classList.remove('show-tooltip');
                activeTooltip = null;
            }
        }

        // Função para iniciar a atualização automática a cada 1 minuto
        function startAutoRefresh() {
            // Limpar qualquer intervalo existente
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Atualizar o indicador com a hora atual
            updateRefreshTime();
            
            // Atualizar a cada 1 minuto (60000 ms)
            autoRefreshInterval = setInterval(() => {
                console.log("Atualizando página automaticamente...");
                
                // Adicionar animação ao ícone de atualização
                const refreshIcon = manualRefreshButton.querySelector('i');
                refreshIcon.classList.add('refresh-animation');
                
                // Verificar se há novas tarefas no localStorage (caso outro cliente tenha adicionado)
                const storedTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                if (JSON.stringify(tasks) !== JSON.stringify(storedTasks)) {
                    tasks = storedTasks;
                }
                
                // Atualizar visualizações
                renderCalendar();
                renderDailyTasks();
                
                // Atualizar notificações
                checkUpcomingTasks();
                
                // Atualizar o indicador com a hora atual
                updateRefreshTime();
                
                // Remover a animação após 1 segundo
                setTimeout(() => {
                    refreshIcon.classList.remove('refresh-animation');
                }, 1000);
            }, 60000);
        }

        // Adicionar função para parar a atualização automática se necessário
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Função para atualizar o indicador de tempo de atualização
        function updateRefreshTime() {
            const now = new Date();
            lastRefreshTime.textContent = now.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Função para carregar usuários no select de atribuição
        function loadUsersForAssignment() {
            // Obter todos os usuários do sistema
            const users = JSON.parse(localStorage.getItem('users')) || Auth.DEFAULT_USERS;
            const select = document.getElementById('taskAssignedTo');
            
            if (!select) return; // Se o elemento não existir, sair da função
            
            // Limpar opções existentes
            select.innerHTML = '';
            
            // Adicionar opções para cada usuário
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                select.appendChild(option);
            });
        }

        // Função para limpar todas as tarefas
        function clearAllTasks() {
            if (confirm('Tem certeza que deseja limpar TODAS as tarefas? Esta ação não pode ser desfeita!')) {
                if (currentUser.accessLevel === 'ADMIN') {
                    // Registrar a ação no histórico se for admin
                    const actionLog = {
                        userId: currentUser.id,
                        userName: currentUser.name,
                        action: 'Limpou todas as tarefas',
                        details: `Todas as tarefas (${tasks.length}) foram removidas do sistema`,
                        timestamp: new Date().toISOString()
                    };
                    actionHistory.unshift(actionLog);
                    localStorage.setItem('actionHistory', JSON.stringify(actionHistory));
                    
                    tasks = [];
                    saveTasks();
                    renderCalendar();
                    renderDailyTasks();
                    renderCompletedTasks();
                    alert('Todas as tarefas foram removidas com sucesso!');
                } else {
                    alert('Apenas administradores podem limpar todas as tarefas.');
                }
            }
        }

        // Função para mostrar notificação de desktop
        function showDesktopNotification(newNotifications) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if (newNotifications.length === 1) {
                    // Uma única notificação
                    const notification = newNotifications[0];
                    const desktopNotification = new Notification('Nova ação no sistema', {
                        body: `${notification.title}: ${notification.message}`,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0OTYgNTEyIj48cGF0aCBmaWxsPSIjMmEzZDY2IiBkPSJNMTg1LjcgMjY4LjFoNzYuMnY3Ni4ySDI2MlYzNDRIMTg1LjdWMjY4LjF6TTU4Ny42IDMyLjhDNTgyLjEgOC4zIDU1NS44IDAgNTI3LjUgMHYtLjFINDhhQzI5LjYgMCAyMyA5LjYgMjMgMjIuMyM4MyAzNjRoMzB2LjJIMzQ5djg5LjRoNzYuN3Y3Ni4ySDI2MlYzNDRIMTg1LjdWMjY4LjFIMjYyVjE5MmgtNzYuN1YxMTYuMkgyNjJWMjkuNWgtNzYuN3YtLjJIMTU4Ljh2LjJoLTMwVi44aC03NnYuMmgtNzYuMnYuMUgyOUMyOS42IDUuOCAyNS4yIDExLjIgMjMgMjIuMyM4MyAzNjR2NzYuMmg5MVYzMjRoMzB2LjJoMzY5VjgzYTIyLjcgMjIuNyAwIDAgMCAtMi0yLjQgMjIuNiAyMi42IDAgMCAwIC0yLjQuOEw1NTEgMzIuNyA1ODcuNiAzMi44eiIvPjwvc3ZnPg==',
                    });
                    
                    // Fechar a notificação após 5 segundos
                    setTimeout(() => {
                        desktopNotification.close();
                    }, 5000);
                    
                    // Abrir a página quando clicar na notificação
                    desktopNotification.onclick = function() {
                        window.focus();
                        notificationDropdown.style.display = 'block';
                    };
                } else {
                    // Múltiplas notificações
                    const desktopNotification = new Notification('Novas ações no sistema', {
                        body: `Você tem ${newNotifications.length} novas notificações não lidas`,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0OTYgNTEyIj48cGF0aCBmaWxsPSIjMmEzZDY2IiBkPSJNMTg1LjcgMjY4LjFoNzYuMnY3Ni4ySDI2MlYzNDRIMTg1LjdWMjY4LjF6TTU4Ny42IDMyLjhDNTgyLjEgOC4zIDU1NS44IDAgNTI3LjUgMHYtLjFINDhhQzI5LjYgMCAyMyA5LjYgMjMgMjIuMyM4MyAzNjRoMzB2LjJIMzQ5djg5LjRoNzYuN3Y3Ni4ySDI2MlYzNDRIMTg1LjdWMjY4LjFIMjYyVjE5MmgtNzYuN1YxMTYuMkgyNjJWMjkuNWgtNzYuN3YtLjJIMTU4Ljh2LjJoLTMwVi44aC03NnYuMmgtNzYuMnYuMUgyOUMyOS42IDUuOCAyNS4yIDExLjIgMjMgMjIuMyM4MyAzNjR2NzYuMmg5MVYzMjRoMzB2LjJoMzY5VjgzYTIyLjcgMjIuNyAwIDAgMCAtMi0yLjQgMjIuNiAyMi42IDAgMCAwIC0yLjQuOEw1NTEgMzIuNyA1ODcuNiAzMi44eiIvPjwvc3ZnPg==',
                    });
                    
                    // Fechar a notificação após 5 segundos
                    setTimeout(() => {
                        desktopNotification.close();
                    }, 5000);
                    
                    // Abrir a página quando clicar na notificação
                    desktopNotification.onclick = function() {
                        window.focus();
                        notificationDropdown.style.display = 'block';
                    };
                }
            }
        }

        // Função para posicionar o tooltip próximo ao elemento
        function positionTooltip(element) {
            if (!element || !dayTooltip) return;
            
            const rect = element.getBoundingClientRect();
            const tooltipRect = dayTooltip.getBoundingClientRect();
            
            // Posicionar abaixo do elemento clicado por padrão
            let top = window.scrollY + rect.bottom + 10;
            let left = window.scrollX + rect.left;
            
            // Verificar se o tooltip ficaria fora da tela à direita
            if (left + tooltipRect.width > window.innerWidth) {
                left = window.innerWidth - tooltipRect.width - 20;
            }
            
            // Verificar se o tooltip ficaria fora da tela abaixo
            if (top + tooltipRect.height > window.scrollY + window.innerHeight) {
                // Posicionar acima do elemento
                top = window.scrollY + rect.top - tooltipRect.height - 10;
            }
            
            // Posicionar a seta do tooltip
            const tooltipArrow = dayTooltip.querySelector('.tooltip-arrow');
            tooltipArrow.style.left = (rect.left + rect.width/2 - left) + 'px';
            
            // Se o tooltip estiver posicionado acima, mover a seta para baixo
            if (top < window.scrollY + rect.top) {
                tooltipArrow.style.top = 'auto';
                tooltipArrow.style.bottom = '-8px';
                tooltipArrow.style.borderBottom = 'none';
                tooltipArrow.style.borderTop = '8px solid white';
            } else {
                tooltipArrow.style.top = '-8px';
                tooltipArrow.style.bottom = 'auto';
                tooltipArrow.style.borderTop = 'none';
                tooltipArrow.style.borderBottom = '8px solid white';
            }
            
            // Aplicar posição
            dayTooltip.style.top = top + 'px';
            dayTooltip.style.left = left + 'px';
        }

        // Função para formatar hora no formato HH:MM
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }
        
        // Função para formatar data completa com mês por extenso
        function formatDateFullMonth(date) {
            if (!date) return '';
            return date.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
        
        // Função para formatar data curta
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T12:00:00');
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Função para controlar a exibição das opções de repetição
        function toggleRepeatOptions() {
            const repeatType = document.getElementById('taskRepeat').value;
            const weekdaysContainer = document.getElementById('weekdaysContainer');
            const repeatEndContainer = document.getElementById('repeatEndContainer');
            
            // Mostrar/esconder dias da semana
            if (repeatType === 'weekly' || repeatType === 'custom') {
                weekdaysContainer.style.display = 'block';
                
                // Se for semanal, selecionar automaticamente o dia da semana da data selecionada
                if (repeatType === 'weekly') {
                    const taskDate = document.getElementById('taskDate').value;
                    if (taskDate) {
                        const date = new Date(taskDate);
                        const dayOfWeek = date.getDay();
                        document.getElementById(`weekday-${dayOfWeek}`).checked = true;
                    }
                }
            } else {
                weekdaysContainer.style.display = 'none';
                // Desmarcar todos os dias da semana
                for (let i = 0; i < 7; i++) {
                    document.getElementById(`weekday-${i}`).checked = false;
                }
            }
            
            // Mostrar/esconder opções de término
            if (repeatType === 'none') {
                repeatEndContainer.style.display = 'none';
            } else {
                repeatEndContainer.style.display = 'block';
            }
        }
        
        // Função para controlar as opções de término da repetição
        function toggleEndDateField() {
            const endType = document.getElementById('repeatEndType').value;
            const endDateContainer = document.getElementById('endDateContainer');
            const occurrencesContainer = document.getElementById('occurrencesContainer');
            
            if (endType === 'on') {
                endDateContainer.style.display = 'block';
                occurrencesContainer.style.display = 'none';
                
                // Definir data padrão (1 mês a partir da data inicial)
                const taskDate = document.getElementById('taskDate').value;
                if (taskDate) {
                    const date = new Date(taskDate);
                    date.setMonth(date.getMonth() + 1);
                    document.getElementById('repeatEndDate').value = date.toISOString().split('T')[0];
                }
            } else if (endType === 'after') {
                endDateContainer.style.display = 'none';
                occurrencesContainer.style.display = 'block';
            } else {
                endDateContainer.style.display = 'none';
                occurrencesContainer.style.display = 'none';
            }
        }
        
        // Função para gerar tarefas repetitivas
        function generateRecurringTasks(baseTask) {
            const repeatType = document.getElementById('taskRepeat').value;
            if (repeatType === 'none') {
                return [baseTask]; // Sem repetição, retorna apenas a tarefa base
            }
            
            const tasks = [];
            const startDate = new Date(baseTask.date);
            let endDate = null;
            let maxOccurrences = null;
            
            // Determinar data de término ou número máximo de ocorrências
            const endType = document.getElementById('repeatEndType').value;
            if (endType === 'on') {
                const endDateStr = document.getElementById('repeatEndDate').value;
                if (endDateStr) {
                    endDate = new Date(endDateStr);
                    // Ajustar para o final do dia
                    endDate.setHours(23, 59, 59, 999);
                }
            } else if (endType === 'after') {
                maxOccurrences = parseInt(document.getElementById('repeatOccurrences').value) || 10;
            } else {
                // Se for "nunca", limitar a um ano para evitar criar muitas tarefas
                const oneYearLater = new Date(startDate);
                oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
                endDate = oneYearLater;
            }
            
            let selectedWeekdays = [];
            if (repeatType === 'weekly' || repeatType === 'custom') {
                // Coletar dias da semana selecionados
                for (let i = 0; i < 7; i++) {
                    if (document.getElementById(`weekday-${i}`).checked) {
                        selectedWeekdays.push(i);
                    }
                }
                
                // Se nenhum dia da semana foi selecionado, usar o dia da semana da data inicial
                if (selectedWeekdays.length === 0) {
                    selectedWeekdays.push(startDate.getDay());
                }
            }
            
            // Adicionar a tarefa base
            tasks.push(baseTask);
            
            let currentDate = new Date(startDate);
            let count = 1; // Já contabilizamos a tarefa base
            
            // Determinar o incremento de dias com base no tipo de repetição
            while (
                (endDate && currentDate <= endDate) || 
                (maxOccurrences && count < maxOccurrences)
            ) {
                // Incrementar a data de acordo com o tipo de repetição
                if (repeatType === 'daily') {
                    currentDate.setDate(currentDate.getDate() + 1);
                } else if (repeatType === 'weekly') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (repeatType === 'custom') {
                    // Encontrar o próximo dia da semana selecionado
                    let daysToAdd = 1;
                    let nextDay = new Date(currentDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    
                    while (!selectedWeekdays.includes(nextDay.getDay())) {
                        daysToAdd++;
                        nextDay.setDate(nextDay.getDate() + 1);
                    }
                    
                    currentDate.setDate(currentDate.getDate() + daysToAdd);
                }
                
                // Se atingimos a data limite, parar
                if (endDate && currentDate > endDate) {
                    break;
                }
                
                // Criar uma nova tarefa com a data atualizada
                const newTask = {...baseTask};
                newTask.id = Date.now() + count; // Garantir ID único
                newTask.date = currentDate.toISOString().split('T')[0];
                newTask.isRecurring = true;
                newTask.recurringParentId = baseTask.id;
                
                tasks.push(newTask);
                count++;
                
                // Se atingimos o número máximo de ocorrências, parar
                if (maxOccurrences && count >= maxOccurrences) {
                    break;
                }
            }
            
            return tasks;
        }

        // Adicionar um aviso visual se o usuário não puder ver todas as operações
        window.addEventListener('load', function() {
            // Verificar se o objeto Auth e suas propriedades existem
            if (!window.Auth || !window.Auth.PERMISSIONS || !window.Auth.hasPermission) {
                console.error('Objeto Auth não está completamente carregado');
                return;
            }

            // Verificar se o usuário pode ver todas as operações
            let podeVerTodasOperacoes = false;
            try {
                podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            } catch (error) {
                console.error('Erro ao verificar permissão VIEW_BY_OPERATION:', error);
            }
            
            if (!podeVerTodasOperacoes && currentUser.operacao) {
                // Definir a operação padrão no formulário
                if (document.getElementById('taskOperacao')) {
                    document.getElementById('taskOperacao').value = currentUser.operacao;
                }
            }
            
            // Se o usuário não tem permissão, desabilitar seleção de operação no formulário
            if (!podeVerTodasOperacoes && currentUser.operacao && document.getElementById('taskOperacao')) {
                document.getElementById('taskOperacao').value = currentUser.operacao;
                document.getElementById('taskOperacao').disabled = true;
                document.getElementById('taskOperacao').style.backgroundColor = '#f0f0f0';
            }
        });
        
        // Atualizar a visão do calendário quando a janela for redimensionada
        window.addEventListener('resize', ajustarCalendario);
        
        // Menu interativo - efeito de hover
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Configurando comportamento do menu');
            const menuItems = document.querySelectorAll('.menu-item');
            
            if (menuItems.length === 0) {
                console.error('Nenhum item de menu encontrado!');
            } else {
                console.log(`${menuItems.length} itens de menu encontrados`);
            }
            
            menuItems.forEach(item => {
                const indicator = item.querySelector('.menu-hover-indicator');
                
                // Certifica que o menu esteja visível
                const menuNav = document.querySelector('.main-menu');
                if (menuNav) {
                    menuNav.style.display = 'block';
                    menuNav.style.visibility = 'visible';
                }
                
                // Efeito hover
                item.addEventListener('mouseenter', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '100%';
                    }
                });
                
                item.addEventListener('mouseleave', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '0';
                    }
                });
                
                // Efeito de clique
                item.addEventListener('click', function() {
                    // Remove a classe active de todos os itens
                    menuItems.forEach(mi => {
                        mi.classList.remove('active');
                        mi.querySelector('.menu-hover-indicator').style.width = '0';
                        mi.querySelector('a').style.background = 'transparent';
                        mi.querySelector('a').style.color = 'var(--text-color)';
                    });
                    
                    // Adiciona a classe active ao item clicado
                    item.classList.add('active');
                    indicator.style.width = '100%';
                    item.querySelector('a').style.background = 'var(--secondary-color)';
                    item.querySelector('a').style.color = 'var(--primary-color)';
                });
            });
            
            // Remova o comportamento do botão voltar se ainda existir
            const btnVoltar = document.getElementById('btnVoltar');
            if (btnVoltar) {
                btnVoltar.remove();
            }
        });
        
        // Função para ajustar o calendário quando a janela for redimensionada
        function ajustarCalendario() {
            // Verificar a visualização atual e renderizar novamente o calendário
            if (currentView === 'monthly') {
                renderCalendar();
            } else if (currentView === 'weekly') {
                renderCalendar('weekly');
            } else if (currentView === 'daily') {
                renderCalendar('daily');
            }
        }
        
        // Atualizar a visão do calendário quando a janela for redimensionada
        window.addEventListener('resize', ajustarCalendario);
    </script>
</body>
</html>
