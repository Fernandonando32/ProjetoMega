<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Acompanhamento de Técnicos e Veículos - FTTH</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="module">
        import * as Auth from './js/auth.js';
        
        // Verificar autenticação
        async function checkAuth() {
            if (!await Auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Obter usuário atual
            const currentUser = Auth.getCurrentUser();
            
            // Garantir que administradores tenham a permissão MANAGE_USERS
            if (currentUser.accessLevel === 'ADMIN') {
                // Se o usuário tiver permissões personalizadas, garantir que MANAGE_USERS esteja incluída
                if (currentUser.customPermissions && Array.isArray(currentUser.permissions)) {
                    if (!currentUser.permissions.includes(Auth.PERMISSIONS.MANAGE_USERS)) {
                        currentUser.permissions.push(Auth.PERMISSIONS.MANAGE_USERS);
                        // Atualizar o sessionStorage para persistir a alteração
                        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                }
            }
            
            // Atribuir uma operação padrão com base no nível de acesso ou permissões personalizadas
            // Em um sistema real, isso viria do banco de dados do usuário
            if (!currentUser.operacao) {
                if (currentUser.accessLevel === 'MAINTENANCE_MANAGER') {
                    // Gerentes de manutenção são da operação Megalink por padrão
                    currentUser.operacao = 'Megalink';
                } else if (currentUser.accessLevel === 'TECH_MANAGER') {
                    // Gerentes de técnicos são da operação BJ Fibra por padrão
                    currentUser.operacao = 'BJ Fibra';
                }
                // ADMIN não recebe operação específica, podendo ver todas
                // Se o usuário tiver a permissão VIEW_BY_OPERATION, ele poderá visualizar 
                // registros de todas as operações independente da sua operação assignada
            }
            
            // Atualizar o objeto do usuário no sessionStorage
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Configurar elementos da interface após carregamento
            document.addEventListener('DOMContentLoaded', setupUI);
            
            // Configurar manipulador do importador CSV
            document.addEventListener('DOMContentLoaded', configureCSVImporter);
        }
        
        // Iniciar verificação de autenticação
        checkAuth();
        
        // Função para configurar a interface do usuário
        function setupUI() {
            const currentUser = Auth.getCurrentUser();
            if (currentUser) {
                // Configurar elementos da interface com base no usuário atual
                // Código para atualizar a UI com informações do usuário...
            }
        }
        
        // Função para configurar o importador de CSV
        function configureCSVImporter() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput) return;
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const text = e.target.result;
                        importCSVData(text);
                    };
                    reader.readAsText(file);
                }
            });
        }
        
        // Função para importar dados do CSV
        function importCSVData(text) {
            const lines = text.split('\n');
            let importCount = 0;
            let duplicateCount = 0;
            let tecnicosSemVeiculoCount = 0;
            let registrosComProblema = [];
            let linhasIgnoradas = 0;
            
            console.log("Iniciando importação CSV...");
            
            // Pular a linha de cabeçalho
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    try {
                        // Dividir a linha usando ponto e vírgula como separador
                        const values = lines[i].split(';').map(v => v.trim());
                        
                        // Verificar se tem técnico e cidade
                        const temTecnico = values[1] && values[1].trim();
                        const temCidade = values[0] && values[0].trim();
                        
                        // Se não tem nem técnico nem cidade, pular
                        if (!temTecnico && !temCidade) {
                            linhasIgnoradas++;
                            continue;
                        }
                        
                        // Extrair latitude e longitude do formato atual
                        let lat = '';
                        let lng = '';
                        
                        if (values[9] && values[10]) {
                            try {
                                if (values[5] === "BJ Fibra") {
                                    // Formato BJ Fibra: lat: -6.4037;"""lng"": -41.7382}"
                                    lat = values[9].replace('lat:', '').replace(/"/g, '').trim();
                                    lng = values[10].replace('"""lng"":', '').replace(/"/g, '').replace('}', '').trim();
                                } else {
                                    // Formato Megalink: lat: -5.890250;" ""lng"": -42.636018}"
                                    lat = values[9].replace('lat:', '').trim();
                                    lng = values[10].replace('" ""lng"":', '').replace('}"', '').trim();
                                }

                                // Garantir que as coordenadas estejam no formato correto
                                lat = lat.replace(/,/g, '.').replace(/[^0-9.-]/g, '');
                                lng = lng.replace(/,/g, '.').replace(/[^0-9.-]/g, '');
                                
                                // Verificar se as coordenadas são válidas
                                const latNum = parseFloat(lat);
                                const lngNum = parseFloat(lng);
                                
                                if (isNaN(latNum) || isNaN(lngNum)) {
                                    registrosComProblema.push({
                                        linha: i + 1,
                                        dados: values,
                                        erro: 'Coordenadas inválidas'
                                    });
                                    continue;
                                }
                            } catch (error) {
                                console.error('Erro ao processar coordenadas:', error);
                                registrosComProblema.push({
                                    linha: i + 1,
                                    dados: values,
                                    erro: 'Erro ao processar coordenadas: ' + error.message
                                });
                                continue;
                            }
                        }
                        
                        // Processar o resto do CSV e criar os registros...
                        // Esta parte será implementada conforme necessário
                        
                        importCount++;
                    } catch (error) {
                        console.error('Erro ao processar linha CSV:', error);
                        registrosComProblema.push({
                            linha: i + 1,
                            dados: lines[i],
                            erro: 'Erro de processamento: ' + error.message
                        });
                    }
                }
            }
            
            // Exibir resultados da importação
            alert(`Importação concluída!\nRegistros importados: ${importCount}\nRegistros duplicados ignorados: ${duplicateCount}\nTécnicos sem veículo: ${tecnicosSemVeiculoCount}\nLinhas ignoradas: ${linhasIgnoradas}\nRegistros com problema: ${registrosComProblema.length}`);
            
            // Atualizar a exibição após a importação
            if (typeof updateDisplay === 'function') {
                updateDisplay();
            }
        }
        
        // Expor Auth e funções de importação CSV globalmente para uso em outros scripts inline
        window.Auth = Auth;
        window.importCSVData = importCSVData;
        window.configureCSVImporter = configureCSVImporter;
    </script>
    <style>
        :root {
            --primary-color: #2a3d66;
            --secondary-color: #eaf0fa;
            --accent-color: #27ae60;
            --danger-color: #c0392b;
            --text-color: #2a3d66;
            --light-text: #666;
            --border-color: #e0e6f0;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f4f6fb;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            width: 100%;
            max-width: none;
            margin: 0;
            background: #fff;
            border-radius: 0;
            box-shadow: none;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        header {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin: 0 0 20px 0;
        }
        .main-menu {
            background: #fff;
            box-shadow: var(--shadow);
            padding: 10px 20px;
            margin-bottom: 20px;
        }
        .main-menu ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .main-menu .menu-item {
            position: relative;
        }
        .main-menu .menu-item a {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        .main-menu .menu-item.active a {
            background: var(--secondary-color);
            color: var(--primary-color);
        }
        .main-menu .menu-hover-indicator {
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
            transition: width 0.2s ease;
        }
        .main-menu .menu-item.active .menu-hover-indicator {
            width: 100%;
        }
        form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        form > div {
            flex: 1 1 180px;
            display: flex;
            flex-direction: column;
        }
        label {
            font-size: 0.95em;
            margin-bottom: 4px;
            color: #2a3d66;
        }
        input, select {
            padding: 7px 10px;
            border: 1px solid #bfc9d9;
            border-radius: 5px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 10px 18px;
            background: #2a3d66;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #1a2540;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            flex: 1;
        }
        th, td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e6f0;
            text-align: left;
        }
        th {
            background: #eaf0fa;
            color: #2a3d66;
            position: sticky;
            top: 0;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .actions button {
            margin-right: 6px;
            padding: 6px 12px;
            font-size: 0.95em;
        }
        @media (max-width: 900px) {
            .container { padding: 15px; }
            form { flex-direction: column; gap: 8px; }
        }
        #mapaContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        #mapa {
            width: 90%;
            height: 90%;
            margin: 2% auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            position: relative;
        }
        .fecharMapa {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #c0392b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            z-index: 1001;
        }
        .fecharMapa:hover {
            background: #a93226;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #painelEstatisticas {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
        }
        #painelEstatisticasCidade {
            margin: 20px 0;
            background: #eaf0fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px #0001;
        }
        .tabela-container {
            margin-top: 20px;
            overflow: auto;
            max-height: calc(100vh - 300px);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: white;
            width: 100%;
            padding-bottom: 10px;
            border: 1px solid #e0e6f0;
            position: relative;
            resize: vertical; /* Allow vertical resizing */
            min-height: 300px; /* Set minimum height */
        }

        /* Resize handle indicator */
        .tabela-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            background: linear-gradient(135deg, transparent 50%, #bfc9d9 50%);
            cursor: ns-resize;
            border-radius: 0 0 8px 0;
        }

        .tabela-container::before {
            content: "Lista de Registros";
            display: block;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            color: #2a3d66;
            background: #f5f8fc;
            border-bottom: 1px solid #e0e6f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Fullscreen toggle button */
        .fullscreen-toggle {
            position: absolute;
            top: 12px;
            right: 15px;
            background: none;
            border: none;
            color: #2a3d66;
            font-size: 18px;
            cursor: pointer;
            z-index: 11;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .fullscreen-toggle:hover {
            background: #e0e6f0;
        }

        /* Fullscreen mode styles */
        .tabela-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            z-index: 2000;
            border-radius: 0;
            margin: 0;
            padding: 0 0 10px 0;
        }

        /* Adjust the table header to account for the new container header */
        #tabelaRegistros {
            width: 100%;
            border-collapse: collapse;
        }
        #tabelaRegistros th {
            background: #eaf0fa;
            color: #2a3d66;
            position: sticky;
            top: 46px;
            z-index: 5;
            padding: 12px 15px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
        }
        #tabelaRegistros td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        #tabelaRegistros tbody tr {
            transition: all 0.2s ease;
        }
        #tabelaRegistros tbody tr:nth-child(even) {
            background-color: #f9fafc;
        }
        #tabelaRegistros tbody tr:hover {
            background-color: #eaf0fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* Tabela container for scrolling */
        .tabela-container {
            margin-top: 20px;
            overflow: auto;
            max-height: calc(100vh - 300px);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: white;
            width: 100%;
            padding-bottom: 10px;
            border: 1px solid #e0e6f0;
            position: relative;
            resize: vertical;
            min-height: 300px;
        }
        
        /* Table header with title */
        .tabela-container::before {
            content: "Lista de Registros";
            display: block;
            padding: 15px 20px;
            font-size: 1.2em;
            font-weight: bold;
            color: #2a3d66;
            background: #f5f8fc;
            border-bottom: 1px solid #e0e6f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Resize handle indicator */
        .tabela-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            background: linear-gradient(135deg, transparent 50%, #bfc9d9 50%);
            cursor: ns-resize;
            border-radius: 0 0 8px 0;
        }
        
        /* Fullscreen toggle button */
        .fullscreen-toggle {
            position: absolute;
            top: 12px;
            right: 15px;
            background: none;
            border: none;
            color: #2a3d66;
            font-size: 18px;
            cursor: pointer;
            z-index: 11;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .fullscreen-toggle:hover {
            background: #e0e6f0;
        }
        
        /* Fullscreen mode styles */
        .tabela-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            z-index: 2000;
            border-radius: 0;
            margin: 0;
            padding: 0 0 10px 0;
        }
        
        /* Custom scrollbar for the table container */
        .tabela-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .tabela-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .tabela-container::-webkit-scrollbar-thumb {
            background: #bfc9d9;
            border-radius: 10px;
            border: 3px solid #f1f1f1;
        }
        
        .tabela-container::-webkit-scrollbar-thumb:hover {
            background: #a7b4ca;
        }
        
        /* Estilo para a notificação de alertas */
        #alertaContratosNotificacao {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            width: 320px;
            max-width: 90%;
            z-index: 1003;
            overflow: hidden;
        }
        
        .alerta-header {
            background-color: #e74c3c;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alerta-body {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alerta-footer {
            padding: 10px 15px;
            background-color: #f8f9fa;
            text-align: right;
            border-top: 1px solid #eee;
        }
        
        .alerta-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }
        
        .alerta-item:last-child {
            border-bottom: none;
        }
        
        .alerta-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        
        .alerta-action {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        /* Indicador de alerta para manutenções frequentes */
        .alerta-manutencao {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            margin-right: 5px;
        }
        
        .alerta-manutencao i {
            margin-right: 5px;
            font-size: 1.1em;
        }
        
        /* Indicador de alerta para troca de óleo */
        .alerta-troca-oleo {
            background-color: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            margin-right: 5px;
        }
        
        .alerta-troca-oleo i {
            margin-right: 5px;
            font-size: 1.1em;
        }
        
        /* Specific alert settings */
        #alertaManutencoesNotificacao {
            display: none;
            position: fixed;
            top: 20px;
            right: 360px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            width: 320px;
            max-width: 90%;
            z-index: 1003;
            overflow: hidden;
        }
        
        #alertaManutencoesNotificacao .alerta-header {
            background-color: #e74c3c;
        }
        
        #alertaTrocaOleoNotificacao {
            display: none;
            position: fixed;
            top: 20px;
            right: 700px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            width: 320px;
            max-width: 90%;
            z-index: 1003;
            overflow: hidden;
        }
        
        #alertaTrocaOleoNotificacao .alerta-header {
            background-color: #f39c12;
        }
        
        /* Estilo para o balão de estatísticas */
        .estatisticas-tooltip {
            display: none;
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 20px;
            z-index: 1050;
            min-width: 400px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            right: 0;
            top: 100%;
            margin-top: 10px;
            border: 1px solid #eee;
            animation: tooltip-fade 0.3s ease-out;
        }

        @keyframes tooltip-fade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .estatisticas-tooltip h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 1.3em;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .estatisticas-tooltip .estatistica-item {
            display: flex;
            flex-wrap: wrap;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .estatisticas-tooltip .estatistica-item:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .estatisticas-tooltip .estatistica-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .estatisticas-tooltip .estatistica-label {
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 15px;
        }

        .estatisticas-tooltip .estatistica-valor {
            color: #444;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* Específico para o botão de estatísticas */
        .btn-estatisticas {
            background: var(--primary-color);
        }
        
        .btn-estatisticas:hover {
            background: #1a2540;
        }
        
        /* Estilo para a mensagem de "nenhum resultado" no tooltip */
        .sem-resultados {
            padding: 20px;
            text-align: center;
            color: var(--light-text);
            font-style: italic;
        }
        
        /* Estilo para o botão de ação */
        .btn-acao {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn-acao:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Estilo para a seção "Resumo Geral" */
        .resumo-estatisticas {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
    </style>
    <script src="js/fix-currentUser.js"></script>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center;">
            <i class="fas fa-truck" style="font-size: 24px; margin-right: 10px;"></i>
            <h1 style="font-size: 20px; margin: 0; color: white;">Acompanhamento de Técnicos e Veículos - FTTH</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="currentUserName" style="font-size: 14px;"></div>
            
            <!-- Sistema de notificação para administradores -->
            <div id="notificationSystem" style="display: none; position: relative;">
                <button id="notificationButton" style="background: none; border: none; color: white; position: relative; padding: 5px; cursor: pointer;" title="Notificações">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" style="position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                </button>
                <div id="notificationDropdown" style="display: none; position: absolute; right: 0; top: 100%; width: 300px; max-height: 400px; overflow-y: auto; background: white; border-radius: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); color: var(--text-color); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">
                        <h3 style="margin: 0; font-size: 16px;">Notificações</h3>
                        <button id="markAllReadButton" style="font-size: 12px; padding: 3px 8px; background: var(--secondary-color); color: var(--text-color); border: none; border-radius: 3px; cursor: pointer;">Marcar todas como lidas</button>
                    </div>
                    <div id="notificationList" style="padding: 0;">
                        <div style="padding: 20px; text-align: center; color: var(--light-text);">
                            Nenhuma notificação
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="admin-button" id="adminButton" style="display: none; padding: 5px 8px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;" title="Administrar Usuários">
                <i class="fas fa-cog"></i>
            </button>
            <button id="logoutButton" style="padding: 5px 10px; font-size: 12px; background: var(--danger-color); color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <!-- Menu de navegação -->
    <nav class="main-menu">
        <ul>
            <li class="menu-item active">
                <a href="Pagina1 (1).html">
                    <i class="fas fa-home" style="margin-right: 8px;"></i>
                    <span>Principal</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
            <li class="menu-item">
                <a href="Agenda.html">
                    <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
                    <span>Agenda</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
            <li class="menu-item">
                <a href="manutencao.html">
                    <i class="fas fa-tools" style="margin-right: 8px;"></i>
                    <span>Manutenção de Veículos</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
        </ul>
    </nav>

    <div class="container" style="padding-top: 20px;">
        <!-- Painel de Estatísticas -->
        <div id="painelEstatisticas" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 25px; flex-wrap: wrap;">
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div style="font-size:2em; font-weight:bold; color:#2a3d66;" id="totalTecnicos">0</div>
                <div style="color:#2a3d66;">Total de Pessoal Técnico</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div style="font-size:2em; font-weight:bold; color:#2a3d66;" id="totalVeiculos">0</div>
                <div style="color:#2a3d66;">Total de Veículos</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div style="font-size:2em; font-weight:bold; color:#2a3d66;" id="totalCidades">0</div>
                <div style="color:#2a3d66;">Cidades Distintas</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div id="bjfibraContainer" style="font-size:1.2em; color:#2a3d66;">BJ Fibra: <span id="bjfibraCount">0</span></div>
                <div id="megalinkContainer" style="font-size:1.2em; color:#2a3d66;">Megalink: <span id="megalinkCount">0</span></div>
                <div style="color:#2a3d66; margin-top:4px;">Pessoal Técnico por Operação</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div id="bjfibraVeiculosContainer" style="font-size:1.2em; color:#2a3d66;">BJ Fibra: <span id="bjfibraVeiculosCount">0</span></div>
                <div id="megalinkVeiculosContainer" style="font-size:1.2em; color:#2a3d66;">Megalink: <span id="megalinkVeiculosCount">0</span></div>
                <div style="color:#2a3d66; margin-top:4px;">Veículos por Operação</div>
            </div>
        </div>
        <!-- Novo painel de estatísticas por cidade -->
        <div id="painelEstatisticasCidade" style="position: relative; margin: 20px 0 25px 0;">
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button id="mostrarEstatisticas" class="btn-acao btn-estatisticas">
                    <span>📊</span> Mostrar Estatísticas
                </button>
                <button id="verMapa" class="btn-acao btn-mapa">
                    <span>🗺️</span> Ver Mapa
                </button>
            </div>
            <div id="estatisticasTooltip" class="estatisticas-tooltip">
                <h3>Estatísticas por Cidade</h3>
                <div id="estatisticasConteudo"></div>
            </div>
        </div>
        <!-- Fim Painel Estatísticas -->
        <form id="registroForm">
            <div>
                <label for="cidade">Cidade</label>
                <input type="text" id="cidade" required>
            </div>
            <div>
                <label for="tecnico">Nome do Técnico</label>
                <input type="text" id="tecnico" required>
            </div>
            <div>
                <label for="auxiliar">Auxiliar</label>
                <input type="text" id="auxiliar">
            </div>
            <div>
                <label for="placa">Placa</label>
                <input type="text" id="placa" required>
            </div>
            <div>
                <label for="modelo">Modelo</label>
                <input type="text" id="modelo" required>
            </div>
            <div>
                <label for="operacao">Operação</label>
                <select id="operacao" required>
                    <option value="Megalink">Megalink</option>
                    <option value="BJ Fibra">BJ Fibra</option>
                </select>
            </div>
            <div>
                <label for="equipes">Equipes Varejo e Backbone</label>
                <input type="text" id="equipes">
            </div>
            <div>
                <label for="kmAtual">KM Atual</label>
                <input type="text" id="kmAtual">
            </div>
            <div>
                <label for="ultimaTrocaOleoInfo" style="display: flex; align-items: center;">
                    Última Troca de Óleo 
                    <span style="background: #95a5a6; color: white; font-size: 0.8em; padding: 2px 5px; border-radius: 3px; margin-left: 8px;">Somente Leitura</span>
                </label>
                <input type="text" id="ultimaTrocaOleoInfo" disabled style="background-color: #f0f0f0; color: #666;">
            </div>
            <div>
                <label for="renavam">Renavam</label>
                <input type="text" id="renavam">
            </div>
            <div>
                <label for="lat">Latitude</label>
                <input type="text" id="lat">
            </div>
            <div>
                <label for="lng">Longitude</label>
                <input type="text" id="lng">
            </div>
            <div>
                <label for="observacoes">Observações</label>
                <input type="text" id="observacoes">
            </div>
            <div>
                <label for="dataInicioContrato">Início do Contrato</label>
                <input type="date" id="dataInicioContrato">
            </div>
            <div>
                <button type="submit" id="btnSalvar">Adicionar</button>
            </div>
        </form>

        <div style="margin: 20px 0;">
            <input type="file" id="fileInput" accept=".csv" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()" style="background: #27ae60;">Importar Planilha</button>
            <button onclick="excluirTodosRegistros()" style="background: #c0392b; margin-left: 10px;">Excluir Todos os Registros</button>
        </div>

        <!-- Adicionar sistema de filtros -->
        <div style="margin: 20px 0; background: #eaf0fa; padding: 15px; border-radius: 8px;">
            <h3 style="color: #2a3d66; margin-top: 0;">Filtros</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                <div>
                    <label for="filtroCidade">Cidade</label>
                    <input type="text" id="filtroCidade" oninput="filtrarRegistros()" style="width: 150px;">
                </div>
                <div>
                    <label for="filtroTecnico">Técnico</label>
                    <input type="text" id="filtroTecnico" oninput="filtrarRegistros()" style="width: 200px;">
                </div>
                <div>
                    <label for="filtroAuxiliar">Auxiliar</label>
                    <input type="text" id="filtroAuxiliar" oninput="filtrarRegistros()" style="width: 200px;">
                </div>
                <div>
                    <label for="filtroPlaca">Placa</label>
                    <input type="text" id="filtroPlaca" oninput="filtrarRegistros()" style="width: 120px;">
                </div>
                <div>
                    <label for="filtroModelo">Modelo</label>
                    <input type="text" id="filtroModelo" oninput="filtrarRegistros()" style="width: 120px;">
                </div>
                <div>
                    <label for="filtroOperacao">Operação</label>
                    <select id="filtroOperacao" onchange="filtrarRegistros()" style="width: 120px;">
                        <option value="">Todos</option>
                        <option value="Megalink">Megalink</option>
                        <option value="BJ Fibra">BJ Fibra</option>
                    </select>
                </div>
                <div>
                    <button onclick="limparFiltros()" style="background: #2a3d66;">Limpar Filtros</button>
                </div>
            </div>
        </div>

        <div class="tabela-container">
            <button class="fullscreen-toggle" title="Alternar tela cheia">
                <i class="fas fa-expand"></i>
            </button>
        <table id="tabelaRegistros">
            <thead>
                <tr>
                    <th>Cidade</th>
                    <th>Nome do Técnico</th>
                    <th>Auxiliar</th>
                    <th>Placa</th>
                    <th>Modelo</th>
                    <th>Operação</th>
                    <th>Equipes Varejo e Backbone</th>
                    <th>KM Atual</th>
                    <th>Última Troca Óleo</th>
                    <th>Renavam</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Observações</th>
                    <th>Início Contrato</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Registros aparecerão aqui -->
            </tbody>
        </table>
        </div>
    </div>

    <!-- Container do Mapa -->
    <div id="mapaContainer">
        <div id="mapa"></div>
    </div>

    <!-- Notificação de Alertas de Contratos -->
    <div id="alertaContratosNotificacao">
        <div class="alerta-header">
            <span>Alertas de Contratos</span>
            <button class="alerta-close" onclick="fecharAlertaNotificacao()">&times;</button>
        </div>
        <div class="alerta-body" id="alertaContratosConteudo">
            <!-- Conteúdo dos alertas será adicionado dinamicamente -->
        </div>
        <div class="alerta-footer">
            <button class="alerta-action" onclick="verTodosAlertas()">Ver Todos os Alertas</button>
        </div>
    </div>
    
    <!-- Notificação de Manutenções Frequentes -->
    <div id="alertaManutencoesNotificacao">
        <div class="alerta-header">
            <span>Manutenções Frequentes</span>
            <button class="alerta-close" onclick="fecharAlertaManutencoesNotificacao()">&times;</button>
        </div>
        <div class="alerta-body" id="alertaManutencoesConteudo">
            <!-- Conteúdo dos alertas será adicionado dinamicamente -->
        </div>
        <div class="alerta-footer">
            <button class="alerta-action" onclick="verTodosManutencoesFrequentes()">Ver Todos os Veículos</button>
        </div>
    </div>
    
    <!-- Notificação de Troca de Óleo -->
    <div id="alertaTrocaOleoNotificacao">
        <div class="alerta-header">
            <span>Alertas de Troca de Óleo</span>
            <button class="alerta-close" onclick="fecharAlertaTrocaOleoNotificacao()">&times;</button>
        </div>
        <div class="alerta-body" id="alertaTrocaOleoConteudo">
            <!-- Conteúdo dos alertas será adicionado dinamicamente -->
        </div>
        <div class="alerta-footer">
            <button class="alerta-action" onclick="verTodosTrocaOleo()">Ver Todos os Veículos</button>
        </div>
    </div>

    <!-- Modal de Manutenção de Veículo -->
    <div id="manutencaoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001;">
        <div style="width: 500px; max-width: 90%; background: white; margin: 50px auto; padding: 20px; border-radius: 8px; position: relative;">
            <button onclick="fecharModalManutencao()" style="position: absolute; top: 10px; right: 10px; background: #c0392b; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px;">✕</button>
            <h2 style="color: #2a3d66; margin-top: 0;">Registro de Manutenção</h2>
            <p id="manutencaoVeiculoInfo" style="margin-bottom: 20px; font-weight: bold;"></p>
            
            <form id="manutencaoForm">
                <input type="hidden" id="manutencaoVeiculoId">
                <div style="margin-bottom: 15px;">
                    <label for="tipoManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Tipo de Manutenção</label>
                    <select id="tipoManutencao" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                        <option value="Troca de Óleo">Troca de Óleo</option>
                        <option value="Revisão">Revisão</option>
                        <option value="Troca de Pneus">Troca de Pneus</option>
                        <option value="Reparo de Motor">Reparo de Motor</option>
                        <option value="Elétrica">Elétrica</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="dataManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Data</label>
                    <input type="date" id="dataManutencao" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="kmManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Quilometragem</label>
                    <input type="number" id="kmManutencao" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="valorManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Valor (R$)</label>
                    <input type="number" id="valorManutencao" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="observacoesManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Observações</label>
                    <textarea id="observacoesManutencao" rows="3" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;"></textarea>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" onclick="fecharModalManutencao()" style="background: #95a5a6; color: white; border: none; border-radius: 5px; padding: 8px 15px; margin-right: 10px; cursor: pointer;">Cancelar</button>
                    <button type="submit" style="background: #2a3d66; color: white; border: none; border-radius: 5px; padding: 8px 15px; cursor: pointer;">Salvar Manutenção</button>
                </div>
            </form>
            
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <h3 style="color: #2a3d66; margin-top: 0; font-size: 16px;">Histórico de Manutenções</h3>
                <div id="historicoManutencao" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let registros = [];
        let editIndex = null;

        // Carregar registros do localStorage ao iniciar
        function carregarRegistros() {
            const dados = localStorage.getItem('registrosFTTH');
            if (dados) {
                try {
                    registros = JSON.parse(dados);
                } catch (e) {
                    registros = [];
                }
            }
        }

        // Salvar registros no localStorage
        function salvarRegistros() {
            localStorage.setItem('registrosFTTH', JSON.stringify(registros));
        }

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            // Adicionar código de depuração temporário para verificar permissões
            console.log('Usuário atual:', currentUser);
            console.log('Nível de acesso:', currentUser.accessLevel);
            console.log('É administrador?', currentUser.accessLevel === 'ADMIN');
            console.log('Permissões personalizadas?', currentUser.customPermissions);
            console.log('Lista de permissões:', currentUser.permissions);
            console.log('Tem permissão MANAGE_USERS?', Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS));
            
            // Listar todas as permissões disponíveis no nível de acesso do usuário
            if (currentUser.accessLevel && Auth.ACCESS_LEVELS[currentUser.accessLevel]) {
                console.log('Permissões do nível de acesso:', Auth.ACCESS_LEVELS[currentUser.accessLevel].permissions);
            }
            
            // Verificar permissões de visualização
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_TECHNICIANS)) {
                alert('Você não tem permissão para acessar esta página.');
                window.location.href = 'login.html';
                return;
            }
            
            // Configurar informações do usuário
            document.getElementById('currentUserName').textContent = `${currentUser.name} (${Auth.ACCESS_LEVELS[currentUser.accessLevel].name})`;
            
            // Se for administrador, mostrar botão de administração imediatamente
            if (currentUser.accessLevel === 'ADMIN') {
                const adminButton = document.getElementById('adminButton');
                adminButton.style.display = 'block';
                adminButton.addEventListener('click', () => {
                    localStorage.setItem('adminOriginPage', 'Pagina1 (1).html');
                    window.location.href = 'admin.html';
                });
            }
            
            // Configurar botão de logout
            document.getElementById('logoutButton').addEventListener('click', () => {
                Auth.logout();
                // Remove o redirecionamento aqui, já que está implementado na função Auth.logout()
            });
            
            // Configurar botão de fullscreen para a tabela
            setupFullscreenToggle();
            
            // Verificar permissão para visualizar por operação
            const filtroOperacao = document.getElementById('filtroOperacao');
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION)) {
                // Se o usuário tem uma operação atribuída, mostrar apenas essa operação
                if (currentUser.operacao) {
                    filtroOperacao.value = currentUser.operacao;
                    filtroOperacao.disabled = true;
                    filtroOperacao.style.backgroundColor = '#f0f0f0';
                } else {
                    // Se não tem uma operação específica, desativar a filtragem por operação
                    filtroOperacao.parentElement.style.display = 'none';
                }
            } else {
                // Se tem permissão, não precisa fazer nada especial
            }
            
            // Adicionar evento ao botão de estatísticas
            document.getElementById('mostrarEstatisticas').addEventListener('click', mostrarEstatisticasPorCidade);
            
            // Adicionar evento ao botão do mapa
            document.getElementById('verMapa').addEventListener('click', mostrarMapa);
            
            // Verificar permissão para ver o mapa
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_MAP)) {
                document.getElementById('verMapa').style.display = 'none';
            }
            
            // Verificar permissão para ver estatísticas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_STATISTICS)) {
                document.getElementById('mostrarEstatisticas').style.display = 'none';
            }
            
            // Carregar registros e renderizar a tabela
            carregarRegistros();
            renderizarTabela();
            atualizarEstatisticas();
            atualizarBadgeNotificacoes();
            
            // Ajustar funcionalidades baseado nas permissões
            ajustarPermissoes();
            
            // Verificar permissões e ajustar a interface
            checkPermissions();
        });
        
        // Função para ajustar a interface baseada nas permissões do usuário
        function ajustarPermissoes() {
            // Verificar se Auth está disponível
            if (!window.Auth) {
                console.error('Auth não disponível em ajustarPermissoes');
                return;
            }
            
            // Obter usuário atual
            const currentUser = Auth.getCurrentUser();
            if (!currentUser) {
                console.warn('Usuário não autenticado em ajustarPermissoes');
                return;
            }
            
            const btnAdicionar = document.getElementById('btnAdicionar');
            const btnLimpar = document.getElementById('btnLimpar');
            const table = document.getElementById('tabelaRegistros');
            
            // Permissão para adicionar técnicos
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.ADD_TECHNICIAN)) {
                if (btnAdicionar) btnAdicionar.style.display = 'none';
                if (btnLimpar) btnLimpar.style.display = 'none';
                
                const formRegistro = document.getElementById('formRegistro');
                if (formRegistro) formRegistro.style.display = 'none';
            }
            
            // Verificar se a tabela existe
            if (!table) {
                console.warn('Tabela de registros não encontrada em ajustarPermissoes');
                return;
            }
            
            // Esconder os botões de editar e excluir para quem não tem permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TECHNICIAN) && 
                !Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                
                const acoes = table.querySelectorAll('.actions');
                acoes.forEach(acao => {
                    acao.style.display = 'none';
                });
            }
            // Esconder apenas o botão de exclusão
            else if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                const botoesExcluir = table.querySelectorAll('.btnExcluir');
                botoesExcluir.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            // Esconder apenas o botão de edição
            else if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TECHNICIAN)) {
                const botoesEditar = table.querySelectorAll('.btnEditar');
                botoesEditar.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }
        
        // Função para adicionar um novo registro
        function adicionarRegistro(event) {
            event.preventDefault();
            
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.ADD_TECHNICIAN)) {
                alert('Você não tem permissão para adicionar registros.');
                return;
            }
            
            // ... resto do código existente ...
        }
        
        // Função para editar um registro
        function editarRegistro(index) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TECHNICIAN)) {
                alert('Você não tem permissão para editar registros.');
                return;
            }
            
            // ... resto do código existente ...
        }
        
        // Função para excluir um registro
        function excluirRegistro(index) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                alert('Você não tem permissão para excluir registros.');
                return;
            }
            
            // ... resto do código existente ...
        }
        
        // Função para renderizar a tabela após alterações
        function renderizarTabela() {
            // Verificar se Auth está disponível e se usuário está autenticado
            if (!window.Auth) {
                console.error('Auth não disponível. A autenticação pode não ter sido inicializada corretamente.');
                setTimeout(() => {
                    // Tentar novamente em 500ms, dando tempo para Auth carregar
                    if (window.Auth) {
                        renderizarTabela();
                    } else {
                        console.error('Auth ainda não disponível após aguardar. Redirecionando para login.');
                        window.location.href = 'login.html';
                    }
                }, 500);
                return;
            }
            
            // Obter usuário atual
            const currentUser = Auth.getCurrentUser();
            if (!currentUser) {
                console.warn('Usuário não autenticado ao renderizar tabela.');
                window.location.href = 'login.html';
                return;
            }
            
            renderTabelaFiltrada(registros);
            atualizarEstatisticas();
            // Aplicar ajustes de permissões após renderizar a tabela
            setTimeout(ajustarPermissoes, 100);
        }
        
        // Alias para manter compatibilidade com o código existente
        function renderTabela() {
            renderizarTabela();
        }
        
        // Verificar permissões e ajustar a interface
        function checkPermissions() {
            const adminButton = document.getElementById('adminButton');
            const notificationSystem = document.getElementById('notificationSystem');
            
            // Verificar se é administrador OU tem permissão de gerenciar usuários
            if (currentUser.accessLevel === 'ADMIN' || Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                adminButton.style.display = 'block';
                adminButton.addEventListener('click', () => {
                    // Armazenar a página de origem antes de redirecionar
                    localStorage.setItem('adminOriginPage', 'Pagina1 (1).html');
                    window.location.href = 'admin.html';
                });
                
                // Inicializar sistema de notificações para administradores
                if (notificationSystem) {
                    notificationSystem.style.display = 'block';
                    
                    // Configurar eventos do sistema de notificações
                    setupNotificationSystem();
                }
            }
        }
        
        // Configurar sistema de notificações
        function setupNotificationSystem() {
            const notificationButton = document.getElementById('notificationButton');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const markAllReadButton = document.getElementById('markAllReadButton');
            
            // Carregar notificações do localStorage
            let notifications = JSON.parse(localStorage.getItem('adminNotifications')) || [];
            
            // Atualizar contador de notificações
            updateNotificationCount(notifications);
            
            // Adicionar evento de clique ao botão de notificações
            notificationButton.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.style.display = notificationDropdown.style.display === 'none' ? 'block' : 'none';
                
                // Renderizar lista de notificações
                renderNotificationList(notifications);
            });
            
            // Adicionar evento de clique ao botão de marcar todas como lidas
            markAllReadButton.addEventListener('click', function(e) {
                e.stopPropagation();
                markAllNotificationsAsRead(notifications);
            });
            
            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function() {
                if (notificationDropdown.style.display === 'block') {
                    notificationDropdown.style.display = 'none';
                }
            });
            
            // Evitar que o clique no dropdown feche ele
            notificationDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Atualizar contador de notificações
        function updateNotificationCount(notifications) {
            const notificationCount = document.getElementById('notificationCount');
            const unreadCount = notifications.filter(notif => !notif.read).length;
            
            notificationCount.textContent = unreadCount;
            notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
        
        // Renderizar lista de notificações
        function renderNotificationList(notifications) {
            const notificationList = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        Nenhuma notificação
                    </div>
                `;
                return;
            }
            
            notificationList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" data-id="${notification.id}" style="padding: 10px 15px; border-bottom: 1px solid #e0e6f0; transition: background-color 0.2s; ${!notification.read ? 'background-color: #f0f7ff;' : ''}">
                    ${!notification.read ? '<div style="position: absolute; top: 7px; right: 7px; width: 8px; height: 8px; background-color: #c0392b; border-radius: 50%;"></div>' : ''}
                    <div style="font-weight: bold; margin-bottom: 3px; font-size: 14px;">${notification.title}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${notification.message}</div>
                    <div style="font-size: 11px; color: #666; text-align: right;">${formatTimeAgo(notification.timestamp)}</div>
                </div>
            `).join('');
            
            // Adicionar evento de clique para marcar como lida
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', () => {
                    const notificationId = parseInt(item.dataset.id);
                    markNotificationAsRead(notificationId, notifications);
                });
            });
        }
        
        // Função para marcar notificação como lida
        function markNotificationAsRead(id, notifications) {
            const index = notifications.findIndex(notif => notif.id === id);
            if (index !== -1) {
                notifications[index].read = true;
                localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                updateNotificationCount(notifications);
                renderNotificationList(notifications);
            }
        }
        
        // Função para marcar todas as notificações como lidas
        function markAllNotificationsAsRead(notifications) {
            notifications.forEach(notif => {
                notif.read = true;
            });
            localStorage.setItem('adminNotifications', JSON.stringify(notifications));
            updateNotificationCount(notifications);
            renderNotificationList(notifications);
        }
        
        // Função para formatar tempo relativo
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'agora mesmo';
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} ${minutes === 1 ? 'minuto' : 'minutos'} atrás`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} ${hours === 1 ? 'hora' : 'horas'} atrás`;
            
            const days = Math.floor(hours / 24);
            if (days < 30) return `${days} ${days === 1 ? 'dia' : 'dias'} atrás`;
            
            const months = Math.floor(days / 30);
            if (months < 12) return `${months} ${months === 1 ? 'mês' : 'meses'} atrás`;
            
            const years = Math.floor(months / 12);
            return `${years} ${years === 1 ? 'ano' : 'anos'} atrás`;
        }

        function atualizarEstatisticas() {
            // Verificar se Auth está disponível
            if (!window.Auth) {
                console.error('Auth não disponível em atualizarEstatisticas');
                return;
            }
            
            // Obter usuário atual
            const currentUser = Auth.getCurrentUser();
            if (!currentUser) {
                console.warn('Usuário não autenticado em atualizarEstatisticas');
                return;
            }
            
            // Verificar permissão para visualizar todas operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Filtrar registros pela operação do usuário se necessário
            let registrosFiltrados = registros;
            if (!podeVerTodasOperacoes && currentUser.operacao) {
                registrosFiltrados = registros.filter(r => r.operacao === currentUser.operacao);
            }
            
            // Total de técnicos (nomes únicos)
            const tecnicosUnicos = new Set(registrosFiltrados.map(r => r.tecnico.toLowerCase().trim()));
            
            // Total de auxiliares (nomes únicos)
            const auxiliaresUnicos = new Set();
            registrosFiltrados.forEach(r => {
                if (r.auxiliar && r.auxiliar.trim()) {
                    auxiliaresUnicos.add(r.auxiliar.toLowerCase().trim());
                }
            });
            
            // Total de pessoal técnico (técnicos + auxiliares)
            const totalPessoalTecnico = tecnicosUnicos.size + auxiliaresUnicos.size;
            
            document.getElementById("totalTecnicos").textContent = totalPessoalTecnico;
            
            // Total de veículos (placas únicas, apenas registros com placa)
            const veiculosUnicos = new Set();
            registrosFiltrados.forEach(r => {
                if (r.placa && r.placa.trim()) {
                    veiculosUnicos.add(r.placa.toUpperCase().trim());
                }
            });
            document.getElementById("totalVeiculos").textContent = veiculosUnicos.size;
            
            // Total de cidades distintas
            const cidadesUnicas = new Set(registrosFiltrados.map(r => r.cidade.toLowerCase().trim()));
            document.getElementById("totalCidades").textContent = cidadesUnicas.size;
            
            // Técnicos por operação
            const bjfibraTecnicos = new Set(registrosFiltrados.filter(r => r.operacao === "BJ Fibra").map(r => r.tecnico.toLowerCase().trim()));
            const bjfibraAuxiliares = new Set();
            registrosFiltrados.filter(r => r.operacao === "BJ Fibra").forEach(r => {
                if (r.auxiliar && r.auxiliar.trim()) {
                    bjfibraAuxiliares.add(r.auxiliar.toLowerCase().trim());
                }
            });
            
            const megalinkTecnicos = new Set(registrosFiltrados.filter(r => r.operacao === "Megalink").map(r => r.tecnico.toLowerCase().trim()));
            const megalinkAuxiliares = new Set();
            registrosFiltrados.filter(r => r.operacao === "Megalink").forEach(r => {
                if (r.auxiliar && r.auxiliar.trim()) {
                    megalinkAuxiliares.add(r.auxiliar.toLowerCase().trim());
                }
            });
            
            document.getElementById("bjfibraCount").textContent = bjfibraTecnicos.size + bjfibraAuxiliares.size;
            document.getElementById("megalinkCount").textContent = megalinkTecnicos.size + megalinkAuxiliares.size;
            
            // Mostrar/ocultar contadores por operação com base nas permissões
            const bjfibraContainer = document.getElementById("bjfibraContainer");
            const megalinkContainer = document.getElementById("megalinkContainer");
            const bjfibraVeiculosContainer = document.getElementById("bjfibraVeiculosContainer");
            const megalinkVeiculosContainer = document.getElementById("megalinkVeiculosContainer");
            
            if (!podeVerTodasOperacoes && currentUser.operacao) {
                // Se o usuário só pode ver uma operação, mostrar apenas a sua
                bjfibraContainer.style.display = currentUser.operacao === "BJ Fibra" ? "block" : "none";
                megalinkContainer.style.display = currentUser.operacao === "Megalink" ? "block" : "none";
                bjfibraVeiculosContainer.style.display = currentUser.operacao === "BJ Fibra" ? "block" : "none";
                megalinkVeiculosContainer.style.display = currentUser.operacao === "Megalink" ? "block" : "none";
            } else {
                // Se pode ver todas, mostrar ambas
                bjfibraContainer.style.display = "block";
                megalinkContainer.style.display = "block";
                bjfibraVeiculosContainer.style.display = "block";
                megalinkVeiculosContainer.style.display = "block";
            }
            
            // Veículos por operação
            const bjfibraVeiculos = new Set();
            registrosFiltrados.filter(r => r.operacao === "BJ Fibra").forEach(r => {
                if (r.placa && r.placa.trim()) {
                    bjfibraVeiculos.add(r.placa.toUpperCase().trim());
                }
            });
            
            const megalinkVeiculos = new Set();
            registrosFiltrados.filter(r => r.operacao === "Megalink").forEach(r => {
                if (r.placa && r.placa.trim()) {
                    megalinkVeiculos.add(r.placa.toUpperCase().trim());
                }
            });
            
            document.getElementById("bjfibraVeiculosCount").textContent = bjfibraVeiculos.size;
            document.getElementById("megalinkVeiculosCount").textContent = megalinkVeiculos.size;

            // Estatísticas por cidade
            const estatisticasPorCidade = {};
            registrosFiltrados.forEach(reg => {
                const cidade = reg.cidade.trim();
                if (!cidade) return;

                if (!estatisticasPorCidade[cidade]) {
                    estatisticasPorCidade[cidade] = {
                        tecnicos: new Set(),
                        auxiliares: new Set(),
                        veiculos: new Set(),
                        veiculosComAuxiliar: new Set()
                    };
                }

                if (reg.tecnico) {
                    estatisticasPorCidade[cidade].tecnicos.add(reg.tecnico.toLowerCase().trim());
                }
                if (reg.auxiliar && reg.auxiliar.trim()) {
                    estatisticasPorCidade[cidade].auxiliares.add(reg.auxiliar.toLowerCase().trim());
                    
                    // Só contador como veículo com auxiliar se tiver placa 
                    if (reg.placa && reg.placa.trim()) {
                        estatisticasPorCidade[cidade].veiculosComAuxiliar.add(reg.placa.toUpperCase().trim());
                    }
                }
                if (reg.placa && reg.placa.trim()) {
                    estatisticasPorCidade[cidade].veiculos.add(reg.placa.toUpperCase().trim());
                }
            });

            // Remover aviso anterior se existir
            const avisoAnterior = document.getElementById('avisoFiltroOperacao');
            if (avisoAnterior) {
                avisoAnterior.remove();
            }
        }

        document.getElementById("registroForm").onsubmit = function(e) {
            e.preventDefault();
            const cidade = document.getElementById("cidade").value.trim().toUpperCase();
            const tecnico = document.getElementById("tecnico").value.trim().toUpperCase();
            const auxiliar = document.getElementById("auxiliar").value.trim().toUpperCase();
            const placa = document.getElementById("placa").value.trim().toUpperCase();
            const modelo = document.getElementById("modelo").value.trim().toUpperCase();
            const operacao = document.getElementById("operacao").value;
            const equipes = document.getElementById("equipes").value.trim().toUpperCase();
            const kmAtual = document.getElementById("kmAtual").value.trim().toUpperCase();
            // Não pegar o valor de ultimaTrocaOleoInfo pois é somente leitura
            const renavam = document.getElementById("renavam").value.trim().toUpperCase();
            const lat = document.getElementById("lat").value.trim();
            const lng = document.getElementById("lng").value.trim();
            const observacoes = document.getElementById("observacoes").value.trim().toUpperCase();
            const dataInicioContrato = document.getElementById("dataInicioContrato").value;

            if (editIndex === null) {
                registros.push({ 
                    cidade, tecnico, auxiliar, placa, modelo, operacao, equipes, 
                    kmAtual, ultimaTrocaOleo: '', renavam, lat, lng, observacoes, dataInicioContrato,
                    manutencoes: [] // Inicializar o array de manutenções vazio para novos registros
                });
            } else {
                // Preservar o histórico de manutenções e outros dados que não estão no formulário
                const manutencoes = registros[editIndex].manutencoes || [];
                const placaOuId = registros[editIndex].placaOuId; // Preservar ID único se existir
                const semVeiculo = registros[editIndex].semVeiculo; // Preservar flag se existir
                const ultimaTrocaOleo = registros[editIndex].ultimaTrocaOleo; // Preservar a última troca de óleo
                
                registros[editIndex] = { 
                    cidade, tecnico, auxiliar, placa, modelo, operacao, equipes, 
                    kmAtual, ultimaTrocaOleo, renavam, lat, lng, observacoes, dataInicioContrato,
                    manutencoes, // Manter o histórico de manutenções existente
                    placaOuId, // Restaurar ID único se existir
                    semVeiculo // Restaurar flag se existir
                };
                editIndex = null;
                document.getElementById("btnSalvar").textContent = "Adicionar";
            }
            this.reset();
            salvarRegistros();
            renderTabela();
        };

        window.editarRegistro = function(idx) {
            const reg = registros[idx];
            document.getElementById("cidade").value = reg.cidade;
            document.getElementById("tecnico").value = reg.tecnico;
            document.getElementById("auxiliar").value = reg.auxiliar || '';
            document.getElementById("placa").value = reg.placa;
            document.getElementById("modelo").value = reg.modelo;
            document.getElementById("operacao").value = reg.operacao || '';
            document.getElementById("equipes").value = reg.equipes || '';
            document.getElementById("kmAtual").value = reg.kmAtual || '';
            document.getElementById("ultimaTrocaOleoInfo").value = reg.ultimaTrocaOleo || '';
            document.getElementById("renavam").value = reg.renavam || '';
            document.getElementById("lat").value = reg.lat || '';
            document.getElementById("lng").value = reg.lng || '';
            document.getElementById("observacoes").value = reg.observacoes || '';
            document.getElementById("dataInicioContrato").value = reg.dataInicioContrato || '';
            editIndex = idx;
            document.getElementById("btnSalvar").textContent = "Salvar";
        };

        window.removerRegistro = function(idx) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                alert('Você não tem permissão para excluir registros.');
                return;
            }
            
            if (confirm("Tem certeza que deseja remover este registro?")) {
                registros.splice(idx, 1);
                salvarRegistros();
                renderTabela();
            }
        };

        // Adicionar função para importar CSV
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    let importCount = 0;
                    let duplicateCount = 0;
                    let tecnicosSemVeiculoCount = 0;
                    let registrosComProblema = [];
                    let linhasIgnoradas = 0;
                    
                    console.log("Iniciando importação CSV...");
                    
                    // Pular a linha de cabeçalho
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            try {
                                // Dividir a linha usando ponto e vírgula como separador
                                const values = lines[i].split(';').map(v => v.trim());
                                
                                // Verificar se tem técnico e cidade
                                const temTecnico = values[1] && values[1].trim();
                                const temCidade = values[0] && values[0].trim();
                                
                                // Se não tem nem técnico nem cidade, pular
                                if (!temTecnico && !temCidade) {
                                    linhasIgnoradas++;
                                    continue;
                                }
                                
                                // Extrair latitude e longitude do formato atual
                                let lat = '';
                                let lng = '';
                                
                                if (values[9] && values[10]) {
                                    try {
                                        if (values[5] === "BJ Fibra") {
                                            // Formato BJ Fibra: lat: -6.4037;"""lng"": -41.7382}"
                                            lat = values[9].replace('lat:', '').replace(/"/g, '').trim();
                                            lng = values[10].replace('"""lng"":', '').replace(/"/g, '').replace('}', '').trim();
                                        } else {
                                            // Formato Megalink: lat: -5.890250;" ""lng"": -42.636018}"
                                            lat = values[9].replace('lat:', '').trim();
                                            lng = values[10].replace('" ""lng"":', '').replace('}"', '').trim();
                                        }

                                        // Garantir que as coordenadas estejam no formato correto
                                        lat = lat.replace(/,/g, '.').replace(/[^0-9.-]/g, '');
                                        lng = lng.replace(/,/g, '.').replace(/[^0-9.-]/g, '');
                                        
                                        // Verificar se as coordenadas são válidas
                                        const latNum = parseFloat(lat);
                                        const lngNum = parseFloat(lng);
                                        
                                        if (isNaN(latNum) || isNaN(lngNum)) {
                                            registrosComProblema.push({
                                                linha: i + 1,
                                                cidade: values[0] || 'Não informada',
                                                tecnico: values[1] || 'Não informado',
                                                placa: values[3] || 'Sem placa',
                                                problema: 'Coordenadas inválidas',
                                                valores: `Lat: "${lat}", Lng: "${lng}"`
                                            });
                                        }
                                    } catch (coordError) {
                                        registrosComProblema.push({
                                            linha: i + 1,
                                            cidade: values[0] || 'Não informada',
                                            tecnico: values[1] || 'Não informado',
                                            placa: values[3] || 'Sem placa',
                                            problema: 'Erro ao extrair coordenadas',
                                            erro: coordError.message
                                        });
                                    }
                                }

                                // Verificar se a placa existe
                                const placa = values[3] ? values[3].trim() : '';
                                
                                // Se não tem placa mas tem técnico, criar um ID único
                                let placaOuId = placa;
                                if (!placa && temTecnico) {
                                    // Criar um ID baseado na cidade e no nome do técnico
                                    placaOuId = `SEM_PLACA_${values[0]}_${values[1]}`.toUpperCase().replace(/\s+/g, '_');
                                    tecnicosSemVeiculoCount++;
                                    console.log(`Técnico sem veículo: ${values[1]} (${values[0]}), ID gerado: ${placaOuId}`);
                                }
                                
                                // Debug: imprimir linha que contém Guadalupe
                                if (values[0] && values[0].includes('GUADALUPE')) {
                                    console.log('Encontrou registro de Guadalupe:', values);
                                }

                                const registro = {
                                    cidade: values[0] || '',
                                    tecnico: values[1] || '',
                                    auxiliar: values[2] || '',
                                    placa: placa,
                                    placaOuId: placaOuId,
                                    modelo: values[4] || '',
                                    operacao: values[5] || '',
                                    equipes: values[6] || '',
                                    ultimaTrocaOleo: values[7] || '',
                                    renavam: values[8] || '',
                                    lat: lat,
                                    lng: lng,
                                    observacoes: values[11] || '',
                                    semVeiculo: !placa && temTecnico,
                                    dataInicioContrato: values[12] ? values[12].trim() : null
                                };

                                // Se não tem placa nem técnico, pular
                                if (!placaOuId) {
                                    registrosComProblema.push({
                                        linha: i + 1,
                                        cidade: values[0] || 'Não informada',
                                        problema: 'Registro sem identificação (sem técnico e sem placa)'
                                    });
                                    continue;
                                }

                                // Verificar se o registro já existe (baseado na placa ou ID)
                                const registroExistente = registros.findIndex(r => 
                                    r.placaOuId && r.placaOuId.toUpperCase() === registro.placaOuId.toUpperCase()
                                );
                                
                                if (registroExistente >= 0) {
                                    duplicateCount++;
                                    
                                    // Preservar o histórico de manutenções do registro existente
                                    const manutencoesExistentes = registros[registroExistente].manutencoes || [];
                                    
                                    // Se for Guadalupe, ou se a cidade atual estiver preenchida e a existente não, atualize o registro
                                    if (registro.cidade.includes('GUADALUPE') || 
                                        (registro.cidade && !registros[registroExistente].cidade)) {
                                        console.log(`Atualizando registro existente para ID ${registro.placaOuId} da cidade ${registro.cidade}`);
                                        // Adicionar as manutenções existentes ao registro atualizado
                                        registro.manutencoes = manutencoesExistentes;
                                        registros[registroExistente] = registro;
                                    } else {
                                        // Mesmo que não atualize outros campos, garantir que as manutenções são preservadas
                                        registros[registroExistente].manutencoes = manutencoesExistentes;
                                    }
                                } else {
                                    // Novo registro, inicializar o array de manutenções vazio
                                    registro.manutencoes = [];
                                    registros.push(registro);
                                    importCount++;
                                }
                            } catch (error) {
                                // Registrar erro de processamento
                                registrosComProblema.push({
                                    linha: i + 1,
                                    conteudo: lines[i],
                                    problema: 'Erro no processamento',
                                    erro: error.message
                                });
                            }
                        } else {
                            linhasIgnoradas++;
                        }
                    }
                    salvarRegistros();
                    renderTabela();
                    console.log(`Importação concluída. ${importCount} registros importados, ${duplicateCount} duplicados tratados, ${tecnicosSemVeiculoCount} técnicos sem veículo.`);
                    
                    // Exibir resultado da importação com detalhes
                    let mensagem = `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 10px; color: #2a3d66;">Resultado da Importação</div>
                            <ul style="margin-bottom: 15px; padding-left: 20px;">
                                <li><span style="color: #27ae60; font-weight: bold;">${importCount}</span> novos registros importados</li>
                                <li><span style="color: #f39c12; font-weight: bold;">${duplicateCount}</span> registros existentes verificados</li>
                                <li><span style="color: #3498db; font-weight: bold;">${tecnicosSemVeiculoCount}</span> técnicos sem veículo</li>
                                <li><span style="color: #95a5a6; font-weight: bold;">${linhasIgnoradas}</span> linhas vazias ignoradas</li>
                            </ul>
                    `;
                    
                    // Adicionar informações de problemas, se houver
                    if (registrosComProblema.length > 0) {
                        mensagem += `
                            <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">
                                Atenção: ${registrosComProblema.length} registros com problemas foram encontrados!
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e74c3c; padding: 10px; margin-bottom: 15px; background: #fff5f5; border-radius: 5px;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="background: #e74c3c; color: white; text-align: left;">
                                        <th style="padding: 5px;">Linha</th>
                                        <th style="padding: 5px;">Local</th>
                                        <th style="padding: 5px;">Problema</th>
                                    </tr>
                        `;
                        
                        registrosComProblema.forEach((problema, index) => {
                            mensagem += `
                                <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: rgba(255,255,255,0.6);' : ''}">
                                    <td style="padding: 5px;">${problema.linha}</td>
                                    <td style="padding: 5px;">${problema.cidade || ''} ${problema.placa ? `(${problema.placa})` : ''}</td>
                                    <td style="padding: 5px;">${problema.problema}</td>
                                </tr>
                            `;
                        });
                        
                        mensagem += `
                                </table>
                            </div>
                        `;
                    }
                    
                    // Fechar div principal
                    mensagem += `</div>`;
                    
                    // Mostrar modal com resultado
                    mostrarModalResultadoImportacao(mensagem);
                };
                reader.readAsText(file, 'ISO-8859-1');
            }
        });
        
        // Função para mostrar modal com resultado da importação
        function mostrarModalResultadoImportacao(conteudo) {
            // Criar o modal
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '2000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Criar o conteúdo do modal
            const modalContent = document.createElement('div');
            modalContent.style.background = 'white';
            modalContent.style.padding = '25px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '600px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflow = 'auto';
            modalContent.style.position = 'relative';
            modalContent.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
            
            // Adicionar título
            const titulo = document.createElement('div');
            titulo.style.fontSize = '1.4em';
            titulo.style.fontWeight = 'bold';
            titulo.style.marginBottom = '15px';
            titulo.style.color = '#2a3d66';
            titulo.style.paddingBottom = '10px';
            titulo.style.borderBottom = '2px solid #eee';
            titulo.textContent = 'Resultado da Importação';
            
            // Adicionar botão de fechar
            const btnFechar = document.createElement('button');
            btnFechar.innerHTML = '×';
            btnFechar.style.position = 'absolute';
            btnFechar.style.top = '15px';
            btnFechar.style.right = '15px';
            btnFechar.style.background = '#e74c3c';
            btnFechar.style.color = 'white';
            btnFechar.style.border = 'none';
            btnFechar.style.borderRadius = '50%';
            btnFechar.style.width = '30px';
            btnFechar.style.height = '30px';
            btnFechar.style.fontSize = '20px';
            btnFechar.style.cursor = 'pointer';
            btnFechar.style.display = 'flex';
            btnFechar.style.justifyContent = 'center';
            btnFechar.style.alignItems = 'center';
            
            // Adicionar conteúdo personalizado
            const conteudoDiv = document.createElement('div');
            conteudoDiv.innerHTML = conteudo;
            
            // Adicionar botão "OK"
            const btnOk = document.createElement('button');
            btnOk.textContent = 'OK';
            btnOk.style.background = '#2a3d66';
            btnOk.style.color = 'white';
            btnOk.style.border = 'none';
            btnOk.style.borderRadius = '5px';
            btnOk.style.padding = '10px 20px';
            btnOk.style.marginTop = '15px';
            btnOk.style.cursor = 'pointer';
            btnOk.style.fontSize = '1em';
            btnOk.style.fontWeight = 'bold';
            btnOk.style.width = '100%';
            
            // Adicionar evento para fechar o modal
            const fecharModal = () => {
                document.body.removeChild(modal);
            };
            
            btnFechar.addEventListener('click', fecharModal);
            btnOk.addEventListener('click', fecharModal);
            
            // Montar o modal
            modalContent.appendChild(titulo);
            modalContent.appendChild(btnFechar);
            modalContent.appendChild(conteudoDiv);
            modalContent.appendChild(btnOk);
            modal.appendChild(modalContent);
            
            // Adicionar à página
            document.body.appendChild(modal);
        }

        // Adicionar função para excluir todos os registros
        window.excluirTodosRegistros = function() {
            if (confirm("Tem certeza que deseja excluir TODOS os registros? Esta ação não pode ser desfeita.")) {
                registros = [];
                salvarRegistros();
                renderTabela();
                alert("Todos os registros foram excluídos com sucesso!");
            }
        };

        // Inicializa a tabela com dados do localStorage
        carregarRegistros();
        
        // Verificar e corrigir problemas automicamente
        setTimeout(() => {
            const duplicadosRemovidos = limparRegistrosDuplicados();
            const guadalupeAdicionado = adicionarRegistroGuadalupe();
            
            if (duplicadosRemovidos > 0 || guadalupeAdicionado) {
                console.log(`Correção automática: ${duplicadosRemovidos} duplicados removidos, Guadalupe ${guadalupeAdicionado ? 'adicionado' : 'já existente'}`);
            }
            
        renderTabela();
            
            // Verificar alertas de contratos e manutenções frequentes após carregar a tabela
            verificarAlertasContratos();
            verificarAlertasManutencoesFrequentes();
            verificarAlertasTrocaOleo();
        }, 500);
        
        // Adicionar um botão para corrigir registros
        const divBotoes = document.querySelector('div[style="margin: 20px 0;"]');
        const btnCorrigir = document.createElement('button');
        btnCorrigir.textContent = 'Corrigir Registros';
        btnCorrigir.style.background = '#3498db';
        btnCorrigir.style.marginLeft = '10px';
        btnCorrigir.onclick = function() {
            // Armazenar registros antes das correções para comparação posterior
            const registrosAntes = JSON.parse(JSON.stringify(registros));
            
            // Aplicar correções
            const duplicadosRemovidos = limparRegistrosDuplicados();
            const guadalupeAdicionado = adicionarRegistroGuadalupe();
            
            // Preparar relatório detalhado
            let relatorio = `<div style="max-height: 500px; overflow-y: auto;">
                <div style="margin-bottom: 15px;">
                    <h3 style="margin-top: 0; color: #2a3d66; font-size: 1.3em;">Relatório de Correções</h3>`;
            
            // Detalhes sobre os registros duplicados
            if (duplicadosRemovidos > 0) {
                relatorio += `<div style="margin-bottom: 20px;">
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;">
                        ${duplicadosRemovidos} registros duplicados removidos
                    </div>
                    <div style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; background: #f9f9f9; border-radius: 5px; padding: 10px;">`;
                
                // Encontrar quais registros foram removidos
                const registrosRemovidos = [];
                const idRegistrosDepois = new Set(registros.map(r => r.placaOuId || r.placa));
                
                registrosAntes.forEach(regAntigo => {
                    const id = regAntigo.placaOuId || regAntigo.placa;
                    if (id && !idRegistrosDepois.has(id)) {
                        registrosRemovidos.push(regAntigo);
                    }
                });
                
                if (registrosRemovidos.length > 0) {
                    relatorio += `<table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: #eee; font-weight: bold;">
                            <th style="padding: 8px; text-align: left;">Placa/ID</th>
                            <th style="padding: 8px; text-align: left;">Técnico</th>
                            <th style="padding: 8px; text-align: left;">Cidade</th>
                            <th style="padding: 8px; text-align: left;">Motivo</th>
                        </tr>`;
                    
                    registrosRemovidos.forEach(reg => {
                        // Encontrar o registro mantido para comparar
                        const registroMantido = registros.find(r => 
                            (r.placa && r.placa.toUpperCase() === reg.placa?.toUpperCase()) ||
                            (r.placaOuId && reg.placaOuId && r.placaOuId.toUpperCase() === reg.placaOuId.toUpperCase())
                        );
                        
                        const motivo = registroMantido ? 
                            "Duplicado: registro mais completo mantido" : 
                            "Duplicado: registro mais recente mantido";
                        
                        relatorio += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${reg.placa || reg.placaOuId || 'N/A'}</td>
                            <td style="padding: 8px;">${reg.tecnico || 'N/A'}</td>
                            <td style="padding: 8px;">${reg.cidade || 'N/A'}</td>
                            <td style="padding: 8px;">${motivo}</td>
                        </tr>`;
                    });
                    
                    relatorio += `</table>`;
                } else {
                    relatorio += `<p style="color: #666; font-style: italic;">Detalhes não disponíveis para os registros removidos.</p>`;
                }
                
                relatorio += `</div></div>`;
            } else {
                relatorio += `<div style="margin-bottom: 10px; color: #27ae60;">
                    <p>✓ Não foram encontrados registros duplicados.</p>
                </div>`;
            }
            
            // Detalhes sobre a correção do registro de Guadalupe
            if (guadalupeAdicionado) {
                // Encontrar o registro de Guadalupe
                const regGuadalupe = registros.find(r => 
                    r.cidade.includes('GUADALUPE') && r.placa === 'QRS-4J09');
                
                relatorio += `<div style="margin-bottom: 20px;">
                    <div style="font-weight: bold; color: #3498db; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;">
                        Registro de Guadalupe ${regGuadalupe ? 'adicionado/corrigido' : 'processado'}
                    </div>`;
                
                if (regGuadalupe) {
                    relatorio += `<div style="background: #f0f9ff; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: #2a3d66;">Placa:</div>
                            <div>${regGuadalupe.placa}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Técnico:</div>
                            <div>${regGuadalupe.tecnico}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Auxiliar:</div>
                            <div>${regGuadalupe.auxiliar || 'N/A'}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Modelo:</div>
                            <div>${regGuadalupe.modelo}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Coordenadas:</div>
                            <div>Lat: ${regGuadalupe.lat}, Lng: ${regGuadalupe.lng}</div>
                        </div>
                        <div style="font-style: italic; color: #666; font-size: 0.9em;">
                            Este é um registro especial que deve ser mantido no sistema.
                        </div>
                    </div>`;
                }
                
                relatorio += `</div>`;
            } else {
                relatorio += `<div style="margin-bottom: 10px; color: #27ae60;">
                    <p>✓ O registro de Guadalupe já existe e está correto.</p>
                </div>`;
            }
            
            if (duplicadosRemovidos === 0 && !guadalupeAdicionado) {
                relatorio += `<div style="text-align: center; margin: 20px 0; padding: 15px; background: #e8f8f5; border-radius: 5px; color: #27ae60; font-weight: bold;">
                    Nenhuma correção necessária. Todos os registros estão corretos.
                </div>`;
            }
            
            relatorio += `</div></div>`;
            
            // Mostrar o relatório em um modal
            mostrarModalRelatorioCorrecoes(relatorio);
        };
        divBotoes.appendChild(btnCorrigir);

        // Função para mostrar o modal com o relatório de correções
        function mostrarModalRelatorioCorrecoes(conteudo) {
            // Criar o modal
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '2000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Criar o conteúdo do modal
            const modalContent = document.createElement('div');
            modalContent.style.background = 'white';
            modalContent.style.padding = '25px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '700px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflow = 'auto';
            modalContent.style.position = 'relative';
            modalContent.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
            
            // Adicionar título
            const titulo = document.createElement('div');
            titulo.style.fontSize = '1.4em';
            titulo.style.fontWeight = 'bold';
            titulo.style.marginBottom = '15px';
            titulo.style.color = '#2a3d66';
            titulo.style.paddingBottom = '10px';
            titulo.style.borderBottom = '2px solid #eee';
            titulo.textContent = 'Relatório de Correções de Registros';
            
            // Adicionar botão de fechar
            const btnFechar = document.createElement('button');
            btnFechar.innerHTML = '×';
            btnFechar.style.position = 'absolute';
            btnFechar.style.top = '15px';
            btnFechar.style.right = '15px';
            btnFechar.style.background = '#e74c3c';
            btnFechar.style.color = 'white';
            btnFechar.style.border = 'none';
            btnFechar.style.borderRadius = '50%';
            btnFechar.style.width = '30px';
            btnFechar.style.height = '30px';
            btnFechar.style.fontSize = '20px';
            btnFechar.style.cursor = 'pointer';
            btnFechar.style.display = 'flex';
            btnFechar.style.justifyContent = 'center';
            btnFechar.style.alignItems = 'center';
            
            // Adicionar conteúdo personalizado
            const conteudoDiv = document.createElement('div');
            conteudoDiv.innerHTML = conteudo;
            
            // Adicionar botão "OK"