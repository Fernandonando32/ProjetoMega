<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração de Usuários</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuração única do Supabase -->
    <script src="./js/supabase-config.js"></script>
    
    <!-- Configurações específicas -->
    <script src="./js/db-config.js"></script>
    <script src="./js/auth.js"></script>
    <script>
        // Verificar autenticação e permissões
        async function checkAuth() {
            if (!await Auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            const currentUser = Auth.getCurrentUser();
            if (!currentUser || !currentUser.permissions || !currentUser.permissions.includes('manage_users')) {
                window.location.href = 'Pagina1 (1).html';
                return;
            }

            // Atualizar informações do usuário
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
        }
        
        // Executar verificação de autenticação
        checkAuth();
    </script>
    <style>
        :root {
            --primary-color: #2a3d66;
            --secondary-color: #eaf0fa;
            --accent-color: #27ae60;
            --danger-color: #c0392b;
            --text-color: #2a3d66;
            --light-text: #666;
            --border-color: #e0e6f0;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: #f4f6fb;
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .main-menu {
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        .main-menu ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .main-menu .menu-item {
            position: relative;
        }

        .main-menu .menu-item a {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .main-menu .menu-item.active a {
            background: var(--secondary-color);
            color: var(--primary-color);
        }

        .main-menu .menu-hover-indicator {
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
            transition: width 0.2s ease;
        }

        .main-menu .menu-item.active .menu-hover-indicator {
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .logo h1 {
            font-size: 20px;
            color: var(--primary-color);
        }

        .user-info {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1a2540;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #a93226;
        }

        .btn-success {
            background: var(--accent-color);
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .panel-header {
            padding: 15px 20px;
            background: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            font-size: 18px;
            color: var(--primary-color);
        }

        .panel-body {
            padding: 20px;
        }

        .panel-footer {
            padding: 15px 20px;
            background: var(--secondary-color);
            text-align: right;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-table th,
        .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .user-table th {
            background: var(--secondary-color);
            font-weight: bold;
            color: var(--primary-color);
        }

        .user-table tr:last-child td {
            border-bottom: none;
        }

        .user-table tr:hover {
            background: #f8f9fa;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: white;
            width: 90%;
            max-width: 550px;
            margin: 30px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .permission-group {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .permission-group h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .permission-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .permission-checkbox input {
            width: auto;
            margin-right: 10px;
        }

        .permission-description {
            font-size: 12px;
            color: var(--light-text);
            margin-left: 25px;
        }

        .required {
            color: var(--danger-color);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge-admin {
            background: #2a3d66;
            color: white;
        }

        .badge-user {
            background: #27ae60;
            color: white;
        }

        .badge-viewer {
            background: #3498db;
            color: white;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .links {
            margin-top: 20px;
            text-align: center;
        }

        .links a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }

        .links a:hover {
            text-decoration: underline;
        }

        /* Estilo para a barra de rolagem do container de permissões */
        #permissionsContainer::-webkit-scrollbar {
            width: 8px;
        }
        
        #permissionsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        #permissionsContainer::-webkit-scrollbar-thumb {
            background: #c1c9d9;
            border-radius: 4px;
        }
        
        #permissionsContainer::-webkit-scrollbar-thumb:hover {
            background: #a1afc9;
        }

        /* Estilo para as seções de permissões */
        #permissionsContainer section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        #permissionsContainer h4 {
            margin-top: 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e6f0;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .list-group-item {
            padding: 10px;
            border: 1px solid #e0e6f0;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .list-group-item-success {
            background-color: #d4edda;
            color: #155724;
        }

        .list-group-item-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        #syncModal.modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center;">
            <i class="fas fa-users-cog" style="font-size: 24px; margin-right: 10px; color: white;"></i>
            <h1 style="font-size: 20px; margin: 0; color: white;">Administração de Usuários</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="currentUserName" style="font-size: 14px;"></div>
            
            <!-- Sistema de notificação para administradores -->
            <div id="notificationSystem" style="display: none; position: relative;">
                <button id="notificationButton" style="background: none; border: none; color: white; position: relative; padding: 5px; cursor: pointer;" title="Notificações">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" style="position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                </button>
                <div id="notificationDropdown" style="display: none; position: absolute; right: 0; top: 100%; width: 300px; max-height: 400px; overflow-y: auto; background: white; border-radius: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); color: var(--text-color); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">
                        <h3 style="margin: 0; font-size: 16px;">Notificações</h3>
                        <button id="markAllReadButton" style="font-size: 12px; padding: 3px 8px; background: var(--secondary-color); color: var(--text-color); border: none; border-radius: 3px; cursor: pointer;">Marcar todas como lidas</button>
                    </div>
                    <div id="notificationList" style="padding: 0;">
                        <div style="padding: 20px; text-align: center; color: var(--light-text);">
                            Nenhuma notificação
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="logout-button" id="logoutButton" style="padding: 5px 10px; font-size: 12px; background: var(--danger-color); color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <!-- Menu de navegação intuitivo -->
    <nav class="main-menu">
        <ul>
            <li class="menu-item">
                <a href="Pagina1 (1).html">
                    <i class="fas fa-home" style="margin-right: 8px;"></i>
                    <span>Principal</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
            <li class="menu-item">
                <a href="Agenda.html">
                    <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
                    <span>Agenda</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
            <li class="menu-item">
                <a href="manutencao.html">
                    <i class="fas fa-tools" style="margin-right: 8px;"></i>
                    <span>Manutenção de Veículos</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
            <li class="menu-item active">
                <a href="admin.html">
                    <i class="fas fa-users-cog" style="margin-right: 8px;"></i>
                    <span>Administrar Usuários</span>
                </a>
                <div class="menu-hover-indicator" style="width: 100%;"></div>
            </li>
        </ul>
    </nav>
    
    <div class="container">
        <div class="panel">
            <div class="panel-header">
                <h2>Lista de Usuários</h2>
                <button class="button btn-success" id="addUserButton">
                    <i class="fas fa-plus"></i> Adicionar Usuário
                </button>
            </div>
            <div class="panel-body">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Usuário</th>
                            <th>E-mail</th>
                            <th>Nível de Acesso</th>
                            <th>Operação</th>
                            <th>Operação</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <!-- Será preenchido dinamicamente -->
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #2a3d66;"></i>
                                <p style="margin-top: 10px;">Carregando usuários...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Usuário -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Adicionar Usuário</h2>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="name">Nome Completo <span class="required">*</span></label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="username">Nome de Usuário <span class="required">*</span></label>
                    <input type="text" id="username" required>
                    <div class="error-message" id="usernameError">Este nome de usuário já existe</div>
                </div>
                <div class="form-group">
                    <label for="email">E-mail <span class="required">*</span></label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha <span class="required">*</span></label>
                    <input type="password" id="password" required>
                </div>
                <div class="form-group">
                    <label for="accessLevel">Nível de Acesso <span class="required">*</span></label>
                    <select id="accessLevel">
                        <option value="ADMIN">Administrador</option>
                        <option value="TECH_MANAGER">Gestor de Técnicos</option>
                        <option value="MAINTENANCE_MANAGER">Gestor de Manutenção</option>
                        <option value="USER">Usuário Padrão</option>
                        <option value="VIEWER">Visualizador</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="operacao">Operação</label>
                    <select id="operacao">
                        <option value="">Selecione uma operação</option>
                        <option value="BJ Fibra">BJ Fibra</option>
                        <option value="Megalink">Megalink</option>
                    </select>
                    <div style="font-size: 12px; color: var(--light-text); margin-top: 5px;">
                        Associa o usuário a uma operação específica. Usuários sem a permissão "Visualizar por Operação" só poderão ver registros de sua própria operação.
                    </div>
                </div>

                <div class="permission-group">
                    <h3>Permissões Personalizadas</h3>
                    <p style="font-size: 12px; margin-bottom: 10px;">Se você quiser personalizar as permissões além do nível de acesso padrão, marque as opções abaixo:</p>
                    
                    <div class="permission-checkbox">
                        <input type="checkbox" id="customPermissions">
                        <label for="customPermissions">Usar permissões personalizadas</label>
                    </div>

                    <div id="permissionsContainer" style="display: none; margin-top: 15px; max-height: 350px; overflow-y: auto; padding-right: 10px;">
                        <section>
                            <h4 style="color: #2a3d66;">Permissões da Agenda</h4>
                            
                            <!-- VIEW_TASKS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_view_tasks" value="view_tasks">
                                <label for="perm_view_tasks">Visualizar Tarefas</label>
                            </div>
                            <div class="permission-description">Permite visualizar o calendário e as tarefas</div>

                            <!-- CREATE_TASKS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_create_tasks" value="create_tasks">
                                <label for="perm_create_tasks">Criar Tarefas</label>
                            </div>
                            <div class="permission-description">Permite adicionar novas tarefas no sistema</div>

                            <!-- EDIT_TASKS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_edit_tasks" value="edit_tasks">
                                <label for="perm_edit_tasks">Editar Tarefas</label>
                            </div>
                            <div class="permission-description">Permite modificar tarefas existentes</div>

                            <!-- DELETE_TASKS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_delete_tasks" value="delete_tasks">
                                <label for="perm_delete_tasks">Excluir Tarefas</label>
                            </div>
                            <div class="permission-description">Permite remover tarefas do sistema</div>

                            <!-- COMPLETE_TASKS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_complete_tasks" value="complete_tasks">
                                <label for="perm_complete_tasks">Concluir Tarefas</label>
                            </div>
                            <div class="permission-description">Permite marcar tarefas como concluídas</div>

                            <!-- VIEW_COMPLETED -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_view_completed" value="view_completed">
                                <label for="perm_view_completed">Ver Tarefas Concluídas</label>
                            </div>
                            <div class="permission-description">Permite acessar a visualização de tarefas concluídas</div>
                        </section>
                        
                        <section>
                            <h4 style="color: #2a3d66;">Permissões de Acompanhamento de Técnicos e Veículos</h4>
                            
                            <!-- VIEW_TECHNICIANS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_view_technicians" value="view_technicians">
                                <label for="perm_view_technicians">Visualizar Técnicos</label>
                            </div>
                            <div class="permission-description">Permite visualizar os dados dos técnicos e veículos</div>
                            
                            <!-- ADD_TECHNICIAN -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_add_technician" value="add_technician">
                                <label for="perm_add_technician">Adicionar Técnicos</label>
                            </div>
                            <div class="permission-description">Permite adicionar novos registros de técnicos e veículos</div>
                            
                            <!-- EDIT_TECHNICIAN -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_edit_technician" value="edit_technician">
                                <label for="perm_edit_technician">Editar Técnicos</label>
                            </div>
                            <div class="permission-description">Permite modificar registros de técnicos e veículos existentes</div>
                            
                            <!-- DELETE_TECHNICIAN -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_delete_technician" value="delete_technician">
                                <label for="perm_delete_technician">Excluir Técnicos</label>
                            </div>
                            <div class="permission-description">Permite remover registros de técnicos e veículos</div>
                            
                            <!-- VIEW_STATISTICS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_view_statistics" value="view_statistics">
                                <label for="perm_view_statistics">Ver Estatísticas</label>
                            </div>
                            <div class="permission-description">Permite visualizar estatísticas e gráficos de desempenho</div>
                            
                            <!-- VIEW_MAP -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_view_map" value="view_map">
                                <label for="perm_view_map">Ver Mapa</label>
                            </div>
                            <div class="permission-description">Permite visualizar o mapa com a localização dos técnicos</div>
                            
                            <!-- VIEW_BY_OPERATION -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_view_by_operation" value="view_by_operation">
                                <label for="perm_view_by_operation">Visualizar por Operação</label>
                            </div>
                            <div class="permission-description">Permite visualizar registros de todas as operações (BJ Fibra e Megalink). Sem esta permissão, o usuário só vê registros da sua própria operação</div>
                        </section>
                        
                        <section>
                            <h4 style="color: #2a3d66;">Permissões de Manutenção de Veículos</h4>
                            
                            <!-- VIEW_MAINTENANCE -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_view_maintenance" value="view_maintenance">
                                <label for="perm_view_maintenance">Visualizar Manutenções</label>
                            </div>
                            <div class="permission-description">Permite visualizar os registros de manutenção de veículos</div>
                            
                            <!-- ADD_MAINTENANCE -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_add_maintenance" value="add_maintenance">
                                <label for="perm_add_maintenance">Adicionar Manutenções</label>
                            </div>
                            <div class="permission-description">Permite adicionar novos registros de manutenção</div>
                            
                            <!-- EDIT_MAINTENANCE -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_edit_maintenance" value="edit_maintenance">
                                <label for="perm_edit_maintenance">Editar Manutenções</label>
                            </div>
                            <div class="permission-description">Permite modificar registros de manutenção existentes</div>
                            
                            <!-- DELETE_MAINTENANCE -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_delete_maintenance" value="delete_maintenance">
                                <label for="perm_delete_maintenance">Excluir Manutenções</label>
                            </div>
                            <div class="permission-description">Permite remover registros de manutenção de veículos</div>
                        </section>

                        <section>
                            <h4 style="color: #2a3d66;">Permissões de Administração</h4>
                            
                            <!-- MANAGE_USERS -->
                            <div class="permission-checkbox">
                                <input type="checkbox" id="perm_manage_users" value="manage_users">
                                <label for="perm_manage_users">Gerenciar Usuários</label>
                            </div>
                            <div class="permission-description">Permite adicionar, editar e remover usuários do sistema</div>
                        </section>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="button btn-primary" style="width: 100%;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="margin-bottom: 20px;">Confirmar Exclusão</h2>
            <p>Tem certeza que deseja excluir este usuário?</p>
            <p style="margin-top: 10px; color: var(--danger-color);">Esta ação não pode ser desfeita.</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="button" id="cancelDeleteButton">Cancelar</button>
                <button class="button btn-danger" id="confirmDeleteButton">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de Sincronização -->
    <div id="syncModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title" id="syncModalLabel">Sincronização com Servidor</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="syncStatus">
                    <p>Verificando usuários locais...</p>
                    <div class="progress-bar" style="height: 10px; width: 100%; background-color: #2a3d66; border-radius: 5px; margin-bottom: 15px;"></div>
                </div>
                <div id="syncResults" style="display: none;">
                    <div class="alert" role="alert" style="padding: 10px; border-radius: 4px; margin-bottom: 15px;"></div>
                    <div class="sync-details" style="max-height: 200px; overflow-y: auto; margin-top: 15px;">
                        <h6>Detalhes:</h6>
                        <ul class="list-group"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="button" id="btnCloseSync">Fechar</button>
                <button type="button" class="button btn-primary" id="btnStartSync" style="display: none;">Iniciar Sincronização</button>
            </div>
        </div>
    </div>

    <!-- Botão flutuante de sincronização -->
    <div id="syncBadgeContainer" style="position: fixed; bottom: 20px; right: 20px; display: none; z-index: 1000;">
        <button type="button" class="btn btn-warning position-relative" id="btnOpenSyncModal">
            <i class="fas fa-sync-alt"></i> Sincronizar
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                <span id="localUserCount">0</span>
                <span class="visually-hidden">usuários locais</span>
            </span>
        </button>
    </div>

    <!-- Botão de diagnóstico -->
    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
        <button type="button" class="button btn-primary" id="btnDiagnostic">
            <i class="fas fa-stethoscope"></i> Diagnóstico do Banco
        </button>
    </div>

    <!-- Modal de Diagnóstico -->
    <div id="diagnosticModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; width: 90%;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title">Diagnóstico do Banco de Dados</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="diagnosticStatus">
                    <p>Executando diagnóstico do banco de dados...</p>
                    <div class="progress-bar" style="height: 10px; width: 100%; background-color: #2a3d66; border-radius: 5px; margin-bottom: 15px;"></div>
                </div>
                <div id="diagnosticResults" style="display: none;">
                    <div class="alert" role="alert" style="padding: 10px; border-radius: 4px; margin-bottom: 15px;"></div>
                    
                    <div class="diagnostic-details" style="margin-top: 15px;">
                        <h6>Detalhes do Diagnóstico:</h6>
                        
                        <div class="panel" style="margin-bottom: 15px; border: 1px solid #e0e6f0; border-radius: 5px; overflow: hidden;">
                            <div class="panel-header" style="background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e0e6f0;">
                                <h6 style="margin: 0;">Status da Conexão</h6>
                            </div>
                            <div class="panel-body" style="padding: 15px;" id="connectionStatus">
                                <!-- Será preenchido pelo JavaScript -->
                            </div>
                        </div>
                        
                        <div class="panel" style="margin-bottom: 15px; border: 1px solid #e0e6f0; border-radius: 5px; overflow: hidden;">
                            <div class="panel-header" style="background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e0e6f0;">
                                <h6 style="margin: 0;">Detalhes do Banco</h6>
                            </div>
                            <div class="panel-body" style="padding: 15px;" id="databaseDetails">
                                <!-- Será preenchido pelo JavaScript -->
                            </div>
                        </div>
                        
                        <div class="panel" style="margin-bottom: 15px; border: 1px solid #e0e6f0; border-radius: 5px; overflow: hidden;">
                            <div class="panel-header" style="background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e0e6f0;">
                                <h6 style="margin: 0;">Resultados dos Testes</h6>
                            </div>
                            <div class="panel-body" style="padding: 15px;" id="testResults">
                                <!-- Será preenchido pelo JavaScript -->
                            </div>
                        </div>
                        
                        <div class="panel" style="border: 1px solid #e0e6f0; border-radius: 5px; overflow: hidden;">
                            <div class="panel-header" style="background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e0e6f0;">
                                <h6 style="margin: 0;">Dados Técnicos Completos</h6>
                            </div>
                            <div class="panel-body" style="padding: 15px;">
                                <pre id="rawDiagnosticData" style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; max-height: 200px; font-size: 12px;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="button" id="btnCloseDiagnostic">Fechar</button>
                <button type="button" class="button btn-primary" id="btnFixDatabase" style="display: none;">Tentar Corrigir</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Variáveis Globais
        let users = [];
        let currentEditingUserId = null;
        let originPage = sessionStorage.getItem('adminOriginPage') || 'Agenda.html';

        // Elementos do DOM
        const currentUserNameElement = document.getElementById('currentUserName');
        const logoutButton = document.getElementById('logoutButton');
        const addUserButton = document.getElementById('addUserButton');
        const userTableBody = document.getElementById('userTableBody');
        const userModal = document.getElementById('userModal');
        const confirmModal = document.getElementById('confirmModal');
        const closeModalButton = document.querySelector('.close');
        const userForm = document.getElementById('userForm');
        const modalTitle = document.getElementById('modalTitle');
        const usernameError = document.getElementById('usernameError');
        const customPermissionsCheckbox = document.getElementById('customPermissions');
        const permissionsContainer = document.getElementById('permissionsContainer');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');

        // Evento ao carregar a página - Consolidando todos os event listeners de DOMContentLoaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Mostrar informações do usuário atual
            const currentUser = Auth.getCurrentUser();
            currentUserNameElement.textContent = `${currentUser.name} (${Auth.ACCESS_LEVELS[currentUser.accessLevel].name})`;
            
            // Carregar lista de usuários
            await loadUsers();
            
            // Configurar eventos
            setupEventListeners();
            
            // Menu interativo - efeito de hover
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                const indicator = item.querySelector('.menu-hover-indicator');
                
                // Efeito hover
                item.addEventListener('mouseenter', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '100%';
                    }
                });
                
                item.addEventListener('mouseleave', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '0';
                    }
                });
            });

            // Verificar usuários locais na inicialização
            await checkForLocalUsers();
        });

        // Configurar event listeners
        function setupEventListeners() {
            console.log('Configurando event listeners');
            
            // Configurar botão de adicionar usuário
            addUserButton.addEventListener('click', function() {
                console.log('Botão Adicionar Usuário clicado');
                openUserModal();
                console.log('Modal de usuário aberto');
            });
            
            // Botão logout
            logoutButton.addEventListener('click', async () => {
                await Auth.logout();
            });
            
            // Configuração do sistema de notificações
            const currentUser = Auth.getCurrentUser();
            if (currentUser.accessLevel === 'ADMIN' || Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                document.getElementById('notificationSystem').style.display = 'block';
                
                // Adicionar listener para o botão de notificação
                document.getElementById('notificationButton').addEventListener('click', function() {
                    const dropdown = document.getElementById('notificationDropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Fechar dropdown ao clicar fora
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('#notificationSystem')) {
                        document.getElementById('notificationDropdown').style.display = 'none';
                    }
                });
                
                // Funcionalidade do botão "Marcar todas como lidas"
                document.getElementById('markAllReadButton').addEventListener('click', function() {
                    // Implementar lógica para marcar todas como lidas
                    alert('Todas as notificações foram marcadas como lidas');
                    document.getElementById('notificationDropdown').style.display = 'none';
                });
            }
            
            closeModalButton.addEventListener('click', () => {
                userModal.style.display = 'none';
            });
            
            userForm.addEventListener('submit', handleUserFormSubmit);
            
            customPermissionsCheckbox.addEventListener('change', (e) => {
                permissionsContainer.style.display = e.target.checked ? 'block' : 'none';
            });
            
            document.getElementById('accessLevel').addEventListener('change', function() {
                updatePermissionsFromAccessLevel();
                suggestOperationFromAccessLevel();
            });
            
            // Fechar modais quando clicar fora deles
            window.addEventListener('click', (e) => {
                if (e.target === userModal) {
                    userModal.style.display = 'none';
                }
                if (e.target === confirmModal) {
                    confirmModal.style.display = 'none';
                }
            });
            
            cancelDeleteButton.addEventListener('click', () => {
                confirmModal.style.display = 'none';
            });
        }

        // Carregar lista de usuários
        async function loadUsers() {
            try {
                users = await Auth.getAllUsers();
                
                // Renderizar tabela
                renderUserTable();
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                userTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #c0392b;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px;"></i>
                            <p style="margin-top: 10px;">Erro ao carregar usuários. Tente novamente mais tarde.</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Renderizar tabela de usuários
        function renderUserTable() {
            userTableBody.innerHTML = '';
            
            if (users.length === 0) {
                userTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            <i class="fas fa-users-slash" style="font-size: 24px; color: #666;"></i>
                            <p style="margin-top: 10px;">Nenhum usuário encontrado.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                
                // Determinar qual badge usar baseado no nível de acesso
                let badgeClass = '';
                switch(user.accessLevel) {
                    case 'ADMIN':
                        badgeClass = 'badge-admin';
                        break;
                    case 'USER':
                        badgeClass = 'badge-user';
                        break;
                    case 'VIEWER':
                        badgeClass = 'badge-viewer';
                        break;
                }
                
                const currentUser = Auth.getCurrentUser();
                
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${user.email || '-'}</td>
                    <td>${Auth.ACCESS_LEVELS[user.accessLevel].name} <span class="badge ${badgeClass}">${user.accessLevel}</span></td>
                    <td>${user.operacao || '-'}</td>
                    <td class="user-actions">
                        <button class="button btn-primary edit-user" data-id="${user.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="button btn-danger delete-user" data-id="${user.id}" ${user.id === currentUser.id ? 'disabled' : ''}>
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                userTableBody.appendChild(tr);
            });
            
            // Adicionar eventos de edição e exclusão
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', () => {
                    const userId = parseInt(button.dataset.id);
                    editUser(userId);
                });
            });
            
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', () => {
                    const userId = parseInt(button.dataset.id);
                    const currentUser = Auth.getCurrentUser();
                    if (userId !== currentUser.id) {
                        openDeleteConfirmation(userId);
                    }
                });
            });
        }

        // Abrir modal para adicionar usuário
        function openUserModal(userId = null) {
            // Resetar o formulário
            userForm.reset();
            usernameError.style.display = 'none';
            
            // Desativar permissões personalizadas
            customPermissionsCheckbox.checked = false;
            permissionsContainer.style.display = 'none';
            
            if (userId) {
                // Modo de edição
                currentEditingUserId = userId;
                modalTitle.textContent = 'Editar Usuário';
                
                // Encontrar o usuário
                const user = users.find(u => u.id === userId);
                if (user) {
                    // Preencher o formulário
                    document.getElementById('userId').value = user.id;
                    document.getElementById('name').value = user.name;
                    document.getElementById('username').value = user.username;
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('password').value = '';
                    document.getElementById('password').placeholder = '(Manter a mesma senha)';
                    document.getElementById('accessLevel').value = user.accessLevel;
                    
                    // Preencher o campo de operação
                    document.getElementById('operacao').value = user.operacao || '';
                    
                    // Verificar se o usuário tem permissões personalizadas
                    if (user.customPermissions) {
                        customPermissionsCheckbox.checked = true;
                        permissionsContainer.style.display = 'block';
                        
                        // Resetar todas as permissões
                        document.querySelectorAll('#permissionsContainer input[type="checkbox"]').forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        
                        // Marcar as permissões que o usuário tem
                        if (user.permissions) {
                            user.permissions.forEach(permission => {
                                const checkbox = document.getElementById(`perm_${permission}`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            });
                        }
                    } else {
                        // Atualizar os checkboxes baseado no nível de acesso
                        updatePermissionsFromAccessLevel();
                    }
                }
            } else {
                // Modo de adição
                currentEditingUserId = null;
                modalTitle.textContent = 'Adicionar Usuário';
                document.getElementById('userId').value = '';
                document.getElementById('password').placeholder = 'Senha';
                
                // Atualizar os checkboxes baseado no nível de acesso padrão
                updatePermissionsFromAccessLevel();
            }
            
            // Mostrar o modal
            userModal.style.display = 'block';
        }

        // Editar usuário
        function editUser(userId) {
            openUserModal(userId);
        }

        // Abrir confirmação de exclusão
        function openDeleteConfirmation(userId) {
            // Armazenar o ID do usuário a ser excluído
            confirmDeleteButton.dataset.userId = userId;
            
            // Configurar evento de confirmação
            confirmDeleteButton.onclick = async () => {
                await deleteUser(userId);
                confirmModal.style.display = 'none';
            };
            
            // Mostrar o modal
            confirmModal.style.display = 'block';
        }

        // Excluir usuário
        async function deleteUser(userId) {
            // Não permitir excluir o próprio usuário
            const currentUser = Auth.getCurrentUser();
            if (userId === currentUser.id) {
                alert('Você não pode excluir seu próprio usuário!');
                return;
            }
            
            try {
                // Mostrar indicador de carregamento
                confirmDeleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
                confirmDeleteButton.disabled = true;
                
                // Chamar a API para excluir o usuário
                const result = await Auth.deleteUser(userId);
                
                if (result.success) {
                    // Remover o usuário da lista local
                    users = users.filter(user => user.id !== userId);
                    
                    // Atualizar a tabela
                    renderUserTable();
                    
                    // Mostrar mensagem de sucesso
                    alert('Usuário excluído com sucesso!');
                } else {
                    // Mostrar mensagem de erro
                    alert(`Erro ao excluir usuário: ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                alert('Erro ao excluir usuário. Tente novamente mais tarde.');
            } finally {
                // Restaurar o botão
                confirmDeleteButton.innerHTML = 'Excluir';
                confirmDeleteButton.disabled = false;
                
                // Fechar o modal
                confirmModal.style.display = 'none';
            }
        }

        // Atualizar permissões baseado no nível de acesso
        function updatePermissionsFromAccessLevel() {
            if (customPermissionsCheckbox.checked) {
                return; // Não alterar se estiver usando permissões personalizadas
            }
            
            const accessLevel = document.getElementById('accessLevel').value;
            const permissions = Auth.ACCESS_LEVELS[accessLevel].permissions;
            
            // Resetar todas as permissões
            document.querySelectorAll('#permissionsContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Marcar as permissões do nível de acesso
            permissions.forEach(permission => {
                const checkbox = document.getElementById(`perm_${permission}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }

        // Sugerir operação baseado no nível de acesso
        function suggestOperationFromAccessLevel() {
            const accessLevel = document.getElementById('accessLevel').value;
            const operacao = document.getElementById('operacao');
            
            // Sugerir operação com base no nível de acesso
            if (accessLevel === 'TECH_MANAGER') {
                operacao.value = 'BJ Fibra';
            } else if (accessLevel === 'MAINTENANCE_MANAGER') {
                operacao.value = 'Megalink';
            } else if (accessLevel === 'ADMIN') {
                // Administradores não precisam de operação específica
                operacao.value = '';
            }
        }

        // Manipular envio do formulário
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            
            // Obter valores do formulário
            const userId = document.getElementById('userId').value ? parseInt(document.getElementById('userId').value) : null;
            const name = document.getElementById('name').value.trim();
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const accessLevel = document.getElementById('accessLevel').value;
            const operacao = document.getElementById('operacao').value;
            
            // Criar objeto de usuário
            let userData = {
                name,
                username,
                email,
                accessLevel,
                operacao,
            };
            
            // Adicionar senha apenas se for um novo usuário ou se a senha foi alterada
            if (!userId || password.trim() !== '') {
                userData.password = password;
            }
            
            // Verificar se está usando permissões personalizadas
            if (customPermissionsCheckbox.checked) {
                userData.customPermissions = true;
                userData.permissions = [];
                
                // Coletar permissões marcadas
                document.querySelectorAll('#permissionsContainer input[type="checkbox"]:checked').forEach(checkbox => {
                    userData.permissions.push(checkbox.value);
                });
            } else {
                userData.customPermissions = false;
                // As permissões serão determinadas pelo nível de acesso
            }
            
            try {
                // Desabilitar o botão de envio e mostrar indicador de carregamento
                const submitButton = userForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                
                let result;
                
                // Atualizar ou adicionar usuário
                if (userId) {
                    // Atualizar usuário existente
                    result = await Auth.updateUser(userId, userData);
                } else {
                    // Adicionar novo usuário
                    result = await Auth.createUser(userData);
                }
                
                if (result.success) {
                    // Recarregar a lista de usuários
                    await loadUsers();
                    
                    // Fechar o modal
                    userModal.style.display = 'none';
                    
                    // Mostrar mensagem de sucesso
                    alert(userId ? 'Usuário atualizado com sucesso!' : 'Usuário adicionado com sucesso!');
                } else {
                    // Mostrar erro
                    if (result.message === 'Nome de usuário já existe') {
                        usernameError.style.display = 'block';
                    } else {
                        alert(`Erro: ${result.message}`);
                    }
                }
            } catch (error) {
                console.error('Erro ao salvar usuário:', error);
                alert('Erro ao salvar usuário. Tente novamente mais tarde.');
            } finally {
                // Restaurar o botão de envio
                const submitButton = userForm.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Salvar';
            }
        }

        // Verificar se há usuários locais para sincronizar
        async function checkForLocalUsers() {
            try {
                const localUsers = await Auth.checkLocalUsersCount();
                
                // Atualizar o badge e mostrar se necessário
                if (localUsers.hasLocalUsers) {
                    document.getElementById('localUserCount').textContent = localUsers.count;
                    document.getElementById('syncBadgeContainer').style.display = 'block';
                } else {
                    document.getElementById('syncBadgeContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao verificar usuários locais:', error);
            }
        }
        
        // Modal de sincronização
        document.getElementById('btnOpenSyncModal').addEventListener('click', async function() {
            // Abrir modal
            document.getElementById('syncModal').style.display = 'block';
            
            // Reset modal state
            document.getElementById('syncStatus').style.display = 'block';
            document.getElementById('syncResults').style.display = 'none';
            document.querySelector('#syncStatus .progress-bar').style.display = 'none';
            document.getElementById('btnStartSync').style.display = 'none';
            
            // Verificar usuários locais
            const localUsers = await Auth.checkLocalUsersCount();
            
            if (localUsers.hasLocalUsers) {
                document.getElementById('syncStatus').innerHTML = `
                    <p>Encontrados <strong>${localUsers.count}</strong> usuários locais para sincronizar:</p>
                    <ul class="list-group mb-3">
                        ${localUsers.usernames.map(username => `<li class="list-group-item">${username}</li>`).join('')}
                    </ul>
                    <p>Deseja sincronizar estes usuários com o servidor?</p>
                `;
                document.getElementById('btnStartSync').style.display = 'block';
            } else {
                document.getElementById('syncStatus').innerHTML = `
                    <div class="alert alert-info" role="alert">
                        Não há usuários locais para sincronizar.
                    </div>
                `;
            }
        });
        
        // Fechar modal
        document.querySelector('#syncModal .close').addEventListener('click', function() {
            document.getElementById('syncModal').style.display = 'none';
        });

        document.getElementById('btnCloseSync').addEventListener('click', function() {
            document.getElementById('syncModal').style.display = 'none';
        });

        // Fechar modal ao clicar fora dele
        window.addEventListener('click', function(event) {
            const syncModal = document.getElementById('syncModal');
            if (event.target === syncModal) {
                syncModal.style.display = 'none';
            }
        });

        // Iniciar sincronização
        document.getElementById('btnStartSync').addEventListener('click', async function() {
            try {
                // Atualizar UI para mostrar progresso
                const btnStartSync = document.getElementById('btnStartSync');
                if (btnStartSync) {
                    btnStartSync.style.display = 'none';
                }
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) {
                    syncStatus.innerHTML = `
                        <p>Sincronizando usuários locais com o servidor...</p>
                        <div class="progress-bar" style="height: 10px; width: 100%; background-color: #2a3d66; border-radius: 5px; margin-bottom: 15px;"></div>
                    `;
                }
                
                // Executar sincronização
                const result = await Auth.syncLocalUsers();
                
                // Mostrar resultados
                const syncStatusAfter = document.getElementById('syncStatus');
                if (syncStatusAfter) {
                    syncStatusAfter.style.display = 'none';
                }
                
                const syncResults = document.getElementById('syncResults');
                if (syncResults) {
                    syncResults.style.display = 'block';
                    
                    const alertElement = syncResults.querySelector('.alert');
                    if (alertElement) {
                        if (result.success) {
                            alertElement.className = 'alert alert-success';
                            alertElement.textContent = result.message;
                        } else {
                            alertElement.className = 'alert alert-danger';
                            alertElement.textContent = `Erro: ${result.message || 'Falha na sincronização'}`;
                        }
                        
                        // Mostrar detalhes se houver
                        const detailsList = syncResults.querySelector('.sync-details ul');
                        if (detailsList) {
                            detailsList.innerHTML = '';
                            
                            if (result.details && result.details.length > 0) {
                                result.details.forEach(item => {
                                    const li = document.createElement('li');
                                    li.className = `list-group-item ${item.success ? 'list-group-item-success' : 'list-group-item-danger'}`;
                                    li.innerHTML = `
                                        <strong>${item.username}</strong>: 
                                        ${item.success 
                                            ? `Sincronizado com sucesso (ID: ${item.serverId})` 
                                            : `Falha: ${item.error || 'Erro desconhecido'}`}
                                    `;
                                    detailsList.appendChild(li);
                                });
                            } else {
                                detailsList.innerHTML = '<li class="list-group-item">Nenhum detalhe disponível</li>';
                            }
                        }
                    }
                }
                
                // Atualizar contagem de usuários locais
                await checkForLocalUsers();
            } catch (error) {
                console.error('Erro ao sincronizar:', error);
                
                const syncStatusError = document.getElementById('syncStatus');
                if (syncStatusError) {
                    syncStatusError.style.display = 'none';
                }
                
                const syncResultsError = document.getElementById('syncResults');
                if (syncResultsError) {
                    syncResultsError.style.display = 'block';
                    
                    const alertElement = syncResultsError.querySelector('.alert');
                    if (alertElement) {
                        alertElement.className = 'alert alert-danger';
                        alertElement.textContent = `Erro: ${error.message || 'Erro desconhecido durante a sincronização'}`;
                    }
                }
            }
        });

        // Diagnóstico do banco de dados
        document.getElementById('btnDiagnostic').addEventListener('click', async function() {
            // Abrir modal
            document.getElementById('diagnosticModal').style.display = 'block';
            
            // Resetar estado do modal
            document.getElementById('diagnosticStatus').style.display = 'block';
            document.getElementById('diagnosticResults').style.display = 'none';
            document.getElementById('btnFixDatabase').style.display = 'none';
            
            try {
                // Executar diagnóstico
                const results = await Auth.runDatabaseDiagnostic();
                
                // Atualizar UI com resultados
                document.getElementById('diagnosticStatus').style.display = 'none';
                document.getElementById('diagnosticResults').style.display = 'block';
                
                // Mostrar mensagem principal
                const alertElement = document.querySelector('#diagnosticResults .alert');
                
                if (results.databaseConnected && results.tablesExist && results.canCreateUser) {
                    alertElement.className = 'alert alert-success';
                    alertElement.textContent = 'O banco de dados está funcionando corretamente.';
                } else if (results.serverReachable && !results.databaseConnected) {
                    alertElement.className = 'alert alert-danger';
                    alertElement.textContent = 'O servidor está acessível, mas não consegue se conectar ao banco de dados.';
                    document.getElementById('btnFixDatabase').style.display = 'inline-block';
                } else if (results.serverReachable && results.databaseConnected && !results.tablesExist) {
                    alertElement.className = 'alert alert-danger';
                    alertElement.textContent = 'Conectado ao banco de dados, mas a tabela de usuários não existe.';
                    document.getElementById('btnFixDatabase').style.display = 'inline-block';
                } else if (results.infiniteRecursion) {
                    alertElement.className = 'alert alert-danger';
                    alertElement.textContent = 'Detectado erro de recursão infinita nas políticas de segurança do Supabase.';
                    document.getElementById('btnFixDatabase').style.display = 'inline-block';
                } else if (!results.permissionsOk) {
                    alertElement.className = 'alert alert-danger';
                    alertElement.textContent = 'Erro de permissões ou políticas no banco de dados.';
                    document.getElementById('btnFixDatabase').style.display = 'inline-block';
                } else if (!results.serverReachable) {
                    alertElement.className = 'alert alert-danger';
                    alertElement.textContent = 'Não foi possível acessar o servidor API.';
                } else {
                    alertElement.className = 'alert alert-warning';
                    alertElement.textContent = 'Diagnóstico concluído com problemas identificados.';
                    document.getElementById('btnFixDatabase').style.display = 'inline-block';
                }
                
                // Detalhes da conexão
                let connectionHtml = '<ul style="list-style: none; padding-left: 0;">';
                connectionHtml += `<li><strong>Servidor API:</strong> ${results.serverReachable ? '✅ Acessível' : '❌ Inacessível'}</li>`;
                connectionHtml += `<li><strong>Funcionamento da API:</strong> ${results.apiWorking ? '✅ Funcional' : '❌ Não funcional'}</li>`;
                connectionHtml += `<li><strong>Conexão com banco:</strong> ${results.databaseConnected ? '✅ Conectado' : '❌ Desconectado'}</li>`;
                connectionHtml += `<li><strong>Tabela de usuários:</strong> ${results.tablesExist ? '✅ Existe' : '❌ Não existe'}</li>`;
                connectionHtml += `<li><strong>Armazenamento local:</strong> ${results.localStorage?.working ? '✅ Funcional' : '❌ Não funcional'}</li>`;
                connectionHtml += `<li><strong>Online:</strong> ${results.environment.isOnline ? '✅ Sim' : '❌ Não'}</li>`;
                connectionHtml += '</ul>';
                
                document.getElementById('connectionStatus').innerHTML = connectionHtml;
                
                // Detalhes do banco
                if (results.dbDetails) {
                    let dbHtml = '<ul style="list-style: none; padding-left: 0;">';
                    if (results.dbDetails.fields && results.dbDetails.fields.length > 0) {
                        dbHtml += `<li><strong>Campos na tabela:</strong> ${results.dbDetails.fields.join(', ')}</li>`;
                    }
                    if (results.dbDetails.errors && results.dbDetails.errors.length > 0) {
                        dbHtml += '<li><strong>Erros detectados:</strong><ul>';
                        results.dbDetails.errors.forEach(err => {
                            dbHtml += `<li>${err.context || ''}: ${err.error || JSON.stringify(err)}</li>`;
                        });
                        dbHtml += '</ul></li>';
                    }
                    if (results.permissionError) {
                        dbHtml += `<li><strong>Erro de permissão:</strong> ${results.permissionError}</li>`;
                    }
                    if (results.recursionError) {
                        dbHtml += `<li><strong>Erro de recursão:</strong> ${results.recursionError}</li>`;
                    }
                    dbHtml += '</ul>';
                    
                    document.getElementById('databaseDetails').innerHTML = dbHtml;
                } else {
                    document.getElementById('databaseDetails').innerHTML = '<p>Informações detalhadas do banco não disponíveis.</p>';
                }
                
                // Resultados dos testes
                if (results.tests && results.tests.length > 0) {
                    let testsHtml = '<ul style="list-style: none; padding-left: 0;">';
                    results.tests.forEach(test => {
                        const icon = test.success === true ? '✅' : (test.success === false ? '❌' : '⚠️');
                        testsHtml += `<li>${icon} <strong>${test.name}:</strong> `;
                        
                        if (test.success) {
                            testsHtml += 'Sucesso';
                        } else if (test.error) {
                            testsHtml += `Falha - ${test.error}`;
                        } else if (test.status) {
                            testsHtml += `Status ${test.status} ${test.statusText || ''}`;
                        } else if (test.note) {
                            testsHtml += test.note;
                        }
                        
                        testsHtml += '</li>';
                    });
                    testsHtml += '</ul>';
                    
                    document.getElementById('testResults').innerHTML = testsHtml;
                } else {
                    document.getElementById('testResults').innerHTML = '<p>Nenhum teste executado.</p>';
                }
                
                // Dados técnicos completos
                document.getElementById('rawDiagnosticData').textContent = JSON.stringify(results, null, 2);
                
            } catch (error) {
                console.error('Erro ao executar diagnóstico:', error);
                
                document.getElementById('diagnosticStatus').style.display = 'none';
                document.getElementById('diagnosticResults').style.display = 'block';
                
                const alertElement = document.querySelector('#diagnosticResults .alert');
                alertElement.className = 'alert alert-danger';
                alertElement.textContent = `Erro ao executar diagnóstico: ${error.message}`;
                
                document.getElementById('connectionStatus').innerHTML = '<p>Ocorreu um erro ao executar o diagnóstico.</p>';
                document.getElementById('databaseDetails').innerHTML = '<p>Informações não disponíveis devido a erro.</p>';
                document.getElementById('testResults').innerHTML = '<p>Testes não executados devido a erro.</p>';
                document.getElementById('rawDiagnosticData').textContent = JSON.stringify({error: error.message}, null, 2);
            }
        });

        // Fechar modal de diagnóstico
        document.querySelector('#diagnosticModal .close').addEventListener('click', function() {
            document.getElementById('diagnosticModal').style.display = 'none';
        });

        document.getElementById('btnCloseDiagnostic').addEventListener('click', function() {
            document.getElementById('diagnosticModal').style.display = 'none';
        });

        // Tentar corrigir problemas do banco
        document.getElementById('btnFixDatabase').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Tentando corrigir...';
            
            try {
                // Chamar API para tentar inicializar/corrigir o banco
                const response = await fetch(`${API_URL}?action=fix-database`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const alertElement = document.querySelector('#diagnosticResults .alert');
                    if (data.success) {
                        alertElement.className = 'alert alert-success';
                        alertElement.textContent = 'Correção aplicada com sucesso! ' + (data.message || '');
                    } else {
                        alertElement.className = 'alert alert-warning';
                        alertElement.textContent = 'Tentativa de correção executada, mas com avisos: ' + (data.message || '');
                    }
                    
                    // Executar diagnóstico novamente após 3 segundos
                    setTimeout(() => {
                        document.getElementById('btnDiagnostic').click();
                    }, 3000);
                } else {
                    const errorData = await response.json();
                    const alertElement = document.querySelector('#diagnosticResults .alert');
                    alertElement.className = 'alert alert-danger';
                    alertElement.textContent = 'Falha ao aplicar correção: ' + (errorData.message || errorData.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao tentar corrigir banco:', error);
                const alertElement = document.querySelector('#diagnosticResults .alert');
                alertElement.className = 'alert alert-danger';
                alertElement.textContent = 'Erro ao tentar corrigir: ' + error.message;
            } finally {
                this.disabled = false;
                this.innerHTML = 'Tentar Corrigir';
            }
        });

        // Fechar modal ao clicar fora
        window.addEventListener('click', function(event) {
            const diagnosticModal = document.getElementById('diagnosticModal');
            if (event.target === diagnosticModal) {
                diagnosticModal.style.display = 'none';
            }
        });
    </script>
</body>
</html> 