<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>FTTH - Carregando...</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #2a3d66;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <h2>Corrigindo erro do Auth.js</h2>
        <p>Aguarde enquanto corrigimos o erro "Unexpected token 'export'".</p>
    </div>
    
    <iframe id="mainFrame" src="Pagina1 (1).html"></iframe>
    
    <script>
        // Script para corrigir o erro do auth.js
        window.addEventListener('load', function() {
            // Obtém a referência ao iframe
            const mainFrame = document.getElementById('mainFrame');
            
            // Aguarda o carregamento do iframe
            mainFrame.onload = function() {
                try {
                    // Acessa o documento dentro do iframe
                    const frameDoc = mainFrame.contentDocument || mainFrame.contentWindow.document;
                    const frameWin = mainFrame.contentWindow;
                    
                    // Remover todos os scripts com src="js/auth.js"
                    const authScripts = frameDoc.querySelectorAll('script[src="js/auth.js"]');
                    authScripts.forEach(script => script.remove());
                    
                    // Remover todos os scripts que importam auth.js como módulo
                    const moduleScripts = frameDoc.querySelectorAll('script[type="module"]');
                    moduleScripts.forEach(script => {
                        if (script.textContent.includes('import * as Auth from')) {
                            script.remove();
                        }
                    });
                    
                    // Adicionar nossa versão modificada do auth.js (não-módulo)
                    const authScript = frameDoc.createElement('script');
                    authScript.src = 'js/auth-non-module.js';
                    frameDoc.head.appendChild(authScript);
                    
                    // Esperar que nosso script termine de carregar
                    authScript.onload = function() {
                        console.log('Auth não-módulo carregado com sucesso');
                        
                        // Re-executar a inicialização da interface quando auth estiver pronto
                        const initScript = frameDoc.createElement('script');
                        initScript.textContent = `
                            // Verificar autenticação
                            async function checkAuth() {
                                if (!await Auth.isAuthenticated()) {
                                    window.location.href = 'login.html';
                                    return;
                                }
                                
                                // Obter usuário atual
                                const currentUser = Auth.getCurrentUser();
                                
                                // Garantir que administradores tenham a permissão MANAGE_USERS
                                if (currentUser.accessLevel === 'ADMIN') {
                                    // Se o usuário tiver permissões personalizadas, garantir que MANAGE_USERS esteja incluída
                                    if (currentUser.customPermissions && Array.isArray(currentUser.permissions)) {
                                        if (!currentUser.permissions.includes(Auth.PERMISSIONS.MANAGE_USERS)) {
                                            currentUser.permissions.push(Auth.PERMISSIONS.MANAGE_USERS);
                                            // Atualizar o sessionStorage para persistir a alteração
                                            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                                        }
                                    }
                                }
                                
                                // Atribuir uma operação padrão com base no nível de acesso ou permissões personalizadas
                                if (!currentUser.operacao) {
                                    if (currentUser.accessLevel === 'MAINTENANCE_MANAGER') {
                                        // Gerentes de manutenção são da operação Megalink por padrão
                                        currentUser.operacao = 'Megalink';
                                    } else if (currentUser.accessLevel === 'TECH_MANAGER') {
                                        // Gerentes de técnicos são da operação BJ Fibra por padrão
                                        currentUser.operacao = 'BJ Fibra';
                                    }
                                    // ADMIN não recebe operação específica, podendo ver todas
                                }
                                
                                // Atualizar o objeto do usuário no sessionStorage
                                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                                
                                // Configurar manipulador do importador CSV se ele existir
                                const fileInput = document.getElementById('fileInput');
                                if (fileInput) {
                                    fileInput.addEventListener('change', function(e) {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onload = function(e) {
                                                const text = e.target.result;
                                                importCSVData(text);
                                            };
                                            reader.readAsText(file);
                                        }
                                    });
                                }
                                
                                // Configurar elementos da interface após carregamento
                                renderizarTabela();
                                atualizarEstatisticas();
                            }
                            
                            // Iniciar verificação de autenticação
                            checkAuth();
                        `;
                        frameDoc.body.appendChild(initScript);
                        
                        // Esconder a tela de carregamento
                        document.getElementById('loading').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loading').style.display = 'none';
                        }, 500);
                        
                        // Atualizar o título da página
                        document.title = frameDoc.title || 'Sistema de Gestão FTTH';
                    };
                    
                } catch (error) {
                    console.error('Erro ao acessar iframe:', error);
                    document.getElementById('loading').style.display = 'none';
                }
            };
        });
    </script>
</body>
</html> 