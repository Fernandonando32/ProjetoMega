<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Acompanhamento de Técnicos e Veículos - FTTH</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="users.js"></script>
    <script>
        // Verificar autenticação
        if (!Auth.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Obter usuário atual
        const currentUser = Auth.getCurrentUser();
        
        // Garantir que administradores tenham a permissão MANAGE_USERS
        if (currentUser.accessLevel === 'ADMIN') {
            // Se o usuário tiver permissões personalizadas, garantir que MANAGE_USERS esteja incluída
            if (currentUser.customPermissions && Array.isArray(currentUser.permissions)) {
                if (!currentUser.permissions.includes(Auth.PERMISSIONS.MANAGE_USERS)) {
                    currentUser.permissions.push(Auth.PERMISSIONS.MANAGE_USERS);
                    // Atualizar o localStorage para persistir a alteração
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            }
        }
        
        // Atribuir uma operação padrão com base no nível de acesso ou permissões personalizadas
        // Em um sistema real, isso viria do banco de dados do usuário
        if (!currentUser.operacao) {
            if (currentUser.accessLevel === 'MAINTENANCE_MANAGER') {
                // Gerentes de manutenção são da operação Megalink por padrão
                currentUser.operacao = 'Megalink';
            } else if (currentUser.accessLevel === 'TECH_MANAGER') {
                // Gerentes de técnicos são da operação BJ Fibra por padrão
                currentUser.operacao = 'BJ Fibra';
            }
            // ADMIN não recebe operação específica, podendo ver todas
            // Se o usuário tiver a permissão VIEW_BY_OPERATION, ele poderá visualizar 
            // registros de todas as operações independente da sua operação assignada
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6fb;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            width: 100%;
            max-width: none;
            margin: 0;
            background: #fff;
            border-radius: 0;
            box-shadow: none;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        h1 {
            text-align: center;
            color: #2a3d66;
            margin: 0 0 20px 0;
        }
        form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        form > div {
            flex: 1 1 180px;
            display: flex;
            flex-direction: column;
        }
        label {
            font-size: 0.95em;
            margin-bottom: 4px;
            color: #2a3d66;
        }
        input, select {
            padding: 7px 10px;
            border: 1px solid #bfc9d9;
            border-radius: 5px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 10px 18px;
            background: #2a3d66;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #1a2540;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            flex: 1;
        }
        th, td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e6f0;
            text-align: left;
        }
        th {
            background: #eaf0fa;
            color: #2a3d66;
            position: sticky;
            top: 0;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .actions button {
            margin-right: 6px;
            padding: 6px 12px;
            font-size: 0.95em;
        }
        @media (max-width: 900px) {
            .container { padding: 15px; }
            form { flex-direction: column; gap: 8px; }
        }
        #mapaContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        #mapa {
            width: 90%;
            height: 90%;
            margin: 2% auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            position: relative;
        }
        .fecharMapa {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #c0392b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            z-index: 1001;
        }
        .fecharMapa:hover {
            background: #a93226;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #painelEstatisticas {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
        }
        #painelEstatisticasCidade {
            margin: 20px 0;
            background: #eaf0fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px #0001;
        }
        #tabelaRegistros {
            flex: 1;
            overflow-y: auto;
            display: block;
            max-height: calc(100vh - 500px);
        }
        #tabelaRegistros thead {
            position: sticky;
            top: 0;
            background: #eaf0fa;
            z-index: 1;
        }
        /* Estilo para a notificação de alertas */
        #alertaContratosNotificacao {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            width: 320px;
            max-width: 90%;
            z-index: 1003;
            overflow: hidden;
        }
        
        .alerta-header {
            background-color: #e74c3c;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alerta-body {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alerta-footer {
            padding: 10px 15px;
            background-color: #f8f9fa;
            text-align: right;
            border-top: 1px solid #eee;
        }
        
        .alerta-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }
        
        .alerta-item:last-child {
            border-bottom: none;
        }
        
        .alerta-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        
        .alerta-action {
            background: #2a3d66;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        /* Indicador de alerta para manutenções frequentes */
        .alerta-manutencao {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            margin-right: 5px;
        }
        .alerta-manutencao i {
            margin-right: 5px;
            font-size: 1.1em;
        }
        /* Indicador de alerta para troca de óleo */
        .alerta-troca-oleo {
            background-color: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            margin-right: 5px;
        }
        .alerta-troca-oleo i {
            margin-right: 5px;
            font-size: 1.1em;
        }
        /* Estilo para o balão de estatísticas */
        .estatisticas-tooltip {
            display: none;
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            padding: 20px;
            z-index: 1050; /* Z-index aumentado para garantir que fique por cima de outros elementos */
            min-width: 350px;
            max-width: 500px;
            max-height: 70vh; /* Limitar altura para não sair da tela */
            overflow-y: auto; /* Adicionar scroll se necessário */
            right: 0; /* Posicionar à direita por padrão */
            top: 100%; /* Posicionar abaixo do elemento pai por padrão */
            margin-top: 10px; /* Espaçamento superior */
            border: 1px solid #ddd;
            animation: tooltip-fade 0.3s ease-out;
        }

        @keyframes tooltip-fade {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .estatisticas-tooltip h3 {
            margin: 0 0 15px 0;
            color: #2a3d66;
            font-size: 1.2em;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaf0fa;
        }

        .estatisticas-tooltip .estatistica-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .estatisticas-tooltip .estatistica-item:hover {
            background: #f9f9f9;
        }

        .estatisticas-tooltip .estatistica-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .estatisticas-tooltip .estatistica-label {
            color: #2a3d66;
            font-weight: bold;
            margin-right: 15px;
        }

        .estatisticas-tooltip .estatistica-valor {
            color: #444;
            text-align: right;
        }
        
        /* Estilos para o mapa */
        .custom-div-icon {
            background: none;
            border: none;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.3);
        }
        .leaflet-popup-content {
            margin: 15px;
        }
        .custom-tooltip {
            background-color: rgba(0, 0, 0, 0.8);
            border: none;
            border-radius: 4px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.3);
            color: white;
            font-weight: bold;
            padding: 5px 10px;
        }
        .custom-tooltip::before {
            border-top-color: rgba(0, 0, 0, 0.8);
        }
        
        /* Estilos para os botões de ação */
        .btn-acao {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: none;
            color: white;
            cursor: pointer;
        }
        .btn-acao:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-estatisticas {
            background: #3498db;
        }
        .btn-estatisticas:hover {
            background: #2980b9;
        }
        .btn-manutencao {
            background: #2980b9;
        }
        .btn-manutencao:hover {
            background: #1c638b;
        }
        .btn-mapa {
            background: #16a085;
        }
        .btn-mapa:hover {
            background: #0d8068;
        }

        /* Estilo para a barra do topo (semelhante à da página agenda.html) */
        .top-header {
            background: #2a3d66;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .top-header .logo {
            display: flex;
            align-items: center;
        }

        .top-header .logo i {
            font-size: 24px;
            margin-right: 10px;
        }

        .top-header h1 {
            font-size: 20px;
            margin: 0;
            color: white;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            font-size: 14px;
        }

        .admin-button, .btn-secondary {
            padding: 5px 8px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .logout-button {
            margin-top: 5px;
            padding: 8px 15px;
            font-size: 14px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .logout-button:hover {
            background: #a93226;
        }
        .admin-button {
            padding: 8px 15px;
            font-size: 14px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .admin-button:hover {
            background: #d68910;
        }
        .user-config-button {
            padding: 8px 15px;
            font-size: 14px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            transition: background 0.2s;
        }
        .user-config-button:hover {
            background: #2980b9;
        }
        
        /* Variáveis de cor para o header */
        :root {
            --primary-color: #2a3d66;
            --secondary-color: #eaf0fa;
            --accent-color: #27ae60;
            --danger-color: #c0392b;
            --text-color: #2a3d66;
            --light-text: #666;
            --border-color: #e0e6f0;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #menu-toggle {
            margin-top: 10px;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px 12px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            display: inline-block;
            transition: background 0.2s;
            border: none;
        }
        #menu-toggle:hover {
            background: #2980b9;
        }
        /* Removido o estilo .top-header que não é mais usado */
        .user-info {
            font-size: 14px;
            text-align: right;
            margin-right: 15px;
        }
        
        /* Estilos do header baseados em Agenda.html */
        header {
            background: var(--primary-color); 
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: var(--shadow);
        }
        
        header > div {
            display: flex;
            align-items: center;
        }
        
        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center;">
            <i class="fas fa-truck" style="font-size: 24px; margin-right: 10px; color: white;"></i>
            <h1 style="font-size: 20px; margin: 0; color: white;">Acompanhamento de Técnicos e Veículos - FTTH</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="currentUserName" style="font-size: 14px;"></div>
            
            <!-- Sistema de notificação para administradores -->
            <div id="notificationSystem" style="display: none; position: relative;">
                <button id="notificationButton" style="background: none; border: none; color: white; position: relative; padding: 5px; cursor: pointer;" title="Notificações">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" style="position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                </button>
                <div id="notificationDropdown" style="display: none; position: absolute; right: 0; top: 100%; width: 300px; max-height: 400px; overflow-y: auto; background: white; border-radius: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); color: var(--text-color); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color);">
                        <h3 style="margin: 0; font-size: 16px;">Notificações</h3>
                        <button id="markAllReadButton" style="font-size: 12px; padding: 3px 8px; background: var(--secondary-color); color: var(--text-color); border: none; border-radius: 3px; cursor: pointer;">Marcar todas como lidas</button>
                    </div>
                    <div id="notificationList" style="padding: 0;">
                        <div style="padding: 20px; text-align: center; color: var(--light-text);">
                            Nenhuma notificação
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="admin-button" id="adminButton" style="display: none; padding: 5px 8px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;" title="Administrar Usuários">
                <i class="fas fa-cog"></i>
            </button>
            <button class="logout-button" id="logoutButton" style="padding: 5px 10px; font-size: 12px; background: var(--danger-color); color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <!-- Menu de navegação intuitivo -->
    <nav class="main-menu" style="background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 10px 20px; margin-bottom: 20px;">
        <ul style="display: flex; list-style: none; margin: 0; padding: 0; gap: 5px; flex-wrap: wrap; justify-content: center;">
            <li class="menu-item active" style="position: relative;">
                <a href="Pagina1 (1).html" style="display: flex; align-items: center; padding: 10px 15px; color: var(--primary-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: all 0.2s ease; background: var(--secondary-color);">
                    <i class="fas fa-home" style="margin-right: 8px;"></i>
                    <span>Principal</span>
                </a>
                <div class="menu-hover-indicator" style="position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--primary-color); border-radius: 3px;"></div>
            </li>
            <li class="menu-item" style="position: relative;">
                <a href="Agenda.html" style="display: flex; align-items: center; padding: 10px 15px; color: var(--text-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: all 0.2s ease; background: transparent;">
                    <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
                    <span>Agenda</span>
                </a>
                <div class="menu-hover-indicator" style="position: absolute; bottom: -2px; left: 0; width: 0; height: 3px; background: var(--primary-color); border-radius: 3px; transition: width 0.2s ease;"></div>
            </li>
            <li class="menu-item" style="position: relative;">
                <a href="manutencao.html" style="display: flex; align-items: center; padding: 10px 15px; color: var(--text-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: all 0.2s ease; background: transparent;">
                    <i class="fas fa-tools" style="margin-right: 8px;"></i>
                    <span>Manutenção de Veículos</span>
                </a>
                <div class="menu-hover-indicator" style="position: absolute; bottom: -2px; left: 0; width: 0; height: 3px; background: var(--primary-color); border-radius: 3px; transition: width 0.2s ease;"></div>
            </li>
        </ul>
    </nav>

    <div class="container" style="padding-top: 20px;">
        <!-- Painel de Estatísticas -->
        <div id="painelEstatisticas" style="display: flex; gap: 30px; justify-content: center; margin-bottom: 25px; flex-wrap: wrap;">
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div style="font-size:2em; font-weight:bold; color:#2a3d66;" id="totalTecnicos">0</div>
                <div style="color:#2a3d66;">Total de Pessoal Técnico</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div style="font-size:2em; font-weight:bold; color:#2a3d66;" id="totalVeiculos">0</div>
                <div style="color:#2a3d66;">Total de Veículos</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div style="font-size:2em; font-weight:bold; color:#2a3d66;" id="totalCidades">0</div>
                <div style="color:#2a3d66;">Cidades Distintas</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div id="bjfibraContainer" style="font-size:1.2em; color:#2a3d66;">BJ Fibra: <span id="bjfibraCount">0</span></div>
                <div id="megalinkContainer" style="font-size:1.2em; color:#2a3d66;">Megalink: <span id="megalinkCount">0</span></div>
                <div style="color:#2a3d66; margin-top:4px;">Pessoal Técnico por Operação</div>
            </div>
            <div style="background:#eaf0fa; border-radius:8px; padding:18px 28px; min-width:180px; text-align:center;">
                <div id="bjfibraVeiculosContainer" style="font-size:1.2em; color:#2a3d66;">BJ Fibra: <span id="bjfibraVeiculosCount">0</span></div>
                <div id="megalinkVeiculosContainer" style="font-size:1.2em; color:#2a3d66;">Megalink: <span id="megalinkVeiculosCount">0</span></div>
                <div style="color:#2a3d66; margin-top:4px;">Veículos por Operação</div>
            </div>
        </div>
        <!-- Novo painel de estatísticas por cidade -->
        <div id="painelEstatisticasCidade" style="position: relative; margin: 20px 0 25px 0;">
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button id="mostrarEstatisticas" class="btn-acao btn-estatisticas">
                    <span>📊</span> Mostrar Estatísticas
                </button>
                <button id="verMapa" class="btn-acao btn-mapa">
                    <span>🗺️</span> Ver Mapa
                </button>
            </div>
            <div id="estatisticasTooltip" class="estatisticas-tooltip">
                <h3>Estatísticas por Cidade</h3>
                <div id="estatisticasConteudo"></div>
            </div>
        </div>
        <!-- Fim Painel Estatísticas -->
        <form id="registroForm">
            <div>
                <label for="cidade">Cidade</label>
                <input type="text" id="cidade" required>
            </div>
            <div>
                <label for="tecnico">Nome do Técnico</label>
                <input type="text" id="tecnico" required>
            </div>
            <div>
                <label for="auxiliar">Auxiliar</label>
                <input type="text" id="auxiliar">
            </div>
            <div>
                <label for="placa">Placa</label>
                <input type="text" id="placa" required>
            </div>
            <div>
                <label for="modelo">Modelo</label>
                <input type="text" id="modelo" required>
            </div>
            <div>
                <label for="operacao">Operação</label>
                <select id="operacao" required>
                    <option value="Megalink">Megalink</option>
                    <option value="BJ Fibra">BJ Fibra</option>
                </select>
            </div>
            <div>
                <label for="equipes">Equipes Varejo e Backbone</label>
                <input type="text" id="equipes">
            </div>
            <div>
                <label for="kmAtual">KM Atual</label>
                <input type="text" id="kmAtual">
            </div>
            <div>
                <label for="ultimaTrocaOleoInfo" style="display: flex; align-items: center;">
                    Última Troca de Óleo 
                    <span style="background: #95a5a6; color: white; font-size: 0.8em; padding: 2px 5px; border-radius: 3px; margin-left: 8px;">Somente Leitura</span>
                </label>
                <input type="text" id="ultimaTrocaOleoInfo" disabled style="background-color: #f0f0f0; color: #666;">
            </div>
            <div>
                <label for="renavam">Renavam</label>
                <input type="text" id="renavam">
            </div>
            <div>
                <label for="lat">Latitude</label>
                <input type="text" id="lat">
            </div>
            <div>
                <label for="lng">Longitude</label>
                <input type="text" id="lng">
            </div>
            <div>
                <label for="observacoes">Observações</label>
                <input type="text" id="observacoes">
            </div>
            <div>
                <label for="dataInicioContrato">Início do Contrato</label>
                <input type="date" id="dataInicioContrato">
            </div>
            <div>
                <button type="submit" id="btnSalvar">Adicionar</button>
            </div>
        </form>

        <div style="margin: 20px 0;">
            <input type="file" id="fileInput" accept=".csv" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()" style="background: #27ae60;">Importar Planilha</button>
            <button onclick="excluirTodosRegistros()" style="background: #c0392b; margin-left: 10px;">Excluir Todos os Registros</button>
        </div>

        <!-- Adicionar sistema de filtros -->
        <div style="margin: 20px 0; background: #eaf0fa; padding: 15px; border-radius: 8px;">
            <h3 style="color: #2a3d66; margin-top: 0;">Filtros</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                <div>
                    <label for="filtroCidade">Cidade</label>
                    <input type="text" id="filtroCidade" oninput="filtrarRegistros()" style="width: 150px;">
                </div>
                <div>
                    <label for="filtroTecnico">Técnico</label>
                    <input type="text" id="filtroTecnico" oninput="filtrarRegistros()" style="width: 200px;">
                </div>
                <div>
                    <label for="filtroAuxiliar">Auxiliar</label>
                    <input type="text" id="filtroAuxiliar" oninput="filtrarRegistros()" style="width: 200px;">
                </div>
                <div>
                    <label for="filtroPlaca">Placa</label>
                    <input type="text" id="filtroPlaca" oninput="filtrarRegistros()" style="width: 120px;">
                </div>
                <div>
                    <label for="filtroModelo">Modelo</label>
                    <input type="text" id="filtroModelo" oninput="filtrarRegistros()" style="width: 120px;">
                </div>
                <div>
                    <label for="filtroOperacao">Operação</label>
                    <select id="filtroOperacao" onchange="filtrarRegistros()" style="width: 120px;">
                        <option value="">Todos</option>
                        <option value="Megalink">Megalink</option>
                        <option value="BJ Fibra">BJ Fibra</option>
                    </select>
                </div>
                <div>
                    <button onclick="limparFiltros()" style="background: #2a3d66;">Limpar Filtros</button>
                </div>
            </div>
        </div>

        <table id="tabelaRegistros">
            <thead>
                <tr>
                    <th>Cidade</th>
                    <th>Nome do Técnico</th>
                    <th>Auxiliar</th>
                    <th>Placa</th>
                    <th>Modelo</th>
                    <th>Operação</th>
                    <th>Equipes Varejo e Backbone</th>
                    <th>KM Atual</th>
                    <th>Última Troca Óleo</th>
                    <th>Renavam</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Observações</th>
                    <th>Início Contrato</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Registros aparecerão aqui -->
            </tbody>
        </table>
    </div>

    <!-- Container do Mapa -->
    <div id="mapaContainer">
        <div id="mapa"></div>
    </div>

    <!-- Notificação de Alertas de Contratos -->
    <div id="alertaContratosNotificacao">
        <div class="alerta-header">
            <span>Alertas de Contratos</span>
            <button class="alerta-close" onclick="fecharAlertaNotificacao()">&times;</button>
        </div>
        <div class="alerta-body" id="alertaContratosConteudo">
            <!-- Conteúdo dos alertas será adicionado dinamicamente -->
        </div>
        <div class="alerta-footer">
            <button class="alerta-action" onclick="verTodosAlertas()">Ver Todos os Alertas</button>
        </div>
    </div>
    
    <!-- Notificação de Manutenções Frequentes -->
    <div id="alertaManutencoesNotificacao" style="display: none; position: fixed; top: 20px; right: 360px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 0; width: 320px; max-width: 90%; z-index: 1003; overflow: hidden;">
        <div class="alerta-header" style="background-color: #e74c3c; color: white; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>Manutenções Frequentes</span>
            <button class="alerta-close" onclick="fecharAlertaManutencoesNotificacao()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
        <div class="alerta-body" id="alertaManutencoesConteudo" style="padding: 15px; max-height: 300px; overflow-y: auto;">
            <!-- Conteúdo dos alertas será adicionado dinamicamente -->
        </div>
        <div class="alerta-footer" style="padding: 10px 15px; background-color: #f8f9fa; text-align: right; border-top: 1px solid #eee;">
            <button class="alerta-action" onclick="verTodosManutencoesFrequentes()" style="background: #2a3d66; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Ver Todos os Veículos</button>
        </div>
    </div>
    
    <!-- Notificação de Troca de Óleo -->
    <div id="alertaTrocaOleoNotificacao" style="display: none; position: fixed; top: 20px; right: 700px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 0; width: 320px; max-width: 90%; z-index: 1003; overflow: hidden;">
        <div class="alerta-header" style="background-color: #f39c12; color: white; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>Alertas de Troca de Óleo</span>
            <button class="alerta-close" onclick="fecharAlertaTrocaOleoNotificacao()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
        <div class="alerta-body" id="alertaTrocaOleoConteudo" style="padding: 15px; max-height: 300px; overflow-y: auto;">
            <!-- Conteúdo dos alertas será adicionado dinamicamente -->
        </div>
        <div class="alerta-footer" style="padding: 10px 15px; background-color: #f8f9fa; text-align: right; border-top: 1px solid #eee;">
            <button class="alerta-action" onclick="verTodosTrocaOleo()" style="background: #2a3d66; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Ver Todos os Veículos</button>
        </div>
    </div>

    <!-- Modal de Manutenção de Veículo -->
    <div id="manutencaoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001;">
        <div style="width: 500px; max-width: 90%; background: white; margin: 50px auto; padding: 20px; border-radius: 8px; position: relative;">
            <button onclick="fecharModalManutencao()" style="position: absolute; top: 10px; right: 10px; background: #c0392b; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px;">✕</button>
            <h2 style="color: #2a3d66; margin-top: 0;">Registro de Manutenção</h2>
            <p id="manutencaoVeiculoInfo" style="margin-bottom: 20px; font-weight: bold;"></p>
            
            <form id="manutencaoForm">
                <input type="hidden" id="manutencaoVeiculoId">
                <div style="margin-bottom: 15px;">
                    <label for="tipoManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Tipo de Manutenção</label>
                    <select id="tipoManutencao" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                        <option value="Troca de Óleo">Troca de Óleo</option>
                        <option value="Revisão">Revisão</option>
                        <option value="Troca de Pneus">Troca de Pneus</option>
                        <option value="Reparo de Motor">Reparo de Motor</option>
                        <option value="Elétrica">Elétrica</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="dataManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Data</label>
                    <input type="date" id="dataManutencao" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="kmManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Quilometragem</label>
                    <input type="number" id="kmManutencao" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="valorManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Valor (R$)</label>
                    <input type="number" id="valorManutencao" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="observacoesManutencao" style="display: block; margin-bottom: 5px; color: #2a3d66;">Observações</label>
                    <textarea id="observacoesManutencao" rows="3" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;"></textarea>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" onclick="fecharModalManutencao()" style="background: #95a5a6; color: white; border: none; border-radius: 5px; padding: 8px 15px; margin-right: 10px; cursor: pointer;">Cancelar</button>
                    <button type="submit" style="background: #2a3d66; color: white; border: none; border-radius: 5px; padding: 8px 15px; cursor: pointer;">Salvar Manutenção</button>
                </div>
            </form>
            
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <h3 style="color: #2a3d66; margin-top: 0; font-size: 16px;">Histórico de Manutenções</h3>
                <div id="historicoManutencao" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let registros = [];
        let editIndex = null;

        // Carregar registros do localStorage ao iniciar
        function carregarRegistros() {
            const dados = localStorage.getItem('registrosFTTH');
            if (dados) {
                try {
                    registros = JSON.parse(dados);
                } catch (e) {
                    registros = [];
                }
            }
        }

        // Salvar registros no localStorage
        function salvarRegistros() {
            localStorage.setItem('registrosFTTH', JSON.stringify(registros));
        }

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            // Adicionar código de depuração temporário para verificar permissões
            console.log('Usuário atual:', currentUser);
            console.log('Nível de acesso:', currentUser.accessLevel);
            console.log('É administrador?', currentUser.accessLevel === 'ADMIN');
            console.log('Permissões personalizadas?', currentUser.customPermissions);
            console.log('Lista de permissões:', currentUser.permissions);
            console.log('Tem permissão MANAGE_USERS?', Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS));
            
            // Listar todas as permissões disponíveis no nível de acesso do usuário
            if (currentUser.accessLevel && Auth.ACCESS_LEVELS[currentUser.accessLevel]) {
                console.log('Permissões do nível de acesso:', Auth.ACCESS_LEVELS[currentUser.accessLevel].permissions);
            }
            
            // Verificar permissões de visualização
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_TECHNICIANS)) {
                alert('Você não tem permissão para acessar esta página.');
                window.location.href = 'login.html';
                return;
            }
            
            // Configurar informações do usuário
            document.getElementById('currentUserName').textContent = `${currentUser.name} (${Auth.ACCESS_LEVELS[currentUser.accessLevel].name})`;
            
            // Se for administrador, mostrar botão de administração imediatamente
            if (currentUser.accessLevel === 'ADMIN') {
                const adminButton = document.getElementById('adminButton');
                adminButton.style.display = 'block';
                adminButton.addEventListener('click', () => {
                    localStorage.setItem('adminOriginPage', 'Pagina1 (1).html');
                    window.location.href = 'admin.html';
                });
            }
            
            // Configurar botão de logout
            document.getElementById('logoutButton').addEventListener('click', () => {
                Auth.logout();
                window.location.href = 'login.html';
            });
            
            // Verificar permissão para visualizar por operação
            const filtroOperacao = document.getElementById('filtroOperacao');
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION)) {
                // Se o usuário tem uma operação atribuída, mostrar apenas essa operação
                if (currentUser.operacao) {
                    filtroOperacao.value = currentUser.operacao;
                    filtroOperacao.disabled = true;
                    filtroOperacao.style.backgroundColor = '#f0f0f0';
                } else {
                    // Se não tem uma operação específica, desativar a filtragem por operação
                    filtroOperacao.parentElement.style.display = 'none';
                }
            } else {
                // Se tem permissão, não precisa fazer nada especial
            }
            
            // Adicionar evento ao botão de estatísticas
            document.getElementById('mostrarEstatisticas').addEventListener('click', mostrarEstatisticasPorCidade);
            
            // Adicionar evento ao botão do mapa
            document.getElementById('verMapa').addEventListener('click', mostrarMapa);
            
            // Verificar permissão para ver o mapa
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_MAP)) {
                document.getElementById('verMapa').style.display = 'none';
            }
            
            // Verificar permissão para ver estatísticas
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_STATISTICS)) {
                document.getElementById('mostrarEstatisticas').style.display = 'none';
            }
            
            // Carregar registros e renderizar a tabela
            carregarRegistros();
            renderizarTabela();
            atualizarEstatisticas();
            atualizarBadgeNotificacoes();
            
            // Ajustar funcionalidades baseado nas permissões
            ajustarPermissoes();
            
            // Verificar permissões e ajustar a interface
            checkPermissions();
        });
        
        // Função para ajustar a interface baseada nas permissões do usuário
        function ajustarPermissoes() {
            const btnAdicionar = document.getElementById('btnAdicionar');
            const btnLimpar = document.getElementById('btnLimpar');
            const table = document.getElementById('tabelaRegistros');
            
            // Permissão para adicionar técnicos
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.ADD_TECHNICIAN)) {
                btnAdicionar.style.display = 'none';
                btnLimpar.style.display = 'none';
                document.getElementById('formRegistro').style.display = 'none';
            }
            
            // Esconder os botões de editar e excluir para quem não tem permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TECHNICIAN) && 
                !Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                
                const acoes = table.querySelectorAll('.actions');
                acoes.forEach(acao => {
                    acao.style.display = 'none';
                });
            }
            // Esconder apenas o botão de exclusão
            else if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                const botoesExcluir = table.querySelectorAll('.btnExcluir');
                botoesExcluir.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            // Esconder apenas o botão de edição
            else if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TECHNICIAN)) {
                const botoesEditar = table.querySelectorAll('.btnEditar');
                botoesEditar.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }
        
        // Função para adicionar um novo registro
        function adicionarRegistro(event) {
            event.preventDefault();
            
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.ADD_TECHNICIAN)) {
                alert('Você não tem permissão para adicionar registros.');
                return;
            }
            
            // ... resto do código existente ...
        }
        
        // Função para editar um registro
        function editarRegistro(index) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TECHNICIAN)) {
                alert('Você não tem permissão para editar registros.');
                return;
            }
            
            // ... resto do código existente ...
        }
        
        // Função para excluir um registro
        function excluirRegistro(index) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                alert('Você não tem permissão para excluir registros.');
                return;
            }
            
            // ... resto do código existente ...
        }
        
        // Função para renderizar a tabela após alterações
        function renderizarTabela() {
            renderTabelaFiltrada(registros);
            atualizarEstatisticas();
            // Aplicar ajustes de permissões após renderizar a tabela
            setTimeout(ajustarPermissoes, 100);
        }
        
        // Alias para manter compatibilidade com o código existente
        function renderTabela() {
            renderizarTabela();
        }
        
        // Verificar permissões e ajustar a interface
        function checkPermissions() {
            const adminButton = document.getElementById('adminButton');
            const notificationSystem = document.getElementById('notificationSystem');
            
            // Verificar se é administrador OU tem permissão de gerenciar usuários
            if (currentUser.accessLevel === 'ADMIN' || Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                adminButton.style.display = 'block';
                adminButton.addEventListener('click', () => {
                    // Armazenar a página de origem antes de redirecionar
                    localStorage.setItem('adminOriginPage', 'Pagina1 (1).html');
                    window.location.href = 'admin.html';
                });
                
                // Inicializar sistema de notificações para administradores
                if (notificationSystem) {
                    notificationSystem.style.display = 'block';
                    
                    // Configurar eventos do sistema de notificações
                    setupNotificationSystem();
                }
            }
        }
        
        // Configurar sistema de notificações
        function setupNotificationSystem() {
            const notificationButton = document.getElementById('notificationButton');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const markAllReadButton = document.getElementById('markAllReadButton');
            
            // Carregar notificações do localStorage
            let notifications = JSON.parse(localStorage.getItem('adminNotifications')) || [];
            
            // Atualizar contador de notificações
            updateNotificationCount(notifications);
            
            // Adicionar evento de clique ao botão de notificações
            notificationButton.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.style.display = notificationDropdown.style.display === 'none' ? 'block' : 'none';
                
                // Renderizar lista de notificações
                renderNotificationList(notifications);
            });
            
            // Adicionar evento de clique ao botão de marcar todas como lidas
            markAllReadButton.addEventListener('click', function(e) {
                e.stopPropagation();
                markAllNotificationsAsRead(notifications);
            });
            
            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function() {
                if (notificationDropdown.style.display === 'block') {
                    notificationDropdown.style.display = 'none';
                }
            });
            
            // Evitar que o clique no dropdown feche ele
            notificationDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Atualizar contador de notificações
        function updateNotificationCount(notifications) {
            const notificationCount = document.getElementById('notificationCount');
            const unreadCount = notifications.filter(notif => !notif.read).length;
            
            notificationCount.textContent = unreadCount;
            notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
        
        // Renderizar lista de notificações
        function renderNotificationList(notifications) {
            const notificationList = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        Nenhuma notificação
                    </div>
                `;
                return;
            }
            
            notificationList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${!notification.read ? 'unread' : ''}" data-id="${notification.id}" style="padding: 10px 15px; border-bottom: 1px solid #e0e6f0; transition: background-color 0.2s; ${!notification.read ? 'background-color: #f0f7ff;' : ''}">
                    ${!notification.read ? '<div style="position: absolute; top: 7px; right: 7px; width: 8px; height: 8px; background-color: #c0392b; border-radius: 50%;"></div>' : ''}
                    <div style="font-weight: bold; margin-bottom: 3px; font-size: 14px;">${notification.title}</div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${notification.message}</div>
                    <div style="font-size: 11px; color: #666; text-align: right;">${formatTimeAgo(notification.timestamp)}</div>
                </div>
            `).join('');
            
            // Adicionar evento de clique para marcar como lida
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', () => {
                    const notificationId = parseInt(item.dataset.id);
                    markNotificationAsRead(notificationId, notifications);
                });
            });
        }
        
        // Função para marcar notificação como lida
        function markNotificationAsRead(id, notifications) {
            const index = notifications.findIndex(notif => notif.id === id);
            if (index !== -1) {
                notifications[index].read = true;
                localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                updateNotificationCount(notifications);
                renderNotificationList(notifications);
            }
        }
        
        // Função para marcar todas as notificações como lidas
        function markAllNotificationsAsRead(notifications) {
            notifications.forEach(notif => {
                notif.read = true;
            });
            localStorage.setItem('adminNotifications', JSON.stringify(notifications));
            updateNotificationCount(notifications);
            renderNotificationList(notifications);
        }
        
        // Função para formatar tempo relativo
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'agora mesmo';
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} ${minutes === 1 ? 'minuto' : 'minutos'} atrás`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} ${hours === 1 ? 'hora' : 'horas'} atrás`;
            
            const days = Math.floor(hours / 24);
            if (days < 30) return `${days} ${days === 1 ? 'dia' : 'dias'} atrás`;
            
            const months = Math.floor(days / 30);
            if (months < 12) return `${months} ${months === 1 ? 'mês' : 'meses'} atrás`;
            
            const years = Math.floor(months / 12);
            return `${years} ${years === 1 ? 'ano' : 'anos'} atrás`;
        }

        function atualizarEstatisticas() {
            // Verificar permissão para visualizar todas operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Filtrar registros pela operação do usuário se necessário
            let registrosFiltrados = registros;
            if (!podeVerTodasOperacoes && currentUser.operacao) {
                registrosFiltrados = registros.filter(r => r.operacao === currentUser.operacao);
            }
            
            // Total de técnicos (nomes únicos)
            const tecnicosUnicos = new Set(registrosFiltrados.map(r => r.tecnico.toLowerCase().trim()));
            
            // Total de auxiliares (nomes únicos)
            const auxiliaresUnicos = new Set();
            registrosFiltrados.forEach(r => {
                if (r.auxiliar && r.auxiliar.trim()) {
                    auxiliaresUnicos.add(r.auxiliar.toLowerCase().trim());
                }
            });
            
            // Total de pessoal técnico (técnicos + auxiliares)
            const totalPessoalTecnico = tecnicosUnicos.size + auxiliaresUnicos.size;
            
            document.getElementById("totalTecnicos").textContent = totalPessoalTecnico;
            
            // Total de veículos (placas únicas, apenas registros com placa)
            const veiculosUnicos = new Set();
            registrosFiltrados.forEach(r => {
                if (r.placa && r.placa.trim()) {
                    veiculosUnicos.add(r.placa.toUpperCase().trim());
                }
            });
            document.getElementById("totalVeiculos").textContent = veiculosUnicos.size;
            
            // Total de cidades distintas
            const cidadesUnicas = new Set(registrosFiltrados.map(r => r.cidade.toLowerCase().trim()));
            document.getElementById("totalCidades").textContent = cidadesUnicas.size;
            
            // Técnicos por operação
            const bjfibraTecnicos = new Set(registrosFiltrados.filter(r => r.operacao === "BJ Fibra").map(r => r.tecnico.toLowerCase().trim()));
            const bjfibraAuxiliares = new Set();
            registrosFiltrados.filter(r => r.operacao === "BJ Fibra").forEach(r => {
                if (r.auxiliar && r.auxiliar.trim()) {
                    bjfibraAuxiliares.add(r.auxiliar.toLowerCase().trim());
                }
            });
            
            const megalinkTecnicos = new Set(registrosFiltrados.filter(r => r.operacao === "Megalink").map(r => r.tecnico.toLowerCase().trim()));
            const megalinkAuxiliares = new Set();
            registrosFiltrados.filter(r => r.operacao === "Megalink").forEach(r => {
                if (r.auxiliar && r.auxiliar.trim()) {
                    megalinkAuxiliares.add(r.auxiliar.toLowerCase().trim());
                }
            });
            
            document.getElementById("bjfibraCount").textContent = bjfibraTecnicos.size + bjfibraAuxiliares.size;
            document.getElementById("megalinkCount").textContent = megalinkTecnicos.size + megalinkAuxiliares.size;
            
            // Mostrar/ocultar contadores por operação com base nas permissões
            const bjfibraContainer = document.getElementById("bjfibraContainer");
            const megalinkContainer = document.getElementById("megalinkContainer");
            const bjfibraVeiculosContainer = document.getElementById("bjfibraVeiculosContainer");
            const megalinkVeiculosContainer = document.getElementById("megalinkVeiculosContainer");
            
            if (!podeVerTodasOperacoes && currentUser.operacao) {
                // Se o usuário só pode ver uma operação, mostrar apenas a sua
                bjfibraContainer.style.display = currentUser.operacao === "BJ Fibra" ? "block" : "none";
                megalinkContainer.style.display = currentUser.operacao === "Megalink" ? "block" : "none";
                bjfibraVeiculosContainer.style.display = currentUser.operacao === "BJ Fibra" ? "block" : "none";
                megalinkVeiculosContainer.style.display = currentUser.operacao === "Megalink" ? "block" : "none";
            } else {
                // Se pode ver todas, mostrar ambas
                bjfibraContainer.style.display = "block";
                megalinkContainer.style.display = "block";
                bjfibraVeiculosContainer.style.display = "block";
                megalinkVeiculosContainer.style.display = "block";
            }
            
            // Veículos por operação
            const bjfibraVeiculos = new Set();
            registrosFiltrados.filter(r => r.operacao === "BJ Fibra").forEach(r => {
                if (r.placa && r.placa.trim()) {
                    bjfibraVeiculos.add(r.placa.toUpperCase().trim());
                }
            });
            
            const megalinkVeiculos = new Set();
            registrosFiltrados.filter(r => r.operacao === "Megalink").forEach(r => {
                if (r.placa && r.placa.trim()) {
                    megalinkVeiculos.add(r.placa.toUpperCase().trim());
                }
            });
            
            document.getElementById("bjfibraVeiculosCount").textContent = bjfibraVeiculos.size;
            document.getElementById("megalinkVeiculosCount").textContent = megalinkVeiculos.size;

            // Estatísticas por cidade
            const estatisticasPorCidade = {};
            registrosFiltrados.forEach(reg => {
                const cidade = reg.cidade.trim();
                if (!cidade) return;

                if (!estatisticasPorCidade[cidade]) {
                    estatisticasPorCidade[cidade] = {
                        tecnicos: new Set(),
                        auxiliares: new Set(),
                        veiculos: new Set(),
                        veiculosComAuxiliar: new Set()
                    };
                }

                if (reg.tecnico) {
                    estatisticasPorCidade[cidade].tecnicos.add(reg.tecnico.toLowerCase().trim());
                }
                if (reg.auxiliar && reg.auxiliar.trim()) {
                    estatisticasPorCidade[cidade].auxiliares.add(reg.auxiliar.toLowerCase().trim());
                    
                    // Só contador como veículo com auxiliar se tiver placa 
                    if (reg.placa && reg.placa.trim()) {
                        estatisticasPorCidade[cidade].veiculosComAuxiliar.add(reg.placa.toUpperCase().trim());
                    }
                }
                if (reg.placa && reg.placa.trim()) {
                    estatisticasPorCidade[cidade].veiculos.add(reg.placa.toUpperCase().trim());
                }
            });

            // Remover aviso anterior se existir
            const avisoAnterior = document.getElementById('avisoFiltroOperacao');
            if (avisoAnterior) {
                avisoAnterior.remove();
            }
        }

        document.getElementById("registroForm").onsubmit = function(e) {
            e.preventDefault();
            const cidade = document.getElementById("cidade").value.trim().toUpperCase();
            const tecnico = document.getElementById("tecnico").value.trim().toUpperCase();
            const auxiliar = document.getElementById("auxiliar").value.trim().toUpperCase();
            const placa = document.getElementById("placa").value.trim().toUpperCase();
            const modelo = document.getElementById("modelo").value.trim().toUpperCase();
            const operacao = document.getElementById("operacao").value;
            const equipes = document.getElementById("equipes").value.trim().toUpperCase();
            const kmAtual = document.getElementById("kmAtual").value.trim().toUpperCase();
            // Não pegar o valor de ultimaTrocaOleoInfo pois é somente leitura
            const renavam = document.getElementById("renavam").value.trim().toUpperCase();
            const lat = document.getElementById("lat").value.trim();
            const lng = document.getElementById("lng").value.trim();
            const observacoes = document.getElementById("observacoes").value.trim().toUpperCase();
            const dataInicioContrato = document.getElementById("dataInicioContrato").value;

            if (editIndex === null) {
                registros.push({ 
                    cidade, tecnico, auxiliar, placa, modelo, operacao, equipes, 
                    kmAtual, ultimaTrocaOleo: '', renavam, lat, lng, observacoes, dataInicioContrato,
                    manutencoes: [] // Inicializar o array de manutenções vazio para novos registros
                });
            } else {
                // Preservar o histórico de manutenções e outros dados que não estão no formulário
                const manutencoes = registros[editIndex].manutencoes || [];
                const placaOuId = registros[editIndex].placaOuId; // Preservar ID único se existir
                const semVeiculo = registros[editIndex].semVeiculo; // Preservar flag se existir
                const ultimaTrocaOleo = registros[editIndex].ultimaTrocaOleo; // Preservar a última troca de óleo
                
                registros[editIndex] = { 
                    cidade, tecnico, auxiliar, placa, modelo, operacao, equipes, 
                    kmAtual, ultimaTrocaOleo, renavam, lat, lng, observacoes, dataInicioContrato,
                    manutencoes, // Manter o histórico de manutenções existente
                    placaOuId, // Restaurar ID único se existir
                    semVeiculo // Restaurar flag se existir
                };
                editIndex = null;
                document.getElementById("btnSalvar").textContent = "Adicionar";
            }
            this.reset();
            salvarRegistros();
            renderTabela();
        };

        window.editarRegistro = function(idx) {
            const reg = registros[idx];
            document.getElementById("cidade").value = reg.cidade;
            document.getElementById("tecnico").value = reg.tecnico;
            document.getElementById("auxiliar").value = reg.auxiliar || '';
            document.getElementById("placa").value = reg.placa;
            document.getElementById("modelo").value = reg.modelo;
            document.getElementById("operacao").value = reg.operacao || '';
            document.getElementById("equipes").value = reg.equipes || '';
            document.getElementById("kmAtual").value = reg.kmAtual || '';
            document.getElementById("ultimaTrocaOleoInfo").value = reg.ultimaTrocaOleo || '';
            document.getElementById("renavam").value = reg.renavam || '';
            document.getElementById("lat").value = reg.lat || '';
            document.getElementById("lng").value = reg.lng || '';
            document.getElementById("observacoes").value = reg.observacoes || '';
            document.getElementById("dataInicioContrato").value = reg.dataInicioContrato || '';
            editIndex = idx;
            document.getElementById("btnSalvar").textContent = "Salvar";
        };

        window.removerRegistro = function(idx) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN)) {
                alert('Você não tem permissão para excluir registros.');
                return;
            }
            
            if (confirm("Tem certeza que deseja remover este registro?")) {
                registros.splice(idx, 1);
                salvarRegistros();
                renderTabela();
            }
        };

        // Adicionar função para importar CSV
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    let importCount = 0;
                    let duplicateCount = 0;
                    let tecnicosSemVeiculoCount = 0;
                    let registrosComProblema = [];
                    let linhasIgnoradas = 0;
                    
                    console.log("Iniciando importação CSV...");
                    
                    // Pular a linha de cabeçalho
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            try {
                                // Dividir a linha usando ponto e vírgula como separador
                                const values = lines[i].split(';').map(v => v.trim());
                                
                                // Verificar se tem técnico e cidade
                                const temTecnico = values[1] && values[1].trim();
                                const temCidade = values[0] && values[0].trim();
                                
                                // Se não tem nem técnico nem cidade, pular
                                if (!temTecnico && !temCidade) {
                                    linhasIgnoradas++;
                                    continue;
                                }
                                
                                // Extrair latitude e longitude do formato atual
                                let lat = '';
                                let lng = '';
                                
                                if (values[9] && values[10]) {
                                    try {
                                        if (values[5] === "BJ Fibra") {
                                            // Formato BJ Fibra: lat: -6.4037;"""lng"": -41.7382}"
                                            lat = values[9].replace('lat:', '').replace(/"/g, '').trim();
                                            lng = values[10].replace('"""lng"":', '').replace(/"/g, '').replace('}', '').trim();
                                        } else {
                                            // Formato Megalink: lat: -5.890250;" ""lng"": -42.636018}"
                                            lat = values[9].replace('lat:', '').trim();
                                            lng = values[10].replace('" ""lng"":', '').replace('}"', '').trim();
                                        }

                                        // Garantir que as coordenadas estejam no formato correto
                                        lat = lat.replace(/,/g, '.').replace(/[^0-9.-]/g, '');
                                        lng = lng.replace(/,/g, '.').replace(/[^0-9.-]/g, '');
                                        
                                        // Verificar se as coordenadas são válidas
                                        const latNum = parseFloat(lat);
                                        const lngNum = parseFloat(lng);
                                        
                                        if (isNaN(latNum) || isNaN(lngNum)) {
                                            registrosComProblema.push({
                                                linha: i + 1,
                                                cidade: values[0] || 'Não informada',
                                                tecnico: values[1] || 'Não informado',
                                                placa: values[3] || 'Sem placa',
                                                problema: 'Coordenadas inválidas',
                                                valores: `Lat: "${lat}", Lng: "${lng}"`
                                            });
                                        }
                                    } catch (coordError) {
                                        registrosComProblema.push({
                                            linha: i + 1,
                                            cidade: values[0] || 'Não informada',
                                            tecnico: values[1] || 'Não informado',
                                            placa: values[3] || 'Sem placa',
                                            problema: 'Erro ao extrair coordenadas',
                                            erro: coordError.message
                                        });
                                    }
                                }

                                // Verificar se a placa existe
                                const placa = values[3] ? values[3].trim() : '';
                                
                                // Se não tem placa mas tem técnico, criar um ID único
                                let placaOuId = placa;
                                if (!placa && temTecnico) {
                                    // Criar um ID baseado na cidade e no nome do técnico
                                    placaOuId = `SEM_PLACA_${values[0]}_${values[1]}`.toUpperCase().replace(/\s+/g, '_');
                                    tecnicosSemVeiculoCount++;
                                    console.log(`Técnico sem veículo: ${values[1]} (${values[0]}), ID gerado: ${placaOuId}`);
                                }
                                
                                // Debug: imprimir linha que contém Guadalupe
                                if (values[0] && values[0].includes('GUADALUPE')) {
                                    console.log('Encontrou registro de Guadalupe:', values);
                                }

                                const registro = {
                                    cidade: values[0] || '',
                                    tecnico: values[1] || '',
                                    auxiliar: values[2] || '',
                                    placa: placa,
                                    placaOuId: placaOuId,
                                    modelo: values[4] || '',
                                    operacao: values[5] || '',
                                    equipes: values[6] || '',
                                    ultimaTrocaOleo: values[7] || '',
                                    renavam: values[8] || '',
                                    lat: lat,
                                    lng: lng,
                                    observacoes: values[11] || '',
                                    semVeiculo: !placa && temTecnico,
                                    dataInicioContrato: values[12] ? values[12].trim() : null
                                };

                                // Se não tem placa nem técnico, pular
                                if (!placaOuId) {
                                    registrosComProblema.push({
                                        linha: i + 1,
                                        cidade: values[0] || 'Não informada',
                                        problema: 'Registro sem identificação (sem técnico e sem placa)'
                                    });
                                    continue;
                                }

                                // Verificar se o registro já existe (baseado na placa ou ID)
                                const registroExistente = registros.findIndex(r => 
                                    r.placaOuId && r.placaOuId.toUpperCase() === registro.placaOuId.toUpperCase()
                                );
                                
                                if (registroExistente >= 0) {
                                    duplicateCount++;
                                    
                                    // Preservar o histórico de manutenções do registro existente
                                    const manutencoesExistentes = registros[registroExistente].manutencoes || [];
                                    
                                    // Se for Guadalupe, ou se a cidade atual estiver preenchida e a existente não, atualize o registro
                                    if (registro.cidade.includes('GUADALUPE') || 
                                        (registro.cidade && !registros[registroExistente].cidade)) {
                                        console.log(`Atualizando registro existente para ID ${registro.placaOuId} da cidade ${registro.cidade}`);
                                        // Adicionar as manutenções existentes ao registro atualizado
                                        registro.manutencoes = manutencoesExistentes;
                                        registros[registroExistente] = registro;
                                    } else {
                                        // Mesmo que não atualize outros campos, garantir que as manutenções são preservadas
                                        registros[registroExistente].manutencoes = manutencoesExistentes;
                                    }
                                } else {
                                    // Novo registro, inicializar o array de manutenções vazio
                                    registro.manutencoes = [];
                                    registros.push(registro);
                                    importCount++;
                                }
                            } catch (error) {
                                // Registrar erro de processamento
                                registrosComProblema.push({
                                    linha: i + 1,
                                    conteudo: lines[i],
                                    problema: 'Erro no processamento',
                                    erro: error.message
                                });
                            }
                        } else {
                            linhasIgnoradas++;
                        }
                    }
                    salvarRegistros();
                    renderTabela();
                    console.log(`Importação concluída. ${importCount} registros importados, ${duplicateCount} duplicados tratados, ${tecnicosSemVeiculoCount} técnicos sem veículo.`);
                    
                    // Exibir resultado da importação com detalhes
                    let mensagem = `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; font-size: 1.2em; margin-bottom: 10px; color: #2a3d66;">Resultado da Importação</div>
                            <ul style="margin-bottom: 15px; padding-left: 20px;">
                                <li><span style="color: #27ae60; font-weight: bold;">${importCount}</span> novos registros importados</li>
                                <li><span style="color: #f39c12; font-weight: bold;">${duplicateCount}</span> registros existentes verificados</li>
                                <li><span style="color: #3498db; font-weight: bold;">${tecnicosSemVeiculoCount}</span> técnicos sem veículo</li>
                                <li><span style="color: #95a5a6; font-weight: bold;">${linhasIgnoradas}</span> linhas vazias ignoradas</li>
                            </ul>
                    `;
                    
                    // Adicionar informações de problemas, se houver
                    if (registrosComProblema.length > 0) {
                        mensagem += `
                            <div style="color: #e74c3c; font-weight: bold; margin-bottom: 10px;">
                                Atenção: ${registrosComProblema.length} registros com problemas foram encontrados!
                            </div>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e74c3c; padding: 10px; margin-bottom: 15px; background: #fff5f5; border-radius: 5px;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="background: #e74c3c; color: white; text-align: left;">
                                        <th style="padding: 5px;">Linha</th>
                                        <th style="padding: 5px;">Local</th>
                                        <th style="padding: 5px;">Problema</th>
                                    </tr>
                        `;
                        
                        registrosComProblema.forEach((problema, index) => {
                            mensagem += `
                                <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: rgba(255,255,255,0.6);' : ''}">
                                    <td style="padding: 5px;">${problema.linha}</td>
                                    <td style="padding: 5px;">${problema.cidade || ''} ${problema.placa ? `(${problema.placa})` : ''}</td>
                                    <td style="padding: 5px;">${problema.problema}</td>
                                </tr>
                            `;
                        });
                        
                        mensagem += `
                                </table>
                            </div>
                        `;
                    }
                    
                    // Fechar div principal
                    mensagem += `</div>`;
                    
                    // Mostrar modal com resultado
                    mostrarModalResultadoImportacao(mensagem);
                };
                reader.readAsText(file, 'ISO-8859-1');
            }
        });
        
        // Função para mostrar modal com resultado da importação
        function mostrarModalResultadoImportacao(conteudo) {
            // Criar o modal
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '2000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Criar o conteúdo do modal
            const modalContent = document.createElement('div');
            modalContent.style.background = 'white';
            modalContent.style.padding = '25px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '600px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflow = 'auto';
            modalContent.style.position = 'relative';
            modalContent.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
            
            // Adicionar título
            const titulo = document.createElement('div');
            titulo.style.fontSize = '1.4em';
            titulo.style.fontWeight = 'bold';
            titulo.style.marginBottom = '15px';
            titulo.style.color = '#2a3d66';
            titulo.style.paddingBottom = '10px';
            titulo.style.borderBottom = '2px solid #eee';
            titulo.textContent = 'Resultado da Importação';
            
            // Adicionar botão de fechar
            const btnFechar = document.createElement('button');
            btnFechar.innerHTML = '×';
            btnFechar.style.position = 'absolute';
            btnFechar.style.top = '15px';
            btnFechar.style.right = '15px';
            btnFechar.style.background = '#e74c3c';
            btnFechar.style.color = 'white';
            btnFechar.style.border = 'none';
            btnFechar.style.borderRadius = '50%';
            btnFechar.style.width = '30px';
            btnFechar.style.height = '30px';
            btnFechar.style.fontSize = '20px';
            btnFechar.style.cursor = 'pointer';
            btnFechar.style.display = 'flex';
            btnFechar.style.justifyContent = 'center';
            btnFechar.style.alignItems = 'center';
            
            // Adicionar conteúdo personalizado
            const conteudoDiv = document.createElement('div');
            conteudoDiv.innerHTML = conteudo;
            
            // Adicionar botão "OK"
            const btnOk = document.createElement('button');
            btnOk.textContent = 'OK';
            btnOk.style.background = '#2a3d66';
            btnOk.style.color = 'white';
            btnOk.style.border = 'none';
            btnOk.style.borderRadius = '5px';
            btnOk.style.padding = '10px 20px';
            btnOk.style.marginTop = '15px';
            btnOk.style.cursor = 'pointer';
            btnOk.style.fontSize = '1em';
            btnOk.style.fontWeight = 'bold';
            btnOk.style.width = '100%';
            
            // Adicionar evento para fechar o modal
            const fecharModal = () => {
                document.body.removeChild(modal);
            };
            
            btnFechar.addEventListener('click', fecharModal);
            btnOk.addEventListener('click', fecharModal);
            
            // Montar o modal
            modalContent.appendChild(titulo);
            modalContent.appendChild(btnFechar);
            modalContent.appendChild(conteudoDiv);
            modalContent.appendChild(btnOk);
            modal.appendChild(modalContent);
            
            // Adicionar à página
            document.body.appendChild(modal);
        }

        // Adicionar função para excluir todos os registros
        window.excluirTodosRegistros = function() {
            if (confirm("Tem certeza que deseja excluir TODOS os registros? Esta ação não pode ser desfeita.")) {
                registros = [];
                salvarRegistros();
                renderTabela();
                alert("Todos os registros foram excluídos com sucesso!");
            }
        };

        // Inicializa a tabela com dados do localStorage
        carregarRegistros();
        
        // Verificar e corrigir problemas automicamente
        setTimeout(() => {
            const duplicadosRemovidos = limparRegistrosDuplicados();
            const guadalupeAdicionado = adicionarRegistroGuadalupe();
            
            if (duplicadosRemovidos > 0 || guadalupeAdicionado) {
                console.log(`Correção automática: ${duplicadosRemovidos} duplicados removidos, Guadalupe ${guadalupeAdicionado ? 'adicionado' : 'já existente'}`);
            }
            
        renderTabela();
            
            // Verificar alertas de contratos e manutenções frequentes após carregar a tabela
            verificarAlertasContratos();
            verificarAlertasManutencoesFrequentes();
            verificarAlertasTrocaOleo();
        }, 500);
        
        // Adicionar um botão para corrigir registros
        const divBotoes = document.querySelector('div[style="margin: 20px 0;"]');
        const btnCorrigir = document.createElement('button');
        btnCorrigir.textContent = 'Corrigir Registros';
        btnCorrigir.style.background = '#3498db';
        btnCorrigir.style.marginLeft = '10px';
        btnCorrigir.onclick = function() {
            // Armazenar registros antes das correções para comparação posterior
            const registrosAntes = JSON.parse(JSON.stringify(registros));
            
            // Aplicar correções
            const duplicadosRemovidos = limparRegistrosDuplicados();
            const guadalupeAdicionado = adicionarRegistroGuadalupe();
            
            // Preparar relatório detalhado
            let relatorio = `<div style="max-height: 500px; overflow-y: auto;">
                <div style="margin-bottom: 15px;">
                    <h3 style="margin-top: 0; color: #2a3d66; font-size: 1.3em;">Relatório de Correções</h3>`;
            
            // Detalhes sobre os registros duplicados
            if (duplicadosRemovidos > 0) {
                relatorio += `<div style="margin-bottom: 20px;">
                    <div style="font-weight: bold; color: #e74c3c; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;">
                        ${duplicadosRemovidos} registros duplicados removidos
                    </div>
                    <div style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; background: #f9f9f9; border-radius: 5px; padding: 10px;">`;
                
                // Encontrar quais registros foram removidos
                const registrosRemovidos = [];
                const idRegistrosDepois = new Set(registros.map(r => r.placaOuId || r.placa));
                
                registrosAntes.forEach(regAntigo => {
                    const id = regAntigo.placaOuId || regAntigo.placa;
                    if (id && !idRegistrosDepois.has(id)) {
                        registrosRemovidos.push(regAntigo);
                    }
                });
                
                if (registrosRemovidos.length > 0) {
                    relatorio += `<table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: #eee; font-weight: bold;">
                            <th style="padding: 8px; text-align: left;">Placa/ID</th>
                            <th style="padding: 8px; text-align: left;">Técnico</th>
                            <th style="padding: 8px; text-align: left;">Cidade</th>
                            <th style="padding: 8px; text-align: left;">Motivo</th>
                        </tr>`;
                    
                    registrosRemovidos.forEach(reg => {
                        // Encontrar o registro mantido para comparar
                        const registroMantido = registros.find(r => 
                            (r.placa && r.placa.toUpperCase() === reg.placa?.toUpperCase()) ||
                            (r.placaOuId && reg.placaOuId && r.placaOuId.toUpperCase() === reg.placaOuId.toUpperCase())
                        );
                        
                        const motivo = registroMantido ? 
                            "Duplicado: registro mais completo mantido" : 
                            "Duplicado: registro mais recente mantido";
                        
                        relatorio += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${reg.placa || reg.placaOuId || 'N/A'}</td>
                            <td style="padding: 8px;">${reg.tecnico || 'N/A'}</td>
                            <td style="padding: 8px;">${reg.cidade || 'N/A'}</td>
                            <td style="padding: 8px;">${motivo}</td>
                        </tr>`;
                    });
                    
                    relatorio += `</table>`;
                } else {
                    relatorio += `<p style="color: #666; font-style: italic;">Detalhes não disponíveis para os registros removidos.</p>`;
                }
                
                relatorio += `</div></div>`;
            } else {
                relatorio += `<div style="margin-bottom: 10px; color: #27ae60;">
                    <p>✓ Não foram encontrados registros duplicados.</p>
                </div>`;
            }
            
            // Detalhes sobre a correção do registro de Guadalupe
            if (guadalupeAdicionado) {
                // Encontrar o registro de Guadalupe
                const regGuadalupe = registros.find(r => 
                    r.cidade.includes('GUADALUPE') && r.placa === 'QRS-4J09');
                
                relatorio += `<div style="margin-bottom: 20px;">
                    <div style="font-weight: bold; color: #3498db; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;">
                        Registro de Guadalupe ${regGuadalupe ? 'adicionado/corrigido' : 'processado'}
                    </div>`;
                
                if (regGuadalupe) {
                    relatorio += `<div style="background: #f0f9ff; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 8px; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: #2a3d66;">Placa:</div>
                            <div>${regGuadalupe.placa}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Técnico:</div>
                            <div>${regGuadalupe.tecnico}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Auxiliar:</div>
                            <div>${regGuadalupe.auxiliar || 'N/A'}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Modelo:</div>
                            <div>${regGuadalupe.modelo}</div>
                            <div style="font-weight: bold; color: #2a3d66;">Coordenadas:</div>
                            <div>Lat: ${regGuadalupe.lat}, Lng: ${regGuadalupe.lng}</div>
                        </div>
                        <div style="font-style: italic; color: #666; font-size: 0.9em;">
                            Este é um registro especial que deve ser mantido no sistema.
                        </div>
                    </div>`;
                }
                
                relatorio += `</div>`;
            } else {
                relatorio += `<div style="margin-bottom: 10px; color: #27ae60;">
                    <p>✓ O registro de Guadalupe já existe e está correto.</p>
                </div>`;
            }
            
            if (duplicadosRemovidos === 0 && !guadalupeAdicionado) {
                relatorio += `<div style="text-align: center; margin: 20px 0; padding: 15px; background: #e8f8f5; border-radius: 5px; color: #27ae60; font-weight: bold;">
                    Nenhuma correção necessária. Todos os registros estão corretos.
                </div>`;
            }
            
            relatorio += `</div></div>`;
            
            // Mostrar o relatório em um modal
            mostrarModalRelatorioCorrecoes(relatorio);
        };
        divBotoes.appendChild(btnCorrigir);

        // Função para mostrar o modal com o relatório de correções
        function mostrarModalRelatorioCorrecoes(conteudo) {
            // Criar o modal
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '2000';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            
            // Criar o conteúdo do modal
            const modalContent = document.createElement('div');
            modalContent.style.background = 'white';
            modalContent.style.padding = '25px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '700px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflow = 'auto';
            modalContent.style.position = 'relative';
            modalContent.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
            
            // Adicionar título
            const titulo = document.createElement('div');
            titulo.style.fontSize = '1.4em';
            titulo.style.fontWeight = 'bold';
            titulo.style.marginBottom = '15px';
            titulo.style.color = '#2a3d66';
            titulo.style.paddingBottom = '10px';
            titulo.style.borderBottom = '2px solid #eee';
            titulo.textContent = 'Relatório de Correções de Registros';
            
            // Adicionar botão de fechar
            const btnFechar = document.createElement('button');
            btnFechar.innerHTML = '×';
            btnFechar.style.position = 'absolute';
            btnFechar.style.top = '15px';
            btnFechar.style.right = '15px';
            btnFechar.style.background = '#e74c3c';
            btnFechar.style.color = 'white';
            btnFechar.style.border = 'none';
            btnFechar.style.borderRadius = '50%';
            btnFechar.style.width = '30px';
            btnFechar.style.height = '30px';
            btnFechar.style.fontSize = '20px';
            btnFechar.style.cursor = 'pointer';
            btnFechar.style.display = 'flex';
            btnFechar.style.justifyContent = 'center';
            btnFechar.style.alignItems = 'center';
            
            // Adicionar conteúdo personalizado
            const conteudoDiv = document.createElement('div');
            conteudoDiv.innerHTML = conteudo;
            
            // Adicionar botão "OK"
            const btnOk = document.createElement('button');
            btnOk.textContent = 'Fechar';
            btnOk.style.background = '#2a3d66';
            btnOk.style.color = 'white';
            btnOk.style.border = 'none';
            btnOk.style.borderRadius = '5px';
            btnOk.style.padding = '10px 20px';
            btnOk.style.marginTop = '15px';
            btnOk.style.cursor = 'pointer';
            btnOk.style.fontSize = '1em';
            btnOk.style.fontWeight = 'bold';
            btnOk.style.width = '100%';
            
            // Adicionar evento para fechar o modal
            const fecharModal = () => {
                document.body.removeChild(modal);
            };
            
            btnFechar.addEventListener('click', fecharModal);
            btnOk.addEventListener('click', fecharModal);
            
            // Montar o modal
            modalContent.appendChild(titulo);
            modalContent.appendChild(btnFechar);
            modalContent.appendChild(conteudoDiv);
            modalContent.appendChild(btnOk);
            modal.appendChild(modalContent);
            
            // Adicionar à página
            document.body.appendChild(modal);
        }

        // Adicionar funcionalidade de toggle para as estatísticas
        // document.getElementById('toggleEstatisticas').addEventListener('click', function() {
        //     const estatisticasCidade = document.getElementById('estatisticasCidade');
        //     const botao = this;
            
        //     if (estatisticasCidade.style.display === 'none') {
        //         estatisticasCidade.style.display = 'grid';
        //         botao.textContent = 'Ocultar Estatísticas';
        //     } else {
        //         estatisticasCidade.style.display = 'none';
        //         botao.textContent = 'Mostrar Estatísticas';
        //     }
        // });

        // Dicionário de coordenadas das cidades
        const CIDADES_COORDENADAS = {
            "Água Branca": {"lat": -5.890250, "lng": -42.636018},
            "Alagoinha Do Piauí": {"lat": -7.7034, "lng": -41.1470},
            "Amarante": {"lat": -6.2433, "lng": -42.8433},
            "Angical Do Piauí": {"lat": -6.0847, "lng": -42.7400},
            "Aroazes": {"lat": -6.110532072594805, "lng": -41.789924993255},
            "Balsas": {"lat": -7.5328, "lng": -46.0358},
            "Barão De Grajaú": {"lat": -6.7469, "lng": -43.0286},
            "Batalha": {"lat": -4.0247, "lng": -42.1350},
            "Bom Jesus": {"lat": -9.0744, "lng": -44.3586},
            "Caridade Do Piauí": {"lat": -7.7358, "lng": -40.8431},
            "Caxias": {"lat": -4.8589, "lng": -43.3558},
            "Cocal": {"lat": -3.4728, "lng": -41.5542},
            "Colinas": {"lat": -6.0258, "lng": -44.2492},
            "Colônia Do Gurguéia": {"lat": -8.1833, "lng": -43.8000},
            "Corrente": {"lat": -10.4433, "lng": -45.1628},
            "Cristino Castro": {"lat": -8.815289716872442, "lng": -44.21511715975416},
            "Currais": {"lat": -9.0111, "lng": -44.4061},
            "Eliseu Martins": {"lat": -8.0969, "lng": -43.6669},
            "Floriano": {"lat": -6.7669, "lng": -43.0211},
            "Formosa Do Rio Preto": {"lat": -11.0478, "lng": -45.1931},
            "Fronteiras": {"lat": -7.0889, "lng": -40.6169},
            "Geminiano": {"lat": -7.1558, "lng": -41.3578},
            "Gilbués": {"lat": -9.8319, "lng": -45.3433},
            "Guadalupe": {"lat": -6.7858, "lng": -43.5589},
            "Imperatriz": {"lat": -5.5258, "lng": -47.4758},
            "Ipiranga Do Piauí": {"lat": -6.8250, "lng": -41.7378},
            "Isaías Coelho": {"lat": -7.7358, "lng": -41.6733},
            "Itainópolis": {"lat": -7.4489, "lng": -41.4778},
            "Itapecuru Mirim": {"lat": -3.3928, "lng": -44.3586},
            "Landri Sales": {"lat": -7.2589, "lng": -43.9319},
            "Matões": {"lat": -5.5219, "lng": -43.2019},
            "Monsenhor Gil": {"lat": -5.5628, "lng": -42.6075},
            "Monte Alegre Do Piauí": {"lat": -9.7558, "lng": -45.3031},
            "Nazaré Do Piauí": {"lat": -6.9708, "lng": -42.6739},
            "Nazária": {"lat": -5.3517, "lng": -42.8158},
            "Oeiras": {"lat": -7.0158, "lng": -42.1283},
            "Parnarama": {"lat": -5.6808, "lng": -43.0939},
            "Paulistana": {"lat": -8.1439, "lng": -41.1508},
            "Picos": {"lat": -7.0769, "lng": -41.4669},
            "Pimenteiras": {"lat": -6.2389, "lng": -41.4169},
            "Piripiri": {"lat": -4.2736, "lng": -41.7769},
            "Presidente Dutra": {"lat": -5.2900, "lng": -44.4900},
            "Regeneração": {"lat": -6.2389, "lng": -42.6869},
            "Redenção Do Gurguéia": {"lat": -9.4833, "lng": -44.5833},
            "Santa Luz": {"lat": -8.9489, "lng": -44.1292},
            "Santana Do Maranhão": {"lat": -3.1097, "lng": -42.4078},
            "São Francisco Do Piauí": {"lat": -7.2489, "lng": -42.5419},
            "São Gonçalo Do Gurguéia": {"lat": -9.9833, "lng": -45.3000},
            "São Gonçalo Do Piauí": {"lat": -5.9939, "lng": -42.7000},
            "São João Do Piauí": {"lat": -8.3489, "lng": -42.2558},
            "São Luís": {"lat": -2.5300, "lng": -44.3028},
            "São Pedro Do Piauí": {"lat": -5.9289, "lng": -42.7189},
            "Simplício Mendes": {"lat": -7.8558, "lng": -41.9078},
            "Sussuapara": {"lat": -7.2000, "lng": -41.6669},
            "Teresina": {"lat": -5.0950, "lng": -42.8042},
            "Tutóia": {"lat": -2.7619, "lng": -42.2744},
            "Urbano Santos": {"lat": -3.2067, "lng": -43.4058},
            "Valença Do Piauí": {"lat": -6.3789, "lng": -41.7378},
            "Vera Mendes": {"lat": -7.6000, "lng": -41.4669},
            "Parnaíba": {"lat": -2.9102786674619714, "lng": -41.75425213603615},
            "Paraibano": {"lat": -6.431902599526348, "lng": -43.988166344014985},
            "Piritoró": {"lat": -4.37293138053947, "lng": -44.34183072987808},
            "Palmeira do Piauí": {"lat": -8.722678610849579, "lng": -44.23630399911177}
        };

        let mapa = null;

        // Função para mostrar o mapa
        function mostrarMapa() {
            document.getElementById('mapaContainer').style.display = 'block';
            
            if (!mapa) {
                mapa = L.map('mapa').setView([-6.0, -42.0], 7);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(mapa);

                // Adicionar botão de fechar
                const fecharButton = document.createElement('button');
                fecharButton.className = 'fecharMapa';
                fecharButton.innerHTML = '✕ Fechar Mapa';
                fecharButton.style.position = 'absolute';
                fecharButton.style.top = '15px';
                fecharButton.style.right = '15px';
                fecharButton.style.background = '#c0392b';
                fecharButton.style.color = 'white';
                fecharButton.style.border = 'none';
                fecharButton.style.padding = '10px 18px';
                fecharButton.style.borderRadius = '5px';
                fecharButton.style.cursor = 'pointer';
                fecharButton.style.fontWeight = 'bold';
                fecharButton.style.fontSize = '0.95em';
                fecharButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
                fecharButton.style.transition = 'all 0.2s ease';
                fecharButton.style.zIndex = '1001';
                fecharButton.style.display = 'flex';
                fecharButton.style.alignItems = 'center';
                fecharButton.style.gap = '5px';
                fecharButton.onclick = fecharMapa;
                document.getElementById('mapa').appendChild(fecharButton);

                // Verificar permissão para visualizar todas as operações
                const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
                
                // Adicionar controle de filtro de operação (sempre mostrar, mas com conteúdo diferente)
                const filtroContainer = L.control({position: 'topleft'});
                filtroContainer.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.style.backgroundColor = 'white';
                    div.style.padding = '20px';
                    div.style.borderRadius = '8px';
                    div.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    div.style.marginTop = '10px';
                    div.style.minWidth = '200px';
                    
                    // Conteúdo diferente baseado na permissão
                    if (podeVerTodasOperacoes) {
                    div.innerHTML = `
                        <div style="margin-bottom: 15px; font-weight: bold; color: #2a3d66; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                            Filtrar por Operação
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: block; width: 100%; padding: 5px; border-radius: 4px; background-color: #f9f9f9;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="filtroMegalink" checked onchange="atualizarMarcadores()" style="margin-right: 20px; transform: scale(1.2);">
                                    <span style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                        <span style="display: inline-block; width: 12px; height: 12px; background-color: #000033; border-radius: 50%;"></span>
                                        Megalink
                                    </span>
                                </label>
                            </div>
                                <div style="display: block; width: 100%; padding: 5px; border-radius: 4px; background-color: #f9f9f9;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="filtroBJFibra" checked onchange="atualizarMarcadores()" style="margin-right: 20px; transform: scale(1.2);">
                                    <span style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                        <span style="display: inline-block; width: 12px; height: 12px; background-color: #FF6B00; border-radius: 50%;"></span>
                                        BJFibra
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button id="aplicarFiltros" style="background: #2a3d66; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; width: 100%; font-weight: bold;" onclick="atualizarMarcadores()">
                                Atualizar Mapa
                            </button>
                        </div>
                    `;
                    } else if (currentUser.operacao) {
                        // Usuário com operação específica
                        const corOperacao = currentUser.operacao === "BJ Fibra" ? "#FF6B00" : "#000033";
                        div.innerHTML = `
                            <div style="margin-bottom: 15px; font-weight: bold; color: #2a3d66; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                                Sua Operação
                            </div>
                            <div style="padding: 15px; font-size: 14px; text-align: center; background: #f9f9f9; border-radius: 5px; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    <span style="display: inline-block; width: 16px; height: 16px; background-color: ${corOperacao}; border-radius: 50%;"></span>
                                    <span style="font-weight: bold;">${currentUser.operacao}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // Usuário sem operação específica
                        div.innerHTML = `
                            <div style="margin-bottom: 15px; font-weight: bold; color: #2a3d66; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                                Informações
                            </div>
                        `;
                    }
                    
                    // Prevenir propagação de eventos de mouse para o mapa quando interagir com o controle
                    L.DomEvent.disableClickPropagation(div);
                    return div;
                };
                filtroContainer.addTo(mapa);

                // Adicionar legenda
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.style.backgroundColor = 'white';
                    div.style.padding = '12px';
                    div.style.borderRadius = '8px';
                    div.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    div.innerHTML = `
                        <div style="margin-bottom: 15px; font-weight: bold; color: #2a3d66; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                            Legenda
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 10px;">
                            <div style="display: block; width: 100%; padding: 8px; border-radius: 4px; background-color: #f9f9f9;">
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 16px; height: 16px; background-color: #FF6B00; border-radius: 50%; margin-right: 10px;"></div>
                                    <span style="font-size: 13px;">BJ Fibra</span>
                                </div>
                            </div>
                            <div style="display: block; width: 100%; padding: 8px; border-radius: 4px; background-color: #f9f9f9;">
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 16px; height: 16px; background-color: #000033; border-radius: 50%; margin-right: 10px;"></div>
                                    <span style="font-size: 13px;">Megalink</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return div;
                };
                legend.addTo(mapa);

                // Adicionar estilo para o ícone personalizado
                const style = document.createElement('style');
                style.textContent = `
                    .custom-div-icon {
                        background: none;
                        border: none;
                    }
                `;
                document.head.appendChild(style);
            }

            // Atualizar os marcadores
            atualizarMarcadores();
        }

        // Função para atualizar os marcadores com base nos filtros
        function atualizarMarcadores() {
            // Remover todos os marcadores existentes
            if (mapa) {
                mapa.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        mapa.removeLayer(layer);
                    }
                });

                // Verificar permissão para visualizar todas as operações
                const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
                
                // Determinar quais operações mostrar com base nas permissões
                let mostrarMegalink = true;
                let mostrarBJFibra = true;
                
                if (podeVerTodasOperacoes) {
                    // Se tem permissão, usar os filtros checkbox
                    const filtroMegalink = document.getElementById('filtroMegalink');
                    const filtroBJFibra = document.getElementById('filtroBJFibra');
                    
                    mostrarMegalink = filtroMegalink ? filtroMegalink.checked : true;
                    mostrarBJFibra = filtroBJFibra ? filtroBJFibra.checked : true;
                } else if (currentUser.operacao) {
                    // Se não tem permissão e tem operação atribuída, mostrar apenas essa operação
                    mostrarMegalink = currentUser.operacao === "Megalink";
                    mostrarBJFibra = currentUser.operacao === "BJ Fibra";
                }

                // Agrupar registros por cidade
                const registrosPorCidade = {};
                registros.forEach(reg => {
                    if (!reg.cidade) return;
                    
                    const cidade = reg.cidade.trim();
                    if (!registrosPorCidade[cidade]) {
                        registrosPorCidade[cidade] = {
                            registros: [],
                            tecnicos: new Set(),
                            auxiliares: new Set()
                        };
                    }
                    registrosPorCidade[cidade].registros.push(reg);
                    
                    if (reg.tecnico) {
                        registrosPorCidade[cidade].tecnicos.add(reg.tecnico.toLowerCase().trim());
                    }
                    if (reg.auxiliar && reg.auxiliar.trim()) {
                        registrosPorCidade[cidade].auxiliares.add(reg.auxiliar.toLowerCase().trim());
                    }
                });

                // Adicionar marcadores para cada cidade
                Object.entries(registrosPorCidade).forEach(([cidade, dadosCidade]) => {
                    const registrosCidade = dadosCidade.registros;
                    const totalTecnicos = dadosCidade.tecnicos.size;
                    const totalAuxiliares = dadosCidade.auxiliares.size;
                    
                    // Tentar encontrar um registro com coordenadas para esta cidade
                    const registroComCoordenadas = registrosCidade.find(reg => {
                        // Verificar filtros de operação
                        if ((reg.operacao === "Megalink" && !mostrarMegalink) || 
                            (reg.operacao === "BJ Fibra" && !mostrarBJFibra)) {
                            return false;
                        }

                        let lat = reg.lat;
                        let lng = reg.lng;

                        if (lat && lng) {
                            lat = parseFloat(lat);
                            lng = parseFloat(lng);
                            return !isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0;
                        }
                        return false;
                    });

                    if (registroComCoordenadas) {
                        let lat = parseFloat(registroComCoordenadas.lat);
                        let lng = parseFloat(registroComCoordenadas.lng);

                            const popupContent = `
                                <div style="max-width: 350px;">
                                    <h3 style="margin: 0 0 10px 0; color: #2a3d66;">${cidade}</h3>
                                    <div style="max-height: 400px; overflow-y: auto;">
                                        ${registrosCidade.map(reg => {
                                        const temAuxiliar = reg.auxiliar && reg.auxiliar.trim() !== '';
                                        const temVeiculo = reg.placa && reg.placa.trim();
                                        
                                            return `
                                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); ${!temVeiculo ? 'font-style: italic; background: #f9f9f9;' : ''}">
                                                <div style="font-weight: bold; color: #2a3d66; margin-bottom: 5px;">${reg.tecnico || 'Não informado'}</div>
                                                ${temAuxiliar ? '<div style="color: #27ae60; font-size: 0.9em; margin-bottom: 5px;">⚠️ Este veículo possui técnico e auxiliar</div>' : ''}
                                            ${!temVeiculo ? '<div style="color: #888; font-size: 0.9em; margin-bottom: 5px;">👤 Técnico sem veículo atribuído</div>' : ''}
                                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                                <tr>
                                                    <td style="padding: 3px; color: #666; width: 40%;">Auxiliar:</td>
                                                    <td style="padding: 3px;">${reg.auxiliar || 'Não informado'}</td>
                                                </tr>
                                                ${temVeiculo ? `
                                                    <tr>
                                                        <td style="padding: 3px; color: #666; width: 40%;">Placa:</td>
                                                    <td style="padding: 3px;">${reg.placa}</td>
                                                    </tr>
                                                    <tr>
                                                        <td style="padding: 3px; color: #666;">Modelo:</td>
                                                        <td style="padding: 3px;">${reg.modelo || 'Não informado'}</td>
                                                </tr>` : ''}
                                                    <tr>
                                                        <td style="padding: 3px; color: #666;">Operação:</td>
                                                        <td style="padding: 3px;">${reg.operacao || 'Não informada'}</td>
                                                    </tr>
                                                ${temVeiculo ? `
                                                    <tr>
                                                        <td style="padding: 3px; color: #666;">Equipes:</td>
                                                        <td style="padding: 3px;">${reg.equipes || 'Não informado'}</td>
                                                    </tr>
                                                    <tr>
                                                        <td style="padding: 3px; color: #666;">Última Troca de Óleo:</td>
                                                        <td style="padding: 3px;">${reg.ultimaTrocaOleo || 'Não informado'}</td>
                                                    </tr>
                                                    <tr>
                                                        <td style="padding: 3px; color: #666;">RENAVAM:</td>
                                                        <td style="padding: 3px;">${reg.renavam || 'Não informado'}</td>
                                                </tr>` : ''}
                                                    <tr>
                                                        <td style="padding: 3px; color: #666;">Observações:</td>
                                                        <td style="padding: 3px;">${reg.observacoes || 'Não informado'}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        `;
                                    }).join('')}
                                    </div>
                                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.9em; color: #2a3d66;">
                                    <div style="display: grid; grid-template-columns: auto auto; gap: 10px;">
                                        <div style="font-weight: bold;">Técnicos:</div>
                                        <div>${totalTecnicos}</div>
                                        <div style="font-weight: bold;">Auxiliares:</div>
                                        <div>${totalAuxiliares}</div>
                                    </div>
                                    </div>
                                </div>
                            `;
                            
                        // Determinar a cor do marcador com base na operação predominante
                        const countBJFibra = registrosCidade.filter(r => r.operacao === "BJ Fibra").length;
                        const countMegalink = registrosCidade.filter(r => r.operacao === "Megalink").length;
                        const cor = countBJFibra > countMegalink ? "#FF6B00" : "#000033";
                        
                            const icone = L.divIcon({
                                className: 'custom-div-icon',
                                html: `
                                    <div style="position: relative;">
                                        <div style="position: absolute; top: -10px; right: -10px; width: 22px; height: 22px; background-color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid ${cor};">
                                            <div style="color: ${cor}; font-weight: bold; font-size: 12px;">
                                            ${totalTecnicos}
                                            </div>
                                        </div>
                                        <svg width="30" height="45" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12.5 0C5.59644 0 0 5.59644 0 12.5C0 21.875 12.5 41 12.5 41C12.5 41 25 21.875 25 12.5C25 5.59644 19.4036 0 12.5 0Z" fill="${cor}"/>
                                            <circle cx="12.5" cy="12.5" r="5" fill="white"/>
                                        </svg>
                                    </div>
                                `,
                                iconSize: [30, 45],
                                iconAnchor: [15, 45],
                                popupAnchor: [0, -40]
                            });

                            const marcador = L.marker([lat, lng], {icon: icone})
                                .bindPopup(popupContent, {
                                    maxWidth: 350,
                                    maxHeight: 400
                                });
                                
                            // Adicionar tooltip ao passar o mouse
                            marcador.bindTooltip(`${cidade} - ${totalTecnicos} técnicos`, {
                                direction: 'top',
                                permanent: false,
                                offset: [0, -35],
                                className: 'custom-tooltip',
                                opacity: 0.9
                            });
                            
                            marcador.addTo(mapa);
                        }
                });
            }
        }

        // Função para fechar o mapa
        function fecharMapa() {
            document.getElementById('mapaContainer').style.display = 'none';
        }

        // Adicionar evento de clique ao botão do mapa
        document.getElementById('verMapa').addEventListener('click', mostrarMapa);

        // Adicionar funções de filtro
        function filtrarRegistros() {
            const filtroCidade = document.getElementById('filtroCidade').value.toLowerCase();
            const filtroTecnico = document.getElementById('filtroTecnico').value.toLowerCase();
            const filtroAuxiliar = document.getElementById('filtroAuxiliar').value.toLowerCase();
            const filtroPlaca = document.getElementById('filtroPlaca').value.toUpperCase();
            const filtroModelo = document.getElementById('filtroModelo').value.toUpperCase();
            const filtroOperacao = document.getElementById('filtroOperacao').value;

            // Verificar se o usuário tem permissão para visualizar todas as operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Determinar qual filtro de operação aplicar:
            // - Se tem permissão para todas operações: usar o filtro selecionado pelo usuário
            // - Se não tem permissão: forçar filtro para operação atribuída ao usuário
            const operacaoFiltro = !podeVerTodasOperacoes && currentUser.operacao ? 
                currentUser.operacao : filtroOperacao;

            const registrosFiltrados = registros.filter(reg => {
                const cidadeMatch = !filtroCidade || (reg.cidade && reg.cidade.toLowerCase().includes(filtroCidade));
                const tecnicoMatch = !filtroTecnico || (reg.tecnico && reg.tecnico.toLowerCase().includes(filtroTecnico));
                const auxiliarMatch = !filtroAuxiliar || (reg.auxiliar && reg.auxiliar.toLowerCase().includes(filtroAuxiliar));
                
                // Se não tiver placa, só filtrar se o filtro de placa estiver vazio
                const placaMatch = !filtroPlaca || 
                    (reg.placa ? reg.placa.toUpperCase().includes(filtroPlaca) : false);
                
                // Se não tiver modelo, só filtrar se o filtro de modelo estiver vazio
                const modeloMatch = !filtroModelo || 
                    (reg.modelo ? reg.modelo.toUpperCase().includes(filtroModelo) : false);
                
                // Aplicar a lógica de permissão na operação
                const operacaoMatch = !operacaoFiltro || reg.operacao === operacaoFiltro;
                
                // Se não tem permissão de visualizar todas operações e tem uma operação atribuída,
                // então só mostrar registros da própria operação
                const permissaoOperacaoMatch = podeVerTodasOperacoes || 
                    !currentUser.operacao || reg.operacao === currentUser.operacao;

                return cidadeMatch && tecnicoMatch && auxiliarMatch && 
                    (placaMatch || !reg.placa) && (modeloMatch || !reg.modelo) && 
                    operacaoMatch && permissaoOperacaoMatch;
            });

            renderTabelaFiltrada(registrosFiltrados);
        }

        function renderTabelaFiltrada(registrosFiltrados) {
            const tbody = document.querySelector("#tabelaRegistros tbody");
            tbody.innerHTML = "";

            // Verificar permissão para filtrar por operação
            const podeVerPorOperacao = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Se não tiver permissão para ver por operação, filtrar baseado na operação do usuário
            let registrosPermitidos = registrosFiltrados;
            if (!podeVerPorOperacao) {
                // Usuários sem permissão só podem ver registros da sua operação designada
                // Esta é uma lógica simplificada, assumindo que a operação do usuário está em algum atributo
                // Se não há operação atribuída ao usuário, mostrar todos (como administrador)
                if (currentUser.operacao) {
                    registrosPermitidos = registrosFiltrados.filter(reg => reg.operacao === currentUser.operacao);
                }
            }
            
            registrosPermitidos.forEach((reg, idx) => {
                const tr = document.createElement("tr");
                const temVeiculo = reg.placa && reg.placa.trim();
                
                // Adicionar class para estilizar os técnicos sem veículo
                if (!temVeiculo) {
                    tr.className = "tecnico-sem-veiculo";
                    tr.style.backgroundColor = "#f9f9f9";
                    tr.style.fontStyle = "italic";
                }
                
                // Verificar se tem manutenções frequentes (menos de 30 dias entre manutenções)
                const temManutencaoFrequente = verificarManutencoesFrequentes(reg.manutencoes);
                if (temManutencaoFrequente && temVeiculo) {
                    tr.style.backgroundColor = "#fff5f5";
                }
                
                // Verificar se precisa de troca de óleo
                let precisaTrocaOleo = false;
                let tipoAlertaTrocaOleo = null;
                if (temVeiculo && reg.manutencoes && reg.manutencoes.length > 0) {
                    // Ordenar manutenções por data (mais recente primeiro)
                    const manutencoesOrdenadas = [...reg.manutencoes].sort((a, b) => {
                        return new Date(b.data) - new Date(a.data);
                    });
                    
                    // Encontrar a última troca de óleo
                    const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                    
                    // Verificar se precisa de troca de óleo
                    if (ultimaTrocaOleo) {
                        const alerta = verificarNecessidadeTrocaOleo(ultimaTrocaOleo, reg);
                        precisaTrocaOleo = alerta.status;
                        tipoAlertaTrocaOleo = alerta.tipoAlerta;
                        
                        // Log para debug
                        if (precisaTrocaOleo) {
                            console.log(`[Tabela] Veículo em alerta: ${reg.placa} (${reg.modelo || "?"}) - Tipo: ${tipoAlertaTrocaOleo || "desconhecido"}`);
                            
                            // Mostrar detalhes do KM
                            if (reg.kmAtual && ultimaTrocaOleo.km) {
                                const kmAtualStr = reg.kmAtual.toString().replace(/\D/g, '');
                                const kmUltimaTrocaStr = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                                
                                const kmAtual = parseInt(kmAtualStr);
                                const kmUltimaTroca = parseInt(kmUltimaTrocaStr);
                                
                                if (!isNaN(kmAtual) && !isNaN(kmUltimaTroca)) {
                                    const kmRodados = kmAtual - kmUltimaTroca;
                                    console.log(`  KM Atual: ${kmAtual}, KM Última Troca: ${kmUltimaTroca}, Diferença: ${kmRodados} km`);
                                }
                            }
                        }
                    }
                }
                
                // Se precisar de troca de óleo, modificar a aparência da linha
                if (precisaTrocaOleo && temVeiculo) {
                    // Se já tem alerta de manutenção frequente, manter esse estilo, senão usar estilo de troca de óleo
                    if (!temManutencaoFrequente) {
                        // Usar cor vermelha para alertas vencidos e laranja para alertas próximos
                        if (tipoAlertaTrocaOleo && tipoAlertaTrocaOleo.includes('vencido')) {
                            tr.style.backgroundColor = "#ffecec"; // Vermelho claro
                        } else {
                            tr.style.backgroundColor = "#fff9e6"; // Laranja claro
                        }
                    }
                }
                
                // Verificar status do contrato
                let statusContrato = '';
                if (reg.dataInicioContrato) {
                    const dataInicio = new Date(reg.dataInicioContrato);
                    const dataVencimento = new Date(dataInicio);
                    dataVencimento.setFullYear(dataVencimento.getFullYear() + 2); // Contrato de 2 anos
                    
                    const hoje = new Date();
                    const diasRestantes = Math.floor((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes < 0) {
                        statusContrato = `<span style="color: #e74c3c; font-weight: bold;">${new Date(reg.dataInicioContrato).toLocaleDateString('pt-BR')} (VENCIDO)</span>`;
                    } else if (diasRestantes <= 30) {
                        statusContrato = `<span style="color: #f39c12; font-weight: bold;">${new Date(reg.dataInicioContrato).toLocaleDateString('pt-BR')} (${diasRestantes} dias)</span>`;
                    } else {
                        statusContrato = `<span style="color: #27ae60;">${new Date(reg.dataInicioContrato).toLocaleDateString('pt-BR')}</span>`;
                    }
                }
                
                // Informação da última troca de óleo formatada
                let ultimaTrocaOleoFormatada = '';
                if (reg.ultimaTrocaOleo) {
                    if (reg.ultimaTrocaOleo.includes('km') || reg.ultimaTrocaOleo.includes('KM')) {
                        ultimaTrocaOleoFormatada = reg.ultimaTrocaOleo;
                    } else {
                        // Tentar encontrar a última manutenção de troca de óleo
                        if (reg.manutencoes && reg.manutencoes.length > 0) {
                            const manutencoesOrdenadas = [...reg.manutencoes].sort((a, b) => {
                                return new Date(b.data) - new Date(a.data);
                            });
                            
                            const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                            if (ultimaTrocaOleo) {
                                const dataFormatada = new Date(ultimaTrocaOleo.data).toLocaleDateString('pt-BR');
                                ultimaTrocaOleoFormatada = `${dataFormatada} - ${ultimaTrocaOleo.km} km`;
                            } else {
                                ultimaTrocaOleoFormatada = reg.ultimaTrocaOleo;
                            }
                        } else {
                            ultimaTrocaOleoFormatada = reg.ultimaTrocaOleo;
                        }
                    }
                }
                
                tr.innerHTML = `
                    <td>${reg.cidade}</td>
                    <td>${reg.tecnico}</td>
                    <td>${reg.auxiliar || 'Não informado'}</td>
                    <td>
                        ${temManutencaoFrequente && temVeiculo ? 
                            `<span class="alerta-manutencao"><i>⚠️</i></span>` : 
                            ''}
                        ${precisaTrocaOleo && temVeiculo ? 
                            `<span class="alerta-troca-oleo" style="background-color: ${tipoAlertaTrocaOleo && tipoAlertaTrocaOleo.includes('vencido') ? '#e74c3c' : '#f39c12'};"><i>🔧</i>${tipoAlertaTrocaOleo && tipoAlertaTrocaOleo.includes('vencido') ? '!' : ''}</span>` : 
                            ''}
                        ${reg.placa || '<span style="color:#888; font-style:italic;">Sem veículo</span>'}
                    </td>
                    <td>${reg.modelo || ''}</td>
                    <td>${reg.operacao || ''}</td>
                    <td>${reg.equipes || ''}</td>
                    <td>${reg.kmAtual || ''}</td>
                    <td>${ultimaTrocaOleoFormatada || ''}</td>
                    <td>${reg.renavam || ''}</td>
                    <td>${reg.lat || ''}</td>
                    <td>${reg.lng || ''}</td>
                    <td>${reg.observacoes || ''}</td>
                    <td>${statusContrato || ''}</td>
                    <td class="actions">
                        ${Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_TECHNICIAN) ? 
                        `<button class="btnEditar" onclick="editarRegistro(${registros.indexOf(reg)})">Editar</button>` : ''}
                        ${Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_TECHNICIAN) ?
                        `<button class="btnExcluir" onclick="removerRegistro(${registros.indexOf(reg)})" style="background:#c0392b;">Remover</button>` : ''}
                        ${temVeiculo ? `<button onclick="registrarManutencao(${registros.indexOf(reg)})" style="background:#2980b9;">Manutenção</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function limparFiltros() {
            document.getElementById('filtroCidade').value = '';
            document.getElementById('filtroTecnico').value = '';
            document.getElementById('filtroAuxiliar').value = '';
            document.getElementById('filtroPlaca').value = '';
            document.getElementById('filtroModelo').value = '';
            document.getElementById('filtroOperacao').value = '';
            renderTabela();
        }

        // Função para mostrar o popup de veículos com auxiliar
        window.showVeiculosAuxiliarPopup = function(element, encodedContent) {
            const content = decodeURIComponent(encodedContent);
            
            // Criar popup
            const popup = document.createElement('div');
            popup.style.position = 'fixed';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.backgroundColor = 'white';
            popup.style.padding = '20px';
            popup.style.borderRadius = '8px';
            popup.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
            popup.style.zIndex = '1000';
            popup.style.maxHeight = '80vh';
            popup.style.overflowY = 'auto';
            popup.innerHTML = content;
            
            // Criar overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
            overlay.style.zIndex = '999';
            
            // Função para fechar o popup
            function fecharPopup() {
                document.body.removeChild(popup);
                document.body.removeChild(overlay);
            }

            // Adicionar botão de fechar
            const closeButton = document.createElement('button');
            closeButton.textContent = '✕';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.background = '#c0392b';
            closeButton.style.color = 'white';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '50%';
            closeButton.style.width = '25px';
            closeButton.style.height = '25px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.fontSize = '14px';
            closeButton.style.display = 'flex';
            closeButton.style.alignItems = 'center';
            closeButton.style.justifyContent = 'center';
            closeButton.onclick = fecharPopup;
            popup.appendChild(closeButton);

            // Adicionar evento ao overlay
            overlay.onclick = fecharPopup;
            
            // Adicionar à página
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
        };

        // Função para limpar registros duplicados
        function limparRegistrosDuplicados() {
            const registrosUnicos = [];
            const idsVistos = new Set();
            
            registros.forEach(reg => {
                // Usar placaOuId para identificar registros
                const id = reg.placaOuId ? reg.placaOuId.toUpperCase() : 
                         (reg.placa ? reg.placa.toUpperCase() : null);
                
                if (id && !idsVistos.has(id)) {
                    idsVistos.add(id);
                    registrosUnicos.push(reg);
                }
            });
            
            const removidos = registros.length - registrosUnicos.length;
            registros = registrosUnicos;
            salvarRegistros();
            renderTabela();
            return removidos;
        }
        
        // Função para adicionar manualmente o registro de Guadalupe
        function adicionarRegistroGuadalupe() {
            // Verificar se já existe um registro de Guadalupe com esta placa
            const existeGuadalupe = registros.some(r => 
                r.cidade.includes('GUADALUPE') && r.placa === 'QRS-4J09');
            
            if (!existeGuadalupe) {
                const registro = {
                    cidade: 'GUADALUPE',
                    tecnico: 'LAYLSON DA SILVA',
                    auxiliar: 'LUCAS DA SILVA SOUSA',
                    placa: 'QRS-4J09',
                    modelo: 'Gol',
                    operacao: 'Megalink',
                    equipes: 'Sim',
                    ultimaTrocaOleo: '95000',
                    renavam: '1215373497',
                    lat: '-6.7858',
                    lng: '-43.5589',
                    observacoes: ''
                };
                
                // Encontrar se já existe um registro com essa placa
                const indiceExistente = registros.findIndex(r => r.placa === 'QRS-4J09');
                
                if (indiceExistente >= 0) {
                    registros[indiceExistente] = registro;
                    console.log('Registro de Guadalupe atualizado.');
                } else {
                    registros.push(registro);
                    console.log('Registro de Guadalupe adicionado.');
                }
                
                salvarRegistros();
                renderTabela();
                return true;
            }
            
            return false;
        }

        // Função para abrir o modal de manutenção sem um veículo específico
        window.abrirManutencaoGeral = function() {
            // Redirecionar para a página de manutenção
            window.location.href = "manutencao.html";
        };
        
        window.fecharModalManutencao = function() {
            document.getElementById('manutencaoModal').style.display = 'none';
        };
        
        // Função para carregar histórico de manutenções
        function atualizarHistoricoManutencao(registro) {
            const historicoDiv = document.getElementById('historicoManutencao');
            historicoDiv.innerHTML = '';
            
            // Verificar se o registro tem histórico de manutenções
            if (!registro.manutencoes || registro.manutencoes.length === 0) {
                historicoDiv.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Nenhuma manutenção registrada.</p>';
                return;
            }
            
            // Ordenar manutenções por data (mais recente primeiro)
            const manutencoes = [...registro.manutencoes].sort((a, b) => {
                return new Date(b.data) - new Date(a.data);
            });
            
            // Criar elementos para cada manutenção
            manutencoes.forEach(manutencao => {
                const manutencaoItem = document.createElement('div');
                manutencaoItem.style.padding = '10px';
                manutencaoItem.style.marginBottom = '10px';
                manutencaoItem.style.background = '#f9f9f9';
                manutencaoItem.style.borderRadius = '5px';
                manutencaoItem.style.borderLeft = '3px solid #2980b9';
                
                const dataFormatada = new Date(manutencao.data).toLocaleDateString('pt-BR');
                
                manutencaoItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong style="color: #2a3d66;">${manutencao.tipo}</strong>
                        <span style="color: #7f8c8d;">${dataFormatada}</span>
                    </div>
                    <div style="margin-bottom: 3px; font-size: 0.9em;">
                        <span style="color: #7f8c8d;">Quilometragem:</span> ${manutencao.km} km
                    </div>
                    <div style="margin-bottom: 3px; font-size: 0.9em;">
                        <span style="color: #7f8c8d;">Valor:</span> R$ ${parseFloat(manutencao.valor).toFixed(2)}
                    </div>
                    ${manutencao.observacoes ? `
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            <span style="color: #7f8c8d;">Observações:</span> ${manutencao.observacoes}
                        </div>
                    ` : ''}
                `;
                
                historicoDiv.appendChild(manutencaoItem);
            });
        }
        
        // Formulário de manutenção
        document.getElementById('manutencaoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const idx = document.getElementById('manutencaoVeiculoId').value;
            const tipo = document.getElementById('tipoManutencao').value;
            const data = document.getElementById('dataManutencao').value;
            const km = document.getElementById('kmManutencao').value;
            const valor = document.getElementById('valorManutencao').value;
            const observacoes = document.getElementById('observacoesManutencao').value;
            
            if (!tipo || !data || !km) {
                alert('Por favor, preencha o tipo, data e quilometragem.');
                return;
            }
            
            const registro = registros[idx];
            
            if (!registro.manutencoes) {
                registro.manutencoes = [];
            }
            
            // Adicionar nova manutenção
            registro.manutencoes.push({
                tipo,
                data,
                km,
                valor: valor || '0',
                observacoes,
                dataRegistro: new Date().toISOString()
            });
            
            // Se for troca de óleo, atualizar o campo de última troca de óleo
            if (tipo === 'Troca de Óleo') {
                const dataFormatada = new Date(data).toLocaleDateString('pt-BR');
                registro.ultimaTrocaOleo = `${dataFormatada} - ${km} km`;
            }
            
            // Sempre atualizar o KM atual com o valor mais recente
            registro.kmAtual = km;
            
            // Salvar registros e atualizar interface
            salvarRegistros();
            atualizarHistoricoManutencao(registro);
            renderTabela();
            
            alert('Manutenção registrada com sucesso!');
        });

        // Funções para gerenciar o registro de manutenções
        window.registrarManutencao = function(idx) {
            // Redirecionar para a página de manutenção com o ID do veículo
            window.open(`manutencao.html?veiculo=${idx}`, '_blank');
        };

        // Função para verificar o status do contrato
        function verificarStatusContrato(dataInicioContrato) {
            if (!dataInicioContrato) return { status: 'sem-contrato', dias: null };
            
            const dataInicio = new Date(dataInicioContrato);
            const dataVencimento = new Date(dataInicio);
            dataVencimento.setFullYear(dataVencimento.getFullYear() + 2); // Contrato de 2 anos
            
            const hoje = new Date();
            const diasRestantes = Math.floor((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
            
            if (diasRestantes < 0) {
                return { status: 'vencido', dias: Math.abs(diasRestantes) };
            } else if (diasRestantes <= 30) {
                return { status: 'alerta', dias: diasRestantes };
            } else {
                return { status: 'vigente', dias: diasRestantes };
            }
        }
        
        // Função para verificar alertas de contratos
        function verificarAlertasContratos() {
            // Filtrar veículos com contratos vencidos ou próximos do vencimento
            const alertas = registros.filter(reg => {
                if (!reg.dataInicioContrato || !reg.placa || !reg.placa.trim()) return false;
                
                const status = verificarStatusContrato(reg.dataInicioContrato);
                return status.status === 'vencido' || status.status === 'alerta';
            });
            
            // Se não houver alertas, não mostrar notificação
            if (alertas.length === 0) return;
            
            // Separar por tipo
            const vencidos = alertas.filter(reg => verificarStatusContrato(reg.dataInicioContrato).status === 'vencido');
            const alertasProximos = alertas.filter(reg => verificarStatusContrato(reg.dataInicioContrato).status === 'alerta');
            
            // Atualizar o conteúdo da notificação
            const conteudoDiv = document.getElementById('alertaContratosConteudo');
            conteudoDiv.innerHTML = '';
            
            // Mostrar resumo dos alertas
            const resumoDiv = document.createElement('div');
            resumoDiv.style.marginBottom = '10px';
            resumoDiv.style.fontSize = '1.1em';
            resumoDiv.style.fontWeight = 'bold';
            resumoDiv.innerHTML = `
                ${vencidos.length > 0 ? `<div style="color: #e74c3c; margin-bottom: 5px;">${vencidos.length} contratos vencidos</div>` : ''}
                ${alertasProximos.length > 0 ? `<div style="color: #f39c12;">${alertasProximos.length} contratos vencem em breve</div>` : ''}
            `;
            conteudoDiv.appendChild(resumoDiv);
            
            // Adicionar os primeiros 5 alertas mais críticos
            const alertasMostrar = [...vencidos, ...alertasProximos].slice(0, 5);
            
            alertasMostrar.forEach(reg => {
                const status = verificarStatusContrato(reg.dataInicioContrato);
                const color = status.status === 'vencido' ? '#e74c3c' : '#f39c12';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'alerta-item';
                
                let statusText = '';
                if (status.status === 'vencido') {
                    statusText = `Vencido há ${status.dias} dias`;
                } else {
                    statusText = `Vence em ${status.dias} dias`;
                }
                
                itemDiv.innerHTML = `
                    <div style="font-weight: bold;">${reg.placa} - ${reg.modelo}</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 3px;">
                        <span style="color: #7f8c8d;">${reg.cidade}</span>
                        <span style="color: ${color}; font-weight: bold;">${statusText}</span>
                    </div>
                `;
                
                conteudoDiv.appendChild(itemDiv);
            });
            
            // Se houver mais alertas do que os mostrados
            if (alertas.length > 5) {
                const maisDiv = document.createElement('div');
                maisDiv.className = 'alerta-item';
                maisDiv.style.textAlign = 'center';
                maisDiv.style.fontStyle = 'italic';
                maisDiv.textContent = `+ ${alertas.length - 5} outros alertas`;
                conteudoDiv.appendChild(maisDiv);
            }
            
            // Exibir a notificação
            document.getElementById('alertaContratosNotificacao').style.display = 'block';
        }
        
        // Função para fechar a notificação de alerta
        function fecharAlertaNotificacao() {
            document.getElementById('alertaContratosNotificacao').style.display = 'none';
        }
        
        // Função para mostrar todos os alertas de contratos (na página separada de manutenção)
        function verTodosAlertas() {
            window.location.href = "manutencao.html?alertas=1";
            // A página de manutenção agora já tem a funcionalidade para ver todos os alertas
            fecharAlertaNotificacao();
        }

        // Função para verificar se um veículo teve mais de uma manutenção em menos de 30 dias
        function verificarManutencoesFrequentes(manutencoes) {
            if (!manutencoes || manutencoes.length < 2) return false;
            
            // Ordenar manutenções por data (mais recente primeiro)
            const manutencoesOrdenadas = [...manutencoes].sort((a, b) => {
                return new Date(b.data) - new Date(a.data);
            });
            
            // Verificar se existe pelo menos um par de manutenções com menos de 30 dias de diferença
            for (let i = 0; i < manutencoesOrdenadas.length - 1; i++) {
                const dataAtual = new Date(manutencoesOrdenadas[i].data);
                const dataSeguinte = new Date(manutencoesOrdenadas[i + 1].data);
                
                // Calcular a diferença em dias
                const diferencaDias = Math.floor((dataAtual - dataSeguinte) / (1000 * 60 * 60 * 24));
                
                if (diferencaDias < 30) {
                    return true;
                }
            }
            
            return false;
        }

        // Função para verificar alertas de manutenções frequentes
        function verificarAlertasManutencoesFrequentes() {
            // Filtrar veículos com manutenções frequentes
            const alertas = registros.filter(reg => {
                if (!reg.manutencoes || !reg.placa || !reg.placa.trim()) return false;
                
                return verificarManutencoesFrequentes(reg.manutencoes);
            });
            
            // Se não houver alertas, não mostrar notificação
            if (alertas.length === 0) return;
            
            // Atualizar o conteúdo da notificação
            const conteudoDiv = document.getElementById('alertaManutencoesConteudo');
            conteudoDiv.innerHTML = '';
            
            // Mostrar resumo dos alertas
            const resumoDiv = document.createElement('div');
            resumoDiv.style.marginBottom = '10px';
            resumoDiv.style.fontSize = '1.1em';
            resumoDiv.style.fontWeight = 'bold';
            resumoDiv.innerHTML = `
                <div style="color: #e74c3c; margin-bottom: 5px;">${alertas.length} veículos com manutenções frequentes</div>
                <p style="color: #666; font-size: 0.85em; font-weight: normal; margin-top: 5px;">
                    Veículos com mais de uma manutenção em menos de 30 dias
                </p>
            `;
            conteudoDiv.appendChild(resumoDiv);
            
            // Adicionar os primeiros 5 alertas
            const alertasMostrar = alertas.slice(0, 5);
            
            alertasMostrar.forEach(reg => {
                // Obter as manutenções recentes
                const manutencoesRecentes = obterManutencoesRecentes(reg.manutencoes);
                
                // Calcular a diferença de dias entre as duas manutenções mais recentes
                let diferencaDias = 0;
                if (manutencoesRecentes.length >= 2) {
                    const data1 = new Date(manutencoesRecentes[0].data);
                    const data2 = new Date(manutencoesRecentes[1].data);
                    diferencaDias = Math.abs(Math.floor((data1 - data2) / (1000 * 60 * 60 * 24)));
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'alerta-item';
                
                itemDiv.innerHTML = `
                    <div style="font-weight: bold;">${reg.placa} - ${reg.modelo}</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 3px;">
                        <span style="color: #7f8c8d;">${reg.cidade}</span>
                        <span style="color: #e74c3c; font-weight: bold;">Intervalo: ${diferencaDias} dias</span>
                    </div>
                `;
                
                conteudoDiv.appendChild(itemDiv);
            });
            
            // Se houver mais alertas do que os mostrados
            if (alertas.length > 5) {
                const maisDiv = document.createElement('div');
                maisDiv.className = 'alerta-item';
                maisDiv.style.textAlign = 'center';
                maisDiv.style.fontStyle = 'italic';
                maisDiv.textContent = `+ ${alertas.length - 5} outros veículos`;
                conteudoDiv.appendChild(maisDiv);
            }
            
            // Exibir a notificação
            document.getElementById('alertaManutencoesNotificacao').style.display = 'block';
        }
        
        // Função para fechar a notificação de manutenções frequentes
        function fecharAlertaManutencoesNotificacao() {
            document.getElementById('alertaManutencoesNotificacao').style.display = 'none';
        }
        
        // Função para redirecionar para a tela de manutenções frequentes
        function verTodosManutencoesFrequentes() {
            window.location.href = "manutencao.html?veiculos_alerta=1";
            fecharAlertaManutencoesNotificacao();
        }
        
        // Função para obter manutenções recentes (menos de 30 dias de diferença)
        function obterManutencoesRecentes(manutencoes) {
            if (!manutencoes || manutencoes.length < 2) return [];
            
            // Ordenar manutenções por data (mais recente primeiro)
            const manutencoesOrdenadas = [...manutencoes].sort((a, b) => {
                return new Date(b.data) - new Date(a.data);
            });
            
            const manutencoesRecentes = [];
            
            // Identificar pares de manutenções com menos de 30 dias de diferença
            for (let i = 0; i < manutencoesOrdenadas.length - 1; i++) {
                const dataAtual = new Date(manutencoesOrdenadas[i].data);
                const dataSeguinte = new Date(manutencoesOrdenadas[i + 1].data);
                
                // Calcular a diferença em dias
                const diferencaDias = Math.floor((dataAtual - dataSeguinte) / (1000 * 60 * 60 * 24));
                
                if (diferencaDias < 30) {
                    // Adicionar ao array, evitando duplicatas
                    if (!manutencoesRecentes.includes(manutencoesOrdenadas[i])) {
                        manutencoesRecentes.push(manutencoesOrdenadas[i]);
                    }
                    if (!manutencoesRecentes.includes(manutencoesOrdenadas[i + 1])) {
                        manutencoesRecentes.push(manutencoesOrdenadas[i + 1]);
                    }
                }
            }
            
            return manutencoesRecentes;
        }

        // Verificar e corrigir problemas automicamente
        setTimeout(() => {
            const duplicadosRemovidos = limparRegistrosDuplicados();
            const guadalupeAdicionado = adicionarRegistroGuadalupe();
            
            if (duplicadosRemovidos > 0 || guadalupeAdicionado) {
                console.log(`Correção automática: ${duplicadosRemovidos} duplicados removidos, Guadalupe ${guadalupeAdicionado ? 'adicionado' : 'já existente'}`);
            }
            
            renderTabela();
            
            // Verificar alertas de contratos e manutenções frequentes após carregar a tabela
            verificarAlertasContratos();
            verificarAlertasManutencoesFrequentes();
            verificarAlertasTrocaOleo();
        }, 500);

        // Adicionar função para verificar alertas de troca de óleo
        function verificarAlertasTrocaOleo() {
            console.log("Iniciando verificação de alertas de troca de óleo...");
            
            // Filtrar veículos que precisam de troca de óleo
            const alertas = registros.filter(reg => {
                if (!reg.manutencoes || !reg.placa || !reg.placa.trim() || reg.manutencoes.length === 0) {
                    return false;
                }
                
                // Ordenar manutenções por data (mais recente primeiro)
                const manutencoesOrdenadas = [...reg.manutencoes].sort((a, b) => {
                    return new Date(b.data) - new Date(a.data);
                });
                
                // Encontrar a última troca de óleo
                const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                
                if (!ultimaTrocaOleo) return false;
                
                const resultado = verificarNecessidadeTrocaOleo(ultimaTrocaOleo, reg);
                
                // Log para debug
                if (resultado.status) {
                    console.log(`Veículo em alerta: ${reg.placa} (${reg.modelo || "?"}) - Tipo: ${resultado.tipoAlerta || "desconhecido"}`);
                }
                
                return resultado.status;
            });
            
            // Se não houver alertas, não mostrar notificação
            if (alertas.length === 0) {
                console.log("Nenhum veículo em alerta de troca de óleo");
                return;
            }
            
            console.log(`Total de veículos em alerta: ${alertas.length}`);
            
            // Separar veículos por estado do alerta
            const alertasVencidos = alertas.filter(veiculo => {
                const manutencoesOrdenadas = [...veiculo.manutencoes].sort((a, b) => {
                    return new Date(b.data) - new Date(a.data);
                });
                const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                const alerta = verificarNecessidadeTrocaOleo(ultimaTrocaOleo, veiculo);
                return alerta.tipoAlerta && alerta.tipoAlerta.includes('vencido');
            });
            
            const alertasProximos = alertas.filter(veiculo => {
                const manutencoesOrdenadas = [...veiculo.manutencoes].sort((a, b) => {
                    return new Date(b.data) - new Date(a.data);
                });
                const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                const alerta = verificarNecessidadeTrocaOleo(ultimaTrocaOleo, veiculo);
                return alerta.tipoAlerta && alerta.tipoAlerta.includes('proximo');
            });
            
            console.log(`Veículos com troca vencida: ${alertasVencidos.length}`);
            console.log(`Veículos próximos do vencimento: ${alertasProximos.length}`);
            
            // Atualizar o conteúdo da notificação
            const conteudoDiv = document.getElementById('alertaTrocaOleoConteudo');
            conteudoDiv.innerHTML = '';
            
            // Mostrar resumo dos alertas
            const resumoDiv = document.createElement('div');
            resumoDiv.style.marginBottom = '10px';
            resumoDiv.style.fontSize = '1.1em';
            resumoDiv.style.fontWeight = 'bold';
            resumoDiv.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <div style="color: #e74c3c; flex: 1; text-align: center; padding: 5px; border-radius: 3px; background: #ffecec;">
                        ${alertasVencidos.length} trocas vencidas
                    </div>
                    <div style="color: #f39c12; flex: 1; text-align: center; padding: 5px; border-radius: 3px; background: #fff9e6;">
                        ${alertasProximos.length} trocas próximas
                    </div>
                </div>
                <p style="color: #666; font-size: 0.85em; font-weight: normal; margin-top: 5px;">
                    Critérios: 10.000 km ou 30 dias (alerta 1.000 km ou 5 dias antes)
                </p>
            `;
            conteudoDiv.appendChild(resumoDiv);
            
            // Mostrar primeiro os vencidos
            if (alertasVencidos.length > 0) {
                const tituloVencidos = document.createElement('div');
                tituloVencidos.style.fontWeight = 'bold';
                tituloVencidos.style.color = '#e74c3c';
                tituloVencidos.style.borderBottom = '1px solid #e74c3c';
                tituloVencidos.style.marginBottom = '8px';
                tituloVencidos.style.paddingBottom = '3px';
                tituloVencidos.textContent = 'Trocas Vencidas (URGENTE)';
                conteudoDiv.appendChild(tituloVencidos);
                
                // Adicionar até 3 alertas vencidos
                const alertasVencidosMostrar = alertasVencidos.slice(0, 3);
                adicionarItensAlerta(alertasVencidosMostrar, conteudoDiv, '#e74c3c');
                
                if (alertasVencidos.length > 3) {
                    const maisVencidos = document.createElement('div');
                    maisVencidos.className = 'alerta-item';
                    maisVencidos.style.textAlign = 'center';
                    maisVencidos.style.fontStyle = 'italic';
                    maisVencidos.style.fontSize = '0.9em';
                    maisVencidos.style.color = '#e74c3c';
                    maisVencidos.textContent = `+ ${alertasVencidos.length - 3} outras trocas vencidas`;
                    conteudoDiv.appendChild(maisVencidos);
                }
            }
            
            // Em seguida mostrar os próximos
            if (alertasProximos.length > 0) {
                const tituloProximos = document.createElement('div');
                tituloProximos.style.fontWeight = 'bold';
                tituloProximos.style.color = '#f39c12';
                tituloProximos.style.borderBottom = '1px solid #f39c12';
                tituloProximos.style.marginTop = '12px';
                tituloProximos.style.marginBottom = '8px';
                tituloProximos.style.paddingBottom = '3px';
                tituloProximos.textContent = 'Próximas da Troca';
                conteudoDiv.appendChild(tituloProximos);
                
                // Adicionar até 2 alertas próximos (para dar prioridade aos vencidos)
                const alertasProximosMostrar = alertasProximos.slice(0, 2);
                adicionarItensAlerta(alertasProximosMostrar, conteudoDiv, '#f39c12');
                
                if (alertasProximos.length > 2) {
                    const maisProximos = document.createElement('div');
                    maisProximos.className = 'alerta-item';
                    maisProximos.style.textAlign = 'center';
                    maisProximos.style.fontStyle = 'italic';
                    maisProximos.style.fontSize = '0.9em';
                    maisProximos.style.color = '#f39c12';
                    maisProximos.textContent = `+ ${alertasProximos.length - 2} outras trocas próximas`;
                    conteudoDiv.appendChild(maisProximos);
                }
            }
            
            // Exibir a notificação
            document.getElementById('alertaTrocaOleoNotificacao').style.display = 'block';
            
            console.log("Verificação de alertas de troca de óleo concluída.");
        }
        
        // Função auxiliar para adicionar itens de alerta
        function adicionarItensAlerta(veiculos, container, cor) {
            veiculos.forEach(reg => {
                // Encontrar a última troca de óleo
                const manutencoesOrdenadas = [...reg.manutencoes].sort((a, b) => {
                    return new Date(b.data) - new Date(a.data);
                });
                const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                
                if (!ultimaTrocaOleo) return; // Pular se não houver troca de óleo
                
                // Calcular informações de alerta
                const dataUltimaTroca = new Date(ultimaTrocaOleo.data);
                const hoje = new Date();
                const diferencaDias = Math.floor((hoje - dataUltimaTroca) / (1000 * 60 * 60 * 24));
                
                // Determinar o motivo do alerta
                let motivoAlerta = '';
                let kmDiferenca = 0;
                let icone = cor === '#e74c3c' ? '⚠️' : '🔧';
                let estilo = cor === '#e74c3c' ? 'font-weight: bold;' : '';
                
                // Calcular quilometragem para a exibição de alertas
                if (reg.kmAtual && ultimaTrocaOleo.km) {
                    // Limpar possíveis textos da string e converter para número
                    const kmAtualStr = reg.kmAtual.toString().replace(/\D/g, '');
                    const kmUltimaTrocaStr = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                    
                    const kmAtual = parseInt(kmAtualStr);
                    const kmUltimaTroca = parseInt(kmUltimaTrocaStr);
                    
                    if (!isNaN(kmAtual) && !isNaN(kmUltimaTroca) && kmAtual > kmUltimaTroca) {
                        kmDiferenca = kmAtual - kmUltimaTroca;
                        
                        if (kmDiferenca >= 10000) {
                            motivoAlerta = `<strong>+${kmDiferenca - 10000} km</strong>`;
                        } else if (kmDiferenca >= 9000) {
                            motivoAlerta = `Faltam ${10000 - kmDiferenca} km`;
                        }
                    }
                } else {
                    // Verificar usando a última manutenção
                    if (manutencoesOrdenadas.length > 0 && manutencoesOrdenadas[0].km && ultimaTrocaOleo.km) {
                        const ultimaKmStr = manutencoesOrdenadas[0].km.toString().replace(/\D/g, '');
                        const trocaOleoKmStr = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                        
                        const ultimaKm = parseInt(ultimaKmStr);
                        const trocaOleoKm = parseInt(trocaOleoKmStr);
                        
                        if (!isNaN(ultimaKm) && !isNaN(trocaOleoKm) && ultimaKm > trocaOleoKm) {
                            kmDiferenca = ultimaKm - trocaOleoKm;
                            
                            if (kmDiferenca >= 10000) {
                                motivoAlerta = `<strong>+${kmDiferenca - 10000} km</strong>`;
                            } else if (kmDiferenca >= 9000) {
                                motivoAlerta = `Faltam ${10000 - kmDiferenca} km`;
                            }
                        }
                    }
                }
                
                // Adicionar informação de dias
                if (diferencaDias > 30) {
                    if (motivoAlerta) {
                        motivoAlerta += ` • <strong>+${diferencaDias - 30} dias</strong>`;
                    } else {
                        motivoAlerta = `<strong>+${diferencaDias - 30} dias</strong>`;
                    }
                } else if (diferencaDias > 25) {
                    if (motivoAlerta) {
                        motivoAlerta += ` • Faltam ${30 - diferencaDias} dias`;
                    } else {
                        motivoAlerta = `Faltam ${30 - diferencaDias} dias`;
                    }
                }
                
                // Se não houver motivo de alerta, não mostrar o item
                if (!motivoAlerta) return;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'alerta-item';
                itemDiv.style.border = `1px solid ${cor}`;
                itemDiv.style.borderRadius = '4px';
                itemDiv.style.padding = '8px';
                itemDiv.style.marginBottom = '8px';
                itemDiv.style.backgroundColor = cor === '#e74c3c' ? '#fff5f5' : '#fff9e6';
                
                // Formatar a data da última troca
                const dataFormatada = dataUltimaTroca.toLocaleDateString('pt-BR');
                
                // Formatar a quilometragem
                const kmUltimaTrocaFormatado = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                
                itemDiv.innerHTML = `
                    <div style="font-weight: bold; display: flex; justify-content: space-between;">
                        <span>${reg.placa} - ${reg.modelo || ''}</span>
                        <span style="color: ${cor};">${icone}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span style="color: #7f8c8d; font-size: 0.9em;">${reg.cidade || ''}</span>
                        <span style="color: ${cor}; ${estilo} font-size: 0.9em;">${motivoAlerta}</span>
                    </div>
                    <div style="color: #666; font-size: 0.8em; margin-top: 5px;">
                        Última troca: ${dataFormatada} (${kmUltimaTrocaFormatado} km)
                    </div>
                    <div style="color: #666; font-size: 0.8em; margin-top: 3px;">
                        KM Atual: ${reg.kmAtual || 'Não informado'}
                    </div>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        // Função para verificar se um veículo precisa de troca de óleo
        function verificarNecessidadeTrocaOleo(ultimaTrocaOleo, veiculo) {
            if (!ultimaTrocaOleo) return { status: false, tipoAlerta: null };
            
            const dataUltimaTroca = new Date(ultimaTrocaOleo.data);
            const hoje = new Date();
            
            // Calcular diferença em dias
            const diferencaDias = Math.floor((hoje - dataUltimaTroca) / (1000 * 60 * 60 * 24));
            
            let status = false;
            let tipoAlerta = null;
            
            // Verificar dias
            if (diferencaDias > 30) {
                // Passou do prazo de 30 dias
                status = true;
                tipoAlerta = "vencido_dias";
            } else if (diferencaDias > 25) {
                // Faltam menos de 5 dias para vencer
                status = true;
                tipoAlerta = "proximo_dias";
            }
            
            // Verificar quilometragem apenas se tivermos km atual
            if (veiculo.kmAtual && ultimaTrocaOleo.km) {
                // Limpar possíveis textos da string e converter para número
                const kmAtualStr = veiculo.kmAtual.toString().replace(/\D/g, '');
                const kmUltimaTrocaStr = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                
                const kmAtual = parseInt(kmAtualStr);
                const kmUltimaTroca = parseInt(kmUltimaTrocaStr);
                
                if (!isNaN(kmAtual) && !isNaN(kmUltimaTroca)) {
                    const kmRodados = kmAtual - kmUltimaTroca;
                    
                    // Comparar apenas se a diferença for positiva (para evitar dados incorretos)
                    if (kmRodados > 0) {
                        if (kmRodados >= 10000) {
                            // Passou dos 10.000 km
                            status = true;
                            tipoAlerta = tipoAlerta ? tipoAlerta : "vencido_km";
                        } else if (kmRodados >= 9000) {
                            // Faltam menos de 1.000 km para vencer
                            status = true;
                            tipoAlerta = tipoAlerta ? tipoAlerta : "proximo_km";
                        }
                    }
                }
            } else {
                // Verificar usando a última manutenção se não tiver KM atual
                if (veiculo.manutencoes && veiculo.manutencoes.length > 0) {
                    // Ordenar manutenções por data (mais recente primeiro)
                    const manutencoesOrdenadas = [...veiculo.manutencoes].sort((a, b) => {
                        return new Date(b.data) - new Date(a.data);
                    });
                    
                    // Verificar se a última manutenção tem quilometragem
                    if (manutencoesOrdenadas[0].km && ultimaTrocaOleo.km) {
                        // Limpar possíveis textos da string e converter para número
                        const ultimaKmStr = manutencoesOrdenadas[0].km.toString().replace(/\D/g, '');
                        const trocaOleoKmStr = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                        
                        const ultimaKm = parseInt(ultimaKmStr);
                        const trocaOleoKm = parseInt(trocaOleoKmStr);
                        
                        if (!isNaN(ultimaKm) && !isNaN(trocaOleoKm)) {
                            const kmRodados = ultimaKm - trocaOleoKm;
                            
                            // Comparar apenas se a diferença for positiva (para evitar dados incorretos)
                            if (kmRodados > 0) {
                                if (kmRodados >= 10000) {
                                    // Passou dos 10.000 km
                                    status = true;
                                    tipoAlerta = tipoAlerta ? tipoAlerta : "vencido_km";
                                } else if (kmRodados >= 9000) {
                                    // Faltam menos de 1.000 km para vencer
                                    status = true;
                                    tipoAlerta = tipoAlerta ? tipoAlerta : "proximo_km";
                                }
                            }
                        }
                    }
                }
            }
            
            return { status, tipoAlerta };
        }

        // Função para fechar a notificação de troca de óleo
        function fecharAlertaTrocaOleoNotificacao() {
            document.getElementById('alertaTrocaOleoNotificacao').style.display = 'none';
        }
        
        // Função para redirecionar para a tela de alertas de troca de óleo
        function verTodosTrocaOleo() {
            window.location.href = "manutencao.html?troca_oleo_alerta=1";
            fecharAlertaTrocaOleoNotificacao();
        }

        // Função para verificar informações de quilometragem
        function diagnosticarQuilometragem() {
            console.log("=== DIAGNÓSTICO DE QUILOMETRAGEM ===");
            
            registros.forEach(reg => {
                if (!reg.placa || !reg.placa.trim()) return;
                
                // Verificar se existe kmAtual
                if (!reg.kmAtual || reg.kmAtual.trim() === '') {
                    console.log(`${reg.placa} (${reg.modelo}): KM Atual não informado`);
                    return;
                }
                
                // Verificar se tem manutenções
                if (!reg.manutencoes || reg.manutencoes.length === 0) {
                    console.log(`${reg.placa} (${reg.modelo}): Sem histórico de manutenções`);
                    return;
                }
                
                // Ordenar manutenções por data (mais recente primeiro)
                const manutencoesOrdenadas = [...reg.manutencoes].sort((a, b) => {
                    return new Date(b.data) - new Date(a.data);
                });
                
                // Encontrar a última troca de óleo
                const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                if (!ultimaTrocaOleo) {
                    console.log(`${reg.placa} (${reg.modelo}): Sem registro de troca de óleo`);
                    return;
                }
                
                // Comparar quilometragens
                let kmAtual = parseInt(reg.kmAtual.toString().replace(/\D/g, ''));
                let kmUltimaTroca = parseInt(ultimaTrocaOleo.km.toString().replace(/\D/g, ''));
                
                if (isNaN(kmAtual)) {
                    console.log(`${reg.placa}: KM Atual inválido: "${reg.kmAtual}"`);
                    return;
                }
                
                if (isNaN(kmUltimaTroca)) {
                    console.log(`${reg.placa}: KM Última Troca inválido: "${ultimaTrocaOleo.km}"`);
                    return;
                }
                
                const kmRodados = kmAtual - kmUltimaTroca;
                
                console.log(`${reg.placa} (${reg.modelo}): KM Atual = ${kmAtual}, KM Última Troca = ${kmUltimaTroca}`);
                console.log(`Diferença: ${kmRodados} km, Data Última Troca: ${new Date(ultimaTrocaOleo.data).toLocaleDateString('pt-BR')}`);
                
                // Verificar se há alerta
                if (kmRodados >= 10000) {
                    console.log(`ALERTA: Excedeu limite de 10.000 km (+${kmRodados - 10000} km)`);
                } else if (kmRodados >= 9000) {
                    console.log(`ALERTA PRÓXIMO: Faltam ${10000 - kmRodados} km para o limite`);
                } else {
                    console.log(`Situação normal: Faltam ${10000 - kmRodados} km para o limite`);
                }
                
                console.log("-----------------------------------");
            });
            
            console.log("=== FIM DO DIAGNÓSTICO ===");
        }
        
        // Adicionar botão de diagnóstico (para uso durante manutenção do sistema)
        document.addEventListener('DOMContentLoaded', function() {
            const btnDiagnostico = document.createElement('button');
            btnDiagnostico.textContent = 'Diagnosticar Alertas';
            btnDiagnostico.style.background = '#8e44ad';
            btnDiagnostico.style.marginLeft = '10px';
            btnDiagnostico.onclick = function() {
                diagnosticarQuilometragem();
                logVeiculosTrocaOleo();
                verificarAlertasTrocaOleo();
                alert('Diagnóstico executado! Verifique o console do navegador (F12) para ver os detalhes completos.');
            };
            
            const divBotoes = document.querySelector('div[style="margin: 20px 0;"]');
            if (divBotoes) {
                divBotoes.appendChild(btnDiagnostico);
            }
        });

        // Função para exibir diagnóstico detalhado de troca de óleo
        function logVeiculosTrocaOleo() {
            console.log("=== DIAGNÓSTICO DETALHADO: VEÍCULOS E TROCA DE ÓLEO ===");
            
            registros.forEach(reg => {
                if (!reg.placa || !reg.placa.trim()) return;
                
                console.log(`\nVeículo: ${reg.placa} (${reg.modelo || "?"})`);
                console.log(`KM Atual: ${reg.kmAtual || "Não informado"}`);
                
                // Verificar se tem manutenções
                if (!reg.manutencoes || reg.manutencoes.length === 0) {
                    console.log("Status: Sem histórico de manutenções");
                    return;
                }
                
                // Ordenar manutenções por data (mais recente primeiro)
                const manutencoesOrdenadas = [...reg.manutencoes].sort((a, b) => {
                    return new Date(b.data) - new Date(a.data);
                });
                
                console.log(`Total de manutenções: ${manutencoesOrdenadas.length}`);
                
                // Encontrar a última troca de óleo
                const ultimaTrocaOleo = manutencoesOrdenadas.find(m => m.tipo === 'Troca de Óleo');
                
                if (!ultimaTrocaOleo) {
                    console.log("Status: Sem registro de troca de óleo");
                    return;
                }
                
                // Data da última troca
                const dataUltimaTroca = new Date(ultimaTrocaOleo.data);
                const hoje = new Date();
                const diferencaDias = Math.floor((hoje - dataUltimaTroca) / (1000 * 60 * 60 * 24));
                
                console.log(`Última troca: ${dataUltimaTroca.toLocaleDateString('pt-BR')}`);
                console.log(`KM na última troca: ${ultimaTrocaOleo.km}`);
                console.log(`Dias desde a troca: ${diferencaDias}`);
                
                // Verificar quilometragem
                if (reg.kmAtual && ultimaTrocaOleo.km) {
                    const kmAtualStr = reg.kmAtual.toString().replace(/\D/g, '');
                    const kmUltimaTrocaStr = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                    
                    const kmAtual = parseInt(kmAtualStr);
                    const kmUltimaTroca = parseInt(kmUltimaTrocaStr);
                    
                    console.log(`KM Atual (limpo): ${kmAtual}`);
                    console.log(`KM Última Troca (limpo): ${kmUltimaTroca}`);
                    
                    if (!isNaN(kmAtual) && !isNaN(kmUltimaTroca)) {
                        const kmRodados = kmAtual - kmUltimaTroca;
                        console.log(`KM Rodados: ${kmRodados}`);
                        
                        if (kmRodados < 0) {
                            console.log(`ERRO: KM atual (${kmAtual}) menor que KM da última troca (${kmUltimaTroca})`);
                        } else if (kmRodados >= 10000) {
                            console.log(`ALERTA: Troca vencida por quilometragem (+${kmRodados - 10000} km)`);
                        } else if (kmRodados >= 9000) {
                            console.log(`ALERTA PRÓXIMO: Faltam ${10000 - kmRodados} km para o limite`);
                        } else {
                            console.log(`KM OK: Faltam ${10000 - kmRodados} km para o limite`);
                        }
                    } else {
                        console.log(`ERRO de conversão: KM Atual = ${reg.kmAtual}, KM Última Troca = ${ultimaTrocaOleo.km}`);
                    }
                } else {
                    console.log("KM Atual não informado, usando última manutenção como referência");
                    
                    if (manutencoesOrdenadas.length > 0 && manutencoesOrdenadas[0].km) {
                        const ultimaKmStr = manutencoesOrdenadas[0].km.toString().replace(/\D/g, '');
                        const trocaOleoKmStr = ultimaTrocaOleo.km.toString().replace(/\D/g, '');
                        
                        const ultimaKm = parseInt(ultimaKmStr);
                        const trocaOleoKm = parseInt(trocaOleoKmStr);
                        
                        console.log(`KM Última manutenção (${manutencoesOrdenadas[0].tipo}): ${ultimaKm}`);
                        console.log(`KM Última Troca óleo: ${trocaOleoKm}`);
                        
                        if (!isNaN(ultimaKm) && !isNaN(trocaOleoKm)) {
                            const kmRodados = ultimaKm - trocaOleoKm;
                            console.log(`KM Rodados desde troca: ${kmRodados}`);
                            
                            if (kmRodados < 0) {
                                console.log(`ERRO: KM última manutenção (${ultimaKm}) menor que KM da última troca (${trocaOleoKm})`);
                            } else if (kmRodados >= 10000) {
                                console.log(`ALERTA: Troca vencida por quilometragem (+${kmRodados - 10000} km)`);
                            } else if (kmRodados >= 9000) {
                                console.log(`ALERTA PRÓXIMO: Faltam ${10000 - kmRodados} km para o limite`);
                            } else {
                                console.log(`KM OK: Faltam ${10000 - kmRodados} km para o limite`);
                            }
                        } else {
                            console.log(`ERRO de conversão: KM última manutenção = ${manutencoesOrdenadas[0].km}, KM Última Troca = ${ultimaTrocaOleo.km}`);
                        }
                    } else {
                        console.log("Sem dados de KM para comparação");
                    }
                }
                
                // Verificar dias
                if (diferencaDias > 30) {
                    console.log(`ALERTA: Troca vencida por tempo (+${diferencaDias - 30} dias)`);
                } else if (diferencaDias > 25) {
                    console.log(`ALERTA PRÓXIMO: Faltam ${30 - diferencaDias} dias para o limite`);
                } else {
                    console.log(`Dias OK: Faltam ${30 - diferencaDias} dias para o limite`);
                }
                
                // Status final
                const alerta = verificarNecessidadeTrocaOleo(ultimaTrocaOleo, reg);
                console.log(`Status Final: ${alerta.status ? "PRECISA TROCAR ÓLEO" : "OK"}`);
                if (alerta.tipoAlerta) {
                    console.log(`Tipo de Alerta: ${alerta.tipoAlerta}`);
                }
                
                console.log("-----------------------------------");
            });
            
            console.log("=== FIM DO DIAGNÓSTICO ===");
        }

        // Função para mostrar estatísticas por cidade
        function mostrarEstatisticasPorCidade() {
            const tooltip = document.getElementById('estatisticasTooltip');
            
            // Se o tooltip já estiver visível, apenas esconda-o
            if (tooltip.style.display === 'block') {
                tooltip.style.display = 'none';
                return;
            }
            
            // Verificar permissão para visualizar todas operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Filtrar registros pela operação do usuário se necessário
            let registrosFiltrados = registros;
            if (!podeVerTodasOperacoes && currentUser.operacao) {
                registrosFiltrados = registros.filter(r => r.operacao === currentUser.operacao);
            }
            
            const estatisticas = {};
            
            // Coletar dados diretamente dos registros em vez da tabela
            registrosFiltrados.forEach(reg => {
                const cidade = reg.cidade.trim();
                if (!cidade) return;
                
                if (!estatisticas[cidade]) {
                    estatisticas[cidade] = {
                        total: 0,
                        tecnicos: new Set(),
                        auxiliares: new Set(),
                        veiculos: new Set()
                    };
                }
                
                estatisticas[cidade].total++;
                
                if (reg.tecnico) {
                    estatisticas[cidade].tecnicos.add(reg.tecnico.toLowerCase().trim());
                }
                
                if (reg.auxiliar && reg.auxiliar.trim()) {
                    estatisticas[cidade].auxiliares.add(reg.auxiliar.toLowerCase().trim());
                }
                
                if (reg.placa && reg.placa.trim()) {
                    estatisticas[cidade].veiculos.add(reg.placa.toUpperCase().trim());
                }
            });

            // Criar conteúdo do tooltip
            const conteudo = document.getElementById('estatisticasConteudo');
            conteudo.innerHTML = '';

            // Adicionar total no início
            const totalCidades = Object.keys(estatisticas).length;
            const totalItem = document.createElement('div');
            totalItem.style.textAlign = 'center';
            totalItem.style.marginBottom = '15px';
            totalItem.style.padding = '10px';
            totalItem.style.background = '#eaf0fa';
            totalItem.style.borderRadius = '5px';
            totalItem.style.fontWeight = 'bold';
            
            // Texto do total de cidades
            let textoTotal = `Total de ${totalCidades} cidades`;
            
            totalItem.innerHTML = textoTotal;
            conteudo.appendChild(totalItem);
            
            Object.entries(estatisticas)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([cidade, dados]) => {
                    const item = document.createElement('div');
                    item.className = 'estatistica-item';
                    
                    // Formatação mais estruturada para as informações
                    item.innerHTML = `
                        <span class="estatistica-label">${cidade}</span>
                        <span class="estatistica-valor">
                            <span style="display: inline-block; margin-right: 8px; color: #2a3d66;">
                                <span style="font-weight: bold;">${dados.tecnicos.size}</span> técnicos
                            </span>
                            <span style="display: inline-block; margin-right: 8px; color: #27ae60;">
                                <span style="font-weight: bold;">${dados.auxiliares.size}</span> auxiliares
                            </span>
                            <span style="display: inline-block; color: #e67e22;">
                                <span style="font-weight: bold;">${dados.veiculos.size}</span> veículos
                            </span>
                        </span>
                    `;
                    conteudo.appendChild(item);
                });

            // Mostrar tooltip
            tooltip.style.display = 'block';
            
            // Garantir que o tooltip apareça no lugar certo
            const botaoEstatisticas = document.getElementById('mostrarEstatisticas');
            const rect = botaoEstatisticas.getBoundingClientRect();
            const painelEstatisticas = document.getElementById('painelEstatisticasCidade');
            const painelRect = painelEstatisticas.getBoundingClientRect();
            
            // Posicionamento ajustado para alinhamento à direita
            tooltip.style.top = (rect.bottom - painelRect.top + 10) + 'px';
            tooltip.style.right = (painelRect.right - rect.right) + 'px';
            tooltip.style.left = 'auto'; // Anular o left para o right funcionar
            
            // Remover a seta anterior, se existir
            const setaAnterior = tooltip.querySelector('.seta-tooltip');
            if (setaAnterior) {
                setaAnterior.remove();
            }
            
            // Adicionar indicador de "seta" para apontar para o botão
            const setaIndicadora = document.createElement('div');
            setaIndicadora.className = 'seta-tooltip';
            setaIndicadora.style.position = 'absolute';
            setaIndicadora.style.top = '-10px';
            setaIndicadora.style.right = (rect.width / 2) + 'px';
            setaIndicadora.style.width = '0';
            setaIndicadora.style.height = '0';
            setaIndicadora.style.borderLeft = '10px solid transparent';
            setaIndicadora.style.borderRight = '10px solid transparent';
            setaIndicadora.style.borderBottom = '10px solid white';
            setaIndicadora.style.zIndex = '1';
            tooltip.appendChild(setaIndicadora);

            // Fechar tooltip ao clicar fora
            document.addEventListener('click', function fecharTooltip(e) {
                if (!tooltip.contains(e.target) && e.target !== document.getElementById('mostrarEstatisticas')) {
                    tooltip.style.display = 'none';
                    // Remover a seta após fechar
                    if (setaIndicadora.parentNode) {
                        setaIndicadora.parentNode.removeChild(setaIndicadora);
                    }
                    document.removeEventListener('click', fecharTooltip);
                }
            });
            
            // Adicionar botão de fechar
            const fecharBtn = document.createElement('button');
            fecharBtn.innerHTML = '×';
            fecharBtn.style.position = 'absolute';
            fecharBtn.style.top = '10px';
            fecharBtn.style.right = '10px';
            fecharBtn.style.background = '#e0e0e0';
            fecharBtn.style.border = 'none';
            fecharBtn.style.borderRadius = '50%';
            fecharBtn.style.width = '24px';
            fecharBtn.style.height = '24px';
            fecharBtn.style.cursor = 'pointer';
            fecharBtn.style.display = 'flex';
            fecharBtn.style.alignItems = 'center';
            fecharBtn.style.justifyContent = 'center';
            fecharBtn.style.fontSize = '16px';
            fecharBtn.style.color = '#666';
            fecharBtn.onclick = function() {
                tooltip.style.display = 'none';
                if (setaIndicadora.parentNode) {
                    setaIndicadora.parentNode.removeChild(setaIndicadora);
                }
            };
            tooltip.appendChild(fecharBtn);
        }

        // Menu interativo - efeito de hover
        document.addEventListener('DOMContentLoaded', function() {
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                const indicator = item.querySelector('.menu-hover-indicator');
                
                // Efeito hover
                item.addEventListener('mouseenter', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '100%';
                    }
                });
                
                item.addEventListener('mouseleave', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '0';
                    }
                });
                
                // Efeito de clique
                item.addEventListener('click', function() {
                    // Remove a classe active de todos os itens
                    menuItems.forEach(mi => {
                        mi.classList.remove('active');
                        mi.querySelector('.menu-hover-indicator').style.width = '0';
                        mi.querySelector('a').style.background = 'transparent';
                        mi.querySelector('a').style.color = 'var(--text-color)';
                    });
                    
                    // Adiciona a classe active ao item clicado
                    item.classList.add('active');
                    indicator.style.width = '100%';
                    item.querySelector('a').style.background = 'var(--secondary-color)';
                    item.querySelector('a').style.color = 'var(--primary-color)';
                });
            });
        });

        // Inicializar interface com base em permissões
        function initializeUiBasedOnPermissions() {
            // Se não tiver permissão para gerenciar usuários, esconder botão admin
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                document.getElementById('adminButton').style.display = 'none';
            }
            
            // Verificar se o usuário é admin para exibir notificações
            if (currentUser.accessLevel === 'ADMIN' || Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                document.getElementById('notificationSystem').style.display = 'block';
            }
            
            // Verificar permissão para visualizar técnicos
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_TECHNICIANS)) {
                document.getElementById('verMapa').style.display = 'none';
            }
        }
        
        // Adicionar eventos aos botões
        function setupEventListeners() {
            // Adicionar evento ao botão Ver Mapa
            document.getElementById('verMapa').addEventListener('click', function() {
                mostrarMapa();
            });
            
            // Adicionar evento ao botão de estatísticas
            document.getElementById('mostrarEstatisticas').addEventListener('click', function() {
                const tooltip = document.getElementById('estatisticasTooltip');
                if (tooltip.style.display === 'block') {
                    tooltip.style.display = 'none';
                } else {
                    tooltip.style.display = 'block';
                    atualizarEstatisticasPorCidade();
                }
            });
            
            // Adicionar evento ao botão de adicionar
            document.getElementById('btnSalvar').addEventListener('click', function(e) {
                e.preventDefault();
                salvarRegistro();
            });
            
            // Fechar tooltip ao clicar fora
            document.addEventListener('click', function(event) {
                const tooltip = document.getElementById('estatisticasTooltip');
                const btnEstatisticas = document.getElementById('mostrarEstatisticas');
                
                if (tooltip.style.display === 'block' && 
                    !tooltip.contains(event.target) && 
                    event.target !== btnEstatisticas) {
                    tooltip.style.display = 'none';
                }
            });
            
            // Adicionar evento ao botão de logout
            document.getElementById('logoutButton').addEventListener('click', function() {
                Auth.logout();
                window.location.href = 'login.html';
            });
            
            // Configurar botão de admin
            if (Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                document.getElementById('adminButton').addEventListener('click', function() {
                    localStorage.setItem('adminOriginPage', 'Pagina1 (1).html');
                    window.location.href = 'admin.html';
                });
            }
            
            // Expandir tooltips nos cards
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('expandir-observacoes')) {
                    event.preventDefault();
                    const tooltip = event.target.nextElementSibling;
                    tooltip.style.display = tooltip.style.display === 'block' ? 'none' : 'block';
                }
            });
        }
    </script>
</body>
</html>