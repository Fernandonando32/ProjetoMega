<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Manutenção de Veículos - FTTH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="module">
        import * as Auth from './js/auth.js';
        
        // Verificar autenticação
        async function checkAuth() {
            if (!await Auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Obter usuário atual
            const currentUser = Auth.getCurrentUser();
            
            // Verificar permissão para visualizar manutenções
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_MAINTENANCE)) {
                alert('Você não tem permissão para acessar esta página.');
                window.location.href = 'Pagina1 (1).html';
                return;
            }
            
            // Configurar elementos da interface após carregamento
            document.addEventListener('DOMContentLoaded', setupUI);
        }
        
        // Iniciar verificação de autenticação
        checkAuth();
        
        // Função para configurar a interface do usuário
        function setupUI() {
            const currentUser = Auth.getCurrentUser();
            if (currentUser) {
                // Configurar elementos da interface com base no usuário atual
                // Código para atualizar a UI com informações do usuário...
            }
        }
        
        // Expor Auth globalmente para uso em outros scripts inline
        window.Auth = Auth;
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6fb;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            width: 100%;
            max-width: none;
            margin: 0;
            background: #fff;
            border-radius: 0;
            box-shadow: none;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        header {
            background: #2a3d66;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        h1 {
            color: #2a3d66;
            margin: 0 0 20px 0;
            text-align: center;
        }
        .main-menu {
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 20px;
            margin-bottom: 20px;
        }
        .main-menu ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .main-menu .menu-item {
            position: relative;
        }
        .main-menu .menu-item a {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: #2a3d66;
            text-decoration: none;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        .main-menu .menu-item.active a {
            background: #eaf0fa;
            color: #2a3d66;
        }
        .main-menu .menu-hover-indicator {
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 3px;
            background: #2a3d66;
            border-radius: 3px;
            transition: width 0.2s ease;
        }
        .main-menu .menu-item.active .menu-hover-indicator {
            width: 100%;
        }
        .btn-voltar {
            background: #2a3d66;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .filtros {
            background: #eaf0fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .filtros h3 {
            color: #2a3d66;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .filtros-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        .filtros-flex > div {
            flex: 1 1 180px;
        }
        .filtros label {
            display: block;
            font-size: 0.95em;
            margin-bottom: 5px;
            color: #2a3d66;
        }
        .filtros input, .filtros select {
            width: 100%;
            padding: 8px;
            border: 1px solid #bfc9d9;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .filtros button {
            padding: 8px 15px;
            background: #2a3d66;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .veiculos-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            width: 100%;
        }
        
        /* Tornar o grid mais responsivo para melhor utilizar tela cheia */
        @media (min-width: 1200px) {
            .veiculos-lista {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1600px) {
            .veiculos-lista {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (min-width: 2000px) {
            .veiculos-lista {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .veiculos-lista {
                grid-template-columns: 1fr;
            }
        }
        .veiculo-card {
            border: 1px solid #e0e6f0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .veiculo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .veiculo-header {
            background: #2a3d66;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .veiculo-body {
            padding: 15px;
            background: #fff;
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-ok {
            background-color: #27ae60;
        }
        
        .status-warning {
            background-color: #f39c12;
        }
        
        .status-alert {
            background-color: #e74c3c;
        }
        
        /* Responsive adjustments for full screen */
        @media (min-width: 1400px) {
            .container {
                padding: 25px 40px;
            }
            
            .filtros {
                margin-bottom: 30px;
            }
        }
        .veiculo-info {
            margin-bottom: 15px;
        }
        .veiculo-info p {
            margin: 5px 0;
            display: flex;
        }
        .veiculo-info .label {
            font-weight: bold;
            color: #2a3d66;
            width: 120px;
            flex-shrink: 0;
        }
        .veiculo-actions {
            display: flex;
            justify-content: flex-end;
        }
        .btn-manutencao {
            background: #2980b9;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
        }
        .modal-content {
            width: 500px;
            max-width: 90%;
            background: white;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            position: relative;
            max-height: 90%;
            overflow-y: auto;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        form > div {
            margin-bottom: 15px;
        }
        form label {
            display: block;
            margin-bottom: 5px;
            color: #2a3d66;
        }
        form input, form select, form textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bfc9d9;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .form-actions {
            text-align: right;
        }
        .form-actions button {
            background: #2a3d66;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .form-actions button.cancel {
            background: #95a5a6;
        }
        .historico-lista {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .historico-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #2980b9;
        }
        .historico-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .historico-tipo {
            font-weight: bold;
            color: #2a3d66;
        }
        .historico-data {
            color: #7f8c8d;
        }
        .historico-info {
            font-size: 0.9em;
        }
        .historico-label {
            color: #7f8c8d;
        }
        /* Estilos para o menu dropdown */
        .dropdown-menu {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1002;
            border-radius: 5px;
        }

        .dropdown-content a {
            color: #2a3d66;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .dropdown-content a:hover {
            background-color: #eaf0fa;
        }

        .show-dropdown {
            display: block;
        }
        /* Indicador de alerta para manutenções frequentes */
        .alerta-manutencao {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            display: inline-flex;
            align-items: center;
            margin-right: 10px;
        }
        .alerta-manutencao i {
            margin-right: 5px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
        <header>
        <div style="display: flex; align-items: center;">
            <i class="fas fa-tools" style="font-size: 24px; margin-right: 10px; color: white;"></i>
            <h1 style="font-size: 20px; margin: 0; color: white;">Manutenção de Veículos - FTTH</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="currentUserName" style="font-size: 14px;"></div>
            
            <!-- Sistema de notificação para administradores -->
            <div id="notificationSystem" style="display: none; position: relative;">
                <button id="notificationButton" style="background: none; border: none; color: white; position: relative; padding: 5px; cursor: pointer;" title="Notificações">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" style="position: absolute; top: -5px; right: -5px; background: #c0392b; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                    </button>
                <div id="notificationDropdown" style="display: none; position: absolute; right: 0; top: 100%; width: 300px; max-height: 400px; overflow-y: auto; background: white; border-radius: 5px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); color: #2a3d66; z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #e0e6f0;">
                        <h3 style="margin: 0; font-size: 16px;">Notificações</h3>
                        <button id="markAllReadButton" style="font-size: 12px; padding: 3px 8px; background: #eaf0fa; color: #2a3d66; border: none; border-radius: 3px; cursor: pointer;">Marcar todas como lidas</button>
                    </div>
                    <div id="notificationList" style="padding: 0;">
                        <div style="padding: 20px; text-align: center; color: #666;">
                            Nenhuma notificação
                </div>
                    </div>
                </div>
            </div>
            
            <button class="admin-button" id="adminButton" style="display: none; padding: 5px 8px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;" title="Administrar Usuários">
                <i class="fas fa-cog"></i>
            </button>
            <button class="logout-button" id="logoutButton" style="padding: 5px 10px; font-size: 12px; background: #c0392b; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
            </div>
        </header>

    <!-- Menu de navegação intuitivo -->
    <nav class="main-menu">
        <ul>
            <li class="menu-item">
                <a href="Pagina1 (1).html">
                    <i class="fas fa-home" style="margin-right: 8px;"></i>
                    <span>Principal</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
            <li class="menu-item">
                <a href="Agenda.html">
                    <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
                    <span>Agenda</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
            <li class="menu-item active">
                <a href="manutencao.html">
                    <i class="fas fa-tools" style="margin-right: 8px;"></i>
                    <span>Manutenção de Veículos</span>
                </a>
                <div class="menu-hover-indicator"></div>
            </li>
        </ul>
    </nav>

    <div class="container">
        <div class="content-wrapper">
        <div class="filtros">
            <h3>Filtros</h3>
                <div class="dropdown-menu" style="margin-bottom: 15px;">
                    <button id="menuDropdownBtn" class="dropdown-btn" style="background: #e67e22; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                        Menu Avançado <span style="margin-left: 5px;">▼</span>
                    </button>
                    <div id="menuDropdownContent" class="dropdown-content" style="display: none; position: absolute; background-color: white; min-width: 180px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px;">
                        <a href="#" id="btnHistoricoGeral" style="color: #2a3d66; padding: 12px 16px; text-decoration: none; display: block; transition: all 0.2s ease;">Histórico Geral</a>
                        <a href="#" id="btnAlertaContratos" style="color: #2a3d66; padding: 12px 16px; text-decoration: none; display: block; transition: all 0.2s ease;">Alertas de Contratos</a>
                        <a href="#" id="btnVeiculosAlerta" style="color: #2a3d66; padding: 12px 16px; text-decoration: none; display: block; transition: all 0.2s ease;">Veículos em Alerta</a>
                        <a href="#" id="btnTrocaOleoAlerta" style="color: #2a3d66; padding: 12px 16px; text-decoration: none; display: block; transition: all 0.2s ease;">Alertas de Troca de Óleo</a>
                        <a href="#" id="btnRelatorios" style="color: #2a3d66; padding: 12px 16px; text-decoration: none; display: block; transition: all 0.2s ease;">Relatórios</a>
                        <a href="#" id="btnConfiguracoes" style="color: #2a3d66; padding: 12px 16px; text-decoration: none; display: block; transition: all 0.2s ease;">Configurações</a>
                    </div>
                </div>
            <div class="filtros-flex">
                <div>
                    <label for="filtroPlaca">Placa</label>
                    <input type="text" id="filtroPlaca" placeholder="Filtre por placa">
                </div>
                <div>
                    <label for="filtroModelo">Modelo</label>
                    <input type="text" id="filtroModelo" placeholder="Filtre por modelo">
                </div>
                <div>
                    <label for="filtroCidade">Cidade</label>
                    <input type="text" id="filtroCidade" placeholder="Filtre por cidade">
                </div>
                <div>
                    <label for="filtroTecnico">Técnico</label>
                    <input type="text" id="filtroTecnico" placeholder="Filtre por técnico">
                </div>
                <div>
                    <button id="btnLimparFiltros">Limpar Filtros</button>
                </div>
            </div>
        </div>

        <div class="veiculos-lista" id="veiculosLista">
            <!-- Os cards de veículos serão adicionados aqui via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal para registro de manutenção -->
    <div id="modalManutencao" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="fecharModal()">✕</button>
            <h2 id="modalTitulo">Registro de Manutenção</h2>
            <p id="veiculoInfo" style="font-weight: bold; margin-bottom: 20px;"></p>
            
            <form id="formManutencao">
                <input type="hidden" id="veiculoIndice">
                <div>
                    <label for="tipoManutencao">Tipo de Manutenção</label>
                    <select id="tipoManutencao">
                        <option value="Troca de Óleo">Troca de Óleo</option>
                        <option value="Revisão">Revisão</option>
                        <option value="Troca de Pneus">Troca de Pneus</option>
                        <option value="Reparo de Motor">Reparo de Motor</option>
                        <option value="Elétrica">Elétrica</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                
                <div>
                    <label for="dataManutencao">Data</label>
                    <input type="date" id="dataManutencao">
                </div>
                
                <div>
                    <label for="kmManutencao">Quilometragem</label>
                    <input type="number" id="kmManutencao">
                </div>
                
                <div>
                    <label for="valorManutencao">Valor (R$)</label>
                    <input type="number" id="valorManutencao" step="0.01">
                </div>
                
                <div>
                    <label for="observacoesManutencao">Observações</label>
                    <textarea id="observacoesManutencao" rows="3"></textarea>
                </div>
                
                <div>
                    <label for="dataInicioContrato">Data de Início do Contrato</label>
                    <input type="date" id="dataInicioContrato">
                </div>
                
                <div id="statusContrato" style="margin-bottom: 15px;">
                    <!-- O status do contrato será exibido aqui -->
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel" onclick="fecharModal()">Cancelar</button>
                    <button type="button" onclick="atualizarDataContrato(event)">Atualizar Contrato</button>
                    <button type="submit">Registrar Manutenção</button>
                </div>
            </form>
            
            <div>
                <h3 style="color: #2a3d66; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">Histórico de Manutenções</h3>
                <div id="historicoManutencao" class="historico-lista">
                    <!-- O histórico será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para histórico geral de manutenções -->
    <div id="modalHistoricoGeral" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80%;">
            <button class="close-modal" onclick="fecharModalHistoricoGeral()">✕</button>
            <h2>Histórico Geral de Manutenções</h2>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label for="filtroHistoricoTipo" style="display: block; margin-bottom: 5px; color: #2a3d66;">Tipo</label>
                        <select id="filtroHistoricoTipo" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                            <option value="">Todos</option>
                            <option value="Troca de Óleo">Troca de Óleo</option>
                            <option value="Revisão">Revisão</option>
                            <option value="Troca de Pneus">Troca de Pneus</option>
                            <option value="Reparo de Motor">Reparo de Motor</option>
                            <option value="Elétrica">Elétrica</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="filtroHistoricoPlaca" style="display: block; margin-bottom: 5px; color: #2a3d66;">Placa</label>
                        <input type="text" id="filtroHistoricoPlaca" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                    </div>
                    <div style="flex: 1;">
                        <label for="filtroHistoricoPeriodo" style="display: block; margin-bottom: 5px; color: #2a3d66;">Período</label>
                        <select id="filtroHistoricoPeriodo" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                            <option value="todos">Todos</option>
                            <option value="ultimoMes">Último mês</option>
                            <option value="ultimos3Meses">Últimos 3 meses</option>
                            <option value="ultimos6Meses">Últimos 6 meses</option>
                            <option value="ultimoAno">Último ano</option>
                        </select>
                    </div>
                </div>
                <button id="btnFiltrarHistorico" style="background: #2a3d66; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    Filtrar
                </button>
                <button id="btnLimparFiltroHistorico" style="background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                    Limpar Filtros
                </button>
            </div>
            
            <div id="historicoGeralConteudo" style="max-height: 500px; overflow-y: auto;">
                <!-- O histórico geral será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para alertas de contratos -->
    <div id="modalAlertaContratos" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80%;">
            <button class="close-modal" onclick="fecharModalAlertaContratos()">✕</button>
            <h2>Alertas de Contratos de Locação</h2>
            
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <label for="filtroAlertaStatus" style="display: block; margin-bottom: 5px; color: #2a3d66;">Status</label>
                        <select id="filtroAlertaStatus" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                            <option value="todos">Todos</option>
                            <option value="vencidos">Vencidos</option>
                            <option value="alertas">Próximos do vencimento</option>
                            <option value="vigentes">Em vigência</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="filtroAlertaPlaca" style="display: block; margin-bottom: 5px; color: #2a3d66;">Placa</label>
                        <input type="text" id="filtroAlertaPlaca" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                    </div>
                    <div style="flex: 1;">
                        <label for="filtroAlertaCidade" style="display: block; margin-bottom: 5px; color: #2a3d66;">Cidade</label>
                        <input type="text" id="filtroAlertaCidade" style="width: 100%; padding: 8px; border: 1px solid #bfc9d9; border-radius: 5px;">
                    </div>
                </div>
                <button id="btnFiltrarAlertas" style="background: #2a3d66; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                    Filtrar
                </button>
                <button id="btnLimparFiltroAlertas" style="background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                    Limpar Filtros
                </button>
            </div>
            
            <div id="alertasContratosConteudo" style="max-height: 500px; overflow-y: auto;">
                <!-- O conteúdo dos alertas será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para alertas de veículos com manutenções frequentes -->
    <div id="modalVeiculosAlerta" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80%;">
            <button class="close-modal" onclick="fecharModalVeiculosAlerta()">✕</button>
            <h2>Veículos com Manutenções Frequentes</h2>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 0.9em;">
                    Os veículos listados abaixo receberam mais de uma manutenção em um período inferior a 30 dias, 
                    o que pode indicar problemas recorrentes ou falhas nos reparos anteriores.
                </p>
            </div>
            
            <div id="veiculosAlertaConteudo" style="max-height: 500px; overflow-y: auto;">
                <!-- O conteúdo dos veículos em alerta será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para alertas de troca de óleo -->
    <div id="modalTrocaOleoAlerta" class="modal">
        <div class="modal-content" style="width: 700px; max-height: 80%;">
            <button class="close-modal" onclick="fecharModalTrocaOleoAlerta()">✕</button>
            <h2>Veículos com Alerta de Troca de Óleo</h2>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 0.9em;">
                    Veículos que precisam de troca de óleo (critérios: 10.000 km após a última troca ou 30 dias após o último registro).
                </p>
            </div>
            
            <div id="trocaOleoAlertaConteudo" style="max-height: 500px; overflow-y: auto;">
                <!-- O conteúdo dos veículos em alerta de troca de óleo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let veiculos = [];
        let manutencoes = [];
        let veiculoFiltrado = null;
        let modalAberto = false;

        // Carregar dados quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            renderizarVeiculos();
            configurarEventos();
            aplicarPermissoes();
            inicializarSistemaNotificacoes();
        });

        // Configurar eventos
        function configurarEventos() {
            // Dropdown do menu
            document.getElementById('menuDropdownBtn').addEventListener('click', function(event) {
                event.preventDefault();
                document.getElementById('menuDropdownContent').classList.toggle('show-dropdown');
            });
            
            // Eventos dos botões do dropdown
            document.getElementById('btnHistoricoGeral').addEventListener('click', function(event) {
                event.preventDefault();
                abrirModalHistoricoGeral();
            });
            
            document.getElementById('btnAlertaContratos').addEventListener('click', function(event) {
                event.preventDefault();
                abrirModalAlertaContratos();
            });
            
            document.getElementById('btnVeiculosAlerta').addEventListener('click', function(event) {
                event.preventDefault();
                abrirModalVeiculosAlerta();
            });
            
            document.getElementById('btnTrocaOleoAlerta').addEventListener('click', function(event) {
                event.preventDefault();
                abrirModalTrocaOleoAlerta();
            });
            
            // Botão limpar filtros
            document.getElementById('btnLimparFiltros').addEventListener('click', function() {
                document.getElementById('filtroPlaca').value = '';
                document.getElementById('filtroModelo').value = '';
                document.getElementById('filtroCidade').value = '';
                document.getElementById('filtroTecnico').value = '';
                filtrarVeiculos();
            });
            
            // Adicionar evento ao filtro de placa para filtrar ao digitar
            document.getElementById('filtroPlaca').addEventListener('input', filtrarVeiculos);
            document.getElementById('filtroModelo').addEventListener('input', filtrarVeiculos);
            document.getElementById('filtroCidade').addEventListener('input', filtrarVeiculos);
            document.getElementById('filtroTecnico').addEventListener('input', filtrarVeiculos);

            // Fechar modais quando clicar fora
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    fecharModal();
                }
                
                // Fechar o dropdown se clicar fora dele
                if (!event.target.matches('.dropdown-btn')) {
                    const dropdowns = document.getElementsByClassName('dropdown-content');
                    for (let i = 0; i < dropdowns.length; i++) {
                        const openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show-dropdown')) {
                            openDropdown.classList.remove('show-dropdown');
                        }
                    }
                }
            });
            
            // Evento de envio do formulário de manutenção
            document.getElementById('formManutencao').addEventListener('submit', function(event) {
                event.preventDefault();
                salvarManutencao();
            });
        }
        
        // Aplicar restrições de permissões na interface
        function aplicarPermissoes() {
            // Verificar permissão para adicionar manutenção
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.ADD_MAINTENANCE)) {
                const botoesManutenção = document.querySelectorAll('.btn-manutencao');
                botoesManutenção.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            
            // Verificar permissão para editar manutenção
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_MAINTENANCE)) {
                const botoesEditar = document.querySelectorAll('.btn-editar');
                botoesEditar.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            
            // Verificar permissão para excluir manutenção
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_MAINTENANCE)) {
                const botoesExcluir = document.querySelectorAll('.btn-excluir');
                botoesExcluir.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }

        // Carregar dados do localStorage
        function carregarDados() {
            // Carregar veículos dos registros
            const registros = JSON.parse(localStorage.getItem('registrosFTTH')) || [];
            
            // Verificar permissão para visualizar todas operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Extrair veículos únicos dos registros
            const veiculosMap = new Map();
            registros.forEach(registro => {
                // Filtrar por operação se o usuário não tiver permissão para ver todas
                if (!podeVerTodasOperacoes && currentUser.operacao && registro.operacao !== currentUser.operacao) {
                    return; // Pular registros de outras operações
                }
                
                if (registro.placa && registro.placa.trim()) {
                    const placa = registro.placa.toUpperCase().trim();
                    if (!veiculosMap.has(placa)) {
                        veiculosMap.set(placa, {
                            placa,
                            modelo: registro.modelo || 'Desconhecido',
                            tipo: registro.tipo || 'Desconhecido',
                            ano: registro.ano || 'N/A',
                            operacao: registro.operacao || 'Não informada',
                            status: 'Ativo',
                            ultimaAtualizacao: new Date().toISOString()
                        });
                    }
                }
            });
            
            // Converter o Map para array
            veiculos = Array.from(veiculosMap.values());
            
            // Carregar manutenções salvas
            manutencoes = JSON.parse(localStorage.getItem('manutencoesVeiculos')) || [];
        }

        // Filtrar veículos com base nos critérios
        function filtrarVeiculos() {
            const filtroPlaca = document.getElementById('filtroPlaca').value.toUpperCase();
            const filtroModelo = document.getElementById('filtroModelo').value.toLowerCase();
            const filtroCidade = document.getElementById('filtroCidade').value.toLowerCase();
            const filtroTecnico = document.getElementById('filtroTecnico').value.toLowerCase();
            
            // Verificar permissão para visualizar todas operações
            const podeVerTodasOperacoes = Auth.hasPermission(currentUser, Auth.PERMISSIONS.VIEW_BY_OPERATION);
            
            // Filtrar veículos
            const veiculosFiltrados = veiculos.filter(veiculo => {
                const placaMatch = veiculo.placa.includes(filtroPlaca);
                const modeloMatch = veiculo.modelo.toLowerCase().includes(filtroModelo);
                const cidadeMatch = !filtroCidade || (veiculo.cidade && veiculo.cidade.toLowerCase().includes(filtroCidade));
                const tecnicoMatch = !filtroTecnico || (veiculo.tecnico && veiculo.tecnico.toLowerCase().includes(filtroTecnico));
                
                // Filtrar por operação se o usuário não tiver permissão para ver todas
                const operacaoMatch = podeVerTodasOperacoes || 
                                     !currentUser.operacao || 
                                     veiculo.operacao === currentUser.operacao;
                
                return placaMatch && modeloMatch && cidadeMatch && tecnicoMatch && operacaoMatch;
            });
            
            // Renderizar os veículos filtrados
            renderizarVeiculosFiltrados(veiculosFiltrados);
        }

        // Renderizar todos os veículos
        function renderizarVeiculos() {
            renderizarVeiculosFiltrados(veiculos);
        }

        // Renderizar veículos filtrados
        function renderizarVeiculosFiltrados(veiculosFiltrados) {
            const container = document.querySelector('.veiculos-lista');
            container.innerHTML = '';
            
            if (veiculosFiltrados.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum veículo encontrado com os critérios de filtragem.</p>';
                return;
            }
            
            veiculosFiltrados.forEach(veiculo => {
                // Criar card para o veículo
                const card = document.createElement('div');
                card.className = 'veiculo-card';
                
                // Obter manutenções para este veículo
                const manutencoesFiltradas = manutencoes.filter(m => m.placa === veiculo.placa);
                
                // Definir status baseado na data da última manutenção
                let ultimaManutencao = "Nunca realizada";
                let proximaManutencao = "Não agendada";
                let statusClass = "";
                
                if (manutencoesFiltradas.length > 0) {
                    // Ordenar manutenções por data (mais recente primeiro)
                    manutencoesFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
                    
                    // Obter data da última manutenção
                    const dataUltima = new Date(manutencoesFiltradas[0].data);
                    ultimaManutencao = dataUltima.toLocaleDateString('pt-BR');
                    
                    // Calcular próxima manutenção (3 meses após a última)
                    const dataProxima = new Date(dataUltima);
                    dataProxima.setMonth(dataProxima.getMonth() + 3);
                    proximaManutencao = dataProxima.toLocaleDateString('pt-BR');
                    
                    // Verificar status baseado na data atual e próxima manutenção
                    const hoje = new Date();
                    const diasRestantes = Math.floor((dataProxima - hoje) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes < 0) {
                        veiculo.status = "Manutenção Atrasada";
                        statusClass = "style='color: #c0392b; font-weight: bold;'";
                    } else if (diasRestantes < 15) {
                        veiculo.status = "Manutenção Próxima";
                        statusClass = "style='color: #e67e22; font-weight: bold;'";
                    } else {
                        veiculo.status = "Em dia";
                        statusClass = "style='color: #27ae60; font-weight: bold;'";
                    }
                }
                
                // Template do card
                card.innerHTML = `
                    <div class="veiculo-header">
                        <span>Placa: ${veiculo.placa}</span>
                        <div class="dropdown-menu">
                            <button class="btn-options">⋮</button>
                            <div class="dropdown-content">
                                <a href="#" class="btn-editar" onclick="abrirModalEditarVeiculo('${veiculo.placa}')">Editar Veículo</a>
                                <a href="#" class="btn-excluir" onclick="confirmarExclusaoVeiculo('${veiculo.placa}')">Remover Veículo</a>
                            </div>
                            </div>
                        </div>
                    <div class="veiculo-body">
                        <div class="veiculo-info">
                            <p><span class="label">Modelo:</span> ${veiculo.modelo}</p>
                            <p><span class="label">Tipo:</span> ${veiculo.tipo}</p>
                            <p><span class="label">Ano:</span> ${veiculo.ano}</p>
                            <p><span class="label">Operação:</span> ${veiculo.operacao}</p>
                            <p><span class="label">Status:</span> <span ${statusClass}>${veiculo.status}</span></p>
                            <p><span class="label">Última Manutenção:</span> ${ultimaManutencao}</p>
                            <p><span class="label">Próxima Prevista:</span> ${proximaManutencao}</p>
                        </div>
                        <div class="veiculo-actions">
                            <button class="btn-manutencao" onclick="abrirModalManutencao('${veiculo.placa}')">
                                <i class="fas fa-tools"></i> Registrar Manutenção
                            </button>
                        </div>
                        <div style="margin-top: 15px;">
                            <h4 style="margin-bottom: 10px; color: #2a3d66;">Histórico de Manutenções</h4>
                            <div class="historico-lista" id="historico-${veiculo.placa.replace(/\s/g, '')}">
                                ${renderizarHistoricoManutencoes(manutencoesFiltradas)}
                        </div>
                        </div>
                    </div>
                `;
            
                container.appendChild(card);
            });
            
            // Aplicar permissões após renderizar
            aplicarPermissoes();
        }

        // Renderizar histórico de manutenções
        function renderizarHistoricoManutencoes(manutencoes) {
            if (manutencoes.length === 0) {
                return "<p>Nenhum registro de manutenção encontrado.</p>";
            }
            
            // Ordenar manutenções por data (mais recente primeiro)
            manutencoes.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            let html = "";
            manutencoes.forEach(manutencao => {
                const data = new Date(manutencao.data).toLocaleDateString('pt-BR');
                
                html += `
                    <div class="historico-item">
                    <div class="historico-header">
                        <span class="historico-tipo">${manutencao.tipo}</span>
                            <span class="historico-data">${data}</span>
                    </div>
                    <div class="historico-info">
                            <p><span class="historico-label">Oficina:</span> ${manutencao.oficina}</p>
                            <p><span class="historico-label">Custo:</span> R$ ${parseFloat(manutencao.custo).toFixed(2)}</p>
                            <p><span class="historico-label">Descrição:</span> ${manutencao.descricao}</p>
                            </div>
                        <div style="text-align: right; margin-top: 8px;">
                            <button class="btn-editar" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-right: 5px;" 
                                    onclick="editarManutencao('${manutencao.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-excluir" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;" 
                                    onclick="excluirManutencao('${manutencao.id}')">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                            </div>
                    </div>
                `;
            });
            
            return html;
        }

        // Abrir modal de manutenção
        function abrirModalManutencao(placa) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.ADD_MAINTENANCE)) {
                alert('Você não tem permissão para adicionar registros de manutenção.');
                return;
            }
            
            const veiculo = veiculos.find(v => v.placa === placa);
            if (!veiculo) return;
            
            // Definir o veículo selecionado
            veiculoFiltrado = veiculo;
            
            // Configurar o modal
            const modal = document.getElementById('modalManutencao');
            document.getElementById('modalTitulo').textContent = `Registrar Manutenção - ${placa}`;
            document.getElementById('veiculoInfo').textContent = `${veiculo.modelo} (${veiculo.placa})`;
            document.getElementById('veiculoIndice').value = placa;
            
            // Preencher a data com a data atual
            const hoje = new Date();
            const dataFormatada = hoje.toISOString().split('T')[0];
            document.getElementById('dataManutencao').value = dataFormatada;
            
            // Limpar outros campos
            document.getElementById('kmManutencao').value = '';
            document.getElementById('valorManutencao').value = '';
            document.getElementById('observacoesManutencao').value = '';
            
            // Tentar carregar data de contrato se existir
            if (veiculo.dataContrato) {
                document.getElementById('dataInicioContrato').value = new Date(veiculo.dataContrato).toISOString().split('T')[0];
                verificarStatusContrato(veiculo.dataContrato);
            } else {
                document.getElementById('dataInicioContrato').value = '';
                document.getElementById('statusContrato').innerHTML = '<em>Nenhuma data de contrato registrada.</em>';
            }
            
            // Carregar histórico de manutenções para este veículo
            carregarHistoricoManutencaoVeiculo(placa);
            
            // Exibir o modal
            modal.style.display = 'block';
            modalAberto = 'modalManutencao';
        }
        
        // Verificar status do contrato com base na data
        function verificarStatusContrato(dataContratoStr) {
            const dataContrato = new Date(dataContratoStr);
            const hoje = new Date();
            
            // Calcular data de vencimento (1 ano após início)
            const dataVencimento = new Date(dataContrato);
            dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
            
            // Calcular dias restantes
            const diasRestantes = Math.floor((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
            
            const statusElement = document.getElementById('statusContrato');
            
            if (diasRestantes < 0) {
                statusElement.innerHTML = `<div style="color: #c0392b; font-weight: bold;">Contrato vencido há ${Math.abs(diasRestantes)} dias.</div>`;
            } else if (diasRestantes < 30) {
                statusElement.innerHTML = `<div style="color: #e67e22; font-weight: bold;">Contrato vence em ${diasRestantes} dias.</div>`;
            } else {
                statusElement.innerHTML = `<div style="color: #27ae60;">Contrato válido. Vence em ${diasRestantes} dias (${dataVencimento.toLocaleDateString('pt-BR')}).</div>`;
            }
        }
        
        // Atualizar data de contrato
        function atualizarDataContrato(event) {
            event.preventDefault();
            
            const placa = document.getElementById('veiculoIndice').value;
            const dataContratoStr = document.getElementById('dataInicioContrato').value;
            
            if (!placa || !dataContratoStr) {
                alert('Informações incompletas.');
                return;
            }
            
            // Atualizar veículo
            const veiculoIndex = veiculos.findIndex(v => v.placa === placa);
            if (veiculoIndex >= 0) {
                veiculos[veiculoIndex].dataContrato = dataContratoStr;
                
                // Salvar alterações
                salvarVeiculos();
                verificarStatusContrato(dataContratoStr);
                
                alert('Data de contrato atualizada com sucesso!');
            }
        }
        
        // Salvar veículos no localStorage
        function salvarVeiculos() {
            // Esta função é simplificada, pois os veículos são extraídos dos registros
            // Em um cenário real, você precisaria atualizar os registros ou ter um armazenamento separado para veículos
            localStorage.setItem('veiculosManutencao', JSON.stringify(veiculos));
        }
        
        // Carregar histórico de manutenções de um veículo específico
        function carregarHistoricoManutencaoVeiculo(placa) {
            const historicoContainer = document.getElementById('historicoManutencao');
            
            // Filtrar manutenções para este veículo
            const manutencoesFiltradas = manutencoes.filter(m => m.placa === placa);
            
            if (manutencoesFiltradas.length === 0) {
                historicoContainer.innerHTML = '<p>Nenhum registro de manutenção encontrado para este veículo.</p>';
                return;
            }
            
            // Ordenar manutenções por data (mais recente primeiro)
            manutencoesFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            let html = '';
            manutencoesFiltradas.forEach(manutencao => {
                const data = new Date(manutencao.data).toLocaleDateString('pt-BR');
                
                html += `
                    <div class="historico-item">
                        <div class="historico-header">
                            <span class="historico-tipo">${manutencao.tipo}</span>
                            <span class="historico-data">${data}</span>
                        </div>
                        <div class="historico-info">
                            <p><span class="historico-label">Quilometragem:</span> ${manutencao.km || 'Não informada'}</p>
                            <p><span class="historico-label">Valor:</span> R$ ${parseFloat(manutencao.valor || 0).toFixed(2)}</p>
                            <p><span class="historico-label">Observações:</span> ${manutencao.observacoes || 'Nenhuma observação'}</p>
                    </div>
                    </div>
                `;
            });
            
            historicoContainer.innerHTML = html;
        }
        
        // Salvar manutenção
        function salvarManutencao() {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.ADD_MAINTENANCE)) {
                alert('Você não tem permissão para adicionar registros de manutenção.');
                return;
            }
            
            // Obter dados do formulário
            const placa = document.getElementById('veiculoIndice').value;
            const tipo = document.getElementById('tipoManutencao').value;
            const data = document.getElementById('dataManutencao').value;
            const km = document.getElementById('kmManutencao').value;
            const valor = document.getElementById('valorManutencao').value;
            const observacoes = document.getElementById('observacoesManutencao').value;
            
            if (!placa || !tipo || !data) {
                alert('Preencha os campos obrigatórios: tipo e data.');
                return;
            }
            
            // Criar objeto de manutenção
            const novaManutenção = {
                id: Date.now().toString(), // ID único baseado no timestamp
                placa: placa,
                tipo: tipo,
                data: data,
                km: km,
                valor: valor,
                observacoes: observacoes,
                registradoPor: currentUser.username,
                dataRegistro: new Date().toISOString()
            };
            
            // Adicionar ao array de manutenções
            manutencoes.push(novaManutenção);
            
            // Salvar no localStorage
            localStorage.setItem('manutencoesVeiculos', JSON.stringify(manutencoes));
            
            // Atualizar interface
            renderizarVeiculos();
            carregarHistoricoManutencaoVeiculo(placa);
            
            // Fechar o modal
            fecharModal();
            
            alert('Manutenção registrada com sucesso!');
        }

        // Editar manutenção existente
        function editarManutencao(id) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.EDIT_MAINTENANCE)) {
                alert('Você não tem permissão para editar registros de manutenção.');
                return;
            }
            
            const manutencao = manutencoes.find(m => m.id === id);
            if (!manutencao) return;
            
            const veiculo = veiculos.find(v => v.placa === manutencao.placa);
            if (!veiculo) return;
            
            // Definir o veículo selecionado
            veiculoFiltrado = veiculo;
            
            // Configurar o modal
            const modal = document.getElementById('modalManutencao');
            document.getElementById('modalTitulo').textContent = `Editar Manutenção - ${manutencao.placa}`;
            document.getElementById('veiculoInfo').textContent = `${veiculo.modelo} (${veiculo.placa})`;
            document.getElementById('veiculoIndice').value = manutencao.placa;
            
            // Preencher dados da manutenção
            const dataFormatada = new Date(manutencao.data).toISOString().split('T')[0];
            document.getElementById('dataManutencao').value = dataFormatada;
            document.getElementById('tipoManutencao').value = manutencao.tipo;
            document.getElementById('kmManutencao').value = manutencao.km || '';
            document.getElementById('valorManutencao').value = manutencao.valor || '';
            document.getElementById('observacoesManutencao').value = manutencao.observacoes || '';
            
            // Tentar carregar data de contrato se existir
            if (veiculo.dataContrato) {
                document.getElementById('dataInicioContrato').value = new Date(veiculo.dataContrato).toISOString().split('T')[0];
                verificarStatusContrato(veiculo.dataContrato);
            } else {
                document.getElementById('dataInicioContrato').value = '';
                document.getElementById('statusContrato').innerHTML = '<em>Nenhuma data de contrato registrada.</em>';
            }
            
            // Configurar o formulário para editar ao invés de criar
            const formManutencao = document.getElementById('formManutencao');
            formManutencao.dataset.editId = id;
            
            // Alterar texto do botão de submit
            const btnSubmit = formManutencao.querySelector('button[type="submit"]');
            btnSubmit.textContent = 'Atualizar Manutenção';
            
            // Carregar histórico de manutenções para este veículo
            carregarHistoricoManutencaoVeiculo(manutencao.placa);
            
            // Exibir o modal
            modal.style.display = 'block';
            modalAberto = 'modalManutencao';
        }
        
        // Excluir manutenção
        function excluirManutencao(id) {
            // Verificar permissão
            if (!Auth.hasPermission(currentUser, Auth.PERMISSIONS.DELETE_MAINTENANCE)) {
                alert('Você não tem permissão para excluir registros de manutenção.');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este registro de manutenção? Esta ação não pode ser desfeita.')) {
                // Obter a placa antes de remover
                const manutencao = manutencoes.find(m => m.id === id);
                const placa = manutencao ? manutencao.placa : null;
                
                // Remover manutenção do array
                manutencoes = manutencoes.filter(m => m.id !== id);
                
                // Salvar dados atualizados
                localStorage.setItem('manutencoesVeiculos', JSON.stringify(manutencoes));
                
                // Atualizar interface
                renderizarVeiculos();
                
                // Se estiver no modal e for a mesma placa, atualizar o histórico
                if (modalAberto === 'modalManutencao' && placa && placa === document.getElementById('veiculoIndice').value) {
                    carregarHistoricoManutencaoVeiculo(placa);
                }
                
                alert('Registro de manutenção excluído com sucesso!');
            }
        }

        // Funções para gerenciar modais
        function fecharModal() {
            const modais = document.getElementsByClassName('modal');
            for (let i = 0; i < modais.length; i++) {
                modais[i].style.display = 'none';
            }
            modalAberto = false;
        }

        function abrirModalHistoricoGeral() {
            const modal = document.getElementById('modalHistoricoGeral');
            modal.style.display = 'block';
            // Aqui você pode implementar o código para carregar os dados do histórico
            carregarHistoricoGeral();
        }

        function fecharModalHistoricoGeral() {
            document.getElementById('modalHistoricoGeral').style.display = 'none';
        }

        function abrirModalAlertaContratos() {
            const modal = document.getElementById('modalAlertaContratos');
            modal.style.display = 'block';
            // Aqui você pode implementar o código para carregar os alertas de contratos
            carregarAlertasContratos();
        }

        function fecharModalAlertaContratos() {
            document.getElementById('modalAlertaContratos').style.display = 'none';
        }

        function abrirModalVeiculosAlerta() {
            const modal = document.getElementById('modalVeiculosAlerta');
            modal.style.display = 'block';
            // Aqui você pode implementar o código para carregar os veículos com manutenções frequentes
            carregarVeiculosAlerta();
        }

        function fecharModalVeiculosAlerta() {
            document.getElementById('modalVeiculosAlerta').style.display = 'none';
        }

        function abrirModalTrocaOleoAlerta() {
            const modal = document.getElementById('modalTrocaOleoAlerta');
            modal.style.display = 'block';
            // Aqui você pode implementar o código para carregar os alertas de troca de óleo
            carregarAlertasTrocaOleo();
        }

        function fecharModalTrocaOleoAlerta() {
            document.getElementById('modalTrocaOleoAlerta').style.display = 'none';
        }

        // Funções para carregar dados nos modais
        function carregarHistoricoGeral() {
            const conteudo = document.getElementById('historicoGeralConteudo');
            
            if (manutencoes.length === 0) {
                conteudo.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum registro de manutenção encontrado.</p>';
                return;
            }
            
            // Fazer uma cópia para não alterar o array original na ordenação
            const manutencoesCopia = [...manutencoes];
            manutencoesCopia.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            let html = '';
            manutencoesCopia.forEach(manutencao => {
                const data = new Date(manutencao.data).toLocaleDateString('pt-BR');
                
                html += `
                    <div style="padding: 15px; margin-bottom: 15px; background: #f9f9f9; border-radius: 5px; border-left: 3px solid #2980b9;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-weight: bold;">${manutencao.placa} - ${manutencao.tipo}</span>
                            <span style="color: #7f8c8d;">${data}</span>
                    </div>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Quilometragem:</span> ${manutencao.km || 'Não informada'}</p>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Valor:</span> R$ ${parseFloat(manutencao.valor || 0).toFixed(2)}</p>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Observações:</span> ${manutencao.observacoes || 'Nenhuma observação'}</p>
                    </div>
            `;
            });
            
            conteudo.innerHTML = html;
        }

        function carregarAlertasContratos() {
            const conteudo = document.getElementById('alertasContratosConteudo');
            
            if (veiculos.length === 0) {
                conteudo.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum veículo encontrado.</p>';
                return;
            }
            
            let html = '';
            veiculos.forEach(veiculo => {
                // Verificar se o veículo tem data de contrato
                if (!veiculo.dataContrato) {
                    return;
                }
                
                const dataContrato = new Date(veiculo.dataContrato);
                const hoje = new Date();
                
                // Calcular data de vencimento (1 ano após início)
                const dataVencimento = new Date(dataContrato);
                dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
                
                // Calcular dias restantes
                const diasRestantes = Math.floor((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
                
                let status = '';
                let corStatus = '';
                
                if (diasRestantes < 0) {
                    status = 'Vencido';
                    corStatus = '#c0392b';
                } else if (diasRestantes < 30) {
                    status = 'Próximo do vencimento';
                    corStatus = '#e67e22';
                } else {
                    status = 'Em vigência';
                    corStatus = '#27ae60';
                }
                
                html += `
                    <div style="padding: 15px; margin-bottom: 15px; background: #f9f9f9; border-radius: 5px; border-left: 3px solid ${corStatus};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-weight: bold;">${veiculo.placa} - ${veiculo.modelo}</span>
                            <span style="color: ${corStatus}; font-weight: bold;">${status}</span>
                        </div>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Início do Contrato:</span> ${dataContrato.toLocaleDateString('pt-BR')}</p>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Vencimento:</span> ${dataVencimento.toLocaleDateString('pt-BR')}</p>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Dias restantes:</span> ${diasRestantes > 0 ? diasRestantes : 'Vencido'}</p>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align: center; padding: 20px;">Nenhum contrato de locação encontrado.</p>';
            }
            
            conteudo.innerHTML = html;
        }
        
        function carregarVeiculosAlerta() {
            const conteudo = document.getElementById('veiculosAlertaConteudo');
            
            if (manutencoes.length === 0) {
                conteudo.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum registro de manutenção encontrado.</p>';
                return;
            }
            
            // Agrupar manutenções por placa
            const manutencoesAgrupadas = {};
            manutencoes.forEach(manutencao => {
                if (!manutencoesAgrupadas[manutencao.placa]) {
                    manutencoesAgrupadas[manutencao.placa] = [];
                }
                manutencoesAgrupadas[manutencao.placa].push(manutencao);
            });
            
            // Verificar manutenções frequentes (mais de uma em 30 dias)
            const veiculosAlerta = [];
            for (const placa in manutencoesAgrupadas) {
                const manutencoesVeiculo = manutencoesAgrupadas[placa];
                
                // Ordenar manutenções por data
                manutencoesVeiculo.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Verificar intervalo entre manutenções
                for (let i = 0; i < manutencoesVeiculo.length - 1; i++) {
                    const dataAtual = new Date(manutencoesVeiculo[i].data);
                    const dataSeguinte = new Date(manutencoesVeiculo[i+1].data);
                    
                    // Calcular diferença em dias
                    const diffDias = Math.abs(Math.floor((dataAtual - dataSeguinte) / (1000 * 60 * 60 * 24)));
                    
                    if (diffDias < 30) {
                        veiculosAlerta.push({
                            placa: placa,
                            modelo: veiculos.find(v => v.placa === placa)?.modelo || 'Desconhecido',
                            manutencao1: manutencoesVeiculo[i],
                            manutencao2: manutencoesVeiculo[i+1],
                            intervalo: diffDias
                        });
                        break; // Já encontrou um alerta para este veículo
                    }
                }
            }
            
            if (veiculosAlerta.length === 0) {
                conteudo.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum veículo com manutenções frequentes.</p>';
                return;
            }
            
            let html = '';
            veiculosAlerta.forEach(alerta => {
                const data1 = new Date(alerta.manutencao1.data).toLocaleDateString('pt-BR');
                const data2 = new Date(alerta.manutencao2.data).toLocaleDateString('pt-BR');
                
                html += `
                    <div style="padding: 15px; margin-bottom: 15px; background: #f9f9f9; border-radius: 5px; border-left: 3px solid #c0392b;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-weight: bold;">${alerta.placa} - ${alerta.modelo}</span>
                            <span style="color: #c0392b; font-weight: bold;">Intervalo: ${alerta.intervalo} dias</span>
                            </div>
                        <div style="margin-bottom: 10px; padding: 10px; background: #eee; border-radius: 5px;">
                            <p style="margin: 5px 0;"><span style="font-weight: bold;">Manutenção 1:</span> ${data1} - ${alerta.manutencao1.tipo}</p>
                            <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Observações:</span> ${alerta.manutencao1.observacoes || 'Nenhuma observação'}</p>
                            </div>
                        <div style="padding: 10px; background: #eee; border-radius: 5px;">
                            <p style="margin: 5px 0;"><span style="font-weight: bold;">Manutenção 2:</span> ${data2} - ${alerta.manutencao2.tipo}</p>
                            <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Observações:</span> ${alerta.manutencao2.observacoes || 'Nenhuma observação'}</p>
                        </div>
                    </div>
                `;
            });
            
            conteudo.innerHTML = html;
        }

        function carregarAlertasTrocaOleo() {
            const conteudo = document.getElementById('trocaOleoAlertaConteudo');
            
            if (manutencoes.length === 0) {
                conteudo.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum registro de manutenção encontrado.</p>';
                return;
            }
            
            // Agrupar manutenções por placa
            const manutencoesAgrupadas = {};
            manutencoes.forEach(manutencao => {
                if (manutencao.tipo === 'Troca de Óleo') {
                    if (!manutencoesAgrupadas[manutencao.placa]) {
                        manutencoesAgrupadas[manutencao.placa] = [];
                    }
                    manutencoesAgrupadas[manutencao.placa].push(manutencao);
                }
            });
            
            // Verificar veículos que necessitam de troca de óleo
            const veiculosAlerta = [];
            for (const placa in manutencoesAgrupadas) {
                const manutencoesVeiculo = manutencoesAgrupadas[placa];
                
                // Ordenar manutenções por data (mais recente primeiro)
                manutencoesVeiculo.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Pegar apenas a manutenção mais recente
                const ultimaTroca = manutencoesVeiculo[0];
                const dataUltimaTroca = new Date(ultimaTroca.data);
                const hoje = new Date();
                
                // Calcular dias desde a última troca
                const diasDesdeUltimaTroca = Math.floor((hoje - dataUltimaTroca) / (1000 * 60 * 60 * 24));
                
                // Verificar se passou do limite (30 dias)
                if (diasDesdeUltimaTroca > 30) {
                    const veiculo = veiculos.find(v => v.placa === placa);
                    if (veiculo) {
                        veiculosAlerta.push({
                            placa: placa,
                            modelo: veiculo.modelo,
                            dataUltimaTroca: dataUltimaTroca,
                            diasDesdeUltimaTroca: diasDesdeUltimaTroca,
                            kmUltimaTroca: ultimaTroca.km || 0
                        });
                    }
                }
            }
            
            if (veiculosAlerta.length === 0) {
                conteudo.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum veículo necessita de troca de óleo no momento.</p>';
                return;
            }
            
            let html = '';
            veiculosAlerta.forEach(alerta => {
                html += `
                    <div style="padding: 15px; margin-bottom: 15px; background: #f9f9f9; border-radius: 5px; border-left: 3px solid #e67e22;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-weight: bold;">${alerta.placa} - ${alerta.modelo}</span>
                            <span style="color: #e67e22; font-weight: bold;">${alerta.diasDesdeUltimaTroca} dias desde última troca</span>
                </div>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Última troca:</span> ${alerta.dataUltimaTroca.toLocaleDateString('pt-BR')}</p>
                        <p style="margin: 5px 0;"><span style="color: #7f8c8d;">Quilometragem:</span> ${alerta.kmUltimaTroca}</p>
                        <button class="btn-manutencao" onclick="abrirModalManutencao('${alerta.placa}')" style="background: #2980b9; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                            <i class="fas fa-tools"></i> Registrar Troca de Óleo
                        </button>
                </div>
            `;
            });
            
            conteudo.innerHTML = html;
        }

        // Configuração do sistema de notificações
        function inicializarSistemaNotificacoes() {
            const currentUser = Auth.getCurrentUser();
            
            // Verificar se o usuário é administrador
            if (currentUser.accessLevel === 'ADMIN' || Auth.hasPermission(currentUser, Auth.PERMISSIONS.MANAGE_USERS)) {
                document.getElementById('notificationSystem').style.display = 'block';
                document.getElementById('adminButton').style.display = 'block';
                
                // Adicionar listener para o botão de notificação
                document.getElementById('notificationButton').addEventListener('click', function() {
                    const dropdown = document.getElementById('notificationDropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Fechar dropdown ao clicar fora
                document.addEventListener('click', function(event) {
                    if (!event.target.closest('#notificationSystem')) {
                        document.getElementById('notificationDropdown').style.display = 'none';
                    }
                });
                
                // Funcionalidade do botão "Marcar todas como lidas"
                document.getElementById('markAllReadButton').addEventListener('click', function() {
                    // Implementar lógica para marcar todas como lidas
                    alert('Todas as notificações foram marcadas como lidas');
                    document.getElementById('notificationDropdown').style.display = 'none';
                });
            }
            
            // Exibir o nome do usuário
            document.getElementById('currentUserName').textContent = currentUser.name || currentUser.username;
            
            // Configurar botão de logout
            document.getElementById('logoutButton').addEventListener('click', function() {
                Auth.logout();
                // O redirecionamento agora é feito diretamente na função Auth.logout()
            });
            
            // Configurar botão de admin
            document.getElementById('adminButton').addEventListener('click', function() {
                localStorage.setItem('adminOriginPage', 'manutencao.html');
                window.location.href = 'admin.html';
            });
            
            // Configuração do dropdown menu
            document.getElementById('menuDropdownBtn').addEventListener('click', function(event) {
                event.stopPropagation();
                const dropdownContent = document.getElementById('menuDropdownContent');
                dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
            });
            
            // Fechar dropdown menu ao clicar fora
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.dropdown-menu')) {
                    document.getElementById('menuDropdownContent').style.display = 'none';
                }
            });
            
            // Efeito hover para itens do dropdown
            const dropdownItems = document.querySelectorAll('.dropdown-content a');
            dropdownItems.forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#eaf0fa';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'transparent';
                });
            });
        }

        // Menu interativo - efeito de hover
        document.addEventListener('DOMContentLoaded', function() {
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                const indicator = item.querySelector('.menu-hover-indicator');
                
                // Efeito hover
                item.addEventListener('mouseenter', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '100%';
                    }
                });
                
                item.addEventListener('mouseleave', function() {
                    if (!item.classList.contains('active')) {
                        indicator.style.width = '0';
                    }
                });
                
                // Efeito de clique
                item.addEventListener('click', function() {
                    // Remove a classe active de todos os itens
                    menuItems.forEach(mi => {
                        mi.classList.remove('active');
                        mi.querySelector('.menu-hover-indicator').style.width = '0';
                        mi.querySelector('a').style.background = 'transparent';
                        mi.querySelector('a').style.color = 'var(--text-color)';
                    });
                    
                    // Adiciona a classe active ao item clicado
                    item.classList.add('active');
                    indicator.style.width = '100%';
                    item.querySelector('a').style.background = 'var(--secondary-color)';
                    item.querySelector('a').style.color = 'var(--primary-color)';
                });
            });
        });
    </script>
</body>
</html> 